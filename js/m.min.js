import{GlobalWorkerOptions,getDocument}from"./p.min.js";let _is_busy=!1;const _busy=()=>{_is_busy=!0},_free=()=>{_is_busy=!1,$(".loading").hide()},getScale=()=>{const e=1*_getImgScale();return e>.99&&e<10?e:2.6};async function qaInit(){if(GlobalWorkerOptions.workerSrc=$("#p-w-p").text(),!_getSiteSource())return;let t=$(".question-image"),n=$(".answer-image");if(_is_busy)return;_busy();let s=t.length+n.length,e=0;t.length>0&&t.each((t,n)=>{let o=$(n);getDocument({url:_getSiteSource()+o.data("file")}).promise.then(t=>{let r=1*o.data("p"),c=1*o.data("r"),i=getScale()*o.data("w"),a=getScale()*o.data("h");o.attr("width",i),o.removeAttr("height");let l=getScale()*o.data("x"),d=getScale()*o.data("y");t.getPage(r).then(t=>{let r=t.getViewport({scale:getScale()});const u=new OffscreenCanvas(r.width,r.height),h=u.getContext("2d");let m={canvasContext:h,viewport:r};t.render(m).promise.then(()=>{const t=new OffscreenCanvas(i,a),r=t.getContext("2d");r.translate(i*.5,a*.5),r.rotate(c*Math.PI/180),r.drawImage(u,-l-i*.5,-d-a*.5),t[t.convertToBlob?"convertToBlob":"toBlob"]().then(t=>{n.src=URL.createObjectURL(t),e++,e>=s&&_free(),o.width()<.9*o.parent().width()&&(o.removeAttr("height"),o.attr("width",o.parent().width()))})})})})}),n.length>0&&n.each((t,n)=>{let o=$(n);getDocument({url:_getSiteSource()+o.data("file")}).promise.then(t=>{let r=1*o.data("p"),c=1*o.data("r"),i=getScale()*o.data("w"),a=getScale()*o.data("h");o.attr("width",i),o.removeAttr("height");let l=getScale()*o.data("x"),d=getScale()*o.data("y");t.getPage(r).then(t=>{let r=t.getViewport({scale:getScale()});const u=new OffscreenCanvas(r.width,r.height),h=u.getContext("2d");let m={canvasContext:h,viewport:r};t.render(m).promise.then(()=>{const t=new OffscreenCanvas(i,a),r=t.getContext("2d");r.translate(i*.5,a*.5),r.rotate(c*Math.PI/180),r.drawImage(u,-l-i*.5,-d-a*.5),t[t.convertToBlob?"convertToBlob":"toBlob"]().then(t=>{n.src=URL.createObjectURL(t),e++,e>=s&&_free(),o.width()<.9*o.parent().width()&&(o.removeAttr("height"),o.attr("width",o.parent().width()))})})})})})}export{qaInit};window.qaInit=qaInit