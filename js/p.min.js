const isNodeJS=typeof process=="object"&&process+""==="[object process]"&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!=="browser"),FONT_IDENTITY_MATRIX=[.001,0,0,.001,0,0],LINE_FACTOR=1.35,LINE_DESCENT_FACTOR=.35,BASELINE_FACTOR=LINE_DESCENT_FACTOR/LINE_FACTOR,RenderingIntentFlag={ANY:1,DISPLAY:2,PRINT:4,SAVE:8,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,IS_EDITING:128,OPLIST:256},AnnotationMode={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3},AnnotationEditorPrefix="pdfjs_internal_editor_",AnnotationEditorType={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15,SIGNATURE:101},AnnotationEditorParamsType={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_DEFAULT_COLOR:32,HIGHLIGHT_THICKNESS:33,HIGHLIGHT_FREE:34,HIGHLIGHT_SHOW_ALL:35,DRAW_STEP:41},PermissionFlag={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048},TextRenderingMode={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_ADD_TO_PATH:4,STROKE_ADD_TO_PATH:5,FILL_STROKE_ADD_TO_PATH:6,ADD_TO_PATH:7,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4},util_ImageKind={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3},AnnotationType={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26},AnnotationReplyType={GROUP:"Group",REPLY:"R"},AnnotationFlag={INVISIBLE:1,HIDDEN:2,PRINT:4,NOZOOM:8,NOROTATE:16,NOVIEW:32,READONLY:64,LOCKED:128,TOGGLENOVIEW:256,LOCKEDCONTENTS:512},AnnotationFieldFlag={READONLY:1,REQUIRED:2,NOEXPORT:4,MULTILINE:4096,PASSWORD:8192,NOTOGGLETOOFF:16384,RADIO:32768,PUSHBUTTON:65536,COMBO:131072,EDIT:262144,SORT:524288,FILESELECT:1048576,MULTISELECT:2097152,DONOTSPELLCHECK:4194304,DONOTSCROLL:8388608,COMB:16777216,RICHTEXT:33554432,RADIOSINUNISON:33554432,COMMITONSELCHANGE:67108864},AnnotationBorderStyleType={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5},AnnotationActionEventType={E:"Mouse Enter",X:"Mouse Exit",D:"Mouse Down",U:"Mouse Up",Fo:"Focus",Bl:"Blur",PO:"PageOpen",PC:"PageClose",PV:"PageVisible",PI:"PageInvisible",K:"Keystroke",F:"Format",V:"Validate",C:"Calculate"},DocumentActionEventType={WC:"WillClose",WS:"WillSave",DS:"DidSave",WP:"WillPrint",DP:"DidPrint"},PageActionEventType={O:"PageOpen",C:"PageClose"},VerbosityLevel={ERRORS:0,WARNINGS:1,INFOS:5},OPS={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91,setStrokeTransparent:92,setFillTransparent:93,rawFillPath:94},DrawOPS={moveTo:0,lineTo:1,curveTo:2,closePath:3},PasswordResponses={NEED_PASSWORD:1,INCORRECT_PASSWORD:2};let verbosity=VerbosityLevel.WARNINGS;function setVerbosityLevel(e){Number.isInteger(e)&&(verbosity=e)}function getVerbosityLevel(){return verbosity}function info(e){verbosity>=VerbosityLevel.INFOS&&console.log(`Info: ${e}`)}function warn(e){verbosity>=VerbosityLevel.WARNINGS&&console.log(`Warning: ${e}`)}function unreachable(e){throw new Error(e)}function assert(e,t){e||unreachable(t)}function _isValidProtocol(e){switch(e?.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return!0;default:return!1}}function createValidAbsoluteUrl(e,t=null,n=null){if(!e)return null;if(n&&typeof e=="string"){if(n.addDefaultProtocol&&e.startsWith("www.")){const t=e.match(/\./g);t?.length>=2&&(e=`http://${e}`)}if(n.tryConvertEncoding)try{e=stringToUTF8String(e)}catch{}}const s=t?URL.parse(e,t):URL.parse(e);return _isValidProtocol(s)?s:null}function updateUrlHash(e,t,n=!1){const s=URL.parse(e);return s?(s.hash=t,s.href):n&&createValidAbsoluteUrl(e,"http://example.com")?e.split("#",1)[0]+`${t?`#${t}`:""}`:""}function shadow(e,t,n,s=!1){return Object.defineProperty(e,t,{value:n,enumerable:!s,configurable:!0,writable:!1}),n}const BaseException=function(){function t(e,t){this.message=e,this.name=t}return t.prototype=new Error,t.constructor=t,t}();class PasswordException extends BaseException{constructor(e,t){super(e,"PasswordException"),this.code=t}}class UnknownErrorException extends BaseException{constructor(e,t){super(e,"UnknownErrorException"),this.details=t}}class InvalidPDFException extends BaseException{constructor(e){super(e,"InvalidPDFException")}}class ResponseException extends BaseException{constructor(e,t,n){super(e,"ResponseException"),this.status=t,this.missing=n}}class FormatError extends BaseException{constructor(e){super(e,"FormatError")}}class AbortException extends BaseException{constructor(e){super(e,"AbortException")}}function bytesToString(e){(typeof e!="object"||e?.length===void 0)&&unreachable("Invalid argument for bytesToString");const t=e.length,n=8192;if(t<n)return String.fromCharCode.apply(null,e);const s=[];for(let o=0;o<t;o+=n){const i=Math.min(o+n,t),a=e.subarray(o,i);s.push(String.fromCharCode.apply(null,a))}return s.join("")}function stringToBytes(e){typeof e!="string"&&unreachable("Invalid argument for stringToBytes");const t=e.length,n=new Uint8Array(t);for(let s=0;s<t;++s)n[s]=e.charCodeAt(s)&255;return n}function string32(e){return String.fromCharCode(e>>24&255,e>>16&255,e>>8&255,e&255)}function objectSize(e){return Object.keys(e).length}function isLittleEndian(){const e=new Uint8Array(4);e[0]=1;const t=new Uint32Array(e.buffer,0,1);return t[0]===1}function isEvalSupported(){try{return new Function(""),!0}catch{return!1}}class util_FeatureTest{static get isLittleEndian(){return shadow(this,"isLittleEndian",isLittleEndian())}static get isEvalSupported(){return shadow(this,"isEvalSupported",isEvalSupported())}static get isOffscreenCanvasSupported(){return shadow(this,"isOffscreenCanvasSupported",typeof OffscreenCanvas!="undefined")}static get isImageDecoderSupported(){return shadow(this,"isImageDecoderSupported",typeof ImageDecoder!="undefined")}static get platform(){const{platform:e,userAgent:t}=navigator;return shadow(this,"platform",{isAndroid:t.includes("Android"),isLinux:e.includes("Linux"),isMac:e.includes("Mac"),isWindows:e.includes("Win"),isFirefox:t.includes("Firefox")})}static get isCSSRoundSupported(){return shadow(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}}const hexNumbers=Array.from(Array(256).keys(),e=>e.toString(16).padStart(2,"0"));class Util{static makeHexColor(e,t,n){return`#${hexNumbers[e]}${hexNumbers[t]}${hexNumbers[n]}`}static scaleMinMax(e,t){let n;e[0]?(e[0]<0&&(n=t[0],t[0]=t[2],t[2]=n),t[0]*=e[0],t[2]*=e[0],e[3]<0&&(n=t[1],t[1]=t[3],t[3]=n),t[1]*=e[3],t[3]*=e[3]):(n=t[0],t[0]=t[1],t[1]=n,n=t[2],t[2]=t[3],t[3]=n,e[1]<0&&(n=t[1],t[1]=t[3],t[3]=n),t[1]*=e[1],t[3]*=e[1],e[2]<0&&(n=t[0],t[0]=t[2],t[2]=n),t[0]*=e[2],t[2]*=e[2]),t[0]+=e[4],t[1]+=e[5],t[2]+=e[4],t[3]+=e[5]}static transform(e,t){return[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],e[0]*t[4]+e[2]*t[5]+e[4],e[1]*t[4]+e[3]*t[5]+e[5]]}static applyTransform(e,t,n=0){const s=e[n],o=e[n+1];e[n]=s*t[0]+o*t[2]+t[4],e[n+1]=s*t[1]+o*t[3]+t[5]}static applyTransformToBezier(e,t,n=0){const s=t[0],o=t[1],i=t[2],a=t[3],r=t[4],c=t[5];for(let t=0;t<6;t+=2){const l=e[n+t],d=e[n+t+1];e[n+t]=l*s+d*i+r,e[n+t+1]=l*o+d*a+c}}static applyInverseTransform(e,t){const n=e[0],s=e[1],o=t[0]*t[3]-t[1]*t[2];e[0]=(n*t[3]-s*t[2]+t[2]*t[5]-t[4]*t[3])/o,e[1]=(-n*t[1]+s*t[0]+t[4]*t[1]-t[5]*t[0])/o}static axialAlignedBoundingBox(e,t,n){const j=t[0],r=t[1],c=t[2],y=t[3],m=t[4],b=t[5],v=e[0],g=e[1],p=e[2],f=e[3];let s=j*v+m,h=s,a=j*p+m,u=a,i=y*g+b,d=i,o=y*f+b,l=o;if(r!==0||c!==0){const e=r*v,t=r*p,n=c*g,m=c*f;s+=n,u+=n,a+=m,h+=m,i+=e,l+=e,o+=t,d+=t}n[0]=Math.min(n[0],s,a,h,u),n[1]=Math.min(n[1],i,o,d,l),n[2]=Math.max(n[2],s,a,h,u),n[3]=Math.max(n[3],i,o,d,l)}static inverseTransform(e){const t=e[0]*e[3]-e[1]*e[2];return[e[3]/t,-e[1]/t,-e[2]/t,e[0]/t,(e[2]*e[5]-e[4]*e[3])/t,(e[4]*e[1]-e[5]*e[0])/t]}static singularValueDecompose2dScale(e,t){const s=e[0],o=e[1],i=e[2],a=e[3],r=s**2+o**2,d=s*i+o*a,c=i**2+a**2,n=(r+c)/2,l=Math.sqrt(n**2-(r*c-d**2));t[0]=Math.sqrt(n+l||1),t[1]=Math.sqrt(n-l||1)}static normalizeRect(e){const t=e.slice(0);return e[0]>e[2]&&(t[0]=e[2],t[2]=e[0]),e[1]>e[3]&&(t[1]=e[3],t[3]=e[1]),t}static intersect(e,t){const n=Math.max(Math.min(e[0],e[2]),Math.min(t[0],t[2])),s=Math.min(Math.max(e[0],e[2]),Math.max(t[0],t[2]));if(n>s)return null;const o=Math.max(Math.min(e[1],e[3]),Math.min(t[1],t[3])),i=Math.min(Math.max(e[1],e[3]),Math.max(t[1],t[3]));return o>i?null:[n,o,s,i]}static pointBoundingBox(e,t,n){n[0]=Math.min(n[0],e),n[1]=Math.min(n[1],t),n[2]=Math.max(n[2],e),n[3]=Math.max(n[3],t)}static rectBoundingBox(e,t,n,s,o){o[0]=Math.min(o[0],e,n),o[1]=Math.min(o[1],t,s),o[2]=Math.max(o[2],e,n),o[3]=Math.max(o[3],t,s)}static#getExtremumOnCurve(e,t,n,s,o,i,a,r,c,l){if(c<=0||c>=1)return;const d=1-c,u=c*c,h=u*c,m=d*(d*(d*e+3*c*t)+3*u*n)+h*s,f=d*(d*(d*o+3*c*i)+3*u*a)+h*r;l[0]=Math.min(l[0],m),l[1]=Math.min(l[1],f),l[2]=Math.max(l[2],m),l[3]=Math.max(l[3],f)}static#getExtremum(e,t,n,s,o,i,a,r,c,l,d,u){if(Math.abs(c)<1e-12){Math.abs(l)>=1e-12&&this.#getExtremumOnCurve(e,t,n,s,o,i,a,r,-d/l,u);return}const h=l**2-4*d*c;if(h<0)return;const m=Math.sqrt(h),f=2*c;this.#getExtremumOnCurve(e,t,n,s,o,i,a,r,(-l+m)/f,u),this.#getExtremumOnCurve(e,t,n,s,o,i,a,r,(-l-m)/f,u)}static bezierBoundingBox(e,t,n,s,o,i,a,r,c){c[0]=Math.min(c[0],e,a),c[1]=Math.min(c[1],t,r),c[2]=Math.max(c[2],e,a),c[3]=Math.max(c[3],t,r),this.#getExtremum(e,n,o,a,t,s,i,r,3*(-e+3*(n-o)+a),6*(e-2*n+o),3*(n-e),c),this.#getExtremum(e,n,o,a,t,s,i,r,3*(-t+3*(s-i)+r),6*(t-2*s+i),3*(s-t),c)}}const PDFStringTranslateTable=null&&[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,728,711,710,729,733,731,730,732,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8226,8224,8225,8230,8212,8211,402,8260,8249,8250,8722,8240,8222,8220,8221,8216,8217,8218,8482,64257,64258,321,338,352,376,381,305,322,339,353,382,0,8364];function stringToPDFString(e,t=!1){if(e[0]>="\xEF"){let n;if(e[0]==="\xFE"&&e[1]==="\xFF"?(n="utf-16be",e.length%2===1&&(e=e.slice(0,-1))):e[0]==="\xFF"&&e[1]==="\xFE"?(n="utf-16le",e.length%2===1&&(e=e.slice(0,-1))):e[0]==="\xEF"&&e[1]==="\xBB"&&e[2]==="\xBF"&&(n="utf-8"),n)try{const o=new TextDecoder(n,{fatal:!0}),i=stringToBytes(e),s=o.decode(i);return t||!s.includes("")?s:s.replaceAll(/\x1b[^\x1b]*(?:\x1b|$)/g,"")}catch(e){warn(`stringToPDFString: "${e}".`)}}const n=[];for(let s=0,o=e.length;s<o;s++){const i=e.charCodeAt(s);if(!t&&i===27){for(;++s<o&&e.charCodeAt(s)!==27;);continue}const a=PDFStringTranslateTable[i];n.push(a?String.fromCharCode(a):e.charAt(s))}return n.join("")}function stringToUTF8String(e){return decodeURIComponent(escape(e))}function utf8StringToString(e){return unescape(encodeURIComponent(e))}function isArrayEqual(e,t){if(e.length!==t.length)return!1;for(let n=0,s=e.length;n<s;n++)if(e[n]!==t[n])return!1;return!0}function getModificationDate(e=new Date){const t=[e.getUTCFullYear().toString(),(e.getUTCMonth()+1).toString().padStart(2,"0"),e.getUTCDate().toString().padStart(2,"0"),e.getUTCHours().toString().padStart(2,"0"),e.getUTCMinutes().toString().padStart(2,"0"),e.getUTCSeconds().toString().padStart(2,"0")];return t.join("")}let NormalizeRegex=null,NormalizationMap=null;function normalizeUnicode(e){return NormalizeRegex||(NormalizeRegex=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu,NormalizationMap=new Map([["ï¬…","Å¿t"]])),e.replaceAll(NormalizeRegex,(e,t,n)=>t?t.normalize("NFKC"):NormalizationMap.get(n))}function getUuid(){if(typeof crypto.randomUUID=="function")return crypto.randomUUID();const e=new Uint8Array(32);return crypto.getRandomValues(e),bytesToString(e)}const AnnotationPrefix="pdfjs_internal_id_";function _isValidExplicitDest(e,t,n){if(!Array.isArray(n)||n.length<2)return!1;const[o,i,...a]=n;if(!e(o)&&!Number.isInteger(o))return!1;if(!t(i))return!1;const s=a.length;let r=!0;switch(i.name){case"XYZ":if(s<2||s>3)return!1;break;case"Fit":case"FitB":return s===0;case"FitH":case"FitBH":case"FitV":case"FitBV":if(s>1)return!1;break;case"FitR":if(s!==4)return!1;r=!1;break;default:return!1}for(const e of a){if(typeof e=="number"||r&&e===null)continue;return!1}return!0}function MathClamp(e,t,n){return Math.min(Math.max(e,t),n)}function toHexUtil(e){return Uint8Array.prototype.toHex?e.toHex():Array.from(e,e=>hexNumbers[e]).join("")}function toBase64Util(e){return Uint8Array.prototype.toBase64?e.toBase64():btoa(bytesToString(e))}function fromBase64Util(e){return Uint8Array.fromBase64?Uint8Array.fromBase64(e):stringToBytes(atob(e))}typeof Promise.try!="function"&&(Promise.try=function(e,...t){return new Promise(n=>{n(e(...t))})}),typeof Math.sumPrecise!="function"&&(Math.sumPrecise=function(e){return e.reduce((e,t)=>e+t,0)});const SVG_NS="http://www.w3.org/2000/svg";class PixelsPerInch{static CSS=96;static PDF=72;static PDF_TO_CSS_UNITS=this.CSS/this.PDF}async function fetchData(e,t="text"){if(isValidFetchUrl(e,document.baseURI)){const n=await fetch(e);if(!n.ok)throw new Error(n.statusText);switch(t){case"arraybuffer":return n.arrayBuffer();case"blob":return n.blob();case"json":return n.json()}return n.text()}return new Promise((n,s)=>{const o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType=t,o.onreadystatechange=()=>{if(o.readyState!==XMLHttpRequest.DONE)return;if(o.status===200||o.status===0){switch(t){case"arraybuffer":case"blob":case"json":n(o.response);return}n(o.responseText);return}s(new Error(o.statusText))},o.send(null)})}class PageViewport{constructor({viewBox:e,userUnit:t,scale:n,rotation:s,offsetX:o=0,offsetY:i=0,dontFlip:a=!1}){this.viewBox=e,this.userUnit=t,this.scale=n,this.rotation=s,this.offsetX=o,this.offsetY=i,n*=t;const u=(e[2]+e[0])/2,h=(e[3]+e[1])/2;let l,d,r,c;switch(s%=360,s<0&&(s+=360),s){case 180:l=-1,d=0,r=0,c=1;break;case 90:l=0,d=1,r=1,c=0;break;case 270:l=0,d=-1,r=-1,c=0;break;case 0:l=1,d=0,r=0,c=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}a&&(r=-r,c=-c);let m,f,p,g;l===0?(m=Math.abs(h-e[1])*n+o,f=Math.abs(u-e[0])*n+i,p=(e[3]-e[1])*n,g=(e[2]-e[0])*n):(m=Math.abs(u-e[0])*n+o,f=Math.abs(h-e[1])*n+i,p=(e[2]-e[0])*n,g=(e[3]-e[1])*n),this.transform=[l*n,d*n,r*n,c*n,m-l*n*u-r*n*h,f-d*n*u-c*n*h],this.width=p,this.height=g}get rawDims(){const e=this.viewBox;return shadow(this,"rawDims",{pageWidth:e[2]-e[0],pageHeight:e[3]-e[1],pageX:e[0],pageY:e[1]})}clone({scale:e=this.scale,rotation:t=this.rotation,offsetX:n=this.offsetX,offsetY:s=this.offsetY,dontFlip:o=!1}={}){return new PageViewport({viewBox:this.viewBox.slice(),userUnit:this.userUnit,scale:e,rotation:t,offsetX:n,offsetY:s,dontFlip:o})}convertToViewportPoint(e,t){const n=[e,t];return Util.applyTransform(n,this.transform),n}convertToViewportRectangle(e){const t=[e[0],e[1]];Util.applyTransform(t,this.transform);const n=[e[2],e[3]];return Util.applyTransform(n,this.transform),[t[0],t[1],n[0],n[1]]}convertToPdfPoint(e,t){const n=[e,t];return Util.applyInverseTransform(n,this.transform),n}}class RenderingCancelledException extends BaseException{constructor(e,t=0){super(e,"RenderingCancelledException"),this.extraDelay=t}}function isDataScheme(e){const n=e.length;let t=0;for(;t<n&&e[t].trim()==="";)t++;return e.substring(t,t+5).toLowerCase()==="data:"}function isPdfFile(e){return typeof e=="string"&&/\.pdf$/i.test(e)}function getFilenameFromUrl(e){return[e]=e.split(/[#?]/,1),e.substring(e.lastIndexOf("/")+1)}function getPdfFilenameFromUrl(e,t="document.pdf"){if(typeof e!="string")return t;if(isDataScheme(e))return warn('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.'),t;const a=e=>{try{return new URL(e)}catch{try{return new URL(decodeURIComponent(e))}catch{try{return new URL(e,"https://foo.bar")}catch{try{return new URL(decodeURIComponent(e),"https://foo.bar")}catch{return null}}}}},n=a(e);if(!n)return t;const s=e=>{try{let t=decodeURIComponent(e);return t.includes("/")?(t=t.split("/").at(-1),t.test(/^\.pdf$/i)?t:e):t}catch{return e}},o=/\.pdf$/i,i=n.pathname.split("/").at(-1);if(o.test(i))return s(i);if(n.searchParams.size>0){const e=Array.from(n.searchParams.values()).reverse();for(const t of e)if(o.test(t))return s(t);const t=Array.from(n.searchParams.keys()).reverse();for(const e of t)if(o.test(e))return s(e)}if(n.hash){const t=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i,e=t.exec(n.hash);if(e)return s(e[0])}return t}class StatTimer{started=Object.create(null);times=[];time(e){e in this.started&&warn(`Timer is already running for ${e}`),this.started[e]=Date.now()}timeEnd(e){e in this.started||warn(`Timer has not been started for ${e}`),this.times.push({name:e,start:this.started[e],end:Date.now()}),delete this.started[e]}toString(){const t=[];let e=0;for(const{name:t}of this.times)e=Math.max(t.length,e);for(const{name:n,start:s,end:o}of this.times)t.push(`${n.padEnd(e)} ${o-s}ms
`);return t.join("")}}function isValidFetchUrl(e,t){const n=t?URL.parse(e,t):URL.parse(e);return n?.protocol==="http:"||n?.protocol==="https:"}function noContextMenu(e){e.preventDefault()}function stopEvent(e){e.preventDefault(),e.stopPropagation()}function deprecated(e){console.log("Deprecated API usage: "+e)}class PDFDateString{static#regex;static toDateObject(e){if(!e||typeof e!="string")return null;this.#regex||=new RegExp("^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?");const t=this.#regex.exec(e);if(!t)return null;const d=parseInt(t[1],10);let a=parseInt(t[2],10);a=a>=1&&a<=12?a-1:0;let r=parseInt(t[3],10);r=r>=1&&r<=31?r:1;let n=parseInt(t[4],10);n=n>=0&&n<=23?n:0;let s=parseInt(t[5],10);s=s>=0&&s<=59?s:0;let c=parseInt(t[6],10);c=c>=0&&c<=59?c:0;const l=t[7]||"Z";let o=parseInt(t[8],10);o=o>=0&&o<=23?o:0;let i=parseInt(t[9],10)||0;return i=i>=0&&i<=59?i:0,l==="-"?(n+=o,s+=i):l==="+"&&(n-=o,s-=i),new Date(Date.UTC(d,a,r,n,s,c))}}function getXfaPageViewport(e,{scale:t=1,rotation:n=0}){const{width:s,height:o}=e.attributes.style,i=[0,0,parseInt(s),parseInt(o)];return new PageViewport({viewBox:i,userUnit:1,scale:t,rotation:n})}function getRGB(e){if(e.startsWith("#")){const t=parseInt(e.slice(1),16);return[(t&16711680)>>16,(t&65280)>>8,t&255]}return e.startsWith("rgb(")?e.slice(4,-1).split(",").map(e=>parseInt(e)):e.startsWith("rgba(")?e.slice(5,-1).split(",").map(e=>parseInt(e)).slice(0,3):(warn(`Not a valid color format: "${e}"`),[0,0,0])}function getColorValues(e){const t=document.createElement("span");t.style.visibility="hidden",t.style.colorScheme="only light",document.body.append(t);for(const n of e.keys()){t.style.color=n;const s=window.getComputedStyle(t).color;e.set(n,getRGB(s))}t.remove()}function getCurrentTransform(e){const{a:t,b:n,c:s,d:o,e:i,f:a}=e.getTransform();return[t,n,s,o,i,a]}function getCurrentTransformInverse(e){const{a:t,b:n,c:s,d:o,e:i,f:a}=e.getTransform().invertSelf();return[t,n,s,o,i,a]}function setLayerDimensions(e,t,n=!1,s=!0){if(t instanceof PageViewport){const{pageWidth:l,pageHeight:d}=t.rawDims,{style:s}=e,o=util_FeatureTest.isCSSRoundSupported,i=`var(--total-scale-factor) * ${l}px`,a=`var(--total-scale-factor) * ${d}px`,r=o?`round(down, ${i}, var(--scale-round-x))`:`calc(${i})`,c=o?`round(down, ${a}, var(--scale-round-y))`:`calc(${a})`;!n||t.rotation%180===0?(s.width=r,s.height=c):(s.width=c,s.height=r)}s&&e.setAttribute("data-main-rotation",t.rotation)}class OutputScale{constructor(){const{pixelRatio:e}=OutputScale;this.sx=e,this.sy=e}get scaled(){return this.sx!==1||this.sy!==1}get symmetric(){return this.sx===this.sy}limitCanvas(e,t,n,s,o=-1){let a=1/0,r=1/0,c=1/0;n=OutputScale.capPixels(n,o),n>0&&(a=Math.sqrt(n/(e*t))),s!==-1&&(r=s/e,c=s/t);const i=Math.min(a,r,c);return(this.sx>i||this.sy>i)&&(this.sx=i,this.sy=i,!0)}static get pixelRatio(){return globalThis.devicePixelRatio||1}static capPixels(e,t){if(t>=0){const n=Math.ceil(window.screen.availWidth*window.screen.availHeight*this.pixelRatio**2*(1+t/100));return e>0?Math.min(e,n):n}return e}}const SupportedImageMimeTypes=["image/apng","image/avif","image/bmp","image/gif","image/jpeg","image/png","image/svg+xml","image/webp","image/x-icon"];class EditorToolbar{#toolbar=null;#colorPicker=null;#editor;#buttons=null;#altText=null;#signatureDescriptionButton=null;static#l10nRemove=null;constructor(e){this.#editor=e,EditorToolbar.#l10nRemove||=Object.freeze({freetext:"pdfjs-editor-remove-freetext-button",highlight:"pdfjs-editor-remove-highlight-button",ink:"pdfjs-editor-remove-ink-button",stamp:"pdfjs-editor-remove-stamp-button",signature:"pdfjs-editor-remove-signature-button"})}render(){const e=this.#toolbar=document.createElement("div");e.classList.add("editToolbar","hidden"),e.setAttribute("role","toolbar");const n=this.#editor._uiManager._signal;e.addEventListener("contextmenu",noContextMenu,{signal:n}),e.addEventListener("pointerdown",EditorToolbar.#pointerDown,{signal:n});const s=this.#buttons=document.createElement("div");s.className="buttons",e.append(s);const t=this.#editor.toolbarPosition;if(t){const{style:n}=e,s=this.#editor._uiManager.direction==="ltr"?1-t[0]:t[0];n.insetInlineEnd=`${100*s}%`,n.top=`calc(${100*t[1]}% + var(--editor-toolbar-vert-offset))`}return this.#addDeleteButton(),e}get div(){return this.#toolbar}static#pointerDown(e){e.stopPropagation()}#focusIn(e){this.#editor._focusEventsAllowed=!1,stopEvent(e)}#focusOut(e){this.#editor._focusEventsAllowed=!0,stopEvent(e)}#addListenersToElement(e){const t=this.#editor._uiManager._signal;e.addEventListener("focusin",this.#focusIn.bind(this),{capture:!0,signal:t}),e.addEventListener("focusout",this.#focusOut.bind(this),{capture:!0,signal:t}),e.addEventListener("contextmenu",noContextMenu,{signal:t})}hide(){this.#toolbar.classList.add("hidden"),this.#colorPicker?.hideDropdown()}show(){this.#toolbar.classList.remove("hidden"),this.#altText?.shown()}#addDeleteButton(){const{editorType:n,_uiManager:t}=this.#editor,e=document.createElement("button");e.className="delete",e.tabIndex=0,e.setAttribute("data-l10n-id",EditorToolbar.#l10nRemove[n]),this.#addListenersToElement(e),e.addEventListener("click",e=>{t.delete()},{signal:t._signal}),this.#buttons.append(e)}get#divider(){const e=document.createElement("div");return e.className="divider",e}async addAltText(e){const t=await e.render();this.#addListenersToElement(t),this.#buttons.prepend(t,this.#divider),this.#altText=e}addColorPicker(e){this.#colorPicker=e;const t=e.renderButton();this.#addListenersToElement(t),this.#buttons.prepend(t,this.#divider)}async addEditSignatureButton(e){const t=this.#signatureDescriptionButton=await e.renderEditButton(this.#editor);this.#addListenersToElement(t),this.#buttons.prepend(t,this.#divider)}updateEditSignatureButton(e){this.#signatureDescriptionButton&&(this.#signatureDescriptionButton.title=e)}remove(){this.#toolbar.remove(),this.#colorPicker?.destroy(),this.#colorPicker=null}}class HighlightToolbar{#buttons=null;#toolbar=null;#uiManager;constructor(e){this.#uiManager=e}#render(){const e=this.#toolbar=document.createElement("div");e.className="editToolbar",e.setAttribute("role","toolbar"),e.addEventListener("contextmenu",noContextMenu,{signal:this.#uiManager._signal});const t=this.#buttons=document.createElement("div");return t.className="buttons",e.append(t),this.#addHighlightButton(),e}#getLastPoint(e,t){let s=0,n=0;for(const i of e){const a=i.y+i.height;if(a<s)continue;const o=i.x+(t?i.width:0);if(a>s){n=o,s=a;continue}t?o>n&&(n=o):o<n&&(n=o)}return[t?1-n:n,s]}show(e,t,n){const[o,i]=this.#getLastPoint(t,n),{style:s}=this.#toolbar||=this.#render();e.append(this.#toolbar),s.insetInlineEnd=`${100*o}%`,s.top=`calc(${100*i}% + var(--editor-toolbar-vert-offset))`}hide(){this.#toolbar.remove()}#addHighlightButton(){const e=document.createElement("button");e.className="highlightButton",e.tabIndex=0,e.setAttribute("data-l10n-id",`pdfjs-highlight-floating-button1`);const t=document.createElement("span");e.append(t),t.className="visuallyHidden",t.setAttribute("data-l10n-id","pdfjs-highlight-floating-button-label");const n=this.#uiManager._signal;e.addEventListener("contextmenu",noContextMenu,{signal:n}),e.addEventListener("click",()=>{this.#uiManager.highlightSelection("floating_button")},{signal:n}),this.#buttons.append(e)}}function bindEvents(e,t,n){for(const s of n)t.addEventListener(s,e[s].bind(e))}class IdManager{#id=0;get id(){return`${AnnotationEditorPrefix}${this.#id++}`}}class ImageManager{#baseId=getUuid();#id=0;#cache=null;static get _isSVGFittingCanvas(){const n=`data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>`,s=new OffscreenCanvas(1,3),t=s.getContext("2d",{willReadFrequently:!0}),e=new Image;e.src=n;const o=e.decode().then(()=>(t.drawImage(e,0,0,1,1,0,0,1,3),new Uint32Array(t.getImageData(0,0,1,1).data.buffer)[0]===0));return shadow(this,"_isSVGFittingCanvas",o)}async#get(e,t){this.#cache||=new Map;let n=this.#cache.get(e);if(n===null)return null;if(n?.bitmap)return n.refCounter+=1,n;try{n||={bitmap:null,id:`image_${this.#baseId}_${this.#id++}`,refCounter:0,isSvg:!1};let e;if(typeof t=="string"?(n.url=t,e=await fetchData(t,"blob")):t instanceof File?e=n.file=t:t instanceof Blob&&(e=t),e.type==="image/svg+xml"){const o=ImageManager._isSVGFittingCanvas,t=new FileReader,s=new Image,i=new Promise((e,i)=>{s.onload=()=>{n.bitmap=s,n.isSvg=!0,e()},t.onload=async()=>{const e=n.svgUrl=t.result;s.src=await o?`${e}#svgView(preserveAspectRatio(none))`:e},s.onerror=t.onerror=i});t.readAsDataURL(e),await i}else n.bitmap=await createImageBitmap(e);n.refCounter=1}catch(e){warn(e),n=null}return this.#cache.set(e,n),n&&this.#cache.set(n.id,n),n}async getFromFile(e){const{lastModified:t,name:n,size:s,type:o}=e;return this.#get(`${t}_${n}_${s}_${o}`,e)}async getFromUrl(e){return this.#get(e,e)}async getFromBlob(e,t){const n=await t;return this.#get(e,n)}async getFromId(e){this.#cache||=new Map;const t=this.#cache.get(e);if(!t)return null;if(t.bitmap)return t.refCounter+=1,t;if(t.file)return this.getFromFile(t.file);if(t.blobPromise){const{blobPromise:e}=t;return delete t.blobPromise,this.getFromBlob(t.id,e)}return this.getFromUrl(t.url)}getFromCanvas(e,t){this.#cache||=new Map;let n=this.#cache.get(e);if(n?.bitmap)return n.refCounter+=1,n;const s=new OffscreenCanvas(t.width,t.height),o=s.getContext("2d");return o.drawImage(t,0,0),n={bitmap:s.transferToImageBitmap(),id:`image_${this.#baseId}_${this.#id++}`,refCounter:1,isSvg:!1},this.#cache.set(e,n),this.#cache.set(n.id,n),n}getSvgUrl(e){const t=this.#cache.get(e);return t?.isSvg?t.svgUrl:null}deleteId(e){this.#cache||=new Map;const t=this.#cache.get(e);if(!t)return;if(t.refCounter-=1,t.refCounter!==0)return;const{bitmap:n}=t;if(!t.url&&!t.file){const e=new OffscreenCanvas(n.width,n.height),s=e.getContext("bitmaprenderer");s.transferFromImageBitmap(n),t.blobPromise=e.convertToBlob()}n.close?.(),t.bitmap=null}isValidId(e){return e.startsWith(`image_${this.#baseId}_`)}}class CommandManager{#commands=[];#locked=!1;#maxSize;#position=-1;constructor(e=128){this.#maxSize=e}add({cmd:e,undo:t,post:n,mustExec:s,type:o=NaN,overwriteIfSameType:i=!1,keepUndo:a=!1}){if(s&&e(),this.#locked)return;const r={cmd:e,undo:t,post:n,type:o};if(this.#position===-1){this.#commands.length>0&&(this.#commands.length=0),this.#position=0,this.#commands.push(r);return}if(i&&this.#commands[this.#position].type===o){a&&(r.undo=this.#commands[this.#position].undo),this.#commands[this.#position]=r;return}const c=this.#position+1;c===this.#maxSize?this.#commands.splice(0,1):(this.#position=c,c<this.#commands.length&&this.#commands.splice(c)),this.#commands.push(r)}undo(){if(this.#position===-1)return;this.#locked=!0;const{undo:e,post:t}=this.#commands[this.#position];e(),t?.(),this.#locked=!1,this.#position-=1}redo(){if(this.#position<this.#commands.length-1){this.#position+=1,this.#locked=!0;const{cmd:e,post:t}=this.#commands[this.#position];e(),t?.(),this.#locked=!1}}hasSomethingToUndo(){return this.#position!==-1}hasSomethingToRedo(){return this.#position<this.#commands.length-1}cleanType(e){if(this.#position===-1)return;for(let t=this.#position;t>=0;t--)if(this.#commands[t].type!==e){this.#commands.splice(t+1,this.#position-t),this.#position=t;return}this.#commands.length=0,this.#position=-1}destroy(){this.#commands=null}}class KeyboardManager{constructor(e){this.buffer=[],this.callbacks=new Map,this.allKeys=new Set;const{isMac:t}=util_FeatureTest.platform;for(const[o,n,s={}]of e)for(const e of o){const i=e.startsWith("mac+");t&&i?(this.callbacks.set(e.slice(4),{callback:n,options:s}),this.allKeys.add(e.split("+").at(-1))):!t&&!i&&(this.callbacks.set(e,{callback:n,options:s}),this.allKeys.add(e.split("+").at(-1)))}}#serialize(e){e.altKey&&this.buffer.push("alt"),e.ctrlKey&&this.buffer.push("ctrl"),e.metaKey&&this.buffer.push("meta"),e.shiftKey&&this.buffer.push("shift"),this.buffer.push(e.key);const t=this.buffer.join("+");return this.buffer.length=0,t}exec(e,t){if(!this.allKeys.has(t.key))return;const n=this.callbacks.get(this.#serialize(t));if(!n)return;const{callback:o,options:{bubbles:i=!1,args:a=[],checker:s=null}}=n;if(s&&!s(e,t))return;o.bind(e,...a,t)(),i||stopEvent(t)}}class ColorManager{static _colorsMapping=new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]);get _colors(){const e=new Map([["CanvasText",null],["Canvas",null]]);return getColorValues(e),shadow(this,"_colors",e)}convert(e){const t=getRGB(e);if(!window.matchMedia("(forced-colors: active)").matches)return t;for(const[e,n]of this._colors)if(n.every((e,n)=>e===t[n]))return ColorManager._colorsMapping.get(e);return t}getHexCode(e){const t=this._colors.get(e);return t?Util.makeHexColor(...t):e}}class AnnotationEditorUIManager{#abortController=new AbortController;#activeEditor=null;#allEditors=new Map;#allLayers=new Map;#altTextManager=null;#annotationStorage=null;#changedExistingAnnotations=null;#commandManager=new CommandManager;#copyPasteAC=null;#currentDrawingSession=null;#currentPageIndex=0;#deletedAnnotationsElementIds=new Set;#draggingEditors=null;#editorTypes=null;#editorsToRescale=new Set;_editorUndoBar=null;#enableHighlightFloatingButton=!1;#enableUpdatedAddImage=!1;#enableNewAltTextWhenAddingImage=!1;#filterFactory=null;#focusMainContainerTimeoutId=null;#focusManagerAC=null;#highlightColors=null;#highlightWhenShiftUp=!1;#highlightToolbar=null;#idManager=new IdManager;#isEnabled=!1;#isWaiting=!1;#keyboardManagerAC=null;#lastActiveElement=null;#mainHighlightColorPicker=null;#missingCanvases=null;#mlManager=null;#mode=AnnotationEditorType.NONE;#selectedEditors=new Set;#selectedTextNode=null;#signatureManager=null;#pageColors=null;#showAllStates=null;#previousStates={isEditing:!1,isEmpty:!0,hasSomethingToUndo:!1,hasSomethingToRedo:!1,hasSelectedEditor:!1,hasSelectedText:!1};#translation=[0,0];#translationTimeoutId=null;#container=null;#viewer=null;#updateModeCapability=null;static TRANSLATE_SMALL=1;static TRANSLATE_BIG=10;static get _keyboardManager(){const e=AnnotationEditorUIManager.prototype,t=e=>e.#container.contains(document.activeElement)&&document.activeElement.tagName!=="BUTTON"&&e.hasSomethingToControl(),n=(e,{target:t})=>{if(t instanceof HTMLInputElement){const{type:e}=t;return e!=="text"&&e!=="number"}return!0},s=this.TRANSLATE_SMALL,o=this.TRANSLATE_BIG;return shadow(this,"_keyboardManager",new KeyboardManager([[["ctrl+a","mac+meta+a"],e.selectAll,{checker:n}],[["ctrl+z","mac+meta+z"],e.undo,{checker:n}],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],e.redo,{checker:n}],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],e.delete,{checker:n}],[["Enter","mac+Enter"],e.addNewEditorFromKeyboard,{checker:(e,{target:t})=>!(t instanceof HTMLButtonElement)&&e.#container.contains(t)&&!e.isEnterHandled}],[[" ","mac+ "],e.addNewEditorFromKeyboard,{checker:(e,{target:t})=>!(t instanceof HTMLButtonElement)&&e.#container.contains(document.activeElement)}],[["Escape","mac+Escape"],e.unselectAll],[["ArrowLeft","mac+ArrowLeft"],e.translateSelectedEditors,{args:[-s,0],checker:t}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],e.translateSelectedEditors,{args:[-o,0],checker:t}],[["ArrowRight","mac+ArrowRight"],e.translateSelectedEditors,{args:[s,0],checker:t}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],e.translateSelectedEditors,{args:[o,0],checker:t}],[["ArrowUp","mac+ArrowUp"],e.translateSelectedEditors,{args:[0,-s],checker:t}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],e.translateSelectedEditors,{args:[0,-o],checker:t}],[["ArrowDown","mac+ArrowDown"],e.translateSelectedEditors,{args:[0,s],checker:t}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],e.translateSelectedEditors,{args:[0,o],checker:t}]]))}constructor(e,t,n,s,o,i,a,r,c,l,d,u,h,m){const f=this._signal=this.#abortController.signal;this.#container=e,this.#viewer=t,this.#altTextManager=n,this.#signatureManager=s,this._eventBus=o,o._on("editingaction",this.onEditingAction.bind(this),{signal:f}),o._on("pagechanging",this.onPageChanging.bind(this),{signal:f}),o._on("scalechanging",this.onScaleChanging.bind(this),{signal:f}),o._on("rotationchanging",this.onRotationChanging.bind(this),{signal:f}),o._on("setpreference",this.onSetPreference.bind(this),{signal:f}),o._on("switchannotationeditorparams",e=>this.updateParams(e.type,e.value),{signal:f}),this.#addSelectionListener(),this.#addDragAndDropListeners(),this.#addKeyboardManager(),this.#annotationStorage=i.annotationStorage,this.#filterFactory=i.filterFactory,this.#pageColors=a,this.#highlightColors=r||null,this.#enableHighlightFloatingButton=c,this.#enableUpdatedAddImage=l,this.#enableNewAltTextWhenAddingImage=d,this.#mlManager=u||null,this.viewParameters={realScale:PixelsPerInch.PDF_TO_CSS_UNITS,rotation:0},this.isShiftKeyDown=!1,this._editorUndoBar=h||null,this._supportsPinchToZoom=m!==!1}destroy(){this.#updateModeCapability?.resolve(),this.#updateModeCapability=null,this.#abortController?.abort(),this.#abortController=null,this._signal=null;for(const e of this.#allLayers.values())e.destroy();this.#allLayers.clear(),this.#allEditors.clear(),this.#editorsToRescale.clear(),this.#missingCanvases?.clear(),this.#activeEditor=null,this.#selectedEditors.clear(),this.#commandManager.destroy(),this.#altTextManager?.destroy(),this.#signatureManager?.destroy(),this.#highlightToolbar?.hide(),this.#highlightToolbar=null,this.#mainHighlightColorPicker?.destroy(),this.#mainHighlightColorPicker=null,this.#focusMainContainerTimeoutId&&(clearTimeout(this.#focusMainContainerTimeoutId),this.#focusMainContainerTimeoutId=null),this.#translationTimeoutId&&(clearTimeout(this.#translationTimeoutId),this.#translationTimeoutId=null),this._editorUndoBar?.destroy()}combinedSignal(e){return AbortSignal.any([this._signal,e.signal])}get mlManager(){return this.#mlManager}get useNewAltTextFlow(){return this.#enableUpdatedAddImage}get useNewAltTextWhenAddingImage(){return this.#enableNewAltTextWhenAddingImage}get hcmFilter(){return shadow(this,"hcmFilter",this.#pageColors?this.#filterFactory.addHCMFilter(this.#pageColors.foreground,this.#pageColors.background):"none")}get direction(){return shadow(this,"direction",getComputedStyle(this.#container).direction)}get highlightColors(){return shadow(this,"highlightColors",this.#highlightColors?new Map(this.#highlightColors.split(",").map(e=>e.split("=").map(e=>e.trim()))):null)}get highlightColorNames(){return shadow(this,"highlightColorNames",this.highlightColors?new Map(Array.from(this.highlightColors,e=>e.reverse())):null)}setCurrentDrawingSession(e){e?(this.unselectAll(),this.disableUserSelect(!0)):this.disableUserSelect(!1),this.#currentDrawingSession=e}setMainHighlightColorPicker(e){this.#mainHighlightColorPicker=e}editAltText(e,t=!1){this.#altTextManager?.editAltText(this,e,t)}getSignature(e){this.#signatureManager?.getSignature({uiManager:this,editor:e})}get signatureManager(){return this.#signatureManager}switchToMode(e,t){this._eventBus.on("annotationeditormodechanged",t,{once:!0,signal:this._signal}),this._eventBus.dispatch("showannotationeditorui",{source:this,mode:e})}setPreference(e,t){this._eventBus.dispatch("setpreference",{source:this,name:e,value:t})}onSetPreference({name:e,value:t}){switch(e){case"enableNewAltTextWhenAddingImage":this.#enableNewAltTextWhenAddingImage=t;break}}onPageChanging({pageNumber:e}){this.#currentPageIndex=e-1}focusMainContainer(){this.#container.focus()}findParent(e,t){for(const n of this.#allLayers.values()){const{x:s,y:o,width:i,height:a}=n.div.getBoundingClientRect();if(e>=s&&e<=s+i&&t>=o&&t<=o+a)return n}return null}disableUserSelect(e=!1){this.#viewer.classList.toggle("noUserSelect",e)}addShouldRescale(e){this.#editorsToRescale.add(e)}removeShouldRescale(e){this.#editorsToRescale.delete(e)}onScaleChanging({scale:e}){this.commitOrRemove(),this.viewParameters.realScale=e*PixelsPerInch.PDF_TO_CSS_UNITS;for(const e of this.#editorsToRescale)e.onScaleChanging();this.#currentDrawingSession?.onScaleChanging()}onRotationChanging({pagesRotation:e}){this.commitOrRemove(),this.viewParameters.rotation=e}#getAnchorElementForSelection({anchorNode:e}){return e.nodeType===Node.TEXT_NODE?e.parentElement:e}#getLayerForTextLayer(e){const{currentLayer:t}=this;if(t.hasTextLayer(e))return t;for(const t of this.#allLayers.values())if(t.hasTextLayer(e))return t;return null}highlightSelection(e=""){const t=document.getSelection();if(!t||t.isCollapsed)return;const{anchorNode:a,anchorOffset:r,focusNode:c,focusOffset:l}=t,d=t.toString(),u=this.#getAnchorElementForSelection(t),n=u.closest(".textLayer"),s=this.getSelectionBoxes(n);if(!s)return;t.empty();const h=this.#getLayerForTextLayer(n),o=this.#mode===AnnotationEditorType.NONE,i=()=>{h?.createAndAddNewEditor({x:0,y:0},!1,{methodOfCreation:e,boxes:s,anchorNode:a,anchorOffset:r,focusNode:c,focusOffset:l,text:d}),o&&this.showAllEditors("highlight",!0,!0)};if(o){this.switchToMode(AnnotationEditorType.HIGHLIGHT,i);return}i()}#displayHighlightToolbar(){const e=document.getSelection();if(!e||e.isCollapsed)return;const s=this.#getAnchorElementForSelection(e),t=s.closest(".textLayer"),n=this.getSelectionBoxes(t);if(!n)return;this.#highlightToolbar||=new HighlightToolbar(this),this.#highlightToolbar.show(t,n,this.direction==="ltr")}addToAnnotationStorage(e){!e.isEmpty()&&this.#annotationStorage&&!this.#annotationStorage.has(e.id)&&this.#annotationStorage.setValue(e.id,e)}#selectionChange(){const e=document.getSelection();if(!e||e.isCollapsed){this.#selectedTextNode&&(this.#highlightToolbar?.hide(),this.#selectedTextNode=null,this.#dispatchUpdateStates({hasSelectedText:!1}));return}const{anchorNode:t}=e;if(t===this.#selectedTextNode)return;const s=this.#getAnchorElementForSelection(e),n=s.closest(".textLayer");if(!n){this.#selectedTextNode&&(this.#highlightToolbar?.hide(),this.#selectedTextNode=null,this.#dispatchUpdateStates({hasSelectedText:!1}));return}if(this.#highlightToolbar?.hide(),this.#selectedTextNode=t,this.#dispatchUpdateStates({hasSelectedText:!0}),this.#mode!==AnnotationEditorType.HIGHLIGHT&&this.#mode!==AnnotationEditorType.NONE)return;if(this.#mode===AnnotationEditorType.HIGHLIGHT&&this.showAllEditors("highlight",!0,!0),this.#highlightWhenShiftUp=this.isShiftKeyDown,!this.isShiftKeyDown){const e=this.#mode===AnnotationEditorType.HIGHLIGHT?this.#getLayerForTextLayer(n):null;e?.toggleDrawing();const t=new AbortController,s=this.combinedSignal(t),o=n=>{if(n.type==="pointerup"&&n.button!==0)return;t.abort(),e?.toggleDrawing(!0),n.type==="pointerup"&&this.#onSelectEnd("main_toolbar")};window.addEventListener("pointerup",o,{signal:s}),window.addEventListener("blur",o,{signal:s})}}#onSelectEnd(e=""){this.#mode===AnnotationEditorType.HIGHLIGHT?this.highlightSelection(e):this.#enableHighlightFloatingButton&&this.#displayHighlightToolbar()}#addSelectionListener(){document.addEventListener("selectionchange",this.#selectionChange.bind(this),{signal:this._signal})}#addFocusManager(){if(this.#focusManagerAC)return;this.#focusManagerAC=new AbortController;const e=this.combinedSignal(this.#focusManagerAC);window.addEventListener("focus",this.focus.bind(this),{signal:e}),window.addEventListener("blur",this.blur.bind(this),{signal:e})}#removeFocusManager(){this.#focusManagerAC?.abort(),this.#focusManagerAC=null}blur(){if(this.isShiftKeyDown=!1,this.#highlightWhenShiftUp&&(this.#highlightWhenShiftUp=!1,this.#onSelectEnd("main_toolbar")),!this.hasSelection)return;const{activeElement:e}=document;for(const t of this.#selectedEditors)if(t.div.contains(e)){this.#lastActiveElement=[t,e],t._focusEventsAllowed=!1;break}}focus(){if(!this.#lastActiveElement)return;const[t,e]=this.#lastActiveElement;this.#lastActiveElement=null,e.addEventListener("focusin",()=>{t._focusEventsAllowed=!0},{once:!0,signal:this._signal}),e.focus()}#addKeyboardManager(){if(this.#keyboardManagerAC)return;this.#keyboardManagerAC=new AbortController;const e=this.combinedSignal(this.#keyboardManagerAC);window.addEventListener("keydown",this.keydown.bind(this),{signal:e}),window.addEventListener("keyup",this.keyup.bind(this),{signal:e})}#removeKeyboardManager(){this.#keyboardManagerAC?.abort(),this.#keyboardManagerAC=null}#addCopyPasteListeners(){if(this.#copyPasteAC)return;this.#copyPasteAC=new AbortController;const e=this.combinedSignal(this.#copyPasteAC);document.addEventListener("copy",this.copy.bind(this),{signal:e}),document.addEventListener("cut",this.cut.bind(this),{signal:e}),document.addEventListener("paste",this.paste.bind(this),{signal:e})}#removeCopyPasteListeners(){this.#copyPasteAC?.abort(),this.#copyPasteAC=null}#addDragAndDropListeners(){const e=this._signal;document.addEventListener("dragover",this.dragOver.bind(this),{signal:e}),document.addEventListener("drop",this.drop.bind(this),{signal:e})}addEditListeners(){this.#addKeyboardManager(),this.#addCopyPasteListeners()}removeEditListeners(){this.#removeKeyboardManager(),this.#removeCopyPasteListeners()}dragOver(e){for(const{type:t}of e.dataTransfer.items)for(const n of this.#editorTypes)if(n.isHandlingMimeForPasting(t)){e.dataTransfer.dropEffect="copy",e.preventDefault();return}}drop(e){for(const t of e.dataTransfer.items)for(const n of this.#editorTypes)if(n.isHandlingMimeForPasting(t.type)){n.paste(t,this.currentLayer),e.preventDefault();return}}copy(e){if(e.preventDefault(),this.#activeEditor?.commitOrRemove(),!this.hasSelection)return;const t=[];for(const n of this.#selectedEditors){const e=n.serialize(!0);e&&t.push(e)}if(t.length===0)return;e.clipboardData.setData("application/pdfjs",JSON.stringify(t))}cut(e){this.copy(e),this.delete()}async paste(e){e.preventDefault();const{clipboardData:n}=e;for(const e of n.items)for(const t of this.#editorTypes)if(t.isHandlingMimeForPasting(e.type)){t.paste(e,this.currentLayer);return}let t=n.getData("application/pdfjs");if(!t)return;try{t=JSON.parse(t)}catch(e){warn(`paste: "${e.message}".`);return}if(!Array.isArray(t))return;this.unselectAll();const s=this.currentLayer;try{const e=[];for(const o of t){const n=await s.deserialize(o);if(!n)return;e.push(n)}const n=()=>{for(const t of e)this.#addEditorToLayer(t);this.#selectEditors(e)},o=()=>{for(const t of e)t.remove()};this.addCommands({cmd:n,undo:o,mustExec:!0})}catch(e){warn(`paste: "${e.message}".`)}}keydown(e){!this.isShiftKeyDown&&e.key==="Shift"&&(this.isShiftKeyDown=!0),this.#mode!==AnnotationEditorType.NONE&&!this.isEditorHandlingKeyboard&&AnnotationEditorUIManager._keyboardManager.exec(this,e)}keyup(e){this.isShiftKeyDown&&e.key==="Shift"&&(this.isShiftKeyDown=!1,this.#highlightWhenShiftUp&&(this.#highlightWhenShiftUp=!1,this.#onSelectEnd("main_toolbar")))}onEditingAction({name:e}){switch(e){case"undo":case"redo":case"delete":case"selectAll":this[e]();break;case"highlightSelection":this.highlightSelection("context_menu");break}}#dispatchUpdateStates(e){const t=Object.entries(e).some(([e,t])=>this.#previousStates[e]!==t);t&&(this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(this.#previousStates,e)}),this.#mode===AnnotationEditorType.HIGHLIGHT&&e.hasSelectedEditor===!1&&this.#dispatchUpdateUI([[AnnotationEditorParamsType.HIGHLIGHT_FREE,!0]]))}#dispatchUpdateUI(e){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details:e})}setEditingState(e){e?(this.#addFocusManager(),this.#addCopyPasteListeners(),this.#dispatchUpdateStates({isEditing:this.#mode!==AnnotationEditorType.NONE,isEmpty:this.#isEmpty(),hasSomethingToUndo:this.#commandManager.hasSomethingToUndo(),hasSomethingToRedo:this.#commandManager.hasSomethingToRedo(),hasSelectedEditor:!1})):(this.#removeFocusManager(),this.#removeCopyPasteListeners(),this.#dispatchUpdateStates({isEditing:!1}),this.disableUserSelect(!1))}registerEditorTypes(e){if(this.#editorTypes)return;this.#editorTypes=e;for(const e of this.#editorTypes)this.#dispatchUpdateUI(e.defaultPropertiesToUpdate)}getId(){return this.#idManager.id}get currentLayer(){return this.#allLayers.get(this.#currentPageIndex)}getLayer(e){return this.#allLayers.get(e)}get currentPageIndex(){return this.#currentPageIndex}addLayer(e){this.#allLayers.set(e.pageIndex,e),this.#isEnabled?e.enable():e.disable()}removeLayer(e){this.#allLayers.delete(e.pageIndex)}async updateMode(e,t=null,n=!1){if(this.#mode===e)return;if(this.#updateModeCapability&&(await this.#updateModeCapability.promise,!this.#updateModeCapability))return;if(this.#updateModeCapability=Promise.withResolvers(),this.#currentDrawingSession?.commitOrRemove(),this.#mode=e,e===AnnotationEditorType.NONE){this.setEditingState(!1),this.#disableAll(),this._editorUndoBar?.hide(),this.#updateModeCapability.resolve();return}e===AnnotationEditorType.SIGNATURE&&await this.#signatureManager?.loadSignatures(),this.setEditingState(!0),await this.#enableAll(),this.unselectAll();for(const t of this.#allLayers.values())t.updateMode(e);if(!t){n&&this.addNewEditorFromKeyboard(),this.#updateModeCapability.resolve();return}for(const e of this.#allEditors.values())e.annotationElementId===t||e.id===t?(this.setSelected(e),e.enterInEditMode()):e.unselect();this.#updateModeCapability.resolve()}addNewEditorFromKeyboard(){this.currentLayer.canCreateNewEmptyEditor()&&this.currentLayer.addNewEditor()}updateToolbar(e){if(e.mode===this.#mode)return;this._eventBus.dispatch("switchannotationeditormode",{source:this,...e})}updateParams(e,t){if(!this.#editorTypes)return;switch(e){case AnnotationEditorParamsType.CREATE:this.currentLayer.addNewEditor(t);return;case AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR:this.#mainHighlightColorPicker?.updateColor(t);break;case AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{type:"highlight",action:"toggle_visibility"}}}),(this.#showAllStates||=new Map).set(e,t),this.showAllEditors("highlight",t);break}for(const n of this.#selectedEditors)n.updateParams(e,t);for(const n of this.#editorTypes)n.updateDefaultParams(e,t)}showAllEditors(e,t){for(const n of this.#allEditors.values())n.editorType===e&&n.show(t);const s=this.#showAllStates?.get(AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL)??!0;s!==t&&this.#dispatchUpdateUI([[AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL,t]])}enableWaiting(e=!1){if(this.#isWaiting===e)return;this.#isWaiting=e;for(const t of this.#allLayers.values())e?t.disableClick():t.enableClick(),t.div.classList.toggle("waiting",e)}async#enableAll(){if(!this.#isEnabled){this.#isEnabled=!0;const e=[];for(const t of this.#allLayers.values())e.push(t.enable());await Promise.all(e);for(const e of this.#allEditors.values())e.enable()}}#disableAll(){if(this.unselectAll(),this.#isEnabled){this.#isEnabled=!1;for(const e of this.#allLayers.values())e.disable();for(const e of this.#allEditors.values())e.disable()}}getEditors(e){const t=[];for(const n of this.#allEditors.values())n.pageIndex===e&&t.push(n);return t}getEditor(e){return this.#allEditors.get(e)}addEditor(e){this.#allEditors.set(e.id,e)}removeEditor(e){e.div.contains(document.activeElement)&&(this.#focusMainContainerTimeoutId&&clearTimeout(this.#focusMainContainerTimeoutId),this.#focusMainContainerTimeoutId=setTimeout(()=>{this.focusMainContainer(),this.#focusMainContainerTimeoutId=null},0)),this.#allEditors.delete(e.id),e.annotationElementId&&this.#missingCanvases?.delete(e.annotationElementId),this.unselect(e),(!e.annotationElementId||!this.#deletedAnnotationsElementIds.has(e.annotationElementId))&&this.#annotationStorage?.remove(e.id)}addDeletedAnnotationElement(e){this.#deletedAnnotationsElementIds.add(e.annotationElementId),this.addChangedExistingAnnotation(e),e.deleted=!0}isDeletedAnnotationElement(e){return this.#deletedAnnotationsElementIds.has(e)}removeDeletedAnnotationElement(e){this.#deletedAnnotationsElementIds.delete(e.annotationElementId),this.removeChangedExistingAnnotation(e),e.deleted=!1}#addEditorToLayer(e){const t=this.#allLayers.get(e.pageIndex);t?t.addOrRebuild(e):(this.addEditor(e),this.addToAnnotationStorage(e))}setActiveEditor(e){if(this.#activeEditor===e)return;this.#activeEditor=e,e&&this.#dispatchUpdateUI(e.propertiesToUpdate)}get#lastSelectedEditor(){let e=null;for(e of this.#selectedEditors);return e}updateUI(e){this.#lastSelectedEditor===e&&this.#dispatchUpdateUI(e.propertiesToUpdate)}updateUIForDefaultProperties(e){this.#dispatchUpdateUI(e.defaultPropertiesToUpdate)}toggleSelected(e){if(this.#selectedEditors.has(e)){this.#selectedEditors.delete(e),e.unselect(),this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection});return}this.#selectedEditors.add(e),e.select(),this.#dispatchUpdateUI(e.propertiesToUpdate),this.#dispatchUpdateStates({hasSelectedEditor:!0})}setSelected(e){this.#currentDrawingSession?.commitOrRemove();for(const t of this.#selectedEditors)t!==e&&t.unselect();this.#selectedEditors.clear(),this.#selectedEditors.add(e),e.select(),this.#dispatchUpdateUI(e.propertiesToUpdate),this.#dispatchUpdateStates({hasSelectedEditor:!0})}isSelected(e){return this.#selectedEditors.has(e)}get firstSelectedEditor(){return this.#selectedEditors.values().next().value}unselect(e){e.unselect(),this.#selectedEditors.delete(e),this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection})}get hasSelection(){return this.#selectedEditors.size!==0}get isEnterHandled(){return this.#selectedEditors.size===1&&this.firstSelectedEditor.isEnterHandled}undo(){this.#commandManager.undo(),this.#dispatchUpdateStates({hasSomethingToUndo:this.#commandManager.hasSomethingToUndo(),hasSomethingToRedo:!0,isEmpty:this.#isEmpty()}),this._editorUndoBar?.hide()}redo(){this.#commandManager.redo(),this.#dispatchUpdateStates({hasSomethingToUndo:!0,hasSomethingToRedo:this.#commandManager.hasSomethingToRedo(),isEmpty:this.#isEmpty()})}addCommands(e){this.#commandManager.add(e),this.#dispatchUpdateStates({hasSomethingToUndo:!0,hasSomethingToRedo:!1,isEmpty:this.#isEmpty()})}cleanUndoStack(e){this.#commandManager.cleanType(e)}#isEmpty(){if(this.#allEditors.size===0)return!0;if(this.#allEditors.size===1)for(const e of this.#allEditors.values())return e.isEmpty();return!1}delete(){this.commitOrRemove();const t=this.currentLayer?.endDrawingSession(!0);if(!this.hasSelection&&!t)return;const e=t?[t]:[...this.#selectedEditors],s=()=>{this._editorUndoBar?.show(n,e.length===1?e[0].editorType:e.length);for(const t of e)t.remove()},n=()=>{for(const t of e)this.#addEditorToLayer(t)};this.addCommands({cmd:s,undo:n,mustExec:!0})}commitOrRemove(){this.#activeEditor?.commitOrRemove()}hasSomethingToControl(){return this.#activeEditor||this.hasSelection}#selectEditors(e){for(const e of this.#selectedEditors)e.unselect();this.#selectedEditors.clear();for(const t of e){if(t.isEmpty())continue;this.#selectedEditors.add(t),t.select()}this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection})}selectAll(){for(const e of this.#selectedEditors)e.commit();this.#selectEditors(this.#allEditors.values())}unselectAll(){if(this.#activeEditor&&(this.#activeEditor.commitOrRemove(),this.#mode!==AnnotationEditorType.NONE))return;if(this.#currentDrawingSession?.commitOrRemove())return;if(!this.hasSelection)return;for(const e of this.#selectedEditors)e.unselect();this.#selectedEditors.clear(),this.#dispatchUpdateStates({hasSelectedEditor:!1})}translateSelectedEditors(e,t,n=!1){if(n||this.commitOrRemove(),!this.hasSelection)return;this.#translation[0]+=e,this.#translation[1]+=t;const[o,i]=this.#translation,s=[...this.#selectedEditors],a=1e3;this.#translationTimeoutId&&clearTimeout(this.#translationTimeoutId),this.#translationTimeoutId=setTimeout(()=>{this.#translationTimeoutId=null,this.#translation[0]=this.#translation[1]=0,this.addCommands({cmd:()=>{for(const e of s)this.#allEditors.has(e.id)&&(e.translateInPage(o,i),e.translationDone())},undo:()=>{for(const e of s)this.#allEditors.has(e.id)&&(e.translateInPage(-o,-i),e.translationDone())},mustExec:!1})},a);for(const n of s)n.translateInPage(e,t),n.translationDone()}setUpDragSession(){if(!this.hasSelection)return;this.disableUserSelect(!0),this.#draggingEditors=new Map;for(const e of this.#selectedEditors)this.#draggingEditors.set(e,{savedX:e.x,savedY:e.y,savedPageIndex:e.pageIndex,newX:0,newY:0,newPageIndex:-1})}endDragSession(){if(!this.#draggingEditors)return!1;this.disableUserSelect(!1);const e=this.#draggingEditors;this.#draggingEditors=null;let t=!1;for(const[{x:s,y:o,pageIndex:i},n]of e)n.newX=s,n.newY=o,n.newPageIndex=i,t||=s!==n.savedX||o!==n.savedY||i!==n.savedPageIndex;if(!t)return!1;const n=(e,t,n,s)=>{if(this.#allEditors.has(e.id)){const o=this.#allLayers.get(s);o?e._setParentAndPosition(o,t,n):(e.pageIndex=s,e.x=t,e.y=n)}};return this.addCommands({cmd:()=>{for(const[t,{newX:s,newY:o,newPageIndex:i}]of e)n(t,s,o,i)},undo:()=>{for(const[t,{savedX:s,savedY:o,savedPageIndex:i}]of e)n(t,s,o,i)},mustExec:!0}),!0}dragSelectedEditors(e,t){if(!this.#draggingEditors)return;for(const n of this.#draggingEditors.keys())n.drag(e,t)}rebuild(e){if(e.parent===null){const t=this.getLayer(e.pageIndex);t?(t.changeParent(e),t.addOrRebuild(e)):(this.addEditor(e),this.addToAnnotationStorage(e),e.rebuild())}else e.parent.addOrRebuild(e)}get isEditorHandlingKeyboard(){return this.getActive()?.shouldGetKeyboardEvents()||this.#selectedEditors.size===1&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(e){return this.#activeEditor===e}getActive(){return this.#activeEditor}getMode(){return this.#mode}get imageManager(){return shadow(this,"imageManager",new ImageManager)}getSelectionBoxes(e){if(!e)return null;const o=document.getSelection();for(let t=0,n=o.rangeCount;t<n;t++)if(!e.contains(o.getRangeAt(t).commonAncestorContainer))return null;const{x:i,y:a,width:t,height:n}=e.getBoundingClientRect();let s;switch(e.getAttribute("data-main-rotation")){case"90":s=(e,s,o,r)=>({x:(s-a)/n,y:1-(e+o-i)/t,width:r/n,height:o/t});break;case"180":s=(e,s,o,r)=>({x:1-(e+o-i)/t,y:1-(s+r-a)/n,width:o/t,height:r/n});break;case"270":s=(e,s,o,r)=>({x:1-(s+r-a)/n,y:(e-i)/t,width:r/n,height:o/t});break;default:s=(e,s,o,r)=>({x:(e-i)/t,y:(s-a)/n,width:o/t,height:r/n});break}const r=[];for(let e=0,n=o.rangeCount;e<n;e++){const t=o.getRangeAt(e);if(t.collapsed)continue;for(const{x:o,y:i,width:e,height:n}of t.getClientRects()){if(e===0||n===0)continue;r.push(s(o,i,e,n))}}return r.length===0?null:r}addChangedExistingAnnotation({annotationElementId:e,id:t}){(this.#changedExistingAnnotations||=new Map).set(e,t)}removeChangedExistingAnnotation({annotationElementId:e}){this.#changedExistingAnnotations?.delete(e)}renderAnnotationElement(e){const n=this.#changedExistingAnnotations?.get(e.data.id);if(!n)return;const t=this.#annotationStorage.getRawValue(n);if(!t)return;if(this.#mode===AnnotationEditorType.NONE&&!t.hasBeenModified)return;t.renderAnnotationElement(e)}setMissingCanvas(e,t,n){const s=this.#missingCanvases?.get(e);if(!s)return;s.setCanvas(t,n),this.#missingCanvases.delete(e)}addMissingCanvas(e,t){(this.#missingCanvases||=new Map).set(e,t)}}class AltText{#altText=null;#altTextDecorative=!1;#altTextButton=null;#altTextButtonLabel=null;#altTextTooltip=null;#altTextTooltipTimeout=null;#altTextWasFromKeyBoard=!1;#badge=null;#editor=null;#guessedText=null;#textWithDisclaimer=null;#useNewAltTextFlow=!1;static#l10nNewButton=null;static _l10n=null;constructor(e){this.#editor=e,this.#useNewAltTextFlow=e._uiManager.useNewAltTextFlow,AltText.#l10nNewButton||=Object.freeze({added:"pdfjs-editor-new-alt-text-added-button","added-label":"pdfjs-editor-new-alt-text-added-button-label",missing:"pdfjs-editor-new-alt-text-missing-button","missing-label":"pdfjs-editor-new-alt-text-missing-button-label",review:"pdfjs-editor-new-alt-text-to-review-button","review-label":"pdfjs-editor-new-alt-text-to-review-button-label"})}static initialize(e){AltText._l10n??=e}async render(){const e=this.#altTextButton=document.createElement("button");e.className="altText",e.tabIndex="0";const n=this.#altTextButtonLabel=document.createElement("span");e.append(n),this.#useNewAltTextFlow?(e.classList.add("new"),e.setAttribute("data-l10n-id",AltText.#l10nNewButton.missing),n.setAttribute("data-l10n-id",AltText.#l10nNewButton["missing-label"])):(e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button"),n.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button-label"));const t=this.#editor._uiManager._signal;e.addEventListener("contextmenu",noContextMenu,{signal:t}),e.addEventListener("pointerdown",e=>e.stopPropagation(),{signal:t});const s=e=>{e.preventDefault(),this.#editor._uiManager.editAltText(this.#editor),this.#useNewAltTextFlow&&this.#editor._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_clicked",data:{label:this.#label}})};return e.addEventListener("click",s,{capture:!0,signal:t}),e.addEventListener("keydown",t=>{t.target===e&&t.key==="Enter"&&(this.#altTextWasFromKeyBoard=!0,s(t))},{signal:t}),await this.#setState(),e}get#label(){return this.#altText&&"added"||this.#altText===null&&this.guessedText&&"review"||"missing"}finish(){if(!this.#altTextButton)return;this.#altTextButton.focus({focusVisible:this.#altTextWasFromKeyBoard}),this.#altTextWasFromKeyBoard=!1}isEmpty(){return this.#useNewAltTextFlow?this.#altText===null:!this.#altText&&!this.#altTextDecorative}hasData(){return this.#useNewAltTextFlow?this.#altText!==null||!!this.#guessedText:this.isEmpty()}get guessedText(){return this.#guessedText}async setGuessedText(e){if(this.#altText!==null)return;this.#guessedText=e,this.#textWithDisclaimer=await AltText._l10n.get("pdfjs-editor-new-alt-text-generated-alt-text-with-disclaimer",{generatedAltText:e}),this.#setState()}toggleAltTextBadge(e=!1){if(!this.#useNewAltTextFlow||this.#altText){this.#badge?.remove(),this.#badge=null;return}if(!this.#badge){const e=this.#badge=document.createElement("div");e.className="noAltTextBadge",this.#editor.div.append(e)}this.#badge.classList.toggle("hidden",!e)}serialize(e){let t=this.#altText;return!e&&this.#guessedText===t&&(t=this.#textWithDisclaimer),{altText:t,decorative:this.#altTextDecorative,guessedText:this.#guessedText,textWithDisclaimer:this.#textWithDisclaimer}}get data(){return{altText:this.#altText,decorative:this.#altTextDecorative}}set data({altText:e,decorative:t,guessedText:n,textWithDisclaimer:s,cancel:o=!1}){if(n&&(this.#guessedText=n,this.#textWithDisclaimer=s),this.#altText===e&&this.#altTextDecorative===t)return;o||(this.#altText=e,this.#altTextDecorative=t),this.#setState()}toggle(e=!1){if(!this.#altTextButton)return;!e&&this.#altTextTooltipTimeout&&(clearTimeout(this.#altTextTooltipTimeout),this.#altTextTooltipTimeout=null),this.#altTextButton.disabled=!e}shown(){this.#editor._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_displayed",data:{label:this.#label}})}destroy(){this.#altTextButton?.remove(),this.#altTextButton=null,this.#altTextButtonLabel=null,this.#altTextTooltip=null,this.#badge?.remove(),this.#badge=null}async#setState(){const t=this.#altTextButton;if(!t)return;if(this.#useNewAltTextFlow){if(t.classList.toggle("done",!!this.#altText),t.setAttribute("data-l10n-id",AltText.#l10nNewButton[this.#label]),this.#altTextButtonLabel?.setAttribute("data-l10n-id",AltText.#l10nNewButton[`${this.#label}-label`]),!this.#altText){this.#altTextTooltip?.remove();return}}else{if(!this.#altText&&!this.#altTextDecorative){t.classList.remove("done"),this.#altTextTooltip?.remove();return}t.classList.add("done"),t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-edit-button")}let e=this.#altTextTooltip;if(!e){this.#altTextTooltip=e=document.createElement("span"),e.className="tooltip",e.setAttribute("role","tooltip"),e.id=`alt-text-tooltip-${this.#editor.id}`;const s=100,n=this.#editor._uiManager._signal;n.addEventListener("abort",()=>{clearTimeout(this.#altTextTooltipTimeout),this.#altTextTooltipTimeout=null},{once:!0}),t.addEventListener("mouseenter",()=>{this.#altTextTooltipTimeout=setTimeout(()=>{this.#altTextTooltipTimeout=null,this.#altTextTooltip.classList.add("show"),this.#editor._reportTelemetry({action:"alt_text_tooltip"})},s)},{signal:n}),t.addEventListener("mouseleave",()=>{this.#altTextTooltipTimeout&&(clearTimeout(this.#altTextTooltipTimeout),this.#altTextTooltipTimeout=null),this.#altTextTooltip?.classList.remove("show")},{signal:n})}this.#altTextDecorative?e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-decorative-tooltip"):(e.removeAttribute("data-l10n-id"),e.textContent=this.#altText),e.parentNode||t.append(e);const n=this.#editor.getElementForAltText();n?.setAttribute("aria-describedby",e.id)}}class TouchManager{#container;#isPinching=!1;#isPinchingStopped=null;#isPinchingDisabled;#onPinchStart;#onPinching;#onPinchEnd;#pointerDownAC=null;#signal;#touchInfo=null;#touchManagerAC;#touchMoveAC=null;constructor({container:e,isPinchingDisabled:t=null,isPinchingStopped:n=null,onPinchStart:s=null,onPinching:o=null,onPinchEnd:i=null,signal:a}){this.#container=e,this.#isPinchingStopped=n,this.#isPinchingDisabled=t,this.#onPinchStart=s,this.#onPinching=o,this.#onPinchEnd=i,this.#touchManagerAC=new AbortController,this.#signal=AbortSignal.any([a,this.#touchManagerAC.signal]),e.addEventListener("touchstart",this.#onTouchStart.bind(this),{passive:!1,signal:this.#signal})}get MIN_TOUCH_DISTANCE_TO_PINCH(){return 35/OutputScale.pixelRatio}#onTouchStart(e){if(this.#isPinchingDisabled?.())return;if(e.touches.length===1){if(this.#pointerDownAC)return;const s=this.#pointerDownAC=new AbortController,o=AbortSignal.any([this.#signal,s.signal]),e=this.#container,t={capture:!0,signal:o,passive:!1},n=e=>{e.pointerType==="touch"&&(this.#pointerDownAC?.abort(),this.#pointerDownAC=null)};e.addEventListener("pointerdown",e=>{e.pointerType==="touch"&&(stopEvent(e),n(e))},t),e.addEventListener("pointerup",n,t),e.addEventListener("pointercancel",n,t);return}if(!this.#touchMoveAC){this.#touchMoveAC=new AbortController;const s=AbortSignal.any([this.#signal,this.#touchMoveAC.signal]),t=this.#container,e={signal:s,capture:!1,passive:!1};t.addEventListener("touchmove",this.#onTouchMove.bind(this),e);const n=this.#onTouchEnd.bind(this);t.addEventListener("touchend",n,e),t.addEventListener("touchcancel",n,e),e.capture=!0,t.addEventListener("pointerdown",stopEvent,e),t.addEventListener("pointermove",stopEvent,e),t.addEventListener("pointercancel",stopEvent,e),t.addEventListener("pointerup",stopEvent,e),this.#onPinchStart?.()}if(stopEvent(e),e.touches.length!==2||this.#isPinchingStopped?.()){this.#touchInfo=null;return}let[t,n]=e.touches;t.identifier>n.identifier&&([t,n]=[n,t]),this.#touchInfo={touch0X:t.screenX,touch0Y:t.screenY,touch1X:n.screenX,touch1Y:n.screenY}}#onTouchMove(e){if(!this.#touchInfo||e.touches.length!==2)return;stopEvent(e);let[s,n]=e.touches;s.identifier>n.identifier&&([s,n]=[n,s]);const{screenX:o,screenY:i}=s,{screenX:a,screenY:r}=n,t=this.#touchInfo,{touch0X:v,touch0Y:d,touch1X:g,touch1Y:u}=t,h=g-v,m=u-d,f=a-o,p=r-i,c=Math.hypot(f,p)||1,l=Math.hypot(h,m)||1;if(!this.#isPinching&&Math.abs(l-c)<=TouchManager.MIN_TOUCH_DISTANCE_TO_PINCH)return;if(t.touch0X=o,t.touch0Y=i,t.touch1X=a,t.touch1Y=r,!this.#isPinching){this.#isPinching=!0;return}const b=[(o+a)/2,(i+r)/2];this.#onPinching?.(b,l,c)}#onTouchEnd(e){if(e.touches.length>=2)return;if(this.#touchMoveAC&&(this.#touchMoveAC.abort(),this.#touchMoveAC=null,this.#onPinchEnd?.()),!this.#touchInfo)return;stopEvent(e),this.#touchInfo=null,this.#isPinching=!1}destroy(){this.#touchManagerAC?.abort(),this.#touchManagerAC=null,this.#pointerDownAC?.abort(),this.#pointerDownAC=null}}class AnnotationEditor{#accessibilityData=null;#allResizerDivs=null;#altText=null;#disabled=!1;#dragPointerId=null;#dragPointerType="";#keepAspectRatio=!1;#resizersDiv=null;#lastPointerCoords=null;#savedDimensions=null;#focusAC=null;#focusedResizerName="";#hasBeenClicked=!1;#initialRect=null;#isEditing=!1;#isInEditMode=!1;#isResizerEnabledForKeyboard=!1;#moveInDOMTimeout=null;#prevDragX=0;#prevDragY=0;#telemetryTimeouts=null;#touchManager=null;isSelected=!1;_isCopy=!1;_editToolbar=null;_initialOptions=Object.create(null);_initialData=null;_isVisible=!0;_uiManager=null;_focusEventsAllowed=!0;static _l10n=null;static _l10nResizer=null;#isDraggable=!1;#zIndex=AnnotationEditor._zIndex++;static _borderLineWidth=-1;static _colorManager=new ColorManager;static _zIndex=1;static _telemetryTimeout=1e3;static get _resizerKeyboardManager(){const e=AnnotationEditor.prototype._resizeWithKeyboard,t=AnnotationEditorUIManager.TRANSLATE_SMALL,n=AnnotationEditorUIManager.TRANSLATE_BIG;return shadow(this,"_resizerKeyboardManager",new KeyboardManager([[["ArrowLeft","mac+ArrowLeft"],e,{args:[-t,0]}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],e,{args:[-n,0]}],[["ArrowRight","mac+ArrowRight"],e,{args:[t,0]}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],e,{args:[n,0]}],[["ArrowUp","mac+ArrowUp"],e,{args:[0,-t]}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],e,{args:[0,-n]}],[["ArrowDown","mac+ArrowDown"],e,{args:[0,t]}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],e,{args:[0,n]}],[["Escape","mac+Escape"],AnnotationEditor.prototype._stopResizingWithKeyboard]]))}constructor(e){this.parent=e.parent,this.id=e.id,this.width=this.height=null,this.pageIndex=e.parent.pageIndex,this.name=e.name,this.div=null,this._uiManager=e.uiManager,this.annotationElementId=null,this._willKeepAspectRatio=!1,this._initialOptions.isCentered=e.isCentered,this._structTreeParentId=null;const{rotation:t,rawDims:{pageWidth:n,pageHeight:s,pageX:o,pageY:i}}=this.parent.viewport;this.rotation=t,this.pageRotation=(360+t-this._uiManager.viewParameters.rotation)%360,this.pageDimensions=[n,s],this.pageTranslation=[o,i];const[a,r]=this.parentDimensions;this.x=e.x/a,this.y=e.y/r,this.isAttachedToDOM=!1,this.deleted=!1}get editorType(){return Object.getPrototypeOf(this).constructor._type}static get isDrawer(){return!1}static get _defaultLineColor(){return shadow(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(e){const t=new FakeEditor({id:e.parent.getNextId(),parent:e.parent,uiManager:e._uiManager});t.annotationElementId=e.annotationElementId,t.deleted=!0,t._uiManager.addToAnnotationStorage(t)}static initialize(e){if(AnnotationEditor._l10n??=e,AnnotationEditor._l10nResizer||=Object.freeze({topLeft:"pdfjs-editor-resizer-top-left",topMiddle:"pdfjs-editor-resizer-top-middle",topRight:"pdfjs-editor-resizer-top-right",middleRight:"pdfjs-editor-resizer-middle-right",bottomRight:"pdfjs-editor-resizer-bottom-right",bottomMiddle:"pdfjs-editor-resizer-bottom-middle",bottomLeft:"pdfjs-editor-resizer-bottom-left",middleLeft:"pdfjs-editor-resizer-middle-left"}),AnnotationEditor._borderLineWidth!==-1)return;const n=getComputedStyle(document.documentElement);AnnotationEditor._borderLineWidth=parseFloat(n.getPropertyValue("--outline-width"))||0}static updateDefaultParams(){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(){return!1}static paste(){unreachable("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return this.#isDraggable}set _isDraggable(e){this.#isDraggable=e,this.div?.classList.toggle("draggable",e)}get isEnterHandled(){return!0}center(){const[e,t]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*t/(e*2),this.y+=this.width*e/(t*2);break;case 180:this.x+=this.width/2,this.y+=this.height/2;break;case 270:this.x+=this.height*t/(e*2),this.y-=this.width*e/(t*2);break;default:this.x-=this.width/2,this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(e){this._uiManager.addCommands(e)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=this.#zIndex}setParent(e){e!==null?(this.pageIndex=e.pageIndex,this.pageDimensions=e.pageDimensions):this.#stopResizing(),this.parent=e}focusin(){if(!this._focusEventsAllowed)return;this.#hasBeenClicked?this.#hasBeenClicked=!1:this.parent.setSelected(this)}focusout(e){if(!this._focusEventsAllowed)return;if(!this.isAttachedToDOM)return;const t=e.relatedTarget;if(t?.closest(`#${this.id}`))return;e.preventDefault(),this.parent?.isMultipleSelection||this.commitOrRemove()}commitOrRemove(){this.isEmpty()?this.remove():this.commit()}commit(){this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(e,t,n,s){const[o,i]=this.parentDimensions;[n,s]=this.screenToPageTranslation(n,s),this.x=(e+n)/o,this.y=(t+s)/i,this.fixAndSetPosition()}_moveAfterPaste(e,t){const[n,s]=this.parentDimensions;this.setAt(e*n,t*s,this.width*n,this.height*s),this._onTranslated()}#translate([e,t],n,s){[n,s]=this.screenToPageTranslation(n,s),this.x+=n/e,this.y+=s/t,this._onTranslating(this.x,this.y),this.fixAndSetPosition()}translate(e,t){this.#translate(this.parentDimensions,e,t)}translateInPage(e,t){this.#initialRect||=[this.x,this.y,this.width,this.height],this.#translate(this.pageDimensions,e,t),this.div.scrollIntoView({block:"nearest"})}translationDone(){this._onTranslated(this.x,this.y)}drag(e,t){this.#initialRect||=[this.x,this.y,this.width,this.height];const{div:o,parentDimensions:[a,r]}=this;if(this.x+=e/a,this.y+=t/r,this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){const{x:e,y:t}=this.div.getBoundingClientRect();this.parent.findNewParent(this,e,t)&&(this.x-=Math.floor(this.x),this.y-=Math.floor(this.y))}let{x:n,y:s}=this;const[c,l]=this.getBaseTranslation();n+=c,s+=l;const{style:i}=o;i.left=`${(100*n).toFixed(2)}%`,i.top=`${(100*s).toFixed(2)}%`,this._onTranslating(n,s),o.scrollIntoView({block:"nearest"})}_onTranslating(){}_onTranslated(){}get _hasBeenMoved(){return!!this.#initialRect&&(this.#initialRect[0]!==this.x||this.#initialRect[1]!==this.y)}get _hasBeenResized(){return!!this.#initialRect&&(this.#initialRect[2]!==this.width||this.#initialRect[3]!==this.height)}getBaseTranslation(){const[s,o]=this.parentDimensions,{_borderLineWidth:n}=AnnotationEditor,e=n/s,t=n/o;switch(this.rotation){case 90:return[-e,t];case 180:return[e,t];case 270:return[e,-t];default:return[-e,-t]}}get _mustFixPosition(){return!0}fixAndSetPosition(e=this.rotation){const{div:{style:r},pageDimensions:[s,o]}=this;let{x:t,y:n,width:i,height:a}=this;if(i*=s,a*=o,t*=s,n*=o,this._mustFixPosition)switch(e){case 0:t=MathClamp(t,0,s-i),n=MathClamp(n,0,o-a);break;case 90:t=MathClamp(t,0,s-a),n=MathClamp(n,i,o);break;case 180:t=MathClamp(t,i,s),n=MathClamp(n,a,o);break;case 270:t=MathClamp(t,a,s),n=MathClamp(n,0,o-i);break}this.x=t/=s,this.y=n/=o;const[c,l]=this.getBaseTranslation();t+=c,n+=l,r.left=`${(100*t).toFixed(2)}%`,r.top=`${(100*n).toFixed(2)}%`,this.moveInDOM()}static#rotatePoint(e,t,n){switch(n){case 90:return[t,-e];case 180:return[-e,-t];case 270:return[-t,e];default:return[e,t]}}screenToPageTranslation(e,t){return AnnotationEditor.#rotatePoint(e,t,this.parentRotation)}pageTranslationToScreen(e,t){return AnnotationEditor.#rotatePoint(e,t,360-this.parentRotation)}#getRotationMatrix(e){switch(e){case 90:{const[e,t]=this.pageDimensions;return[0,-e/t,t/e,0]}case 180:return[-1,0,0,-1];case 270:{const[e,t]=this.pageDimensions;return[0,e/t,-t/e,0]}default:return[1,0,0,1]}}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){const{parentScale:e,pageDimensions:[t,n]}=this;return[t*e,n*e]}setDims(e,t){const[s,o]=this.parentDimensions,{style:n}=this.div;n.width=`${(100*e/s).toFixed(2)}%`,this.#keepAspectRatio||(n.height=`${(100*t/o).toFixed(2)}%`)}fixDims(){const{style:e}=this.div,{height:t,width:n}=e,s=n.endsWith("%"),o=!this.#keepAspectRatio&&t.endsWith("%");if(s&&o)return;const[i,a]=this.parentDimensions;s||(e.width=`${(100*parseFloat(n)/i).toFixed(2)}%`),!this.#keepAspectRatio&&!o&&(e.height=`${(100*parseFloat(t)/a).toFixed(2)}%`)}getInitialTranslation(){return[0,0]}#createResizers(){if(this.#resizersDiv)return;this.#resizersDiv=document.createElement("div"),this.#resizersDiv.classList.add("resizers");const t=this._willKeepAspectRatio?["topLeft","topRight","bottomRight","bottomLeft"]:["topLeft","topMiddle","topRight","middleRight","bottomRight","bottomMiddle","bottomLeft","middleLeft"],e=this._uiManager._signal;for(const s of t){const n=document.createElement("div");this.#resizersDiv.append(n),n.classList.add("resizer",s),n.setAttribute("data-resizer-name",s),n.addEventListener("pointerdown",this.#resizerPointerdown.bind(this,s),{signal:e}),n.addEventListener("contextmenu",noContextMenu,{signal:e}),n.tabIndex=-1}this.div.prepend(this.#resizersDiv)}#resizerPointerdown(e,t){t.preventDefault();const{isMac:i}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&i)return;this.#altText?.toggle(!1);const a=this._isDraggable;this._isDraggable=!1,this.#lastPointerCoords=[t.screenX,t.screenY];const s=new AbortController,n=this._uiManager.combinedSignal(s);this.parent.togglePointerEvents(!1),window.addEventListener("pointermove",this.#resizerPointermove.bind(this,e),{passive:!0,capture:!0,signal:n}),window.addEventListener("touchmove",stopEvent,{passive:!1,signal:n}),window.addEventListener("contextmenu",noContextMenu,{signal:n}),this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const r=this.parent.div.style.cursor,c=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(t.target).cursor;const o=()=>{s.abort(),this.parent.togglePointerEvents(!0),this.#altText?.toggle(!0),this._isDraggable=a,this.parent.div.style.cursor=r,this.div.style.cursor=c,this.#addResizeToUndoStack()};window.addEventListener("pointerup",o,{signal:n}),window.addEventListener("blur",o,{signal:n})}#resize(e,t,n,s){this.width=n,this.height=s,this.x=e,this.y=t;const[o,i]=this.parentDimensions;this.setDims(o*n,i*s),this.fixAndSetPosition(),this._onResized()}_onResized(){}#addResizeToUndoStack(){if(!this.#savedDimensions)return;const{savedX:e,savedY:t,savedWidth:n,savedHeight:s}=this.#savedDimensions;this.#savedDimensions=null;const o=this.x,i=this.y,a=this.width,r=this.height;if(o===e&&i===t&&a===n&&r===s)return;this.addCommands({cmd:this.#resize.bind(this,o,i,a,r),undo:this.#resize.bind(this,e,t,n,s),mustExec:!0})}static _round(e){return Math.round(e*1e4)/1e4}#resizerPointermove(e,t){const[y,b]=this.parentDimensions,k=this.x,E=this.y,o=this.width,i=this.height,_=AnnotationEditor.MIN_SIZE/y,w=AnnotationEditor.MIN_SIZE/b,h=this.#getRotationMatrix(this.rotation),O=(e,t)=>[h[0]*e+h[2]*t,h[1]*e+h[3]*t],m=this.#getRotationMatrix(360-this.rotation),A=(e,t)=>[m[0]*e+m[2]*t,m[1]*e+m[3]*t];let s,n,d=!1,v=!1;switch(e){case"topLeft":d=!0,s=()=>[0,0],n=(e,t)=>[e,t];break;case"topMiddle":s=(e)=>[e/2,0],n=(e,t)=>[e/2,t];break;case"topRight":d=!0,s=(e)=>[e,0],n=(e,t)=>[0,t];break;case"middleRight":v=!0,s=(e,t)=>[e,t/2],n=(e,t)=>[0,t/2];break;case"bottomRight":d=!0,s=(e,t)=>[e,t],n=()=>[0,0];break;case"bottomMiddle":s=(e,t)=>[e/2,t],n=(e)=>[e/2,0];break;case"bottomLeft":d=!0,s=(e,t)=>[0,t],n=(e)=>[e,0];break;case"middleLeft":v=!0,s=(e,t)=>[0,t/2],n=(e,t)=>[e,t/2];break}const u=s(o,i),l=n(o,i);let c=O(...l);const x=AnnotationEditor._round(k+c[0]),C=AnnotationEditor._round(E+c[1]);let f=1,j=1,r,a;if(t.fromKeyboard)({deltaX:r,deltaY:a}=t);else{const{screenX:e,screenY:n}=t,[s,o]=this.#lastPointerCoords;[r,a]=this.screenToPageTranslation(e-s,n-o),this.#lastPointerCoords[0]=e,this.#lastPointerCoords[1]=n}if([r,a]=A(r/y,a/b),d){const e=Math.hypot(o,i);f=j=Math.max(Math.min(Math.hypot(l[0]-u[0]-r,l[1]-u[1]-a)/e,1/o,1/i),_/o,w/i)}else v?f=MathClamp(Math.abs(l[0]-u[0]-r),_,1)/o:j=MathClamp(Math.abs(l[1]-u[1]-a),w,1)/i;const p=AnnotationEditor._round(o*f),g=AnnotationEditor._round(i*j);c=O(...n(p,g));const S=x-c[0],M=C-c[1];this.#initialRect||=[this.x,this.y,this.width,this.height],this.width=p,this.height=g,this.x=S,this.y=M,this.setDims(y*p,b*g),this.fixAndSetPosition(),this._onResizing()}_onResizing(){}altTextFinish(){this.#altText?.finish()}async addEditToolbar(){return this._editToolbar||this.#isInEditMode?this._editToolbar:(this._editToolbar=new EditorToolbar(this),this.div.append(this._editToolbar.render()),this.#altText&&await this._editToolbar.addAltText(this.#altText),this._editToolbar)}removeEditToolbar(){if(!this._editToolbar)return;this._editToolbar.remove(),this._editToolbar=null,this.#altText?.destroy()}addContainer(e){const t=this._editToolbar?.div;t?t.before(e):this.div.append(e)}getClientDimensions(){return this.div.getBoundingClientRect()}async addAltTextButton(){if(this.#altText)return;AltText.initialize(AnnotationEditor._l10n),this.#altText=new AltText(this),this.#accessibilityData&&(this.#altText.data=this.#accessibilityData,this.#accessibilityData=null),await this.addEditToolbar()}get altTextData(){return this.#altText?.data}set altTextData(e){if(!this.#altText)return;this.#altText.data=e}get guessedAltText(){return this.#altText?.guessedText}async setGuessedAltText(e){await this.#altText?.setGuessedText(e)}serializeAltText(e){return this.#altText?.serialize(e)}hasAltText(){return!!this.#altText&&!this.#altText.isEmpty()}hasAltTextData(){return this.#altText?.hasData()??!1}render(){const e=this.div=document.createElement("div");e.setAttribute("data-editor-rotation",(360-this.rotation)%360),e.className=this.name,e.setAttribute("id",this.id),e.tabIndex=this.#disabled?-1:0,e.setAttribute("role","application"),this.defaultL10nId&&e.setAttribute("data-l10n-id",this.defaultL10nId),this._isVisible||e.classList.add("hidden"),this.setInForeground(),this.#addFocusListeners();const[t,n]=this.parentDimensions;this.parentRotation%180!==0&&(e.style.maxWidth=`${(100*n/t).toFixed(2)}%`,e.style.maxHeight=`${(100*t/n).toFixed(2)}%`);const[s,o]=this.getInitialTranslation();return this.translate(s,o),bindEvents(this,e,["keydown","pointerdown","dblclick"]),this.isResizable&&this._uiManager._supportsPinchToZoom&&(this.#touchManager||=new TouchManager({container:e,isPinchingDisabled:()=>!this.isSelected,onPinchStart:this.#touchPinchStartCallback.bind(this),onPinching:this.#touchPinchCallback.bind(this),onPinchEnd:this.#touchPinchEndCallback.bind(this),signal:this._uiManager._signal})),this._uiManager._editorUndoBar?.hide(),e}#touchPinchStartCallback(){this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height},this.#altText?.toggle(!1),this.parent.togglePointerEvents(!1)}#touchPinchCallback(e,t,n){const m=.7;let i=m*(n/t)+1-m;if(i===1)return;const r=this.#getRotationMatrix(this.rotation),u=(e,t)=>[r[0]*e+r[2]*t,r[1]*e+r[3]*t],[d,f]=this.parentDimensions,h=this.x,l=this.y,s=this.width,o=this.height,v=AnnotationEditor.MIN_SIZE/d,b=AnnotationEditor.MIN_SIZE/f;i=Math.max(Math.min(i,1/s,1/o),v/s,b/o);const a=AnnotationEditor._round(s*i),c=AnnotationEditor._round(o*i);if(a===s&&c===o)return;this.#initialRect||=[h,l,s,o];const p=u(s/2,o/2),j=AnnotationEditor._round(h+p[0]),y=AnnotationEditor._round(l+p[1]),g=u(a/2,c/2);this.x=j-g[0],this.y=y-g[1],this.width=a,this.height=c,this.setDims(d*a,f*c),this.fixAndSetPosition(),this._onResizing()}#touchPinchEndCallback(){this.#altText?.toggle(!0),this.parent.togglePointerEvents(!0),this.#addResizeToUndoStack()}pointerdown(e){const{isMac:t}=util_FeatureTest.platform;if(e.button!==0||e.ctrlKey&&t){e.preventDefault();return}if(this.#hasBeenClicked=!0,this._isDraggable){this.#setUpDragSession(e);return}this.#selectOnPointerEvent(e)}#selectOnPointerEvent(e){const{isMac:t}=util_FeatureTest.platform;e.ctrlKey&&!t||e.shiftKey||e.metaKey&&t?this.parent.toggleSelected(this):this.parent.setSelected(this)}#setUpDragSession(e){const{isSelected:r}=this;this._uiManager.setUpDragSession();let t=!1;const o=new AbortController,n=this._uiManager.combinedSignal(o),s={capture:!0,passive:!1,signal:n},i=e=>{o.abort(),this.#dragPointerId=null,this.#hasBeenClicked=!1,this._uiManager.endDragSession()||this.#selectOnPointerEvent(e),t&&this._onStopDragging()};r&&(this.#prevDragX=e.clientX,this.#prevDragY=e.clientY,this.#dragPointerId=e.pointerId,this.#dragPointerType=e.pointerType,window.addEventListener("pointermove",e=>{t||(t=!0,this._onStartDragging());const{clientX:n,clientY:s,pointerId:o}=e;if(o!==this.#dragPointerId){stopEvent(e);return}const[i,a]=this.screenToPageTranslation(n-this.#prevDragX,s-this.#prevDragY);this.#prevDragX=n,this.#prevDragY=s,this._uiManager.dragSelectedEditors(i,a)},s),window.addEventListener("touchmove",stopEvent,s),window.addEventListener("pointerdown",e=>{e.pointerType===this.#dragPointerType&&(this.#touchManager||e.isPrimary)&&i(e),stopEvent(e)},s));const a=e=>{if(!this.#dragPointerId||this.#dragPointerId===e.pointerId){i(e);return}stopEvent(e)};window.addEventListener("pointerup",a,{signal:n}),window.addEventListener("blur",a,{signal:n})}_onStartDragging(){}_onStopDragging(){}moveInDOM(){this.#moveInDOMTimeout&&clearTimeout(this.#moveInDOMTimeout),this.#moveInDOMTimeout=setTimeout(()=>{this.#moveInDOMTimeout=null,this.parent?.moveEditorInDOM(this)},0)}_setParentAndPosition(e,t,n){e.changeParent(this),this.x=t,this.y=n,this.fixAndSetPosition(),this._onTranslated()}getRect(e,t,n=this.rotation){const h=this.parentScale,[m,s]=this.pageDimensions,[o,i]=this.pageTranslation,a=e/h,r=t/h,c=this.x*m,l=this.y*s,d=this.width*m,u=this.height*s;switch(n){case 0:return[c+a+o,s-l-r-u+i,c+a+d+o,s-l-r+i];case 90:return[c+r+o,s-l+a+i,c+r+u+o,s-l+a+d+i];case 180:return[c-a-d+o,s-l+r+i,c-a+o,s-l+r+u+i];case 270:return[c-r-u+o,s-l-a-d+i,c-r+o,s-l-a+i];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(e,t){const[o,i,a,r]=e,n=a-o,s=r-i;switch(this.rotation){case 0:return[o,t-r,n,s];case 90:return[o,t-i,s,n];case 180:return[a,t-i,n,s];case 270:return[a,t-r,s,n];default:throw new Error("Invalid rotation")}}onceAdded(){}isEmpty(){return!1}enableEditMode(){return!this.isInEditMode()&&(this.parent.setEditingState(!1),this.#isInEditMode=!0,!0)}disableEditMode(){return!!this.isInEditMode()&&(this.parent.setEditingState(!0),this.#isInEditMode=!1,!0)}isInEditMode(){return this.#isInEditMode}shouldGetKeyboardEvents(){return this.#isResizerEnabledForKeyboard}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}get isOnScreen(){const{top:e,left:t,bottom:n,right:s}=this.getClientDimensions(),{innerHeight:o,innerWidth:i}=window;return t<i&&s>0&&e<o&&n>0}#addFocusListeners(){if(this.#focusAC||!this.div)return;this.#focusAC=new AbortController;const e=this._uiManager.combinedSignal(this.#focusAC);this.div.addEventListener("focusin",this.focusin.bind(this),{signal:e}),this.div.addEventListener("focusout",this.focusout.bind(this),{signal:e})}rebuild(){this.#addFocusListeners()}rotate(){}resize(){}serializeDeleted(){return{id:this.annotationElementId,deleted:!0,pageIndex:this.pageIndex,popupRef:this._initialData?.popupRef||""}}serialize(){unreachable("An editor must be serializable")}static async deserialize(e,t,n){const s=new this.prototype.constructor({parent:t,id:t.getNextId(),uiManager:n});s.rotation=e.rotation,s.#accessibilityData=e.accessibilityData,s._isCopy=e.isCopy||!1;const[i,o]=s.pageDimensions,[a,r,c,l]=s.getRectInCurrentCoords(e.rect,o);return s.x=a/i,s.y=r/o,s.width=c/i,s.height=l/o,s}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||this.serialize()!==null)}remove(){if(this.#focusAC?.abort(),this.#focusAC=null,this.isEmpty()||this.commit(),this.parent?this.parent.remove(this):this._uiManager.removeEditor(this),this.#moveInDOMTimeout&&(clearTimeout(this.#moveInDOMTimeout),this.#moveInDOMTimeout=null),this.#stopResizing(),this.removeEditToolbar(),this.#telemetryTimeouts){for(const e of this.#telemetryTimeouts.values())clearTimeout(e);this.#telemetryTimeouts=null}this.parent=null,this.#touchManager?.destroy(),this.#touchManager=null}get isResizable(){return!1}makeResizable(){this.isResizable&&(this.#createResizers(),this.#resizersDiv.classList.remove("hidden"))}get toolbarPosition(){return null}keydown(e){if(!this.isResizable||e.target!==this.div||e.key!=="Enter")return;this._uiManager.setSelected(this),this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const s=this.#resizersDiv.children;if(!this.#allResizerDivs){this.#allResizerDivs=Array.from(s);const t=this.#resizerKeydown.bind(this),n=this.#resizerBlur.bind(this),e=this._uiManager._signal;for(const s of this.#allResizerDivs){const o=s.getAttribute("data-resizer-name");s.setAttribute("role","spinbutton"),s.addEventListener("keydown",t,{signal:e}),s.addEventListener("blur",n,{signal:e}),s.addEventListener("focus",this.#resizerFocus.bind(this,o),{signal:e}),s.setAttribute("data-l10n-id",AnnotationEditor._l10nResizer[o])}}const o=this.#allResizerDivs[0];let t=0;for(const e of s){if(e===o)break;t++}const n=(360-this.rotation+this.parentRotation)%360/90*(this.#allResizerDivs.length/4);if(n!==t){if(n<t)for(let e=0;e<t-n;e++)this.#resizersDiv.append(this.#resizersDiv.firstChild);else if(n>t)for(let e=0;e<n-t;e++)this.#resizersDiv.firstChild.before(this.#resizersDiv.lastChild);let e=0;for(const t of s){const n=this.#allResizerDivs[e++],o=n.getAttribute("data-resizer-name");t.setAttribute("data-l10n-id",AnnotationEditor._l10nResizer[o])}}this.#setResizerTabIndex(0),this.#isResizerEnabledForKeyboard=!0,this.#resizersDiv.firstChild.focus({focusVisible:!0}),e.preventDefault(),e.stopImmediatePropagation()}#resizerKeydown(e){AnnotationEditor._resizerKeyboardManager.exec(this,e)}#resizerBlur(e){this.#isResizerEnabledForKeyboard&&e.relatedTarget?.parentNode!==this.#resizersDiv&&this.#stopResizing()}#resizerFocus(e){this.#focusedResizerName=this.#isResizerEnabledForKeyboard?e:""}#setResizerTabIndex(e){if(!this.#allResizerDivs)return;for(const t of this.#allResizerDivs)t.tabIndex=e}_resizeWithKeyboard(e,t){if(!this.#isResizerEnabledForKeyboard)return;this.#resizerPointermove(this.#focusedResizerName,{deltaX:e,deltaY:t,fromKeyboard:!0})}#stopResizing(){this.#isResizerEnabledForKeyboard=!1,this.#setResizerTabIndex(-1),this.#addResizeToUndoStack()}_stopResizingWithKeyboard(){this.#stopResizing(),this.div.focus()}select(){if(this.isSelected&&this._editToolbar)return;if(this.isSelected=!0,this.makeResizable(),this.div?.classList.add("selectedEditor"),!this._editToolbar){this.addEditToolbar().then(()=>{this.div?.classList.contains("selectedEditor")&&this._editToolbar?.show()});return}this._editToolbar?.show(),this.#altText?.toggleAltTextBadge(!1)}unselect(){if(!this.isSelected)return;this.isSelected=!1,this.#resizersDiv?.classList.add("hidden"),this.div?.classList.remove("selectedEditor"),this.div?.contains(document.activeElement)&&this._uiManager.currentLayer.div.focus({preventScroll:!0}),this._editToolbar?.hide(),this.#altText?.toggleAltTextBadge(!0)}updateParams(){}disableEditing(){}enableEditing(){}get canChangeContent(){return!1}enterInEditMode(){if(!this.canChangeContent)return;this.enableEditMode(),this.div.focus()}dblclick(){this.enterInEditMode(),this.parent.updateToolbar({mode:this.constructor._editorType,editId:this.id})}getElementForAltText(){return this.div}get contentDiv(){return this.div}get isEditing(){return this.#isEditing}set isEditing(e){if(this.#isEditing=e,!this.parent)return;e?(this.parent.setSelected(this),this.parent.setActiveEditor(this)):this.parent.setActiveEditor(null)}setAspectRatio(e,t){this.#keepAspectRatio=!0;const s=e/t,{style:n}=this.div;n.aspectRatio=s,n.height="auto"}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return!0}get telemetryInitialData(){return{action:"added"}}get telemetryFinalData(){return null}_reportTelemetry(e,t=!1){if(t){this.#telemetryTimeouts||=new Map;const{action:n}=e;let t=this.#telemetryTimeouts.get(n);t&&clearTimeout(t),t=setTimeout(()=>{this._reportTelemetry(e),this.#telemetryTimeouts.delete(n),this.#telemetryTimeouts.size===0&&(this.#telemetryTimeouts=null)},AnnotationEditor._telemetryTimeout),this.#telemetryTimeouts.set(n,t);return}e.type||=this.editorType,this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:e}})}show(e=this._isVisible){this.div.classList.toggle("hidden",!e),this._isVisible=e}enable(){this.div&&(this.div.tabIndex=0),this.#disabled=!1}disable(){this.div&&(this.div.tabIndex=-1),this.#disabled=!0}renderAnnotationElement(e){let t=e.container.querySelector(".annotationContent");if(t){if(t.nodeName==="CANVAS"){const e=t;t=document.createElement("div"),t.classList.add("annotationContent",this.editorType),e.before(t)}}else t=document.createElement("div"),t.classList.add("annotationContent",this.editorType),e.container.prepend(t);return t}resetAnnotationElement(e){const{firstChild:t}=e.container;t?.nodeName==="DIV"&&t.classList.contains("annotationContent")&&t.remove()}}class FakeEditor extends AnnotationEditor{constructor(e){super(e),this.annotationElementId=e.annotationElementId,this.deleted=!0}serialize(){return this.serializeDeleted()}}const SEED=3285377520,MASK_HIGH=4294901760,MASK_LOW=65535;class MurmurHash3_64{constructor(e){this.h1=e?e&4294967295:SEED,this.h2=e?e&4294967295:SEED}update(e){let s,a;if(typeof e=="string"){s=new Uint8Array(e.length*2),a=0;for(let n=0,o=e.length;n<o;n++){const t=e.charCodeAt(n);t<=255?s[a++]=t:(s[a++]=t>>>8,s[a++]=t&255)}}else if(ArrayBuffer.isView(e))s=e.slice(),a=s.byteLength;else throw new Error("Invalid data format, must be a string or TypedArray.");const r=a>>2,m=a-r*4,h=new Uint32Array(s.buffer,0,r);let t=0,n=0,o=this.h1,i=this.h2;const c=3432918353,l=461845907,d=c&MASK_LOW,u=l&MASK_LOW;for(let e=0;e<r;e++)e&1?(t=h[e],t=t*c&MASK_HIGH|t*d&MASK_LOW,t=t<<15|t>>>17,t=t*l&MASK_HIGH|t*u&MASK_LOW,o^=t,o=o<<13|o>>>19,o=o*5+3864292196):(n=h[e],n=n*c&MASK_HIGH|n*d&MASK_LOW,n=n<<15|n>>>17,n=n*l&MASK_HIGH|n*u&MASK_LOW,i^=n,i=i<<13|i>>>19,i=i*5+3864292196);switch(t=0,m){case 3:t^=s[r*4+2]<<16;case 2:t^=s[r*4+1]<<8;case 1:t^=s[r*4],t=t*c&MASK_HIGH|t*d&MASK_LOW,t=t<<15|t>>>17,t=t*l&MASK_HIGH|t*u&MASK_LOW,r&1?o^=t:i^=t}this.h1=o,this.h2=i}hexdigest(){let e=this.h1,t=this.h2;return e^=t>>>1,e=e*3981806797&MASK_HIGH|e*36045&MASK_LOW,t=t*4283543511&MASK_HIGH|((t<<16|e>>>16)*2950163797&MASK_HIGH)>>>16,e^=t>>>1,e=e*444984403&MASK_HIGH|e*60499&MASK_LOW,t=t*3301882366&MASK_HIGH|((t<<16|e>>>16)*3120437893&MASK_HIGH)>>>16,e^=t>>>1,(e>>>0).toString(16).padStart(8,"0")+(t>>>0).toString(16).padStart(8,"0")}}const SerializableEmpty=Object.freeze({map:null,hash:"",transfer:void 0});class AnnotationStorage{#modified=!1;#modifiedIds=null;#storage=new Map;constructor(){this.onSetModified=null,this.onResetModified=null,this.onAnnotationEditor=null}getValue(e,t){const n=this.#storage.get(e);return n===void 0?t:Object.assign(t,n)}getRawValue(e){return this.#storage.get(e)}remove(e){if(this.#storage.delete(e),this.#storage.size===0&&this.resetModified(),typeof this.onAnnotationEditor=="function"){for(const e of this.#storage.values())if(e instanceof AnnotationEditor)return;this.onAnnotationEditor(null)}}setValue(e,t){const n=this.#storage.get(e);let s=!1;if(n!==void 0)for(const[e,o]of Object.entries(t))n[e]!==o&&(s=!0,n[e]=o);else s=!0,this.#storage.set(e,t);s&&this.#setModified(),t instanceof AnnotationEditor&&typeof this.onAnnotationEditor=="function"&&this.onAnnotationEditor(t.constructor._type)}has(e){return this.#storage.has(e)}get size(){return this.#storage.size}#setModified(){this.#modified||(this.#modified=!0,typeof this.onSetModified=="function"&&this.onSetModified())}resetModified(){this.#modified&&(this.#modified=!1,typeof this.onResetModified=="function"&&this.onResetModified())}get print(){return new PrintAnnotationStorage(this)}get serializable(){if(this.#storage.size===0)return SerializableEmpty;const e=new Map,t=new MurmurHash3_64,n=[],o=Object.create(null);let s=!1;for(const[a,i]of this.#storage){const n=i instanceof AnnotationEditor?i.serialize(!1,o):i;n&&(e.set(a,n),t.update(`${a}:${JSON.stringify(n)}`),s||=!!n.bitmap)}if(s)for(const t of e.values())t.bitmap&&n.push(t.bitmap);return e.size>0?{map:e,hash:t.hexdigest(),transfer:n}:SerializableEmpty}get editorStats(){let e=null;const t=new Map;for(const n of this.#storage.values()){if(!(n instanceof AnnotationEditor))continue;const s=n.telemetryFinalData;if(!s)continue;const{type:o}=s;t.has(o)||t.set(o,Object.getPrototypeOf(n).constructor),e||=Object.create(null);const i=e[o]||=new Map;for(const[t,n]of Object.entries(s)){if(t==="type")continue;let e=i.get(t);e||(e=new Map,i.set(t,e));const o=e.get(n)??0;e.set(n,o+1)}}for(const[n,s]of t)e[n]=s.computeTelemetryFinalData(e[n]);return e}resetModifiedIds(){this.#modifiedIds=null}get modifiedIds(){if(this.#modifiedIds)return this.#modifiedIds;const e=[];for(const t of this.#storage.values()){if(!(t instanceof AnnotationEditor)||!t.annotationElementId||!t.serialize())continue;e.push(t.annotationElementId)}return this.#modifiedIds={ids:new Set(e),hash:e.join(",")}}[Symbol.iterator](){return this.#storage.entries()}}class PrintAnnotationStorage extends AnnotationStorage{#serializable;constructor(e){super();const{map:n,hash:s,transfer:t}=e.serializable,o=structuredClone(n,t?{transfer:t}:null);this.#serializable={map:o,hash:s,transfer:t}}get print(){unreachable("Should not call PrintAnnotationStorage.print")}get serializable(){return this.#serializable}get modifiedIds(){return shadow(this,"modifiedIds",{ids:new Set,hash:""})}}class FontLoader{#systemFonts=new Set;constructor({ownerDocument:e=globalThis.document,styleElement:t=null}){this._document=e,this.nativeFontFaces=new Set,this.styleElement=null,this.loadingRequests=[],this.loadTestFontId=0}addNativeFontFace(e){this.nativeFontFaces.add(e),this._document.fonts.add(e)}removeNativeFontFace(e){this.nativeFontFaces.delete(e),this._document.fonts.delete(e)}insertRule(e){this.styleElement||(this.styleElement=this._document.createElement("style"),this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement));const t=this.styleElement.sheet;t.insertRule(e,t.cssRules.length)}clear(){for(const e of this.nativeFontFaces)this._document.fonts.delete(e);this.nativeFontFaces.clear(),this.#systemFonts.clear(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}async loadSystemFont({systemFontInfo:e,disableFontFace:t,_inspectFont:n}){if(!e||this.#systemFonts.has(e.loadedName))return;if(assert(!t,"loadSystemFont shouldn't be called when `disableFontFace` is set."),this.isFontLoadingAPISupported){const{loadedName:s,src:o,style:i}=e,t=new FontFace(s,o,i);this.addNativeFontFace(t);try{await t.load(),this.#systemFonts.add(s),n?.(e)}catch{warn(`Cannot load system font: ${e.baseFontName}, installing it could help to improve PDF rendering.`),this.removeNativeFontFace(t)}return}unreachable("Not implemented: loadSystemFont without the Font Loading API.")}async bind(e){if(e.attached||e.missingFile&&!e.systemFontInfo)return;if(e.attached=!0,e.systemFontInfo){await this.loadSystemFont(e);return}if(this.isFontLoadingAPISupported){const t=e.createNativeFontFace();if(t){this.addNativeFontFace(t);try{await t.loaded}catch(n){throw warn(`Failed to load font '${t.family}': '${n}'.`),e.disableFontFace=!0,n}}return}const t=e.createFontFaceRule();if(t){if(this.insertRule(t),this.isSyncFontLoadingSupported)return;await new Promise(t=>{const n=this._queueLoadingCallback(t);this._prepareFontLoadEvent(e,n)})}}get isFontLoadingAPISupported(){const e=!!this._document?.fonts;return shadow(this,"isFontLoadingAPISupported",e)}get isSyncFontLoadingSupported(){return shadow(this,"isSyncFontLoadingSupported",isNodeJS||util_FeatureTest.platform.isFirefox)}_queueLoadingCallback(e){function s(){for(assert(!n.done,"completeRequest() cannot be called twice."),n.done=!0;t.length>0&&t[0].done;){const e=t.shift();setTimeout(e.callback,0)}}const{loadingRequests:t}=this,n={done:!1,complete:s,callback:e};return t.push(n),n}get _loadTestFont(){const e=atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==");return shadow(this,"_loadTestFont",e)}_prepareFontLoadEvent(e,t){function l(e,t){return e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3)&255}function f(e,t,n,s){const o=e.substring(0,t),i=e.substring(t+n);return o+s+i}let o,m;const r=this._document.createElement("canvas");r.width=1,r.height=1;const c=r.getContext("2d");let p=0;function d(e,t){if(++p>30){warn("Load test font never loaded."),t();return}c.font="30px "+e,c.fillText(".",0,20);const n=c.getImageData(0,0,1,1);if(n.data[3]>0){t();return}setTimeout(d.bind(null,e,t))}const n=`lt${Date.now()}${this.loadTestFontId++}`;let i=this._loadTestFont;const g=976;i=f(i,g,n.length,n);const u=16,h=1482184792;let a=l(i,u);for(o=0,m=n.length-3;o<m;o+=4)a=a-h+l(n,o)|0;o<n.length&&(a=a-h+l(n+"XXX",o)|0),i=f(i,u,4,string32(a));const v=`url(data:font/opentype;base64,${btoa(i)});`,b=`@font-face {font-family:"${n}";src:${v}}`;this.insertRule(b);const s=this._document.createElement("div");s.style.visibility="hidden",s.style.width=s.style.height="10px",s.style.position="absolute",s.style.top=s.style.left="0px";for(const o of[e.loadedName,n]){const t=this._document.createElement("span");t.textContent="Hi",t.style.fontFamily=o,s.append(t)}this._document.body.append(s),d(n,()=>{s.remove(),t.complete()})}}class FontFaceObject{constructor(e,t=null){this.compiledGlyphs=Object.create(null);for(const t in e)this[t]=e[t];this._inspectFont=t}createNativeFontFace(){if(!this.data||this.disableFontFace)return null;let e;if(this.cssFontInfo){const t={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(t.style=`oblique ${this.cssFontInfo.italicAngle}deg`),e=new FontFace(this.cssFontInfo.fontFamily,this.data,t)}else e=new FontFace(this.loadedName,this.data,{});return this._inspectFont?.(this),e}createFontFaceRule(){if(!this.data||this.disableFontFace)return null;const e=`url(data:${this.mimetype};base64,${toBase64Util(this.data)});`;let t;if(this.cssFontInfo){let n=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(n+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),t=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${n}src:${e}}`}else t=`@font-face {font-family:"${this.loadedName}";src:${e}}`;return this._inspectFont?.(this,e),t}getPathGenerator(e,t){if(this.compiledGlyphs[t]!==void 0)return this.compiledGlyphs[t];const n=this.loadedName+"_path_"+t;let s;try{s=e.get(n)}catch(e){warn(`getPathGenerator - ignoring character: "${e}".`)}const o=new Path2D(s||"");return this.fontExtraProperties||e.delete(n),this.compiledGlyphs[t]=o}}function getUrlProp(e){if(e instanceof URL)return e.href;if(typeof e=="string"){if(isNodeJS)return e;const t=URL.parse(e,window.location);if(t)return t.href}throw new Error("Invalid PDF url data: either string or URL-object is expected in the url property.")}function getDataProp(e){if(isNodeJS&&typeof Buffer!="undefined"&&e instanceof Buffer)throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.");if(e instanceof Uint8Array&&e.byteLength===e.buffer.byteLength)return e;if(typeof e=="string")return stringToBytes(e);if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||typeof e=="object"&&!isNaN(e?.length))return new Uint8Array(e);throw new Error("Invalid PDF binary data: either TypedArray, string, or array-like object is expected in the data property.")}function getFactoryUrlProp(e){if(typeof e!="string")return null;if(e.endsWith("/"))return e;throw new Error(`Invalid factory url: "${e}" must include trailing slash.`)}const isRefProxy=e=>typeof e=="object"&&Number.isInteger(e?.num)&&e.num>=0&&Number.isInteger(e?.gen)&&e.gen>=0,isNameProxy=e=>typeof e=="object"&&typeof e?.name=="string",isValidExplicitDest=_isValidExplicitDest.bind(null,isRefProxy,isNameProxy);class LoopbackPort{#listeners=new Map;#deferred=Promise.resolve();postMessage(e,t){const n={data:structuredClone(e,t?{transfer:t}:null)};this.#deferred.then(()=>{for(const[e]of this.#listeners)e.call(this,n)})}addEventListener(e,t,n=null){let s=null;if(n?.signal instanceof AbortSignal){const{signal:o}=n;if(o.aborted){warn("LoopbackPort - cannot use an `aborted` signal.");return}const i=()=>this.removeEventListener(e,t);s=()=>o.removeEventListener("abort",i),o.addEventListener("abort",i)}this.#listeners.set(t,s)}removeEventListener(e,t){const n=this.#listeners.get(t);n?.(),this.#listeners.delete(t)}terminate(){for(const[,e]of this.#listeners)e?.();this.#listeners.clear()}}const CallbackKind={DATA:1,ERROR:2},StreamKind={CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function onFn(){}function wrapReason(e){if(e instanceof AbortException||e instanceof InvalidPDFException||e instanceof PasswordException||e instanceof ResponseException||e instanceof UnknownErrorException)return e;switch(e instanceof Error||typeof e=="object"&&e!==null||unreachable('wrapReason: Expected "reason" to be a (possibly cloned) Error.'),e.name){case"AbortException":return new AbortException(e.message);case"InvalidPDFException":return new InvalidPDFException(e.message);case"PasswordException":return new PasswordException(e.message,e.code);case"ResponseException":return new ResponseException(e.message,e.status,e.missing);case"UnknownErrorException":return new UnknownErrorException(e.message,e.details)}return new UnknownErrorException(e.message,e.toString())}class MessageHandler{#messageAC=new AbortController;constructor(e,t,n){this.sourceName=e,this.targetName=t,this.comObj=n,this.callbackId=1,this.streamId=1,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null),this.callbackCapabilities=Object.create(null),this.actionHandler=Object.create(null),n.addEventListener("message",this.#onMessage.bind(this),{signal:this.#messageAC.signal})}#onMessage({data:e}){if(e.targetName!==this.sourceName)return;if(e.stream){this.#processStreamMessage(e);return}if(e.callback){const t=e.callbackId,n=this.callbackCapabilities[t];if(!n)throw new Error(`Cannot resolve callback ${t}`);if(delete this.callbackCapabilities[t],e.callback===CallbackKind.DATA)n.resolve(e.data);else if(e.callback===CallbackKind.ERROR)n.reject(wrapReason(e.reason));else throw new Error("Unexpected callback case");return}const t=this.actionHandler[e.action];if(!t)throw new Error(`Unknown action from worker: ${e.action}`);if(e.callbackId){const n=this.sourceName,s=e.sourceName,o=this.comObj;Promise.try(t,e.data).then(function(t){o.postMessage({sourceName:n,targetName:s,callback:CallbackKind.DATA,callbackId:e.callbackId,data:t})},function(t){o.postMessage({sourceName:n,targetName:s,callback:CallbackKind.ERROR,callbackId:e.callbackId,reason:wrapReason(t)})});return}if(e.streamId){this.#createStreamSink(e);return}t(e.data)}on(e,t){const n=this.actionHandler;if(n[e])throw new Error(`There is already an actionName called "${e}"`);n[e]=t}send(e,t,n){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:e,data:t},n)}sendWithPromise(e,t,n){const o=this.callbackId++,s=Promise.withResolvers();this.callbackCapabilities[o]=s;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:e,callbackId:o,data:t},n)}catch(e){s.reject(e)}return s.promise}sendWithStream(e,t,n,s){const o=this.streamId++,i=this.sourceName,a=this.targetName,r=this.comObj;return new ReadableStream({start:n=>{const c=Promise.withResolvers();return this.streamControllers[o]={controller:n,startCall:c,pullCall:null,cancelCall:null,isClosed:!1},r.postMessage({sourceName:i,targetName:a,action:e,streamId:o,data:t,desiredSize:n.desiredSize},s),c.promise},pull:e=>{const t=Promise.withResolvers();return this.streamControllers[o].pullCall=t,r.postMessage({sourceName:i,targetName:a,stream:StreamKind.PULL,streamId:o,desiredSize:e.desiredSize}),t.promise},cancel:e=>{assert(e instanceof Error,"cancel must have a valid reason");const t=Promise.withResolvers();return this.streamControllers[o].cancelCall=t,this.streamControllers[o].isClosed=!0,r.postMessage({sourceName:i,targetName:a,stream:StreamKind.CANCEL,streamId:o,reason:wrapReason(e)}),t.promise}},n)}#createStreamSink(e){const t=e.streamId,n=this.sourceName,s=e.sourceName,o=this.comObj,a=this,r=this.actionHandler[e.action],i={enqueue(e,i=1,a){if(this.isCancelled)return;const r=this.desiredSize;this.desiredSize-=i,r>0&&this.desiredSize<=0&&(this.sinkCapability=Promise.withResolvers(),this.ready=this.sinkCapability.promise),o.postMessage({sourceName:n,targetName:s,stream:StreamKind.ENQUEUE,streamId:t,chunk:e},a)},close(){if(this.isCancelled)return;this.isCancelled=!0,o.postMessage({sourceName:n,targetName:s,stream:StreamKind.CLOSE,streamId:t}),delete a.streamSinks[t]},error(e){if(assert(e instanceof Error,"error must have a valid reason"),this.isCancelled)return;this.isCancelled=!0,o.postMessage({sourceName:n,targetName:s,stream:StreamKind.ERROR,streamId:t,reason:wrapReason(e)})},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:!1,desiredSize:e.desiredSize,ready:null};i.sinkCapability.resolve(),i.ready=i.sinkCapability.promise,this.streamSinks[t]=i,Promise.try(r,e.data,i).then(function(){o.postMessage({sourceName:n,targetName:s,stream:StreamKind.START_COMPLETE,streamId:t,success:!0})},function(e){o.postMessage({sourceName:n,targetName:s,stream:StreamKind.START_COMPLETE,streamId:t,reason:wrapReason(e)})})}#processStreamMessage(e){const n=e.streamId,o=this.sourceName,i=e.sourceName,a=this.comObj,t=this.streamControllers[n],s=this.streamSinks[n];switch(e.stream){case StreamKind.START_COMPLETE:e.success?t.startCall.resolve():t.startCall.reject(wrapReason(e.reason));break;case StreamKind.PULL_COMPLETE:e.success?t.pullCall.resolve():t.pullCall.reject(wrapReason(e.reason));break;case StreamKind.PULL:if(!s){a.postMessage({sourceName:o,targetName:i,stream:StreamKind.PULL_COMPLETE,streamId:n,success:!0});break}s.desiredSize<=0&&e.desiredSize>0&&s.sinkCapability.resolve(),s.desiredSize=e.desiredSize,Promise.try(s.onPull||onFn).then(function(){a.postMessage({sourceName:o,targetName:i,stream:StreamKind.PULL_COMPLETE,streamId:n,success:!0})},function(e){a.postMessage({sourceName:o,targetName:i,stream:StreamKind.PULL_COMPLETE,streamId:n,reason:wrapReason(e)})});break;case StreamKind.ENQUEUE:if(assert(t,"enqueue should have stream controller"),t.isClosed)break;t.controller.enqueue(e.chunk);break;case StreamKind.CLOSE:if(assert(t,"close should have stream controller"),t.isClosed)break;t.isClosed=!0,t.controller.close(),this.#deleteStreamController(t,n);break;case StreamKind.ERROR:assert(t,"error should have stream controller"),t.controller.error(wrapReason(e.reason)),this.#deleteStreamController(t,n);break;case StreamKind.CANCEL_COMPLETE:e.success?t.cancelCall.resolve():t.cancelCall.reject(wrapReason(e.reason)),this.#deleteStreamController(t,n);break;case StreamKind.CANCEL:if(!s)break;const r=wrapReason(e.reason);Promise.try(s.onCancel||onFn,r).then(function(){a.postMessage({sourceName:o,targetName:i,stream:StreamKind.CANCEL_COMPLETE,streamId:n,success:!0})},function(e){a.postMessage({sourceName:o,targetName:i,stream:StreamKind.CANCEL_COMPLETE,streamId:n,reason:wrapReason(e)})}),s.sinkCapability.reject(r),s.isCancelled=!0,delete this.streamSinks[n];break;default:throw new Error("Unexpected stream case")}}async#deleteStreamController(e,t){await Promise.allSettled([e.startCall?.promise,e.pullCall?.promise,e.cancelCall?.promise]),delete this.streamControllers[t]}destroy(){this.#messageAC?.abort(),this.#messageAC=null}}class BaseCanvasFactory{#enableHWA=!1;constructor({enableHWA:e=!1}){this.#enableHWA=e}create(e,t){if(e<=0||t<=0)throw new Error("Invalid canvas size");const n=this._createCanvas(e,t);return{canvas:n,context:n.getContext("2d",{willReadFrequently:!this.#enableHWA})}}reset(e,t,n){if(!e.canvas)throw new Error("Canvas is not specified");if(t<=0||n<=0)throw new Error("Invalid canvas size");e.canvas.width=t,e.canvas.height=n}destroy(e){if(!e.canvas)throw new Error("Canvas is not specified");e.canvas.width=0,e.canvas.height=0,e.canvas=null,e.context=null}_createCanvas(){unreachable("Abstract method `_createCanvas` called.")}}class DOMCanvasFactory extends BaseCanvasFactory{constructor({ownerDocument:e=globalThis.document,enableHWA:t=!1}){super({enableHWA:t}),this._document=e}_createCanvas(e,t){const n=this._document.createElement("canvas");return n.width=e,n.height=t,n}}class BaseCMapReaderFactory{constructor({baseUrl:e=null,isCompressed:t=!0}){this.baseUrl=e,this.isCompressed=t}async fetch({name:e}){if(!this.baseUrl)throw new Error("Ensure that the `cMapUrl` and `cMapPacked` API parameters are provided.");if(!e)throw new Error("CMap name must be specified.");const t=this.baseUrl+e+(this.isCompressed?".bcmap":"");return this._fetch(t).then(e=>({cMapData:e,isCompressed:this.isCompressed})).catch(e=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${t}`)})}async _fetch(){unreachable("Abstract method `_fetch` called.")}}class DOMCMapReaderFactory extends BaseCMapReaderFactory{async _fetch(e){const t=await fetchData(e,this.isCompressed?"arraybuffer":"text");return t instanceof ArrayBuffer?new Uint8Array(t):stringToBytes(t)}}class BaseFilterFactory{addFilter(){return"none"}addHCMFilter(){return"none"}addAlphaFilter(){return"none"}addLuminosityFilter(){return"none"}addHighlightHCMFilter(){return"none"}destroy(){}}class DOMFilterFactory extends BaseFilterFactory{#baseUrl;#_cache;#_defs;#docId;#document;#_hcmCache;#id=0;constructor({docId:e,ownerDocument:t=globalThis.document}){super(),this.#docId=e,this.#document=t}get#cache(){return this.#_cache||=new Map}get#hcmCache(){return this.#_hcmCache||=new Map}get#defs(){if(!this.#_defs){const n=this.#document.createElement("div"),{style:e}=n;e.visibility="hidden",e.contain="strict",e.width=e.height=0,e.position="absolute",e.top=e.left=0,e.zIndex=-1;const t=this.#document.createElementNS(SVG_NS,"svg");t.setAttribute("width",0),t.setAttribute("height",0),this.#_defs=this.#document.createElementNS(SVG_NS,"defs"),n.append(t),t.append(this.#_defs),this.#document.body.append(n)}return this.#_defs}#createTables(e){if(e.length===1){const s=e[0],n=new Array(256);for(let e=0;e<256;e++)n[e]=s[e]/255;const t=n.join(",");return[t,t,t]}const[o,i,a]=e,t=new Array(256),n=new Array(256),s=new Array(256);for(let e=0;e<256;e++)t[e]=o[e]/255,n[e]=i[e]/255,s[e]=a[e]/255;return[t.join(","),n.join(","),s.join(",")]}#createUrl(e){if(this.#baseUrl===void 0){this.#baseUrl="";const e=this.#document.URL;e!==this.#document.baseURI&&(isDataScheme(e)?warn('#createUrl: ignore "data:"-URL for performance reasons.'):this.#baseUrl=updateUrlHash(e,""))}return`url(${this.#baseUrl}#${e})`}addFilter(e){if(!e)return"none";let t=this.#cache.get(e);if(t)return t;const[n,o,i]=this.#createTables(e),a=e.length===1?n:`${n}${o}${i}`;if(t=this.#cache.get(a),t)return this.#cache.set(e,t),t;const r=`g_${this.#docId}_transfer_map_${this.#id++}`,s=this.#createUrl(r);this.#cache.set(e,s),this.#cache.set(a,s);const c=this.#createFilter(r);return this.#addTransferMapConversion(n,o,i,c),s}addHCMFilter(e,t){const s=`${e}-${t}`,r="base";let n=this.#hcmCache.get(r);if(n?.key===s)return n.url;if(n?(n.filter?.remove(),n.key=s,n.url="none",n.filter=null):(n={key:s,url:"none",filter:null},this.#hcmCache.set(r,n)),!e||!t)return n.url;const c=this.#getRGB(e);e=Util.makeHexColor(...c);const l=this.#getRGB(t);if(t=Util.makeHexColor(...l),this.#defs.style.color="",e==="#000000"&&t==="#ffffff"||e===t)return n.url;const d=new Array(256);for(let e=0;e<=255;e++){const t=e/255;d[e]=t<=.03928?t/12.92:((t+.055)/1.055)**2.4}const o=d.join(","),u=`g_${this.#docId}_hcm_filter`,i=n.filter=this.#createFilter(u);this.#addTransferMapConversion(o,o,o,i),this.#addGrayConversion(i);const a=(e,t)=>{const n=c[e]/255,o=l[e]/255,s=new Array(t+1);for(let e=0;e<=t;e++)s[e]=n+e/t*(o-n);return s.join(",")};return this.#addTransferMapConversion(a(0,5),a(1,5),a(2,5),i),n.url=this.#createUrl(u),n.url}addAlphaFilter(e){let t=this.#cache.get(e);if(t)return t;const[s]=this.#createTables([e]),o=`alpha_${s}`;if(t=this.#cache.get(o),t)return this.#cache.set(e,t),t;const i=`g_${this.#docId}_alpha_map_${this.#id++}`,n=this.#createUrl(i);this.#cache.set(e,n),this.#cache.set(o,n);const a=this.#createFilter(i);return this.#addTransferMapAlphaConversion(s,a),n}addLuminosityFilter(e){let t=this.#cache.get(e||"luminosity");if(t)return t;let s,n;if(e?([s]=this.#createTables([e]),n=`luminosity_${s}`):n="luminosity",t=this.#cache.get(n),t)return this.#cache.set(e,t),t;const i=`g_${this.#docId}_luminosity_map_${this.#id++}`,o=this.#createUrl(i);this.#cache.set(e,o),this.#cache.set(n,o);const a=this.#createFilter(i);return this.#addLuminosityConversion(a),e&&this.#addTransferMapAlphaConversion(s,a),o}addHighlightHCMFilter(e,t,n,s,o){const d=`${t}-${n}-${s}-${o}`;let i=this.#hcmCache.get(e);if(i?.key===d)return i.url;if(i?(i.filter?.remove(),i.key=d,i.url="none",i.filter=null):(i={key:d,url:"none",filter:null},this.#hcmCache.set(e,i)),!t||!n)return i.url;const[u,h]=[t,n].map(this.#getRGB.bind(this));let a=Math.round(.2126*u[0]+.7152*u[1]+.0722*u[2]),l=Math.round(.2126*h[0]+.7152*h[1]+.0722*h[2]),[r,c]=[s,o].map(this.#getRGB.bind(this));l<a&&([a,l,r,c]=[l,a,c,r]),this.#defs.style.color="";const m=(e,t,n)=>{const s=new Array(256),i=(l-a)/n,r=e/255,c=(t-e)/(255*n);let o=0;for(let e=0;e<=n;e++){const t=Math.round(a+e*i),l=r+e*c;for(let e=o;e<=t;e++)s[e]=l;o=t+1}for(let e=o;e<256;e++)s[e]=s[o-1];return s.join(",")},f=`g_${this.#docId}_hcm_${e}_filter`,p=i.filter=this.#createFilter(f);return this.#addGrayConversion(p),this.#addTransferMapConversion(m(r[0],c[0],5),m(r[1],c[1],5),m(r[2],c[2],5),p),i.url=this.#createUrl(f),i.url}destroy(e=!1){if(e&&this.#_hcmCache?.size)return;this.#_defs?.parentNode.parentNode.remove(),this.#_defs=null,this.#_cache?.clear(),this.#_cache=null,this.#_hcmCache?.clear(),this.#_hcmCache=null,this.#id=0}#addLuminosityConversion(e){const t=this.#document.createElementNS(SVG_NS,"feColorMatrix");t.setAttribute("type","matrix"),t.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0"),e.append(t)}#addGrayConversion(e){const t=this.#document.createElementNS(SVG_NS,"feColorMatrix");t.setAttribute("type","matrix"),t.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"),e.append(t)}#createFilter(e){const t=this.#document.createElementNS(SVG_NS,"filter");return t.setAttribute("color-interpolation-filters","sRGB"),t.setAttribute("id",e),this.#defs.append(t),t}#appendFeFunc(e,t,n){const s=this.#document.createElementNS(SVG_NS,t);s.setAttribute("type","discrete"),s.setAttribute("tableValues",n),e.append(s)}#addTransferMapConversion(e,t,n,s){const o=this.#document.createElementNS(SVG_NS,"feComponentTransfer");s.append(o),this.#appendFeFunc(o,"feFuncR",e),this.#appendFeFunc(o,"feFuncG",t),this.#appendFeFunc(o,"feFuncB",n)}#addTransferMapAlphaConversion(e,t){const n=this.#document.createElementNS(SVG_NS,"feComponentTransfer");t.append(n),this.#appendFeFunc(n,"feFuncA",e)}#getRGB(e){return this.#defs.style.color=e,getRGB(getComputedStyle(this.#defs).getPropertyValue("color"))}}class BaseStandardFontDataFactory{constructor({baseUrl:e=null}){this.baseUrl=e}async fetch({filename:e}){if(!this.baseUrl)throw new Error("Ensure that the `standardFontDataUrl` API parameter is provided.");if(!e)throw new Error("Font filename must be specified.");const t=`${this.baseUrl}${e}`;return this._fetch(t).catch(e=>{throw new Error(`Unable to load font data at: ${t}`)})}async _fetch(){unreachable("Abstract method `_fetch` called.")}}class DOMStandardFontDataFactory extends BaseStandardFontDataFactory{async _fetch(e){const t=await fetchData(e,"arraybuffer");return new Uint8Array(t)}}class BaseWasmFactory{constructor({baseUrl:e=null}){this.baseUrl=e}async fetch({filename:e}){if(!this.baseUrl)throw new Error("Ensure that the `wasmUrl` API parameter is provided.");if(!e)throw new Error("Wasm filename must be specified.");const t=`${this.baseUrl}${e}`;return this._fetch(t).catch(e=>{throw new Error(`Unable to load wasm data at: ${t}`)})}async _fetch(){unreachable("Abstract method `_fetch` called.")}}class DOMWasmFactory extends BaseWasmFactory{async _fetch(e){const t=await fetchData(e,"arraybuffer");return new Uint8Array(t)}}isNodeJS&&warn("Please use the `legacy` build in Node.js environments.");async function node_utils_fetchData(e){const t=process.getBuiltinModule("fs"),n=await t.promises.readFile(e);return new Uint8Array(n)}class NodeFilterFactory extends BaseFilterFactory{}class NodeCanvasFactory extends BaseCanvasFactory{_createCanvas(e,t){const n=process.getBuiltinModule("module").createRequire(import.meta.url),s=n("@napi-rs/canvas");return s.createCanvas(e,t)}}class NodeCMapReaderFactory extends BaseCMapReaderFactory{async _fetch(e){return node_utils_fetchData(e)}}class NodeStandardFontDataFactory extends BaseStandardFontDataFactory{async _fetch(e){return node_utils_fetchData(e)}}class NodeWasmFactory extends BaseWasmFactory{async _fetch(e){return node_utils_fetchData(e)}}const PathType={FILL:"Fill",STROKE:"Stroke",SHADING:"Shading"};function applyBoundingBox(e,t){if(!t)return;const s=t[2]-t[0],o=t[3]-t[1],n=new Path2D;n.rect(t[0],t[1],s,o),e.clip(n)}class BaseShadingPattern{isModifyingCurrentTransform(){return!1}getPattern(){unreachable("Abstract method `getPattern` called.")}}class RadialAxialShadingPattern extends BaseShadingPattern{constructor(e){super(),this._type=e[1],this._bbox=e[2],this._colorStops=e[3],this._p0=e[4],this._p1=e[5],this._r0=e[6],this._r1=e[7],this.matrix=null}_createGradient(e){let t;this._type==="axial"?t=e.createLinearGradient(this._p0[0],this._p0[1],this._p1[0],this._p1[1]):this._type==="radial"&&(t=e.createRadialGradient(this._p0[0],this._p0[1],this._r0,this._p1[0],this._p1[1],this._r1));for(const e of this._colorStops)t.addColorStop(e[0],e[1]);return t}getPattern(e,t,n,s){let o;if(s===PathType.STROKE||s===PathType.FILL){const a=t.current.getClippedPathBoundingBox(s,getCurrentTransform(e))||[0,0,0,0],c=Math.ceil(a[2]-a[0])||1,l=Math.ceil(a[3]-a[1])||1,r=t.cachedCanvases.getCanvas("pattern",c,l),i=r.context;i.clearRect(0,0,i.canvas.width,i.canvas.height),i.beginPath(),i.rect(0,0,i.canvas.width,i.canvas.height),i.translate(-a[0],-a[1]),n=Util.transform(n,[1,0,0,1,a[0],a[1]]),i.transform(...t.baseTransform),this.matrix&&i.transform(...this.matrix),applyBoundingBox(i,this._bbox),i.fillStyle=this._createGradient(i),i.fill(),o=e.createPattern(r.canvas,"no-repeat");const d=new DOMMatrix(n);o.setTransform(d)}else applyBoundingBox(e,this._bbox),o=this._createGradient(e);return o}}function drawTriangle(e,t,n,s,o,i,a,r){const c=t.coords,d=t.colors,w=e.data,L=e.width*4;let l;c[n+1]>c[s+1]&&(l=n,n=s,s=l,l=i,i=a,a=l),c[s+1]>c[o+1]&&(l=s,s=o,o=l,l=a,a=r,r=l),c[n+1]>c[s+1]&&(l=n,n=s,s=l,l=i,i=a,a=l);const g=(c[n]+t.offsetX)*t.scaleX,u=(c[n+1]+t.offsetY)*t.scaleY,k=(c[s]+t.offsetX)*t.scaleX,f=(c[s+1]+t.offsetY)*t.scaleY,z=(c[o]+t.offsetX)*t.scaleX,h=(c[o+1]+t.offsetY)*t.scaleY;if(u>=h)return;const j=d[i],y=d[i+1],_=d[i+2],x=d[a],E=d[a+1],C=d[a+2],F=d[r],S=d[r+1],M=d[r+2],N=Math.round(u),R=Math.round(h);let m,O,v,p,b,A,D,T;for(let t=N;t<=R;t++){if(t<f){const e=t<u?0:(u-t)/(u-f);m=g-(g-k)*e,O=j-(j-x)*e,v=y-(y-E)*e,p=_-(_-C)*e}else{let e;t>h?e=1:f===h?e=0:e=(f-t)/(f-h),m=k-(k-z)*e,O=x-(x-F)*e,v=E-(E-S)*e,p=C-(C-M)*e}let e;t<u?e=0:t>h?e=1:e=(u-t)/(u-h),b=g-(g-z)*e,A=j-(j-F)*e,D=y-(y-S)*e,T=_-(_-M)*e;const s=Math.round(Math.min(m,b)),o=Math.round(Math.max(m,b));let n=L*t+s*4;for(let t=s;t<=o;t++)e=(m-t)/(m-b),e<0?e=0:e>1&&(e=1),w[n++]=O-(O-A)*e|0,w[n++]=v-(v-D)*e|0,w[n++]=p-(p-T)*e|0,w[n++]=255}}function drawFigure(e,t,n){const o=t.coords,i=t.colors;let s,a;switch(t.type){case"lattice":const r=t.verticesPerRow,c=Math.floor(o.length/r)-1,l=r-1;for(s=0;s<c;s++){let t=s*r;for(let s=0;s<l;s++,t++)drawTriangle(e,n,o[t],o[t+1],o[t+r],i[t],i[t+1],i[t+r]),drawTriangle(e,n,o[t+r+1],o[t+1],o[t+r],i[t+r+1],i[t+1],i[t+r])}break;case"triangles":for(s=0,a=o.length;s<a;s+=3)drawTriangle(e,n,o[s],o[s+1],o[s+2],i[s],i[s+1],i[s+2]);break;default:throw new Error("illegal figure")}}class MeshShadingPattern extends BaseShadingPattern{constructor(e){super(),this._coords=e[2],this._colors=e[3],this._figures=e[4],this._bounds=e[5],this._bbox=e[6],this._background=e[7],this.matrix=null}_createMeshCanvas(e,t,n){const m=1.1,h=3e3,s=2,i=Math.floor(this._bounds[0]),r=Math.floor(this._bounds[1]),u=Math.ceil(this._bounds[2])-i,g=Math.ceil(this._bounds[3])-r,d=Math.min(Math.ceil(Math.abs(u*e[0]*m)),h),o=Math.min(Math.ceil(Math.abs(g*e[1]*m)),h),a=u/d,c=g/o,v={coords:this._coords,colors:this._colors,offsetX:-i,offsetY:-r,scaleX:1/a,scaleY:1/c},b=d+s*2,j=o+s*2,f=n.getCanvas("mesh",b,j),p=f.context,l=p.createImageData(d,o);if(t){const e=l.data;for(let n=0,s=e.length;n<s;n+=4)e[n]=t[0],e[n+1]=t[1],e[n+2]=t[2],e[n+3]=255}for(const e of this._figures)drawFigure(l,e,v);p.putImageData(l,s,s);const y=f.canvas;return{canvas:y,offsetX:i-s*a,offsetY:r-s*c,scaleX:a,scaleY:c}}isModifyingCurrentTransform(){return!0}getPattern(e,t,n,s){applyBoundingBox(e,this._bbox);const o=new Float32Array(2);if(s===PathType.SHADING)Util.singularValueDecompose2dScale(getCurrentTransform(e),o);else if(this.matrix){Util.singularValueDecompose2dScale(this.matrix,o);const[e,n]=o;Util.singularValueDecompose2dScale(t.baseTransform,o),o[0]*=e,o[1]*=n}else Util.singularValueDecompose2dScale(t.baseTransform,o);const i=this._createMeshCanvas(o,s===PathType.SHADING?null:this._background,t.cachedCanvases);return s!==PathType.SHADING&&(e.setTransform(...t.baseTransform),this.matrix&&e.transform(...this.matrix)),e.translate(i.offsetX,i.offsetY),e.scale(i.scaleX,i.scaleY),e.createPattern(i.canvas,"no-repeat")}}class DummyShadingPattern extends BaseShadingPattern{getPattern(){return"hotpink"}}function getShadingPattern(e){switch(e[0]){case"RadialAxial":return new RadialAxialShadingPattern(e);case"Mesh":return new MeshShadingPattern(e);case"Dummy":return new DummyShadingPattern}throw new Error(`Unknown IR type: ${e[0]}`)}const PaintType={COLORED:1,UNCOLORED:2};class TilingPattern{static MAX_PATTERN_SIZE=3e3;constructor(e,t,n,s){this.color=e[1],this.operatorList=e[2],this.matrix=e[3],this.bbox=e[4],this.xstep=e[5],this.ystep=e[6],this.paintType=e[7],this.tilingType=e[8],this.ctx=t,this.canvasGraphicsFactory=n,this.baseTransform=s}createPatternCanvas(e){const{bbox:c,operatorList:T,paintType:F,tilingType:M,color:S,canvasGraphicsFactory:A}=this;let{xstep:n,ystep:s}=this;n=Math.abs(n),s=Math.abs(s),info("TilingType: "+M);const a=c[0],i=c[1],_=c[2],y=c[3],b=_-a,v=y-i,o=new Float32Array(2);Util.singularValueDecompose2dScale(this.matrix,o);const[O,w]=o;Util.singularValueDecompose2dScale(this.baseTransform,o);const m=O*o[0],h=w*o[1];let u=b,d=v,g=!1,r=!1;const x=Math.ceil(n*m),C=Math.ceil(s*h),E=Math.ceil(b*m),k=Math.ceil(v*h);x>=E?u=n:g=!0,C>=k?d=s:r=!0;const f=this.getSizeAndScale(u,this.ctx.canvas.width,m),l=this.getSizeAndScale(d,this.ctx.canvas.height,h),j=e.cachedCanvases.getCanvas("pattern",f.size,l.size),p=j.context,t=A.createCanvasGraphics(p);if(t.groupLevel=e.groupLevel,this.setFillAndStrokeStyleToContext(t,F,S),p.translate(-f.scale*a,-l.scale*i),t.transform(f.scale,0,0,l.scale,0,0),p.save(),this.clipBbox(t,a,i,_,y),t.baseTransform=getCurrentTransform(t.ctx),t.executeOperatorList(T),t.endDrawing(),p.restore(),g||r){const p=j.canvas;g&&(u=n),r&&(d=s);const c=this.getSizeAndScale(u,this.ctx.canvas.width,m),l=this.getSizeAndScale(d,this.ctx.canvas.height,h),t=c.size,o=l.size,f=e.cachedCanvases.getCanvas("pattern-workaround",t,o),y=f.context,_=g?Math.floor(b/n):0,w=r?Math.floor(v/s):0;for(let e=0;e<=_;e++)for(let n=0;n<=w;n++)y.drawImage(p,t*e,o*n,t,o,0,0,t,o);return{canvas:f.canvas,scaleX:c.scale,scaleY:l.scale,offsetX:a,offsetY:i}}return{canvas:j.canvas,scaleX:f.scale,scaleY:l.scale,offsetX:a,offsetY:i}}getSizeAndScale(e,t,n){const o=Math.max(TilingPattern.MAX_PATTERN_SIZE,t);let s=Math.ceil(e*n);return s>=o?s=o:n=s/e,{scale:n,size:s}}clipBbox(e,t,n,s,o){const i=s-t,a=o-n;e.ctx.rect(t,n,i,a),Util.axialAlignedBoundingBox([t,n,s,o],getCurrentTransform(e.ctx),e.current.minMax),e.clip(),e.endPath()}setFillAndStrokeStyleToContext(e,t,n){const s=e.ctx,o=e.current;switch(t){case PaintType.COLORED:const{fillStyle:e,strokeStyle:i}=this.ctx;s.fillStyle=o.fillColor=e,s.strokeStyle=o.strokeColor=i;break;case PaintType.UNCOLORED:s.fillStyle=s.strokeStyle=n,o.fillColor=o.strokeColor=n;break;default:throw new FormatError(`Unsupported paint type: ${t}`)}}isModifyingCurrentTransform(){return!1}getPattern(e,t,n,s){let o=n;s!==PathType.SHADING&&(o=Util.transform(o,t.baseTransform),this.matrix&&(o=Util.transform(o,this.matrix)));const i=this.createPatternCanvas(t);let a=new DOMMatrix(o);a=a.translate(i.offsetX,i.offsetY),a=a.scale(1/i.scaleX,1/i.scaleY);const r=e.createPattern(i.canvas,"repeat");return r.setTransform(a),r}}function convertToRGBA(e){switch(e.kind){case ImageKind.GRAYSCALE_1BPP:return convertBlackAndWhiteToRGBA(e);case ImageKind.RGB_24BPP:return convertRGBToRGBA(e)}return null}function convertBlackAndWhiteToRGBA({src:e,srcPos:t=0,dest:n,width:s,height:o,nonBlackColor:i=4294967295,inverseDecode:a=!1}){const d=util_FeatureTest.isLittleEndian?4278190080:255,[c,l]=a?[i,d]:[d,i],m=s>>3,u=s&7,h=e.length;n=new Uint32Array(n.buffer);let r=0;for(let s=0;s<o;s++){for(const o=t+m;t<o;t++){const s=t<h?e[t]:255;n[r++]=s&128?l:c,n[r++]=s&64?l:c,n[r++]=s&32?l:c,n[r++]=s&16?l:c,n[r++]=s&8?l:c,n[r++]=s&4?l:c,n[r++]=s&2?l:c,n[r++]=s&1?l:c}if(u===0)continue;const i=t<h?e[t++]:255;for(let e=0;e<u;e++)n[r++]=i&1<<7-e?l:c}return{srcPos:t,destPos:r}}function convertRGBToRGBA({src:e,srcPos:t=0,dest:n,destPos:s=0,width:o,height:i}){let a=0;const c=o*i*3,l=c>>2,r=new Uint32Array(e.buffer,t,l);if(FeatureTest.isLittleEndian){for(;a<l-2;a+=3,s+=4){const e=r[a],t=r[a+1],o=r[a+2];n[s]=e|4278190080,n[s+1]=e>>>24|t<<8|4278190080,n[s+2]=t>>>16|o<<16|4278190080,n[s+3]=o>>>8|4278190080}for(let o=a*4,i=t+c;o<i;o+=3)n[s++]=e[o]|e[o+1]<<8|e[o+2]<<16|4278190080}else{for(;a<l-2;a+=3,s+=4){const e=r[a],t=r[a+1],o=r[a+2];n[s]=e|255,n[s+1]=e<<24|t>>>8|255,n[s+2]=t<<16|o>>>16|255,n[s+3]=o<<8|255}for(let o=a*4,i=t+c;o<i;o+=3)n[s++]=e[o]<<24|e[o+1]<<16|e[o+2]<<8|255}return{srcPos:t+c,destPos:s}}function grayToRGBA(e,t){if(FeatureTest.isLittleEndian)for(let n=0,s=e.length;n<s;n++)t[n]=e[n]*65793|4278190080;else for(let n=0,s=e.length;n<s;n++)t[n]=e[n]*16843008|255}const MIN_FONT_SIZE=16,MAX_FONT_SIZE=100,EXECUTION_TIME=15,EXECUTION_STEPS=10,FULL_CHUNK_HEIGHT=16,SCALE_MATRIX=new DOMMatrix,XY=new Float32Array(2),MIN_MAX_INIT=new Float32Array([1/0,1/0,-(1/0),-(1/0)]);function mirrorContextOperations(e,t){if(e._removeMirroring)throw new Error("Context is already forwarding operations.");e.__originalSave=e.save,e.__originalRestore=e.restore,e.__originalRotate=e.rotate,e.__originalScale=e.scale,e.__originalTranslate=e.translate,e.__originalTransform=e.transform,e.__originalSetTransform=e.setTransform,e.__originalResetTransform=e.resetTransform,e.__originalClip=e.clip,e.__originalMoveTo=e.moveTo,e.__originalLineTo=e.lineTo,e.__originalBezierCurveTo=e.bezierCurveTo,e.__originalRect=e.rect,e.__originalClosePath=e.closePath,e.__originalBeginPath=e.beginPath,e._removeMirroring=()=>{e.save=e.__originalSave,e.restore=e.__originalRestore,e.rotate=e.__originalRotate,e.scale=e.__originalScale,e.translate=e.__originalTranslate,e.transform=e.__originalTransform,e.setTransform=e.__originalSetTransform,e.resetTransform=e.__originalResetTransform,e.clip=e.__originalClip,e.moveTo=e.__originalMoveTo,e.lineTo=e.__originalLineTo,e.bezierCurveTo=e.__originalBezierCurveTo,e.rect=e.__originalRect,e.closePath=e.__originalClosePath,e.beginPath=e.__originalBeginPath,delete e._removeMirroring},e.save=function(){t.save(),this.__originalSave()},e.restore=function(){t.restore(),this.__originalRestore()},e.translate=function(e,n){t.translate(e,n),this.__originalTranslate(e,n)},e.scale=function(e,n){t.scale(e,n),this.__originalScale(e,n)},e.transform=function(e,n,s,o,i,a){t.transform(e,n,s,o,i,a),this.__originalTransform(e,n,s,o,i,a)},e.setTransform=function(e,n,s,o,i,a){t.setTransform(e,n,s,o,i,a),this.__originalSetTransform(e,n,s,o,i,a)},e.resetTransform=function(){t.resetTransform(),this.__originalResetTransform()},e.rotate=function(e){t.rotate(e),this.__originalRotate(e)},e.clip=function(e){t.clip(e),this.__originalClip(e)},e.moveTo=function(e,n){t.moveTo(e,n),this.__originalMoveTo(e,n)},e.lineTo=function(e,n){t.lineTo(e,n),this.__originalLineTo(e,n)},e.bezierCurveTo=function(e,n,s,o,i,a){t.bezierCurveTo(e,n,s,o,i,a),this.__originalBezierCurveTo(e,n,s,o,i,a)},e.rect=function(e,n,s,o){t.rect(e,n,s,o),this.__originalRect(e,n,s,o)},e.closePath=function(){t.closePath(),this.__originalClosePath()},e.beginPath=function(){t.beginPath(),this.__originalBeginPath()}}class CachedCanvases{constructor(e){this.canvasFactory=e,this.cache=Object.create(null)}getCanvas(e,t,n){let s;return this.cache[e]!==void 0?(s=this.cache[e],this.canvasFactory.reset(s,t,n)):(s=this.canvasFactory.create(t,n),this.cache[e]=s),s}delete(e){delete this.cache[e]}clear(){for(const e in this.cache){const t=this.cache[e];this.canvasFactory.destroy(t),delete this.cache[e]}}}function drawImageAtIntegerCoords(e,t,n,s,o,i,a,r,c,l){const[d,u,h,m,f,p]=getCurrentTransform(e);if(u===0&&h===0){const y=a*d+f,g=Math.round(y),_=r*m+p,v=Math.round(_),w=(a+c)*d+f,b=Math.abs(Math.round(w)-g)||1,O=(r+l)*m+p,j=Math.abs(Math.round(O)-v)||1;return e.setTransform(Math.sign(d),0,0,Math.sign(m),g,v),e.drawImage(t,n,s,o,i,0,0,b,j),e.setTransform(d,u,h,m,f,p),[b,j]}if(d===0&&m===0){const y=r*h+f,g=Math.round(y),_=a*u+p,v=Math.round(_),w=(r+l)*h+f,b=Math.abs(Math.round(w)-g)||1,O=(a+c)*u+p,j=Math.abs(Math.round(O)-v)||1;return e.setTransform(0,Math.sign(u),Math.sign(h),0,g,v),e.drawImage(t,n,s,o,i,0,0,j,b),e.setTransform(d,u,h,m,f,p),[j,b]}e.drawImage(t,n,s,o,i,a,r,c,l);const g=Math.hypot(d,u),v=Math.hypot(h,m);return[g*c,v*l]}class CanvasExtraState{alphaIsShape=!1;fontSize=0;fontSizeScale=1;textMatrix=null;textMatrixScale=1;fontMatrix=FONT_IDENTITY_MATRIX;leading=0;x=0;y=0;lineX=0;lineY=0;charSpacing=0;wordSpacing=0;textHScale=1;textRenderingMode=TextRenderingMode.FILL;textRise=0;fillColor="#000000";strokeColor="#000000";patternFill=!1;patternStroke=!1;fillAlpha=1;strokeAlpha=1;lineWidth=1;activeSMask=null;transferMaps="none";constructor(e,t){this.clipBox=new Float32Array([0,0,e,t]),this.minMax=MIN_MAX_INIT.slice()}clone(){const e=Object.create(this);return e.clipBox=this.clipBox.slice(),e.minMax=this.minMax.slice(),e}getPathBoundingBox(e=PathType.FILL,t=null){const n=this.minMax.slice();if(e===PathType.STROKE){t||unreachable("Stroke bounding box must include transform."),Util.singularValueDecompose2dScale(t,XY);const e=XY[0]*this.lineWidth/2,s=XY[1]*this.lineWidth/2;n[0]-=e,n[1]-=s,n[2]+=e,n[3]+=s}return n}updateClipFromPath(){const e=Util.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(e||[0,0,0,0])}isEmptyClip(){return this.minMax[0]===1/0}startNewPathAndClipBox(e){this.clipBox.set(e,0),this.minMax.set(MIN_MAX_INIT,0)}getClippedPathBoundingBox(e=PathType.FILL,t=null){return Util.intersect(this.clipBox,this.getPathBoundingBox(e,t))}}function putBinaryImageData(e,t){if(t instanceof ImageData){e.putImageData(t,0,0);return}const p=t.height,l=t.width,m=p%FULL_CHUNK_HEIGHT,h=(p-m)/FULL_CHUNK_HEIGHT,f=m===0?h:h+1,u=e.createImageData(l,FULL_CHUNK_HEIGHT);let o=0,n;const r=t.data,a=u.data;let s,i,d,c;if(t.kind===util_ImageKind.GRAYSCALE_1BPP){const g=r.byteLength,t=new Uint32Array(a.buffer,0,a.byteLength>>2),v=t.length,b=l+7>>3,c=4294967295,p=util_FeatureTest.isLittleEndian?4278190080:255;for(s=0;s<f;s++){d=s<h?FULL_CHUNK_HEIGHT:m,n=0;for(i=0;i<d;i++){const u=g-o;let s=0;const h=u>b?l:u*8-7,m=h&~7;let a=0,e=0;for(;s<m;s+=8)e=r[o++],t[n++]=e&128?c:p,t[n++]=e&64?c:p,t[n++]=e&32?c:p,t[n++]=e&16?c:p,t[n++]=e&8?c:p,t[n++]=e&4?c:p,t[n++]=e&2?c:p,t[n++]=e&1?c:p;for(;s<h;s++)a===0&&(e=r[o++],a=128),t[n++]=e&a?c:p,a>>=1}for(;n<v;)t[n++]=0;e.putImageData(u,0,s*FULL_CHUNK_HEIGHT)}}else if(t.kind===util_ImageKind.RGBA_32BPP){i=0,c=l*FULL_CHUNK_HEIGHT*4;for(s=0;s<h;s++)a.set(r.subarray(o,o+c)),o+=c,e.putImageData(u,0,i),i+=FULL_CHUNK_HEIGHT;s<f&&(c=l*m*4,a.set(r.subarray(o,o+c)),e.putImageData(u,0,i))}else if(t.kind===util_ImageKind.RGB_24BPP){d=FULL_CHUNK_HEIGHT,c=l*d;for(s=0;s<f;s++){s>=h&&(d=m,c=l*d),n=0;for(i=c;i--;)a[n++]=r[o++],a[n++]=r[o++],a[n++]=r[o++],a[n++]=255;e.putImageData(u,0,s*FULL_CHUNK_HEIGHT)}}else throw new Error(`bad image kind: ${t.kind}`)}function putBinaryImageMask(e,t){if(t.bitmap){e.drawImage(t.bitmap,0,0);return}const o=t.height,i=t.width,n=o%FULL_CHUNK_HEIGHT,s=(o-n)/FULL_CHUNK_HEIGHT,c=n===0?s:s+1,a=e.createImageData(i,FULL_CHUNK_HEIGHT);let r=0;const l=t.data,d=a.data;for(let t=0;t<c;t++){const o=t<s?FULL_CHUNK_HEIGHT:n;({srcPos:r}=convertBlackAndWhiteToRGBA({src:l,srcPos:r,dest:d,width:i,height:o,nonBlackColor:0}),e.putImageData(a,0,t*FULL_CHUNK_HEIGHT))}}function copyCtxState(e,t){const n=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(const s of n)e[s]!==void 0&&(t[s]=e[s]);e.setLineDash!==void 0&&(t.setLineDash(e.getLineDash()),t.lineDashOffset=e.lineDashOffset)}function resetCtxToDefault(e){e.strokeStyle=e.fillStyle="#000000",e.fillRule="nonzero",e.globalAlpha=1,e.lineWidth=1,e.lineCap="butt",e.lineJoin="miter",e.miterLimit=10,e.globalCompositeOperation="source-over",e.font="10px sans-serif",e.setLineDash!==void 0&&(e.setLineDash([]),e.lineDashOffset=0);const{filter:t}=e;t!=="none"&&t!==""&&(e.filter="none")}function getImageSmoothingEnabled(e,t){if(t)return!0;Util.singularValueDecompose2dScale(e,XY);const n=Math.fround(OutputScale.pixelRatio*PixelsPerInch.PDF_TO_CSS_UNITS);return XY[0]<=n&&XY[1]<=n}const LINE_CAP_STYLES=["butt","round","square"],LINE_JOIN_STYLES=["miter","round","bevel"],NORMAL_CLIP={},EO_CLIP={};class CanvasGraphics{constructor(e,t,n,s,o,{optionalContentConfig:i,markedContentStack:a=null},r,c){this.ctx=e,this.current=new CanvasExtraState(this.ctx.canvas.width,this.ctx.canvas.height),this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=t,this.objs=n,this.canvasFactory=s,this.filterFactory=o,this.groupStack=[],this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.suspendedCtx=null,this.contentVisible=!0,this.markedContentStack=a||[],this.optionalContentConfig=i,this.cachedCanvases=new CachedCanvases(this.canvasFactory),this.cachedPatterns=new Map,this.annotationCanvasMap=r,this.viewportScale=1,this.outputScaleX=1,this.outputScaleY=1,this.pageColors=c,this._cachedScaleForStroking=[-1,0],this._cachedGetSinglePixelWidth=null,this._cachedBitmapsMap=new Map}getObject(e,t=null){return typeof e=="string"?e.startsWith("g_")?this.commonObjs.get(e):this.objs.get(e):t}beginDrawing({transform:e,viewport:t,transparency:n=!1,background:s=null}){const o=this.ctx.canvas.width,i=this.ctx.canvas.height,a=this.ctx.fillStyle;if(this.ctx.fillStyle=s||"#ffffff",this.ctx.fillRect(0,0,o,i),this.ctx.fillStyle=a,n){const e=this.cachedCanvases.getCanvas("transparent",o,i);this.compositeCtx=this.ctx,this.transparentCanvas=e.canvas,this.ctx=e.context,this.ctx.save(),this.ctx.transform(...getCurrentTransform(this.compositeCtx))}this.ctx.save(),resetCtxToDefault(this.ctx),e&&(this.ctx.transform(...e),this.outputScaleX=e[0],this.outputScaleY=e[0]),this.ctx.transform(...t.transform),this.viewportScale=t.scale,this.baseTransform=getCurrentTransform(this.ctx)}executeOperatorList(e,t,n,s){const i=e.argsArray,d=e.fnArray;let o=t||0;const a=i.length;if(a===o)return o;const c=a-o>EXECUTION_STEPS&&typeof n=="function",u=c?Date.now()+EXECUTION_TIME:0;let l=0;const h=this.commonObjs,m=this.objs;let r;for(;!0;){if(s!==void 0&&o===s.nextBreakPoint)return s.breakIt(o,n),o;if(r=d[o],r!==OPS.dependency)this[r].apply(this,i[o]);else for(const e of i[o]){const t=e.startsWith("g_")?h:m;if(!t.has(e))return t.get(e,n),o}if(o++,o===a)return o;if(c&&++l>EXECUTION_STEPS){if(Date.now()>u)return n(),o;l=0}}}#restoreInitialState(){for(;this.stateStack.length||this.inSMaskMode;)this.restore();this.current.activeSMask=null,this.ctx.restore(),this.transparentCanvas&&(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),this.transparentCanvas=null)}endDrawing(){this.#restoreInitialState(),this.cachedCanvases.clear(),this.cachedPatterns.clear();for(const e of this._cachedBitmapsMap.values()){for(const t of e.values())typeof HTMLCanvasElement!="undefined"&&t instanceof HTMLCanvasElement&&(t.width=t.height=0);e.clear()}this._cachedBitmapsMap.clear(),this.#drawFilter()}#drawFilter(){if(this.pageColors){const e=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(e!=="none"){const t=this.ctx.filter;this.ctx.filter=e,this.ctx.drawImage(this.ctx.canvas,0,0),this.ctx.filter=t}}}_scaleImage(e,t){const l=e.width??e.displayWidth,d=e.height??e.displayHeight;let o=Math.max(Math.hypot(t[0],t[1]),1),i=Math.max(Math.hypot(t[2],t[3]),1),n=l,s=d,a="prescale1",r,c;for(;o>2&&n>1||i>2&&s>1;){let t=n,l=s;o>2&&n>1&&(t=n>=16384?Math.floor(n/2)-1||1:Math.ceil(n/2),o/=n/t),i>2&&s>1&&(l=s>=16384?Math.floor(s/2)-1||1:Math.ceil(s)/2,i/=s/l),r=this.cachedCanvases.getCanvas(a,t,l),c=r.context,c.clearRect(0,0,t,l),c.drawImage(e,0,0,n,s,0,0,t,l),e=r.canvas,n=t,s=l,a=a==="prescale1"?"prescale2":"prescale1"}return{img:e,paintWidth:n,paintHeight:s}}_createMaskCanvas(e){const p=this.ctx,{width:a,height:i}=e,f=this.current.fillColor,r=this.current.patternFill,s=getCurrentTransform(p);let o,l,t,u;if((e.bitmap||e.data)&&e.count>1){const i=e.bitmap||e.data.buffer;l=JSON.stringify(r?s:[s.slice(0,4),f]),o=this._cachedBitmapsMap.get(i),o||(o=new Map,this._cachedBitmapsMap.set(i,o));const n=o.get(l);if(n&&!r){const e=Math.round(Math.min(s[0],s[2])+s[4]),t=Math.round(Math.min(s[1],s[3])+s[5]);return{canvas:n,offsetX:e,offsetY:t}}t=n}t||(u=this.cachedCanvases.getCanvas("maskCanvas",a,i),putBinaryImageMask(u.context,e));let c=Util.transform(s,[1/a,0,0,-1/i,0,0]);c=Util.transform(c,[1,0,0,1,0,-i]);const g=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,a,i],c,g);const[v,b,j,w]=g,_=Math.round(j-v)||1,y=Math.round(w-b)||1,d=this.cachedCanvases.getCanvas("fillCanvas",_,y),n=d.context,m=v,h=b;n.translate(-m,-h),n.transform(...c),t||(t=this._scaleImage(u.canvas,getCurrentTransformInverse(n)),t=t.img,o&&r&&o.set(l,t)),n.imageSmoothingEnabled=getImageSmoothingEnabled(getCurrentTransform(n),e.interpolate),drawImageAtIntegerCoords(n,t,0,0,t.width,t.height,0,0,a,i),n.globalCompositeOperation="source-in";const O=Util.transform(getCurrentTransformInverse(n),[1,0,0,1,-m,-h]);return n.fillStyle=r?f.getPattern(p,this,O,PathType.FILL):f,n.fillRect(0,0,a,i),o&&!r&&(this.cachedCanvases.delete("fillCanvas"),o.set(l,d.canvas)),{canvas:d.canvas,offsetX:Math.round(m),offsetY:Math.round(h)}}setLineWidth(e){e!==this.current.lineWidth&&(this._cachedScaleForStroking[0]=-1),this.current.lineWidth=e,this.ctx.lineWidth=e}setLineCap(e){this.ctx.lineCap=LINE_CAP_STYLES[e]}setLineJoin(e){this.ctx.lineJoin=LINE_JOIN_STYLES[e]}setMiterLimit(e){this.ctx.miterLimit=e}setDash(e,t){const n=this.ctx;n.setLineDash!==void 0&&(n.setLineDash(e),n.lineDashOffset=t)}setRenderingIntent(){}setFlatness(){}setGState(e){for(const[n,t]of e)switch(n){case"LW":this.setLineWidth(t);break;case"LC":this.setLineCap(t);break;case"LJ":this.setLineJoin(t);break;case"ML":this.setMiterLimit(t);break;case"D":this.setDash(t[0],t[1]);break;case"RI":this.setRenderingIntent(t);break;case"FL":this.setFlatness(t);break;case"Font":this.setFont(t[0],t[1]);break;case"CA":this.current.strokeAlpha=t;break;case"ca":this.ctx.globalAlpha=this.current.fillAlpha=t;break;case"BM":this.ctx.globalCompositeOperation=t;break;case"SMask":this.current.activeSMask=t?this.tempSMask:null,this.tempSMask=null,this.checkSMaskState();break;case"TR":this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(t);break}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){const e=this.inSMaskMode;this.current.activeSMask&&!e?this.beginSMaskMode():!this.current.activeSMask&&e&&this.endSMaskMode()}beginSMaskMode(){if(this.inSMaskMode)throw new Error("beginSMaskMode called while already in smask mode");const t=this.ctx.canvas.width,n=this.ctx.canvas.height,s="smaskGroupAt"+this.groupLevel,o=this.cachedCanvases.getCanvas(s,t,n);this.suspendedCtx=this.ctx;const e=this.ctx=o.context;e.setTransform(this.suspendedCtx.getTransform()),copyCtxState(this.suspendedCtx,e),mirrorContextOperations(e,this.suspendedCtx),this.setGState([["BM","source-over"]])}endSMaskMode(){if(!this.inSMaskMode)throw new Error("endSMaskMode called while not in smask mode");this.ctx._removeMirroring(),copyCtxState(this.ctx,this.suspendedCtx),this.ctx=this.suspendedCtx,this.suspendedCtx=null}compose(e){if(!this.current.activeSMask)return;e?(e[0]=Math.floor(e[0]),e[1]=Math.floor(e[1]),e[2]=Math.ceil(e[2]),e[3]=Math.ceil(e[3])):e=[0,0,this.ctx.canvas.width,this.ctx.canvas.height];const t=this.current.activeSMask,n=this.suspendedCtx;this.composeSMask(n,t,this.ctx,e),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}composeSMask(e,t,n,s){const o=s[0],i=s[1],a=s[2]-o,r=s[3]-i;if(a===0||r===0)return;this.genericComposeSMask(t.context,n,a,r,t.subtype,t.backdrop,t.transferMap,o,i,t.offsetX,t.offsetY),e.save(),e.globalAlpha=1,e.globalCompositeOperation="source-over",e.setTransform(1,0,0,1,0,0),e.drawImage(n.canvas,0,0),e.restore()}genericComposeSMask(e,t,n,s,o,i,a,r,c,l,d){let m=e.canvas,u=r-l,h=c-d;if(i)if(u<0||h<0||u+n>m.width||h+s>m.height){const t=this.cachedCanvases.getCanvas("maskExtension",n,s),e=t.context;e.drawImage(m,-u,-h),e.globalCompositeOperation="destination-atop",e.fillStyle=i,e.fillRect(0,0,n,s),e.globalCompositeOperation="source-over",m=t.canvas,u=h=0}else{e.save(),e.globalAlpha=1,e.setTransform(1,0,0,1,0,0);const t=new Path2D;t.rect(u,h,n,s),e.clip(t),e.globalCompositeOperation="destination-atop",e.fillStyle=i,e.fillRect(u,h,n,s),e.restore()}t.save(),t.globalAlpha=1,t.setTransform(1,0,0,1,0,0),o==="Alpha"&&a?t.filter=this.filterFactory.addAlphaFilter(a):o==="Luminosity"&&(t.filter=this.filterFactory.addLuminosityFilter(a));const f=new Path2D;f.rect(r,c,n,s),t.clip(f),t.globalCompositeOperation="destination-in",t.drawImage(m,u,h,n,s,r,c,n,s),t.restore()}save(){this.inSMaskMode&&copyCtxState(this.ctx,this.suspendedCtx),this.ctx.save();const e=this.current;this.stateStack.push(e),this.current=e.clone()}restore(){if(this.stateStack.length===0){this.inSMaskMode&&this.endSMaskMode();return}this.current=this.stateStack.pop(),this.ctx.restore(),this.inSMaskMode&&copyCtxState(this.suspendedCtx,this.ctx),this.checkSMaskState(),this.pendingClip=null,this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}transform(e,t,n,s,o,i){this.ctx.transform(e,t,n,s,o,i),this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}constructPath(e,t,n){let[s]=t;if(!n){s||=t[0]=new Path2D,this[e](s);return}if(!(s instanceof Path2D)){const e=t[0]=new Path2D;for(let t=0,n=s.length;t<n;)switch(s[t++]){case DrawOPS.moveTo:e.moveTo(s[t++],s[t++]);break;case DrawOPS.lineTo:e.lineTo(s[t++],s[t++]);break;case DrawOPS.curveTo:e.bezierCurveTo(s[t++],s[t++],s[t++],s[t++],s[t++],s[t++]);break;case DrawOPS.closePath:e.closePath();break;default:warn(`Unrecognized drawing path operator: ${s[t-1]}`);break}s=e}Util.axialAlignedBoundingBox(n,getCurrentTransform(this.ctx),this.current.minMax),this[e](s)}closePath(){this.ctx.closePath()}stroke(e,t=!0){const n=this.ctx,s=this.current.strokeColor;if(n.globalAlpha=this.current.strokeAlpha,this.contentVisible)if(typeof s=="object"&&s?.getPattern){const t=s.isModifyingCurrentTransform()?n.getTransform():null;if(n.save(),n.strokeStyle=s.getPattern(n,this,getCurrentTransformInverse(n),PathType.STROKE),t){const s=new Path2D;s.addPath(e,n.getTransform().invertSelf().multiplySelf(t)),e=s}this.rescaleAndStroke(e,!1),n.restore()}else this.rescaleAndStroke(e,!0);t&&this.consumePath(e,this.current.getClippedPathBoundingBox(PathType.STROKE,getCurrentTransform(this.ctx))),n.globalAlpha=this.current.fillAlpha}closeStroke(e){this.stroke(e)}fill(e,t=!0){const n=this.ctx,s=this.current.fillColor,a=this.current.patternFill;let o=!1;if(a){const t=s.isModifyingCurrentTransform()?n.getTransform():null;if(n.save(),n.fillStyle=s.getPattern(n,this,getCurrentTransformInverse(n),PathType.FILL),t){const s=new Path2D;s.addPath(e,n.getTransform().invertSelf().multiplySelf(t)),e=s}o=!0}const i=this.current.getClippedPathBoundingBox();this.contentVisible&&i!==null&&(this.pendingEOFill?(n.fill(e,"evenodd"),this.pendingEOFill=!1):n.fill(e)),o&&n.restore(),t&&this.consumePath(e,i)}eoFill(e){this.pendingEOFill=!0,this.fill(e)}fillStroke(e){this.fill(e,!1),this.stroke(e,!1),this.consumePath(e)}eoFillStroke(e){this.pendingEOFill=!0,this.fillStroke(e)}closeFillStroke(e){this.fillStroke(e)}closeEOFillStroke(e){this.pendingEOFill=!0,this.fillStroke(e)}endPath(e){this.consumePath(e)}rawFillPath(e){this.ctx.fill(e)}clip(){this.pendingClip=NORMAL_CLIP}eoClip(){this.pendingClip=EO_CLIP}beginText(){this.current.textMatrix=null,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0}endText(){const e=this.pendingTextPaths,t=this.ctx;if(e===void 0)return;const n=new Path2D,s=t.getTransform().invertSelf();for(const{transform:o,x:i,y:a,fontSize:t,path:r}of e)n.addPath(r,new DOMMatrix(o).preMultiplySelf(s).translate(i,a).scale(t,-t));t.clip(n),delete this.pendingTextPaths}setCharSpacing(e){this.current.charSpacing=e}setWordSpacing(e){this.current.wordSpacing=e}setHScale(e){this.current.textHScale=e/100}setLeading(e){this.current.leading=-e}setFont(e,t){const n=this.commonObjs.get(e),s=this.current;if(!n)throw new Error(`Can't find font for ${e}`);if(s.fontMatrix=n.fontMatrix||FONT_IDENTITY_MATRIX,(s.fontMatrix[0]===0||s.fontMatrix[3]===0)&&warn("Invalid font matrix for font "+e),t<0?(t=-t,s.fontDirection=-1):s.fontDirection=1,this.current.font=n,this.current.fontSize=t,n.isType3Font)return;const a=n.loadedName||"sans-serif",r=n.systemFontInfo?.css||`"${a}", ${n.fallbackName}`;let i="normal";n.black?i="900":n.bold&&(i="bold");const c=n.italic?"italic":"normal";let o=t;t<MIN_FONT_SIZE?o=MIN_FONT_SIZE:t>MAX_FONT_SIZE&&(o=MAX_FONT_SIZE),this.current.fontSizeScale=t/o,this.ctx.font=`${c} ${i} ${o}px ${r}`}setTextRenderingMode(e){this.current.textRenderingMode=e}setTextRise(e){this.current.textRise=e}moveText(e,t){this.current.x=this.current.lineX+=e,this.current.y=this.current.lineY+=t}setLeadingMoveText(e,t){this.setLeading(-t),this.moveText(e,t)}setTextMatrix(e){const{current:t}=this;t.textMatrix=e,t.textMatrixScale=Math.hypot(e[0],e[1]),t.x=t.lineX=0,t.y=t.lineY=0}nextLine(){this.moveText(0,this.current.leading)}#getScaledPath(e,t,n){const s=new Path2D;return s.addPath(e,new DOMMatrix(n).invertSelf().multiplySelf(t)),s}paintChar(e,t,n,s,o){const i=this.ctx,r=this.current,l=r.font,u=r.textRenderingMode,d=r.fontSize/r.fontSizeScale,a=u&TextRenderingMode.FILL_STROKE_MASK,h=!!(u&TextRenderingMode.ADD_TO_PATH_FLAG),m=r.patternFill&&!l.missingFile,f=r.patternStroke&&!l.missingFile;let c;if((l.disableFontFace||h||m||f)&&(c=l.getPathGenerator(this.commonObjs,e)),l.disableFontFace||m||f){i.save(),i.translate(t,n),i.scale(d,-d);let e;if((a===TextRenderingMode.FILL||a===TextRenderingMode.FILL_STROKE)&&(s?(e=i.getTransform(),i.setTransform(...s),i.fill(this.#getScaledPath(c,e,s))):i.fill(c)),a===TextRenderingMode.STROKE||a===TextRenderingMode.FILL_STROKE)if(o){e||=i.getTransform(),i.setTransform(...o);const{a:t,b:n,c:s,d:a}=e,r=Util.inverseTransform(o),l=Util.transform([t,n,s,a,0,0],r);Util.singularValueDecompose2dScale(l,XY),i.lineWidth*=Math.max(XY[0],XY[1])/d,i.stroke(this.#getScaledPath(c,e,o))}else i.lineWidth/=d,i.stroke(c);i.restore()}else(a===TextRenderingMode.FILL||a===TextRenderingMode.FILL_STROKE)&&i.fillText(e,t,n),(a===TextRenderingMode.STROKE||a===TextRenderingMode.FILL_STROKE)&&i.strokeText(e,t,n);if(h){const e=this.pendingTextPaths||=[];e.push({transform:getCurrentTransform(i),x:t,y:n,fontSize:d,path:c})}}get isFontSubpixelAAEnabled(){const{context:e}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);e.scale(1.5,1),e.fillText("I",0,10);const t=e.getImageData(0,0,10,10).data;let n=!1;for(let e=3;e<t.length;e+=4)if(t[e]>0&&t[e]<255){n=!0;break}return shadow(this,"isFontSubpixelAAEnabled",n)}showText(e){const n=this.current,o=n.font;if(o.isType3Font)return this.showType3Text(e);const i=n.fontSize;if(i===0)return void 0;const t=this.ctx,s=n.fontSizeScale,_=n.charSpacing,y=n.wordSpacing,d=n.fontDirection,u=n.textHScale*d,j=e.length,h=o.vertical,b=h?1:-1,g=o.defaultVMetrics,r=i*n.fontMatrix[0],v=n.textRenderingMode===TextRenderingMode.FILL&&!o.disableFontFace&&!n.patternFill;t.save(),n.textMatrix&&t.transform(...n.textMatrix),t.translate(n.x,n.y+n.textRise),d>0?t.scale(u,-1):t.scale(u,1);let m,f;if(n.patternFill){t.save();const e=n.fillColor.getPattern(t,this,getCurrentTransformInverse(t),PathType.FILL);m=getCurrentTransform(t),t.restore(),t.fillStyle=e}if(n.patternStroke){t.save();const e=n.strokeColor.getPattern(t,this,getCurrentTransformInverse(t),PathType.STROKE);f=getCurrentTransform(t),t.restore(),t.strokeStyle=e}let c=n.lineWidth;const p=n.textMatrixScale;if(p===0||c===0){const e=n.textRenderingMode&TextRenderingMode.FILL_STROKE_MASK;(e===TextRenderingMode.STROKE||e===TextRenderingMode.FILL_STROKE)&&(c=this.getSinglePixelWidth())}else c/=p;if(s!==1&&(t.scale(s,s),c/=s),t.lineWidth=c,o.isInvalidPDFjsFont){const s=[];let o=0;for(const t of e)s.push(t.unicode),o+=t.width;return t.fillText(s.join(""),0,0),n.x+=o*r*u,t.restore(),this.compose(),void 0}let a=0,l;for(l=0;l<j;++l){const c=e[l];if(typeof c=="number"){a+=b*c*i/1e3;continue}let x=!1;const C=(c.isSpace?y:0)+_,O=c.fontChar,p=c.accent;let u,w,n=c.width;if(h){const e=c.vmetric||g,t=-(c.vmetric?e[1]:n*.5)*r,o=e[2]*r;n=e?-e[0]:n,u=t/s,w=(a+o)/s}else u=a/s,w=0;if(o.remeasure&&n>0){const e=t.measureText(O).width*1e3/i*s;if(n<e&&this.isFontSubpixelAAEnabled){const s=n/e;x=!0,t.save(),t.scale(s,1),u/=s}else n!==e&&(u+=(n-e)/2e3*i/s)}if(this.contentVisible&&(c.isInFont||o.missingFile))if(v&&!p)t.fillText(O,u,w);else if(this.paintChar(O,u,w,m,f),p){const e=u+i*p.offset.x/s,t=w-i*p.offset.y/s;this.paintChar(p.fontChar,e,t,m,f)}const E=h?n*r-C*d:n*r+C*d;a+=E,x&&t.restore()}return h?n.y-=a:n.x+=a*u,t.restore(),this.compose()}showType3Text(e){const n=this.ctx,t=this.current,u=t.font,o=t.fontSize,d=t.fontDirection,f=u.vertical?1:-1,h=t.charSpacing,m=t.wordSpacing,a=t.textHScale*d,l=t.fontMatrix||FONT_IDENTITY_MATRIX,p=e.length,g=t.textRenderingMode===TextRenderingMode.INVISIBLE;let i,s,r,c;if(g||o===0)return;this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null,n.save(),t.textMatrix&&n.transform(...t.textMatrix),n.translate(t.x,t.y+t.textRise),n.scale(a,d);for(i=0;i<p;++i){if(s=e[i],typeof s=="number"){c=f*s*o/1e3,this.ctx.translate(c,0),t.x+=c*a;continue}const v=(s.isSpace?m:0)+h,d=u.charProcOperatorList[s.operatorListId];d?this.contentVisible&&(this.save(),n.scale(o,o),n.transform(...l),this.executeOperatorList(d),this.restore()):warn(`Type3 character "${s.operatorListId}" is not available.`);const g=[s.width,0];Util.applyTransform(g,l),r=g[0]*o+v,n.translate(r,0),t.x+=r*a}n.restore()}setCharWidth(){}setCharWidthAndBounds(e,t,n,s,o,i){const a=new Path2D;a.rect(n,s,o-n,i-s),this.ctx.clip(a),this.endPath()}getColorN_Pattern(e){let t;if(e[0]==="TilingPattern"){const n=this.baseTransform||getCurrentTransform(this.ctx),s={createCanvasGraphics:e=>new CanvasGraphics(e,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack})};t=new TilingPattern(e,this.ctx,s,n)}else t=this._getPattern(e[1],e[2]);return t}setStrokeColorN(){this.current.strokeColor=this.getColorN_Pattern(arguments),this.current.patternStroke=!0}setFillColorN(){this.current.fillColor=this.getColorN_Pattern(arguments),this.current.patternFill=!0}setStrokeRGBColor(e){this.ctx.strokeStyle=this.current.strokeColor=e,this.current.patternStroke=!1}setStrokeTransparent(){this.ctx.strokeStyle=this.current.strokeColor="transparent",this.current.patternStroke=!1}setFillRGBColor(e){this.ctx.fillStyle=this.current.fillColor=e,this.current.patternFill=!1}setFillTransparent(){this.ctx.fillStyle=this.current.fillColor="transparent",this.current.patternFill=!1}_getPattern(e,t=null){let n;return this.cachedPatterns.has(e)?n=this.cachedPatterns.get(e):(n=getShadingPattern(this.getObject(e)),this.cachedPatterns.set(e,n)),t&&(n.matrix=t),n}shadingFill(e){if(!this.contentVisible)return;const t=this.ctx;this.save();const s=this._getPattern(e);t.fillStyle=s.getPattern(t,this,getCurrentTransformInverse(t),PathType.SHADING);const n=getCurrentTransformInverse(t);if(n){const{width:i,height:a}=t.canvas,e=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,i,a],n,e);const[s,o,r,c]=e;this.ctx.fillRect(s,o,r-s,c-o)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.compose(this.current.getClippedPathBoundingBox()),this.restore()}beginInlineImage(){unreachable("Should not call beginInlineImage")}beginImageData(){unreachable("Should not call beginImageData")}paintFormXObjectBegin(e,t){if(!this.contentVisible)return;if(this.save(),this.baseTransformStack.push(this.baseTransform),e&&this.transform(...e),this.baseTransform=getCurrentTransform(this.ctx),t){Util.axialAlignedBoundingBox(t,this.baseTransform,this.current.minMax);const[e,n,o,i]=t,s=new Path2D;s.rect(e,n,o-e,i-n),this.ctx.clip(s),this.endPath()}}paintFormXObjectEnd(){if(!this.contentVisible)return;this.restore(),this.baseTransform=this.baseTransformStack.pop()}beginGroup(e){if(!this.contentVisible)return;this.save(),this.inSMaskMode&&(this.endSMaskMode(),this.current.activeSMask=null);const t=this.ctx;e.isolated||info("TODO: Support non-isolated groups."),e.knockout&&warn("Knockout groups not supported.");const f=getCurrentTransform(t);if(e.matrix&&t.transform(...e.matrix),!e.bbox)throw new Error("Bounding box is required.");let n=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox(e.bbox,getCurrentTransform(t),n);const m=[0,0,t.canvas.width,t.canvas.height];n=Util.intersect(n,m)||[0,0,0,0];const i=Math.floor(n[0]),a=Math.floor(n[1]),l=Math.max(Math.ceil(n[2])-i,1),c=Math.max(Math.ceil(n[3])-a,1);this.current.startNewPathAndClipBox([0,0,l,c]);let r="groupAt"+this.groupLevel;e.smask&&(r+="_smask_"+this.smaskCounter++%2);const d=this.cachedCanvases.getCanvas(r,l,c),s=d.context;s.translate(-i,-a),s.transform(...f);let o=new Path2D;const[u,h,p,g]=e.bbox;if(o.rect(u,h,p-u,g-h),e.matrix){const t=new Path2D;t.addPath(o,new DOMMatrix(e.matrix)),o=t}s.clip(o),e.smask?this.smaskStack.push({canvas:d.canvas,context:s,offsetX:i,offsetY:a,subtype:e.smask.subtype,backdrop:e.smask.backdrop,transferMap:e.smask.transferMap||null,startTransformInverse:null}):(t.setTransform(1,0,0,1,0,0),t.translate(i,a),t.save()),copyCtxState(t,s),this.ctx=s,this.setGState([["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(t),this.groupLevel++}endGroup(e){if(!this.contentVisible)return;this.groupLevel--;const t=this.ctx,n=this.groupStack.pop();if(this.ctx=n,this.ctx.imageSmoothingEnabled=!1,e.smask)this.tempSMask=this.smaskStack.pop(),this.restore();else{this.ctx.restore();const e=getCurrentTransform(this.ctx);this.restore(),this.ctx.save(),this.ctx.setTransform(...e);const n=MIN_MAX_INIT.slice();Util.axialAlignedBoundingBox([0,0,t.canvas.width,t.canvas.height],e,n),this.ctx.drawImage(t.canvas,0,0),this.ctx.restore(),this.compose(n)}}beginAnnotation(e,t,n,s,o){if(this.#restoreInitialState(),resetCtxToDefault(this.ctx),this.ctx.save(),this.save(),this.baseTransform&&this.ctx.setTransform(...this.baseTransform),t){const i=t[2]-t[0],s=t[3]-t[1];if(o&&this.annotationCanvasMap){n=n.slice(),n[4]-=t[0],n[5]-=t[1],t=t.slice(),t[0]=t[1]=0,t[2]=i,t[3]=s,Util.singularValueDecompose2dScale(getCurrentTransform(this.ctx),XY);const{viewportScale:o}=this,a=Math.ceil(i*this.outputScaleX*o),r=Math.ceil(s*this.outputScaleY*o);this.annotationCanvas=this.canvasFactory.create(a,r);const{canvas:c,context:l}=this.annotationCanvas;this.annotationCanvasMap.set(e,c),this.annotationCanvas.savedCtx=this.ctx,this.ctx=l,this.ctx.save(),this.ctx.setTransform(XY[0],0,0,-XY[1],0,s*XY[1]),resetCtxToDefault(this.ctx)}else{resetCtxToDefault(this.ctx),this.endPath();const e=new Path2D;e.rect(t[0],t[1],i,s),this.ctx.clip(e)}}this.current=new CanvasExtraState(this.ctx.canvas.width,this.ctx.canvas.height),this.transform(...n),this.transform(...s)}endAnnotation(){this.annotationCanvas&&(this.ctx.restore(),this.#drawFilter(),this.ctx=this.annotationCanvas.savedCtx,delete this.annotationCanvas.savedCtx,delete this.annotationCanvas)}paintImageMaskXObject(e){if(!this.contentVisible)return;const s=e.count;e=this.getObject(e.data,e),e.count=s;const t=this.ctx,n=this._createMaskCanvas(e),o=n.canvas;t.save(),t.setTransform(1,0,0,1,0,0),t.drawImage(o,n.offsetX,n.offsetY),t.restore(),this.compose()}paintImageMaskXObjectRepeat(e,t,n=0,s=0,o,i){if(!this.contentVisible)return;e=this.getObject(e.data,e);const a=this.ctx;a.save();const r=getCurrentTransform(a);a.transform(t,n,s,o,0,0);const c=this._createMaskCanvas(e);a.setTransform(1,0,0,1,c.offsetX-r[4],c.offsetY-r[5]);for(let e=0,d=i.length;e<d;e+=2){const l=Util.transform(r,[t,n,s,o,i[e],i[e+1]]);a.drawImage(c.canvas,l[4],l[5])}a.restore(),this.compose()}paintImageMaskXObjectGroup(e){if(!this.contentVisible)return;const t=this.ctx,n=this.current.fillColor,s=this.current.patternFill;for(const r of e){const{data:l,width:i,height:a,transform:d}=r,c=this.cachedCanvases.getCanvas("maskCanvas",i,a),o=c.context;o.save();const u=this.getObject(l,r);putBinaryImageMask(o,u),o.globalCompositeOperation="source-in",o.fillStyle=s?n.getPattern(o,this,getCurrentTransformInverse(t),PathType.FILL):n,o.fillRect(0,0,i,a),o.restore(),t.save(),t.transform(...d),t.scale(1,-1),drawImageAtIntegerCoords(t,c.canvas,0,0,i,a,0,-1,1,1),t.restore()}this.compose()}paintImageXObject(e){if(!this.contentVisible)return;const t=this.getObject(e);if(!t){warn("Dependent image isn't ready yet");return}this.paintInlineImageXObject(t)}paintImageXObjectRepeat(e,t,n,s){if(!this.contentVisible)return;const o=this.getObject(e);if(!o){warn("Dependent image isn't ready yet");return}const a=o.width,r=o.height,i=[];for(let e=0,o=s.length;e<o;e+=2)i.push({transform:[t,0,0,n,s[e],s[e+1]],x:0,y:0,w:a,h:r});this.paintInlineImageXObjectGroup(o,i)}applyTransferMapsToCanvas(e){return this.current.transferMaps!=="none"&&(e.filter=this.current.transferMaps,e.drawImage(e.canvas,0,0),e.filter="none"),e.canvas}applyTransferMapsToBitmap(e){if(this.current.transferMaps==="none")return e.bitmap;const{bitmap:s,width:o,height:i}=e,n=this.cachedCanvases.getCanvas("inlineImage",o,i),t=n.context;return t.filter=this.current.transferMaps,t.drawImage(s,0,0),t.filter="none",n.canvas}paintInlineImageXObject(e){if(!this.contentVisible)return;const o=e.width,n=e.height,t=this.ctx;this.save();const{filter:a}=t;a!=="none"&&a!==""&&(t.filter="none"),t.scale(1/o,-1/n);let s;if(e.bitmap)s=this.applyTransferMapsToBitmap(e);else if(typeof HTMLElement=="function"&&e instanceof HTMLElement||!e.data)s=e;else{const i=this.cachedCanvases.getCanvas("inlineImage",o,n),t=i.context;putBinaryImageData(t,e),s=this.applyTransferMapsToCanvas(t)}const i=this._scaleImage(s,getCurrentTransformInverse(t));t.imageSmoothingEnabled=getImageSmoothingEnabled(getCurrentTransform(t),e.interpolate),drawImageAtIntegerCoords(t,i.img,0,0,i.paintWidth,i.paintHeight,0,-n,o,n),this.compose(),this.restore()}paintInlineImageXObjectGroup(e,t){if(!this.contentVisible)return;const n=this.ctx;let s;if(e.bitmap)s=e.bitmap;else{const n=e.width,o=e.height,i=this.cachedCanvases.getCanvas("inlineImage",n,o),t=i.context;putBinaryImageData(t,e),s=this.applyTransferMapsToCanvas(t)}for(const e of t)n.save(),n.transform(...e.transform),n.scale(1,-1),drawImageAtIntegerCoords(n,s,e.x,e.y,e.w,e.h,0,-1,1,1),n.restore();this.compose()}paintSolidColorImageMask(){if(!this.contentVisible)return;this.ctx.fillRect(0,0,1,1),this.compose()}markPoint(){}markPointProps(){}beginMarkedContent(){this.markedContentStack.push({visible:!0})}beginMarkedContentProps(e,t){e==="OC"?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(t)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()}endMarkedContent(){this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()}beginCompat(){}endCompat(){}consumePath(e,t){const s=this.current.isEmptyClip();this.pendingClip&&this.current.updateClipFromPath(),this.pendingClip||this.compose(t);const n=this.ctx;this.pendingClip&&(s||(this.pendingClip===EO_CLIP?n.clip(e,"evenodd"):n.clip(e)),this.pendingClip=null),this.current.startNewPathAndClipBox(this.current.clipBox)}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){const e=getCurrentTransform(this.ctx);if(e[1]===0&&e[2]===0)this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(e[0]),Math.abs(e[3]));else{const t=Math.abs(e[0]*e[3]-e[2]*e[1]),n=Math.hypot(e[0],e[2]),s=Math.hypot(e[1],e[3]);this._cachedGetSinglePixelWidth=Math.max(n,s)/t}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){const{lineWidth:e}=this.current,{a:s,b:o,c:i,d:a}=this.ctx.getTransform();let t,n;if(o===0&&i===0){const o=Math.abs(s),i=Math.abs(a);if(o===i)if(e===0)t=n=1/o;else{const s=o*e;t=n=s<1?1/s:1}else if(e===0)t=1/o,n=1/i;else{const s=o*e,a=i*e;t=s<1?1/s:1,n=a<1?1/a:1}}else{const r=Math.abs(s*a-o*i),c=Math.hypot(s,o),l=Math.hypot(i,a);if(e===0)t=l/r,n=c/r;else{const s=e*r;t=l>s?l/s:1,n=c>s?c/s:1}}this._cachedScaleForStroking[0]=t,this._cachedScaleForStroking[1]=n}return this._cachedScaleForStroking}rescaleAndStroke(e,t){const{ctx:n,current:{lineWidth:i}}=this,[s,o]=this.getScaleForStroking();if(s===o){n.lineWidth=(i||1)*s,n.stroke(e);return}const a=n.getLineDash();t&&n.save(),n.scale(s,o),SCALE_MATRIX.a=1/s,SCALE_MATRIX.d=1/o;const r=new Path2D;if(r.addPath(e,SCALE_MATRIX),a.length>0){const e=Math.max(s,o);n.setLineDash(a.map(t=>t/e)),n.lineDashOffset/=e}n.lineWidth=i||1,n.stroke(r),t&&n.restore()}isContentVisible(){for(let e=this.markedContentStack.length-1;e>=0;e--)if(!this.markedContentStack[e].visible)return!1;return!0}}for(const e in OPS)CanvasGraphics.prototype[e]!==void 0&&(CanvasGraphics.prototype[OPS[e]]=CanvasGraphics.prototype[e]);class GlobalWorkerOptions{static#port=null;static#src="";static get workerPort(){return this.#port}static set workerPort(e){if(!(typeof Worker!="undefined"&&e instanceof Worker)&&e!==null)throw new Error("Invalid `workerPort` type.");this.#port=e}static get workerSrc(){return this.#src}static set workerSrc(e){if(typeof e!="string")throw new Error("Invalid `workerSrc` type.");this.#src=e}}class Metadata{#map;#data;constructor({parsedData:e,rawData:t}){this.#map=e,this.#data=t}getRaw(){return this.#data}get(e){return this.#map.get(e)??null}[Symbol.iterator](){return this.#map.entries()}}const INTERNAL=Symbol("INTERNAL");class OptionalContentGroup{#isDisplay=!1;#isPrint=!1;#userSet=!1;#visible=!0;constructor(e,{name:t,intent:n,usage:s,rbGroups:o}){this.#isDisplay=!!(e&RenderingIntentFlag.DISPLAY),this.#isPrint=!!(e&RenderingIntentFlag.PRINT),this.name=t,this.intent=n,this.usage=s,this.rbGroups=o}get visible(){if(this.#userSet)return this.#visible;if(!this.#visible)return!1;const{print:e,view:t}=this.usage;return this.#isDisplay?t?.viewState!=="OFF":!this.#isPrint||e?.printState!=="OFF"}_setVisible(e,t,n=!1){e!==INTERNAL&&unreachable("Internal method `_setVisible` called."),this.#userSet=n,this.#visible=t}}class OptionalContentConfig{#cachedGetHash=null;#groups=new Map;#initialHash=null;#order=null;constructor(e,t=RenderingIntentFlag.DISPLAY){if(this.renderingIntent=t,this.name=null,this.creator=null,e===null)return;this.name=e.name,this.creator=e.creator,this.#order=e.order;for(const n of e.groups)this.#groups.set(n.id,new OptionalContentGroup(t,n));if(e.baseState==="OFF")for(const e of this.#groups.values())e._setVisible(INTERNAL,!1);for(const t of e.on)this.#groups.get(t)._setVisible(INTERNAL,!0);for(const t of e.off)this.#groups.get(t)._setVisible(INTERNAL,!1);this.#initialHash=this.getHash()}#evaluateVisibilityExpression(e){const t=e.length;if(t<2)return!0;const n=e[0];for(let i=1;i<t;i++){const s=e[i];let o;if(Array.isArray(s))o=this.#evaluateVisibilityExpression(s);else if(this.#groups.has(s))o=this.#groups.get(s).visible;else return warn(`Optional content group not found: ${s}`),!0;switch(n){case"And":if(!o)return!1;break;case"Or":if(o)return!0;break;case"Not":return!o;default:return!0}}return n==="And"}isVisible(e){if(this.#groups.size===0)return!0;if(!e)return info("Optional content group not defined."),!0;if(e.type==="OCG")return this.#groups.has(e.id)?this.#groups.get(e.id).visible:(warn(`Optional content group not found: ${e.id}`),!0);if(e.type==="OCMD"){if(e.expression)return this.#evaluateVisibilityExpression(e.expression);if(!e.policy||e.policy==="AnyOn"){for(const t of e.ids){if(!this.#groups.has(t))return warn(`Optional content group not found: ${t}`),!0;if(this.#groups.get(t).visible)return!0}return!1}if(e.policy==="AllOn"){for(const t of e.ids){if(!this.#groups.has(t))return warn(`Optional content group not found: ${t}`),!0;if(!this.#groups.get(t).visible)return!1}return!0}if(e.policy==="AnyOff"){for(const t of e.ids){if(!this.#groups.has(t))return warn(`Optional content group not found: ${t}`),!0;if(!this.#groups.get(t).visible)return!0}return!1}if(e.policy==="AllOff"){for(const t of e.ids){if(!this.#groups.has(t))return warn(`Optional content group not found: ${t}`),!0;if(this.#groups.get(t).visible)return!1}return!0}return warn(`Unknown optional content policy ${e.policy}.`),!0}return warn(`Unknown group type ${e.type}.`),!0}setVisibility(e,t=!0,n=!0){const s=this.#groups.get(e);if(!s){warn(`Optional content group not found: ${e}`);return}if(n&&t&&s.rbGroups.length)for(const t of s.rbGroups)for(const n of t)n!==e&&this.#groups.get(n)?._setVisible(INTERNAL,!1,!0);s._setVisible(INTERNAL,!!t,!0),this.#cachedGetHash=null}setOCGState({state:e,preserveRB:t}){let n;for(const s of e){switch(s){case"ON":case"OFF":case"Toggle":n=s;continue}const o=this.#groups.get(s);if(!o)continue;switch(n){case"ON":this.setVisibility(s,!0,t);break;case"OFF":this.setVisibility(s,!1,t);break;case"Toggle":this.setVisibility(s,!o.visible,t);break}}this.#cachedGetHash=null}get hasInitialVisibility(){return this.#initialHash===null||this.getHash()===this.#initialHash}getOrder(){return this.#groups.size?this.#order?this.#order.slice():[...this.#groups.keys()]:null}getGroup(e){return this.#groups.get(e)||null}getHash(){if(this.#cachedGetHash!==null)return this.#cachedGetHash;const e=new MurmurHash3_64;for(const[t,n]of this.#groups)e.update(`${t}:${n.visible}`);return this.#cachedGetHash=e.hexdigest()}[Symbol.iterator](){return this.#groups.entries()}}class PDFDataTransportStream{constructor(e,{disableRange:t=!1,disableStream:n=!1}){assert(e,'PDFDataTransportStream - missing required "pdfDataRangeTransport" argument.');const{length:o,initialData:s,progressiveDone:i,contentDispositionFilename:a}=e;if(this._queuedChunks=[],this._progressiveDone=i,this._contentDispositionFilename=a,s?.length>0){const e=s instanceof Uint8Array&&s.byteLength===s.buffer.byteLength?s.buffer:new Uint8Array(s).buffer;this._queuedChunks.push(e)}this._pdfDataRangeTransport=e,this._isStreamingSupported=!n,this._isRangeSupported=!t,this._contentLength=o,this._fullRequestReader=null,this._rangeReaders=[],e.addRangeListener((e,t)=>{this._onReceiveData({begin:e,chunk:t})}),e.addProgressListener((e,t)=>{this._onProgress({loaded:e,total:t})}),e.addProgressiveReadListener(e=>{this._onReceiveData({chunk:e})}),e.addProgressiveDoneListener(()=>{this._onProgressiveDone()}),e.transportReady()}_onReceiveData({begin:e,chunk:t}){const n=t instanceof Uint8Array&&t.byteLength===t.buffer.byteLength?t.buffer:new Uint8Array(t).buffer;if(e===void 0)this._fullRequestReader?this._fullRequestReader._enqueue(n):this._queuedChunks.push(n);else{const t=this._rangeReaders.some(function(t){return t._begin===e&&(t._enqueue(n),!0)});assert(t,"_onReceiveData - no `PDFDataTransportStreamRangeReader` instance found.")}}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}_onProgress(e){e.total===void 0?this._rangeReaders[0]?.onProgress?.({loaded:e.loaded}):this._fullRequestReader?.onProgress?.({loaded:e.loaded,total:e.total})}_onProgressiveDone(){this._fullRequestReader?.progressiveDone(),this._progressiveDone=!0}_removeRangeReader(e){const t=this._rangeReaders.indexOf(e);t>=0&&this._rangeReaders.splice(t,1)}getFullReader(){assert(!this._fullRequestReader,"PDFDataTransportStream.getFullReader can only be called once.");const e=this._queuedChunks;return this._queuedChunks=null,new PDFDataTransportStreamReader(this,e,this._progressiveDone,this._contentDispositionFilename)}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;const n=new PDFDataTransportStreamRangeReader(this,e,t);return this._pdfDataRangeTransport.requestDataRange(e,t),this._rangeReaders.push(n),n}cancelAllRequests(e){this._fullRequestReader?.cancel(e);for(const t of this._rangeReaders.slice(0))t.cancel(e);this._pdfDataRangeTransport.abort()}}class PDFDataTransportStreamReader{constructor(e,t,n=!1,s=null){this._stream=e,this._done=n||!1,this._filename=isPdfFile(s)?s:null,this._queuedChunks=t||[],this._loaded=0;for(const e of this._queuedChunks)this._loaded+=e.byteLength;this._requests=[],this._headersReady=Promise.resolve(),e._fullRequestReader=this,this.onProgress=null}_enqueue(e){if(this._done)return;if(this._requests.length>0){const t=this._requests.shift();t.resolve({value:e,done:!1})}else this._queuedChunks.push(e);this._loaded+=e.byteLength}get headersReady(){return this._headersReady}get filename(){return this._filename}get isRangeSupported(){return this._stream._isRangeSupported}get isStreamingSupported(){return this._stream._isStreamingSupported}get contentLength(){return this._stream._contentLength}async read(){if(this._queuedChunks.length>0){const e=this._queuedChunks.shift();return{value:e,done:!1}}if(this._done)return{value:void 0,done:!0};const e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}progressiveDone(){if(this._done)return;this._done=!0}}class PDFDataTransportStreamRangeReader{constructor(e,t,n){this._stream=e,this._begin=t,this._end=n,this._queuedChunk=null,this._requests=[],this._done=!1,this.onProgress=null}_enqueue(e){if(this._done)return;if(this._requests.length===0)this._queuedChunk=e;else{const t=this._requests.shift();t.resolve({value:e,done:!1});for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}this._done=!0,this._stream._removeRangeReader(this)}get isStreamingSupported(){return!1}async read(){if(this._queuedChunk){const e=this._queuedChunk;return this._queuedChunk=null,{value:e,done:!1}}if(this._done)return{value:void 0,done:!0};const e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._removeRangeReader(this)}}function getFilenameFromContentDispositionHeader(e){let s=!0,t=o("filename\\*","i").exec(e);if(t){t=t[1];let e=a(t);return e=unescape(e),e=c(e),e=r(e),i(e)}if(t=l(e),t){const e=r(t);return i(e)}if(t=o("filename","i").exec(e),t){t=t[1];let e=a(t);return e=r(e),i(e)}function o(e,t){return new RegExp("(?:^|;)\\s*"+e+'\\s*=\\s*([^";\\s][^;\\s]*|"(?:[^"\\\\]|\\\\"?)+"?)',t)}function n(e,t){if(e){if(!/^[\x00-\xFF]+$/.test(t))return t;try{const n=new TextDecoder(e,{fatal:!0}),o=stringToBytes(t);t=n.decode(o),s=!1}catch{}}return t}function i(e){return s&&/[\x80-\xff]/.test(e)&&(e=n("utf-8",e),s&&(e=n("iso-8859-1",e))),e}function l(e){const t=[];let n;const i=o("filename\\*((?!0\\d)\\d+)(\\*?)","ig");for(;(n=i.exec(e))!==null;){let[,e,s,o]=n;if(e=parseInt(e,10),e in t){if(e===0)break;continue}t[e]=[s,o]}const s=[];for(let n=0;n<t.length;++n){if(!(n in t))break;let[o,e]=t[n];e=a(e),o&&(e=unescape(e),n===0&&(e=c(e))),s.push(e)}return s.join("")}function a(e){if(e.startsWith('"')){const t=e.slice(1).split('\\"');for(let e=0;e<t.length;++e){const n=t[e].indexOf('"');n!==-1&&(t[e]=t[e].slice(0,n),t.length=e+1),t[e]=t[e].replaceAll(/\\(.)/g,"$1")}e=t.join('"')}return e}function c(e){const t=e.indexOf("'");if(t===-1)return e;const s=e.slice(0,t),o=e.slice(t+1),i=o.replace(/^[^']*'/,"");return n(s,i)}function r(e){return!e.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(e)?e:e.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(e,t,s,o){if(s==="q"||s==="Q")return o=o.replaceAll("_"," "),o=o.replaceAll(/=([0-9a-fA-F]{2})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}),n(t,o);try{o=atob(o)}catch{}return n(t,o)})}return""}function createHeaders(e,t){const n=new Headers;if(!e||!t||typeof t!="object")return n;for(const e in t){const s=t[e];s!==void 0&&n.append(e,s)}return n}function getResponseOrigin(e){return URL.parse(e)?.origin??null}function validateRangeRequestCapabilities({responseHeaders:e,isHttp:t,rangeChunkSize:n,disableRange:s}){const o={allowRangeRequests:!1,suggestedLength:void 0},i=parseInt(e.get("Content-Length"),10);if(!Number.isInteger(i))return o;if(o.suggestedLength=i,i<=2*n)return o;if(s||!t)return o;if(e.get("Accept-Ranges")!=="bytes")return o;const a=e.get("Content-Encoding")||"identity";return a!=="identity"?o:(o.allowRangeRequests=!0,o)}function extractFilenameFromHeader(e){const t=e.get("Content-Disposition");if(t){let e=getFilenameFromContentDispositionHeader(t);if(e.includes("%"))try{e=decodeURIComponent(e)}catch{}if(isPdfFile(e))return e}return null}function createResponseError(e,t){return new ResponseException(`Unexpected server response (${e}) while retrieving PDF "${t}".`,e,e===404||e===0&&t.startsWith("file:"))}function validateResponseStatus(e){return e===200||e===206}function createFetchOptions(e,t,n){return{method:"GET",headers:e,signal:n.signal,mode:"cors",credentials:t?"include":"same-origin",redirect:"follow"}}function getArrayBuffer(e){return e instanceof Uint8Array?e.buffer:e instanceof ArrayBuffer?e:(warn(`getArrayBuffer - unexpected data format: ${e}`),new Uint8Array(e).buffer)}class PDFFetchStream{_responseOrigin=null;constructor(e){this.source=e,this.isHttp=/^https?:/i.test(e.url),this.headers=createHeaders(this.isHttp,e.httpHeaders),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return assert(!this._fullRequestReader,"PDFFetchStream.getFullReader can only be called once."),this._fullRequestReader=new PDFFetchStreamReader(this),this._fullRequestReader}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;const n=new PDFFetchStreamRangeReader(this,e,t);return this._rangeRequestReaders.push(n),n}cancelAllRequests(e){this._fullRequestReader?.cancel(e);for(const t of this._rangeRequestReaders.slice(0))t.cancel(e)}}class PDFFetchStreamReader{constructor(e){this._stream=e,this._reader=null,this._loaded=0,this._filename=null;const t=e.source;this._withCredentials=t.withCredentials||!1,this._contentLength=t.length,this._headersCapability=Promise.withResolvers(),this._disableRange=t.disableRange||!1,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._abortController=new AbortController,this._isStreamingSupported=!t.disableStream,this._isRangeSupported=!t.disableRange;const s=new Headers(e.headers),n=t.url;fetch(n,createFetchOptions(s,this._withCredentials,this._abortController)).then(t=>{if(e._responseOrigin=getResponseOrigin(t.url),!validateResponseStatus(t.status))throw createResponseError(t.status,n);this._reader=t.body.getReader(),this._headersCapability.resolve();const s=t.headers,{allowRangeRequests:o,suggestedLength:i}=validateRangeRequestCapabilities({responseHeaders:s,isHttp:e.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=o,this._contentLength=i||this._contentLength,this._filename=extractFilenameFromHeader(s),!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new AbortException("Streaming is disabled."))}).catch(this._headersCapability.reject),this.onProgress=null}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._headersCapability.promise;const{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:(this._loaded+=e.byteLength,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:getArrayBuffer(e),done:!1})}cancel(e){this._reader?.cancel(e),this._abortController.abort()}}class PDFFetchStreamRangeReader{constructor(e,t,n){this._stream=e,this._reader=null,this._loaded=0;const s=e.source;this._withCredentials=s.withCredentials||!1,this._readCapability=Promise.withResolvers(),this._isStreamingSupported=!s.disableStream,this._abortController=new AbortController;const o=new Headers(e.headers);o.append("Range",`bytes=${t}-${n-1}`);const i=s.url;fetch(i,createFetchOptions(o,this._withCredentials,this._abortController)).then(t=>{const n=getResponseOrigin(t.url);if(n!==e._responseOrigin)throw new Error(`Expected range response-origin "${n}" to match "${e._responseOrigin}".`);if(!validateResponseStatus(t.status))throw createResponseError(t.status,i);this._readCapability.resolve(),this._reader=t.body.getReader()}).catch(this._readCapability.reject),this.onProgress=null}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;const{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:(this._loaded+=e.byteLength,this.onProgress?.({loaded:this._loaded}),{value:getArrayBuffer(e),done:!1})}cancel(e){this._reader?.cancel(e),this._abortController.abort()}}const OK_RESPONSE=200,PARTIAL_CONTENT_RESPONSE=206;function network_getArrayBuffer(e){const t=e.response;return typeof t!="string"?t:stringToBytes(t).buffer}class NetworkManager{_responseOrigin=null;constructor({url:e,httpHeaders:t,withCredentials:n}){this.url=e,this.isHttp=/^https?:/i.test(e),this.headers=createHeaders(this.isHttp,t),this.withCredentials=n||!1,this.currXhrId=0,this.pendingRequests=Object.create(null)}request(e){const t=new XMLHttpRequest,s=this.currXhrId++,n=this.pendingRequests[s]={xhr:t};t.open("GET",this.url),t.withCredentials=this.withCredentials;for(const[e,n]of this.headers)t.setRequestHeader(e,n);return this.isHttp&&"begin"in e&&"end"in e?(t.setRequestHeader("Range",`bytes=${e.begin}-${e.end-1}`),n.expectedStatus=PARTIAL_CONTENT_RESPONSE):n.expectedStatus=OK_RESPONSE,t.responseType="arraybuffer",assert(e.onError,"Expected `onError` callback to be provided."),t.onerror=()=>{e.onError(t.status)},t.onreadystatechange=this.onStateChange.bind(this,s),t.onprogress=this.onProgress.bind(this,s),n.onHeadersReceived=e.onHeadersReceived,n.onDone=e.onDone,n.onError=e.onError,n.onProgress=e.onProgress,t.send(null),s}onProgress(e,t){const n=this.pendingRequests[e];if(!n)return;n.onProgress?.(t)}onStateChange(e){const n=this.pendingRequests[e];if(!n)return;const s=n.xhr;if(s.readyState>=2&&n.onHeadersReceived&&(n.onHeadersReceived(),delete n.onHeadersReceived),s.readyState!==4)return;if(!(e in this.pendingRequests))return;if(delete this.pendingRequests[e],s.status===0&&this.isHttp){n.onError(s.status);return}const o=s.status||OK_RESPONSE,a=o===OK_RESPONSE&&n.expectedStatus===PARTIAL_CONTENT_RESPONSE;if(!a&&o!==n.expectedStatus){n.onError(s.status);return}const i=network_getArrayBuffer(s);if(o===PARTIAL_CONTENT_RESPONSE){const t=s.getResponseHeader("Content-Range"),e=/bytes (\d+)-(\d+)\/(\d+)/.exec(t);e?n.onDone({begin:parseInt(e[1],10),chunk:i}):(warn(`Missing or invalid "Content-Range" header.`),n.onError(0))}else i?n.onDone({begin:0,chunk:i}):n.onError(s.status)}getRequestXhr(e){return this.pendingRequests[e].xhr}isPendingRequest(e){return e in this.pendingRequests}abortRequest(e){const t=this.pendingRequests[e].xhr;delete this.pendingRequests[e],t.abort()}}class PDFNetworkStream{constructor(e){this._source=e,this._manager=new NetworkManager(e),this._rangeChunkSize=e.rangeChunkSize,this._fullRequestReader=null,this._rangeRequestReaders=[]}_onRangeRequestReaderClosed(e){const t=this._rangeRequestReaders.indexOf(e);t>=0&&this._rangeRequestReaders.splice(t,1)}getFullReader(){return assert(!this._fullRequestReader,"PDFNetworkStream.getFullReader can only be called once."),this._fullRequestReader=new PDFNetworkStreamFullRequestReader(this._manager,this._source),this._fullRequestReader}getRangeReader(e,t){const n=new PDFNetworkStreamRangeRequestReader(this._manager,e,t);return n.onClosed=this._onRangeRequestReaderClosed.bind(this),this._rangeRequestReaders.push(n),n}cancelAllRequests(e){this._fullRequestReader?.cancel(e);for(const t of this._rangeRequestReaders.slice(0))t.cancel(e)}}class PDFNetworkStreamFullRequestReader{constructor(e,t){this._manager=e,this._url=t.url,this._fullRequestId=e.request({onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._headersCapability=Promise.withResolvers(),this._disableRange=t.disableRange||!1,this._contentLength=t.length,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!1,this._isRangeSupported=!1,this._cachedChunks=[],this._requests=[],this._done=!1,this._storedError=void 0,this._filename=null,this.onProgress=null}_onHeadersReceived(){const e=this._fullRequestId,t=this._manager.getRequestXhr(e);this._manager._responseOrigin=getResponseOrigin(t.responseURL);const n=t.getAllResponseHeaders(),s=new Headers(n?n.trimStart().replace(/[^\S ]+$/,"").split(/[\r\n]+/).map(e=>{const[t,...n]=e.split(": ");return[t,n.join(": ")]}):[]),{allowRangeRequests:o,suggestedLength:i}=validateRangeRequestCapabilities({responseHeaders:s,isHttp:this._manager.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});o&&(this._isRangeSupported=!0),this._contentLength=i||this._contentLength,this._filename=extractFilenameFromHeader(s),this._isRangeSupported&&this._manager.abortRequest(e),this._headersCapability.resolve()}_onDone(e){if(e)if(this._requests.length>0){const t=this._requests.shift();t.resolve({value:e.chunk,done:!1})}else this._cachedChunks.push(e.chunk);if(this._done=!0,this._cachedChunks.length>0)return;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}_onError(e){this._storedError=createResponseError(e,this._url),this._headersCapability.reject(this._storedError);for(const e of this._requests)e.reject(this._storedError);this._requests.length=0,this._cachedChunks.length=0}_onProgress(e){this.onProgress?.({loaded:e.loaded,total:e.lengthComputable?e.total:this._contentLength})}get filename(){return this._filename}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}get contentLength(){return this._contentLength}get headersReady(){return this._headersCapability.promise}async read(){if(await this._headersCapability.promise,this._storedError)throw this._storedError;if(this._cachedChunks.length>0){const e=this._cachedChunks.shift();return{value:e,done:!1}}if(this._done)return{value:void 0,done:!0};const e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0,this._headersCapability.reject(e);for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._fullRequestId)&&this._manager.abortRequest(this._fullRequestId),this._fullRequestReader=null}}class PDFNetworkStreamRangeRequestReader{constructor(e,t,n){this._manager=e,this._url=e.url,this._requestId=e.request({begin:t,end:n,onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._requests=[],this._queuedChunk=null,this._done=!1,this._storedError=void 0,this.onProgress=null,this.onClosed=null}_onHeadersReceived(){const e=getResponseOrigin(this._manager.getRequestXhr(this._requestId)?.responseURL);e!==this._manager._responseOrigin&&(this._storedError=new Error(`Expected range response-origin "${e}" to match "${this._manager._responseOrigin}".`),this._onError(0))}_close(){this.onClosed?.(this)}_onDone(e){const t=e.chunk;if(this._requests.length>0){const e=this._requests.shift();e.resolve({value:t,done:!1})}else this._queuedChunk=t;this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._close()}_onError(e){this._storedError??=createResponseError(e,this._url);for(const e of this._requests)e.reject(this._storedError);this._requests.length=0,this._queuedChunk=null}_onProgress(e){this.isStreamingSupported||this.onProgress?.({loaded:e.loaded})}get isStreamingSupported(){return!1}async read(){if(this._storedError)throw this._storedError;if(this._queuedChunk!==null){const e=this._queuedChunk;return this._queuedChunk=null,{value:e,done:!1}}if(this._done)return{value:void 0,done:!0};const e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._requestId)&&this._manager.abortRequest(this._requestId),this._close()}}const urlRegex=/^[a-z][a-z0-9-+.]+:/i;function parseUrlOrPath(e){if(urlRegex.test(e))return new URL(e);const t=process.getBuiltinModule("url");return new URL(t.pathToFileURL(e))}class PDFNodeStream{constructor(e){this.source=e,this.url=parseUrlOrPath(e.url),assert(this.url.protocol==="file:","PDFNodeStream only supports file:// URLs."),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return assert(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once."),this._fullRequestReader=new PDFNodeStreamFsFullReader(this),this._fullRequestReader}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;const n=new PDFNodeStreamFsRangeReader(this,e,t);return this._rangeRequestReaders.push(n),n}cancelAllRequests(e){this._fullRequestReader?.cancel(e);for(const t of this._rangeRequestReaders.slice(0))t.cancel(e)}}class PDFNodeStreamFsFullReader{constructor(e){this._url=e.url,this._done=!1,this._storedError=null,this.onProgress=null;const t=e.source;this._contentLength=t.length,this._loaded=0,this._filename=null,this._disableRange=t.disableRange||!1,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!t.disableStream,this._isRangeSupported=!t.disableRange,this._readableStream=null,this._readCapability=Promise.withResolvers(),this._headersCapability=Promise.withResolvers();const n=process.getBuiltinModule("fs");n.promises.lstat(this._url).then(e=>{this._contentLength=e.size,this._setReadableStream(n.createReadStream(this._url)),this._headersCapability.resolve()},e=>{e.code==="ENOENT"&&(e=createResponseError(0,this._url.href)),this._storedError=e,this._headersCapability.reject(e)})}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const e=this._readableStream.read();if(e===null)return this._readCapability=Promise.withResolvers(),this.read();this._loaded+=e.length,this.onProgress?.({loaded:this._loaded,total:this._contentLength});const t=new Uint8Array(e).buffer;return{value:t,done:!1}}cancel(e){if(!this._readableStream){this._error(e);return}this._readableStream.destroy(e)}_error(e){this._storedError=e,this._readCapability.resolve()}_setReadableStream(e){this._readableStream=e,e.on("readable",()=>{this._readCapability.resolve()}),e.on("end",()=>{e.destroy(),this._done=!0,this._readCapability.resolve()}),e.on("error",e=>{this._error(e)}),!this._isStreamingSupported&&this._isRangeSupported&&this._error(new AbortException("streaming is disabled")),this._storedError&&this._readableStream.destroy(this._storedError)}}class PDFNodeStreamFsRangeReader{constructor(e,t,n){this._url=e.url,this._done=!1,this._storedError=null,this.onProgress=null,this._loaded=0,this._readableStream=null,this._readCapability=Promise.withResolvers();const s=e.source;this._isStreamingSupported=!s.disableStream;const o=process.getBuiltinModule("fs");this._setReadableStream(o.createReadStream(this._url,{start:t,end:n-1}))}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const e=this._readableStream.read();if(e===null)return this._readCapability=Promise.withResolvers(),this.read();this._loaded+=e.length,this.onProgress?.({loaded:this._loaded});const t=new Uint8Array(e).buffer;return{value:t,done:!1}}cancel(e){if(!this._readableStream){this._error(e);return}this._readableStream.destroy(e)}_error(e){this._storedError=e,this._readCapability.resolve()}_setReadableStream(e){this._readableStream=e,e.on("readable",()=>{this._readCapability.resolve()}),e.on("end",()=>{e.destroy(),this._done=!0,this._readCapability.resolve()}),e.on("error",e=>{this._error(e)}),this._storedError&&this._readableStream.destroy(this._storedError)}}const INITIAL_DATA=Symbol("INITIAL_DATA");class PDFObjects{#objs=Object.create(null);#ensureObj(e){return this.#objs[e]||={...Promise.withResolvers(),data:INITIAL_DATA}}get(e,t=null){if(t){const n=this.#ensureObj(e);return n.promise.then(()=>t(n.data)),null}const n=this.#objs[e];if(!n||n.data===INITIAL_DATA)throw new Error(`Requesting object that isn't resolved yet ${e}.`);return n.data}has(e){const t=this.#objs[e];return!!t&&t.data!==INITIAL_DATA}delete(e){const t=this.#objs[e];return!!t&&t.data!==INITIAL_DATA&&(delete this.#objs[e],!0)}resolve(e,t=null){const n=this.#ensureObj(e);n.data=t,n.resolve()}clear(){for(const e in this.#objs){const{data:t}=this.#objs[e];t?.bitmap?.close()}this.#objs=Object.create(null)}*[Symbol.iterator](){for(const e in this.#objs){const{data:t}=this.#objs[e];if(t===INITIAL_DATA)continue;yield[e,t]}}}const MAX_TEXT_DIVS_TO_RENDER=1e5,DEFAULT_FONT_SIZE=30;class TextLayer{#capability=Promise.withResolvers();#container=null;#disableProcessItems=!1;#fontInspectorEnabled=!!globalThis.FontInspector?.enabled;#lang=null;#layoutTextParams=null;#pageHeight=0;#pageWidth=0;#reader=null;#rootContainer=null;#rotation=0;#scale=0;#styleCache=Object.create(null);#textContentItemsStr=[];#textContentSource=null;#textDivs=[];#textDivProperties=new WeakMap;#transform=null;static#ascentCache=new Map;static#canvasContexts=new Map;static#canvasCtxFonts=new WeakMap;static#minFontSize=null;static#pendingTextLayers=new Set;constructor({textContentSource:e,container:t,viewport:n}){if(e instanceof ReadableStream)this.#textContentSource=e;else if(typeof e=="object")this.#textContentSource=new ReadableStream({start(t){t.enqueue(e),t.close()}});else throw new Error('No "textContentSource" parameter specified.');this.#container=this.#rootContainer=t,this.#scale=n.scale*OutputScale.pixelRatio,this.#rotation=n.rotation,this.#layoutTextParams={div:null,properties:null,ctx:null};const{pageWidth:o,pageHeight:s,pageX:i,pageY:a}=n.rawDims;this.#transform=[1,0,0,-1,-i,a+s],this.#pageWidth=o,this.#pageHeight=s,TextLayer.#ensureMinFontSizeComputed(),setLayerDimensions(t,n),this.#capability.promise.finally(()=>{TextLayer.#pendingTextLayers.delete(this),this.#layoutTextParams=null,this.#styleCache=null}).catch(()=>{})}static get fontFamilyMap(){const{isWindows:e,isFirefox:t}=util_FeatureTest.platform;return shadow(this,"fontFamilyMap",new Map([["sans-serif",`${e&&t?"Calibri, ":""}sans-serif`],["monospace",`${e&&t?"Lucida Console, ":""}monospace`]]))}render(){const e=()=>{this.#reader.read().then(({value:t,done:n})=>{if(n){this.#capability.resolve();return}this.#lang??=t.lang,Object.assign(this.#styleCache,t.styles),this.#processItems(t.items),e()},this.#capability.reject)};return this.#reader=this.#textContentSource.getReader(),TextLayer.#pendingTextLayers.add(this),e(),this.#capability.promise}update({viewport:e,onBefore:t=null}){const s=e.scale*OutputScale.pixelRatio,n=e.rotation;if(n!==this.#rotation&&(t?.(),this.#rotation=n,setLayerDimensions(this.#rootContainer,{rotation:n})),s!==this.#scale){t?.(),this.#scale=s;const e={div:null,properties:null,ctx:TextLayer.#getCtx(this.#lang)};for(const t of this.#textDivs)e.properties=this.#textDivProperties.get(t),e.div=t,this.#layout(e)}}cancel(){const e=new AbortException("TextLayer task cancelled.");this.#reader?.cancel(e).catch(()=>{}),this.#reader=null,this.#capability.reject(e)}get textDivs(){return this.#textDivs}get textContentItemsStr(){return this.#textContentItemsStr}#processItems(e){if(this.#disableProcessItems)return;this.#layoutTextParams.ctx??=TextLayer.#getCtx(this.#lang);const t=this.#textDivs,n=this.#textContentItemsStr;for(const s of e){if(t.length>MAX_TEXT_DIVS_TO_RENDER){warn("Ignoring additional textDivs for performance reasons."),this.#disableProcessItems=!0;return}if(s.str===void 0){if(s.type==="beginMarkedContentProps"||s.type==="beginMarkedContent"){const e=this.#container;this.#container=document.createElement("span"),this.#container.classList.add("markedContent"),s.id!==null&&this.#container.setAttribute("id",`${s.id}`),e.append(this.#container)}else s.type==="endMarkedContent"&&(this.#container=this.#container.parentNode);continue}n.push(s.str),this.#appendText(s)}}#appendText(e){const t=document.createElement("span"),s={angle:0,canvasWidth:0,hasText:e.str!=="",hasEOL:e.hasEOL,fontSize:0};this.#textDivs.push(t);const n=Util.transform(this.#transform,e.transform);let o=Math.atan2(n[1],n[0]);const i=this.#styleCache[e.fontName];i.vertical&&(o+=Math.PI/2);let r=this.#fontInspectorEnabled&&i.fontSubstitution||i.fontFamily;r=TextLayer.fontFamilyMap.get(r)||r;const h=Math.hypot(n[2],n[3]),d=h*TextLayer.#getAscent(r,i,this.#lang);let l,c;o===0?(l=n[4],c=n[5]-d):(l=n[4]+d*Math.sin(o),c=n[5]-d*Math.cos(o));const u="calc(var(--total-scale-factor) *",a=t.style;this.#container===this.#rootContainer?(a.left=`${(100*l/this.#pageWidth).toFixed(2)}%`,a.top=`${(100*c/this.#pageHeight).toFixed(2)}%`):(a.left=`${u}${l.toFixed(2)}px)`,a.top=`${u}${c.toFixed(2)}px)`),a.fontSize=`${u}${(TextLayer.#minFontSize*h).toFixed(2)}px)`,a.fontFamily=r,s.fontSize=h,t.setAttribute("role","presentation"),t.textContent=e.str,t.dir=e.dir,this.#fontInspectorEnabled&&(t.dataset.fontName=i.fontSubstitutionLoadedName||e.fontName),o!==0&&(s.angle=o*(180/Math.PI));let m=!1;if(e.str.length>1)m=!0;else if(e.str!==" "&&e.transform[0]!==e.transform[3]){const t=Math.abs(e.transform[0]),n=Math.abs(e.transform[3]);t!==n&&Math.max(t,n)/Math.min(t,n)>1.5&&(m=!0)}if(m&&(s.canvasWidth=i.vertical?e.height:e.width),this.#textDivProperties.set(t,s),this.#layoutTextParams.div=t,this.#layoutTextParams.properties=s,this.#layout(this.#layoutTextParams),s.hasText&&this.#container.append(t),s.hasEOL){const e=document.createElement("br");e.setAttribute("role","presentation"),this.#container.append(e)}}#layout(e){const{div:s,properties:n,ctx:o}=e,{style:i}=s;let t="";if(TextLayer.#minFontSize>1&&(t=`scale(${1/TextLayer.#minFontSize})`),n.canvasWidth!==0&&n.hasText){const{fontFamily:a}=i,{canvasWidth:r,fontSize:c}=n;TextLayer.#ensureCtxFont(o,c*this.#scale,a);const{width:e}=o.measureText(s.textContent);e>0&&(t=`scaleX(${r*this.#scale/e}) ${t}`)}n.angle!==0&&(t=`rotate(${n.angle}deg) ${t}`),t.length>0&&(i.transform=t)}static cleanup(){if(this.#pendingTextLayers.size>0)return;this.#ascentCache.clear();for(const{canvas:e}of this.#canvasContexts.values())e.remove();this.#canvasContexts.clear()}static#getCtx(e=null){let t=this.#canvasContexts.get(e||="");if(!t){const n=document.createElement("canvas");n.className="hiddenCanvasElement",n.lang=e,document.body.append(n),t=n.getContext("2d",{alpha:!1,willReadFrequently:!0}),this.#canvasContexts.set(e,t),this.#canvasCtxFonts.set(t,{size:0,family:""})}return t}static#ensureCtxFont(e,t,n){const s=this.#canvasCtxFonts.get(e);if(t===s.size&&n===s.family)return;e.font=`${t}px ${n}`,s.size=t,s.family=n}static#ensureMinFontSizeComputed(){if(this.#minFontSize!==null)return;const e=document.createElement("div");e.style.opacity=0,e.style.lineHeight=1,e.style.fontSize="1px",e.style.position="absolute",e.textContent="X",document.body.append(e),this.#minFontSize=e.getBoundingClientRect().height,e.remove()}static#getAscent(e,t,n){const a=this.#ascentCache.get(e);if(a)return a;const s=this.#getCtx(n);s.canvas.width=s.canvas.height=DEFAULT_FONT_SIZE,this.#ensureCtxFont(s,DEFAULT_FONT_SIZE,e);const r=s.measureText(""),i=r.fontBoundingBoxAscent,c=Math.abs(r.fontBoundingBoxDescent);s.canvas.width=s.canvas.height=0;let o=.8;return i?o=i/(i+c):(util_FeatureTest.platform.isFirefox&&warn("Enable the `dom.textMetrics.fontBoundingBox.enabled` preference in `about:config` to improve TextLayer rendering."),t.ascent?o=t.ascent:t.descent&&(o=1+t.descent)),this.#ascentCache.set(e,o),o}}class XfaText{static textContent(e){const t=[],s={items:t,styles:Object.create(null)};function n(e){if(!e)return;let s=null;const o=e.name;if(o==="#text")s=e.value;else if(XfaText.shouldBuildText(o))e?.attributes?.textContent?s=e.attributes.textContent:e.value&&(s=e.value);else return;if(s!==null&&t.push({str:s}),!e.children)return;for(const t of e.children)n(t)}return n(e),s}static shouldBuildText(e){return!(e==="textarea"||e==="input"||e==="option"||e==="select")}}const RENDERING_CANCELLED_TIMEOUT=100;function getDocument(e={}){typeof e=="string"||e instanceof URL?e={url:e}:(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t=new PDFDocumentLoadingTask,{docId:l}=t,d=e.url?getUrlProp(e.url):null,o=e.data?getDataProp(e.data):null,B=e.httpHeaders||null,H=e.withCredentials===!0,z=e.password??null,r=e.range instanceof PDFDataRangeTransport?e.range:null,v=Number.isInteger(e.rangeChunkSize)&&e.rangeChunkSize>0?e.rangeChunkSize:2**16;let n=e.worker instanceof PDFWorker?e.worker:null;const g=e.verbosity,T=typeof e.docBaseUrl=="string"&&!isDataScheme(e.docBaseUrl)?e.docBaseUrl:null,s=getFactoryUrlProp(e.cMapUrl),F=e.cMapPacked!==!1,p=e.CMapReaderFactory||(isNodeJS?NodeCMapReaderFactory:DOMCMapReaderFactory),M=getFactoryUrlProp(e.iccUrl),c=getFactoryUrlProp(e.standardFontDataUrl),b=e.StandardFontDataFactory||(isNodeJS?NodeStandardFontDataFactory:DOMStandardFontDataFactory),a=getFactoryUrlProp(e.wasmUrl),y=e.WasmFactory||(isNodeJS?NodeWasmFactory:DOMWasmFactory),S=e.stopAtErrors!==!0,k=Number.isInteger(e.maxImageSize)&&e.maxImageSize>-1?e.maxImageSize:-1,O=e.isEvalSupported!==!1,D=typeof e.isOffscreenCanvasSupported=="boolean"?e.isOffscreenCanvasSupported:!isNodeJS,C=typeof e.isImageDecoderSupported=="boolean"?e.isImageDecoderSupported:!isNodeJS&&(util_FeatureTest.platform.isFirefox||!globalThis.chrome),E=Number.isInteger(e.canvasMaxAreaInBytes)?e.canvasMaxAreaInBytes:-1,w=typeof e.disableFontFace=="boolean"?e.disableFontFace:isNodeJS,A=e.fontExtraProperties===!0,_=e.enableXfa===!0,u=e.ownerDocument||globalThis.document,f=e.disableRange===!0,m=e.disableStream===!0,j=e.disableAutoFetch===!0,x=e.pdfBug===!0,N=e.CanvasFactory||(isNodeJS?NodeCanvasFactory:DOMCanvasFactory),L=e.FilterFactory||(isNodeJS?NodeFilterFactory:DOMFilterFactory),R=e.enableHWA===!0,P=e.useWasm!==!1,h=r?r.length:e.length??NaN,I=typeof e.useSystemFonts=="boolean"?e.useSystemFonts:!isNodeJS&&!w,i=typeof e.useWorkerFetch=="boolean"?e.useWorkerFetch:!!(p===DOMCMapReaderFactory&&b===DOMStandardFontDataFactory&&y===DOMWasmFactory&&s&&c&&a&&isValidFetchUrl(s,document.baseURI)&&isValidFetchUrl(c,document.baseURI)&&isValidFetchUrl(a,document.baseURI)),V=null;setVerbosityLevel(g);const $={canvasFactory:new N({ownerDocument:u,enableHWA:R}),filterFactory:new L({docId:l,ownerDocument:u}),cMapReaderFactory:i?null:new p({baseUrl:s,isCompressed:F}),standardFontDataFactory:i?null:new b({baseUrl:c}),wasmFactory:i?null:new y({baseUrl:a})};n||(n=PDFWorker.create({verbosity:g,port:GlobalWorkerOptions.workerPort}),t._worker=n);const W={docId:l,apiVersion:"5.3.60",data:o,password:z,disableAutoFetch:j,rangeChunkSize:v,length:h,docBaseUrl:T,enableXfa:_,evaluatorOptions:{maxImageSize:k,disableFontFace:w,ignoreErrors:S,isEvalSupported:O,isOffscreenCanvasSupported:D,isImageDecoderSupported:C,canvasMaxAreaInBytes:E,fontExtraProperties:A,useSystemFonts:I,useWasm:P,useWorkerFetch:i,cMapUrl:s,iccUrl:M,standardFontDataUrl:c,wasmUrl:a}},U={ownerDocument:u,pdfBug:x,styleElement:V,loadingParams:{disableAutoFetch:j,enableXfa:_}};return n.promise.then(function(){if(t.destroyed)throw new Error("Loading aborted");if(n.destroyed)throw new Error("Worker was destroyed");const s=n.messageHandler.sendWithPromise("GetDocRequest",W,o?[o.buffer]:null);let e;if(r)e=new PDFDataTransportStream(r,{disableRange:f,disableStream:m});else if(!o){if(!d)throw new Error("getDocument - no `url` parameter provided.");const t=isValidFetchUrl(d)?PDFFetchStream:isNodeJS?PDFNodeStream:PDFNetworkStream;e=new t({url:d,length:h,httpHeaders:B,withCredentials:H,rangeChunkSize:v,disableRange:f,disableStream:m})}return s.then(s=>{if(t.destroyed)throw new Error("Loading aborted");if(n.destroyed)throw new Error("Worker was destroyed");const o=new MessageHandler(l,s,n.port),i=new WorkerTransport(o,t,e,U,$);t._transport=i,o.send("Ready",null)})}).catch(t._capability.reject),t}class PDFDocumentLoadingTask{static#docId=0;_capability=Promise.withResolvers();_transport=null;_worker=null;docId=`d${PDFDocumentLoadingTask.#docId++}`;destroyed=!1;onPassword=null;onProgress=null;get promise(){return this._capability.promise}async destroy(){this.destroyed=!0;try{this._worker?.port&&(this._worker._pendingDestroy=!0),await this._transport?.destroy()}catch(e){throw this._worker?.port&&delete this._worker._pendingDestroy,e}this._transport=null,this._worker?.destroy(),this._worker=null}async getData(){return this._transport.getData()}}class PDFDataRangeTransport{#capability=Promise.withResolvers();#progressiveDoneListeners=[];#progressiveReadListeners=[];#progressListeners=[];#rangeListeners=[];constructor(e,t,n=!1,s=null){this.length=e,this.initialData=t,this.progressiveDone=n,this.contentDispositionFilename=s}addRangeListener(e){this.#rangeListeners.push(e)}addProgressListener(e){this.#progressListeners.push(e)}addProgressiveReadListener(e){this.#progressiveReadListeners.push(e)}addProgressiveDoneListener(e){this.#progressiveDoneListeners.push(e)}onDataRange(e,t){for(const n of this.#rangeListeners)n(e,t)}onDataProgress(e,t){this.#capability.promise.then(()=>{for(const n of this.#progressListeners)n(e,t)})}onDataProgressiveRead(e){this.#capability.promise.then(()=>{for(const t of this.#progressiveReadListeners)t(e)})}onDataProgressiveDone(){this.#capability.promise.then(()=>{for(const e of this.#progressiveDoneListeners)e()})}transportReady(){this.#capability.resolve()}requestDataRange(){unreachable("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}}class PDFDocumentProxy{constructor(e,t){this._pdfInfo=e,this._transport=t}get annotationStorage(){return this._transport.annotationStorage}get canvasFactory(){return this._transport.canvasFactory}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return shadow(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(e){return this._transport.getPage(e)}getPageIndex(e){return this._transport.getPageIndex(e)}getDestinations(){return this._transport.getDestinations()}getDestination(e){return this._transport.getDestination(e)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent:e="display"}={}){const{renderingIntent:t}=this._transport.getRenderingIntent(e);return this._transport.getOptionalContentConfig(t)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(e=!1){return this._transport.startCleanup(e||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(e){return this._transport.cachedPageNumber(e)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}}class PDFPageProxy{#pendingCleanup=!1;constructor(e,t,n,s=!1){this._pageIndex=e,this._pageInfo=t,this._transport=n,this._stats=s?new StatTimer:null,this._pdfBug=s,this.commonObjs=n.commonObjs,this.objs=new PDFObjects,this._intentStates=new Map,this.destroyed=!1}get pageNumber(){return this._pageIndex+1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:e,rotation:t=this.rotate,offsetX:n=0,offsetY:s=0,dontFlip:o=!1}={}){return new PageViewport({viewBox:this.view,userUnit:this.userUnit,scale:e,rotation:t,offsetX:n,offsetY:s,dontFlip:o})}getAnnotations({intent:e="display"}={}){const{renderingIntent:t}=this._transport.getRenderingIntent(e);return this._transport.getAnnotations(this._pageIndex,t)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return shadow(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext:e,viewport:t,intent:n="display",annotationMode:s=AnnotationMode.ENABLE,transform:o=null,background:i=null,optionalContentConfigPromise:a=null,annotationCanvasMap:r=null,pageColors:c=null,printAnnotationStorage:l=null,isEditing:d=!1}){this._stats?.time("Overall");const p=this._transport.getRenderingIntent(n,s,l,d),{renderingIntent:m,cacheKey:g}=p;this.#pendingCleanup=!1,a||=this._transport.getOptionalContentConfig(m);let u=this._intentStates.get(g);u||(u=Object.create(null),this._intentStates.set(g,u)),u.streamReaderCancelTimeout&&(clearTimeout(u.streamReaderCancelTimeout),u.streamReaderCancelTimeout=null);const v=!!(m&RenderingIntentFlag.PRINT);u.displayReadyCapability||(u.displayReadyCapability=Promise.withResolvers(),u.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(p));const f=e=>{u.renderTasks.delete(h),v&&(this.#pendingCleanup=!0),this.#tryCleanup(),e?(h.capability.reject(e),this._abortOperatorList({intentState:u,reason:e instanceof Error?e:new Error(e)})):h.capability.resolve(),this._stats&&(this._stats.timeEnd("Rendering"),this._stats.timeEnd("Overall"),globalThis.Stats?.enabled&&globalThis.Stats.add(this.pageNumber,this._stats))},h=new InternalRenderTask({callback:f,params:{canvasContext:e,viewport:t,transform:o,background:i},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:r,operatorList:u.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!v,pdfBug:this._pdfBug,pageColors:c});(u.renderTasks||=new Set).add(h);const b=h.task;return Promise.all([u.displayReadyCapability.promise,a]).then(([e,t])=>{if(this.destroyed){f();return}if(this._stats?.time("Rendering"),!(t.renderingIntent&m))throw new Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` and `PDFDocumentProxy.getOptionalContentConfig` methods.");h.initializeGraphics({transparency:e,optionalContentConfig:t}),h.operatorListChanged()}).catch(f),b}getOperatorList({intent:e="display",annotationMode:t=AnnotationMode.ENABLE,printAnnotationStorage:n=null,isEditing:s=!1}={}){function r(){o.operatorList.lastChunk&&(o.opListReadCapability.resolve(o.operatorList),o.renderTasks.delete(i))}const a=this._transport.getRenderingIntent(e,t,n,s,!0);let o=this._intentStates.get(a.cacheKey);o||(o=Object.create(null),this._intentStates.set(a.cacheKey,o));let i;return o.opListReadCapability||(i=Object.create(null),i.operatorListChanged=r,o.opListReadCapability=Promise.withResolvers(),(o.renderTasks||=new Set).add(i),o.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(a)),o.opListReadCapability.promise}streamTextContent({includeMarkedContent:e=!1,disableNormalization:t=!1}={}){const n=100;return this._transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this._pageIndex,includeMarkedContent:e===!0,disableNormalization:t===!0},{highWaterMark:n,size(e){return e.items.length}})}getTextContent(e={}){if(this._transport._htmlForXfa)return this.getXfa().then(e=>XfaText.textContent(e));const t=this.streamTextContent(e);return new Promise(function(e,n){function o(){i.read().then(function({value:t,done:n}){if(n){e(s);return}s.lang??=t.lang,Object.assign(s.styles,t.styles),s.items.push(...t.items),o()},n)}const i=t.getReader(),s={items:[],styles:Object.create(null),lang:null};o()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=!0;const e=[];for(const t of this._intentStates.values()){if(this._abortOperatorList({intentState:t,reason:new Error("Page was destroyed."),force:!0}),t.opListReadCapability)continue;for(const n of t.renderTasks)e.push(n.completed),n.cancel()}return this.objs.clear(),this.#pendingCleanup=!1,Promise.all(e)}cleanup(e=!1){this.#pendingCleanup=!0;const t=this.#tryCleanup();return e&&t&&(this._stats&&=new StatTimer),t}#tryCleanup(){if(!this.#pendingCleanup||this.destroyed)return!1;for(const{renderTasks:e,operatorList:t}of this._intentStates.values())if(e.size>0||!t.lastChunk)return!1;return this._intentStates.clear(),this.objs.clear(),this.#pendingCleanup=!1,!0}_startRenderPage(e,t){const n=this._intentStates.get(t);if(!n)return;this._stats?.timeEnd("Page Request"),n.displayReadyCapability?.resolve(e)}_renderPageChunk(e,t){for(let n=0,s=e.length;n<s;n++)t.operatorList.fnArray.push(e.fnArray[n]),t.operatorList.argsArray.push(e.argsArray[n]);t.operatorList.lastChunk=e.lastChunk,t.operatorList.separateAnnots=e.separateAnnots;for(const e of t.renderTasks)e.operatorListChanged();e.lastChunk&&this.#tryCleanup()}_pumpOperatorList({renderingIntent:e,cacheKey:t,annotationStorageSerializable:n,modifiedIds:s}){const{map:r,transfer:c}=n,l=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageIndex:this._pageIndex,intent:e,cacheKey:t,annotationStorage:r,modifiedIds:s},c),i=l.getReader(),o=this._intentStates.get(t);o.streamReader=i;const a=()=>{i.read().then(({value:e,done:t})=>{if(t){o.streamReader=null;return}if(this._transport.destroyed)return;this._renderPageChunk(e,o),a()},e=>{if(o.streamReader=null,this._transport.destroyed)return;if(o.operatorList){o.operatorList.lastChunk=!0;for(const e of o.renderTasks)e.operatorListChanged();this.#tryCleanup()}if(o.displayReadyCapability)o.displayReadyCapability.reject(e);else if(o.opListReadCapability)o.opListReadCapability.reject(e);else throw e})};a()}_abortOperatorList({intentState:e,reason:t,force:n=!1}){if(!e.streamReader)return;if(e.streamReaderCancelTimeout&&(clearTimeout(e.streamReaderCancelTimeout),e.streamReaderCancelTimeout=null),!n){if(e.renderTasks.size>0)return;if(t instanceof RenderingCancelledException){let n=RENDERING_CANCELLED_TIMEOUT;t.extraDelay>0&&t.extraDelay<1e3&&(n+=t.extraDelay),e.streamReaderCancelTimeout=setTimeout(()=>{e.streamReaderCancelTimeout=null,this._abortOperatorList({intentState:e,reason:t,force:!0})},n);return}}if(e.streamReader.cancel(new AbortException(t.message)).catch(()=>{}),e.streamReader=null,this._transport.destroyed)return;for(const[t,n]of this._intentStates)if(n===e){this._intentStates.delete(t);break}this.cleanup()}get stats(){return this._stats}}class PDFWorker{#capability=Promise.withResolvers();#messageHandler=null;#port=null;#webWorker=null;static#fakeWorkerId=0;static#isWorkerDisabled=!1;static#workerPorts=new WeakMap;static{if(isNodeJS){this.#isWorkerDisabled=!0;GlobalWorkerOptions.workerSrc||="./pdf.worker.mjs"}this._isSameOrigin=(e,t)=>{const n=URL.parse(e);if(!n?.origin||n.origin==="null")return!1;const s=new URL(t,n);return n.origin===s.origin};this._createCDNWrapper=e=>{const t=`await import("${e}");`;return URL.createObjectURL(new Blob([t],{type:"text/javascript"}))};this.fromPort=e=>{if(deprecated("`PDFWorker.fromPort` - please use `PDFWorker.create` instead."),!e?.port)throw new Error("PDFWorker.fromPort - invalid method signature.");return this.create(e)}}constructor({name:e=null,port:t=null,verbosity:n=getVerbosityLevel()}={}){if(this.name=e,this.destroyed=!1,this.verbosity=n,t){if(PDFWorker.#workerPorts.has(t))throw new Error("Cannot use more than one PDFWorker per port.");PDFWorker.#workerPorts.set(t,this),this.#initializeFromPort(t)}else this.#initialize()}get promise(){return this.#capability.promise}#resolve(){this.#capability.resolve(),this.#messageHandler.send("configure",{verbosity:this.verbosity})}get port(){return this.#port}get messageHandler(){return this.#messageHandler}#initializeFromPort(e){this.#port=e,this.#messageHandler=new MessageHandler("main","worker",e),this.#messageHandler.on("ready",()=>{}),this.#resolve()}#initialize(){if(PDFWorker.#isWorkerDisabled||PDFWorker.#mainThreadWorkerMessageHandler){this.#setupFakeWorker();return}let{workerSrc:e}=PDFWorker;try{PDFWorker._isSameOrigin(window.location,e)||(e=PDFWorker._createCDNWrapper(new URL(e,window.location).href));const t=new Worker(e,{type:"module"}),n=new MessageHandler("main","worker",t),o=()=>{s.abort(),n.destroy(),t.terminate(),this.destroyed?this.#capability.reject(new Error("Worker was destroyed")):this.#setupFakeWorker()},s=new AbortController;t.addEventListener("error",()=>{this.#webWorker||o()},{signal:s.signal}),n.on("test",e=>{if(s.abort(),this.destroyed||!e){o();return}this.#messageHandler=n,this.#port=t,this.#webWorker=t,this.#resolve()}),n.on("ready",e=>{if(s.abort(),this.destroyed){o();return}try{i()}catch{this.#setupFakeWorker()}});const i=()=>{const e=new Uint8Array;n.send("test",e,[e.buffer])};i();return}catch{info("The worker has been disabled.")}this.#setupFakeWorker()}#setupFakeWorker(){PDFWorker.#isWorkerDisabled||(warn("Setting up fake worker."),PDFWorker.#isWorkerDisabled=!0),PDFWorker._setupFakeWorkerGlobal.then(e=>{if(this.destroyed){this.#capability.reject(new Error("Worker was destroyed"));return}const t=new LoopbackPort;this.#port=t;const n=`fake${PDFWorker.#fakeWorkerId++}`,s=new MessageHandler(n+"_worker",n,t);e.setup(s,t),this.#messageHandler=new MessageHandler(n,n+"_worker",t),this.#resolve()}).catch(e=>{this.#capability.reject(new Error(`Setting up fake worker failed: "${e.message}".`))})}destroy(){this.destroyed=!0,this.#webWorker?.terminate(),this.#webWorker=null,PDFWorker.#workerPorts.delete(this.#port),this.#port=null,this.#messageHandler?.destroy(),this.#messageHandler=null}static create(e){const t=this.#workerPorts.get(e?.port);if(t){if(t._pendingDestroy)throw new Error("PDFWorker.create - the worker is being destroyed.\nPlease remember to await `PDFDocumentLoadingTask.destroy()`-calls.");return t}return new PDFWorker(e)}static get workerSrc(){if(GlobalWorkerOptions.workerSrc)return GlobalWorkerOptions.workerSrc;throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get#mainThreadWorkerMessageHandler(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}}static get _setupFakeWorkerGlobal(){const e=async()=>{if(this.#mainThreadWorkerMessageHandler)return this.#mainThreadWorkerMessageHandler;const e=await import(this.workerSrc);return e.WorkerMessageHandler};return shadow(this,"_setupFakeWorkerGlobal",e())}}class WorkerTransport{#methodPromises=new Map;#pageCache=new Map;#pagePromises=new Map;#pageRefCache=new Map;#passwordCapability=null;constructor(e,t,n,s,o){this.messageHandler=e,this.loadingTask=t,this.commonObjs=new PDFObjects,this.fontLoader=new FontLoader({ownerDocument:s.ownerDocument,styleElement:s.styleElement}),this.loadingParams=s.loadingParams,this._params=s,this.canvasFactory=o.canvasFactory,this.filterFactory=o.filterFactory,this.cMapReaderFactory=o.cMapReaderFactory,this.standardFontDataFactory=o.standardFontDataFactory,this.wasmFactory=o.wasmFactory,this.destroyed=!1,this.destroyCapability=null,this._networkStream=n,this._fullReader=null,this._lastProgress=null,this.downloadInfoCapability=Promise.withResolvers(),this.setupMessageHandler()}#cacheSimpleMethod(e,t=null){const n=this.#methodPromises.get(e);if(n)return n;const s=this.messageHandler.sendWithPromise(e,t);return this.#methodPromises.set(e,s),s}get annotationStorage(){return shadow(this,"annotationStorage",new AnnotationStorage)}getRenderingIntent(e,t=AnnotationMode.ENABLE,n=null,s=!1,o=!1){let i=RenderingIntentFlag.DISPLAY,a=SerializableEmpty;switch(e){case"any":i=RenderingIntentFlag.ANY;break;case"display":break;case"print":i=RenderingIntentFlag.PRINT;break;default:warn(`getRenderingIntent - invalid intent: ${e}`)}const r=i&RenderingIntentFlag.PRINT&&n instanceof PrintAnnotationStorage?n:this.annotationStorage;switch(t){case AnnotationMode.DISABLE:i+=RenderingIntentFlag.ANNOTATIONS_DISABLE;break;case AnnotationMode.ENABLE:break;case AnnotationMode.ENABLE_FORMS:i+=RenderingIntentFlag.ANNOTATIONS_FORMS;break;case AnnotationMode.ENABLE_STORAGE:i+=RenderingIntentFlag.ANNOTATIONS_STORAGE,a=r.serializable;break;default:warn(`getRenderingIntent - invalid annotationMode: ${t}`)}s&&(i+=RenderingIntentFlag.IS_EDITING),o&&(i+=RenderingIntentFlag.OPLIST);const{ids:c,hash:l}=r.modifiedIds,d=[i,a.hash,l];return{renderingIntent:i,cacheKey:d.join("_"),annotationStorageSerializable:a,modifiedIds:c}}destroy(){if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=Promise.withResolvers(),this.#passwordCapability?.reject(new Error("Worker was destroyed during onPassword callback"));const e=[];for(const t of this.#pageCache.values())e.push(t._destroy());this.#pageCache.clear(),this.#pagePromises.clear(),this.#pageRefCache.clear(),this.hasOwnProperty("annotationStorage")&&this.annotationStorage.resetModified();const t=this.messageHandler.sendWithPromise("Terminate",null);return e.push(t),Promise.all(e).then(()=>{this.commonObjs.clear(),this.fontLoader.clear(),this.#methodPromises.clear(),this.filterFactory.destroy(),TextLayer.cleanup(),this._networkStream?.cancelAllRequests(new AbortException("Worker was terminated.")),this.messageHandler?.destroy(),this.messageHandler=null,this.destroyCapability.resolve()},this.destroyCapability.reject),this.destroyCapability.promise}setupMessageHandler(){const{messageHandler:e,loadingTask:t}=this;e.on("GetReader",(e,t)=>{assert(this._networkStream,"GetReader - no `IPDFStream` instance available."),this._fullReader=this._networkStream.getFullReader(),this._fullReader.onProgress=e=>{this._lastProgress={loaded:e.loaded,total:e.total}},t.onPull=()=>{this._fullReader.read().then(function({value:e,done:n}){if(n){t.close();return}assert(e instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer."),t.enqueue(new Uint8Array(e),1,[e])}).catch(e=>{t.error(e)})},t.onCancel=e=>{this._fullReader.cancel(e),t.ready.catch(e=>{if(this.destroyed)return;throw e})}}),e.on("ReaderHeadersReady",async e=>{await this._fullReader.headersReady;const{isStreamingSupported:n,isRangeSupported:s,contentLength:o}=this._fullReader;return(!n||!s)&&(this._lastProgress&&t.onProgress?.(this._lastProgress),this._fullReader.onProgress=e=>{t.onProgress?.({loaded:e.loaded,total:e.total})}),{isStreamingSupported:n,isRangeSupported:s,contentLength:o}}),e.on("GetRangeReader",(e,t)=>{assert(this._networkStream,"GetRangeReader - no `IPDFStream` instance available.");const n=this._networkStream.getRangeReader(e.begin,e.end);if(!n){t.close();return}t.onPull=()=>{n.read().then(function({value:e,done:n}){if(n){t.close();return}assert(e instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer."),t.enqueue(new Uint8Array(e),1,[e])}).catch(e=>{t.error(e)})},t.onCancel=e=>{n.cancel(e),t.ready.catch(e=>{if(this.destroyed)return;throw e})}}),e.on("GetDoc",({pdfInfo:e})=>{this._numPages=e.numPages,this._htmlForXfa=e.htmlForXfa,delete e.htmlForXfa,t._capability.resolve(new PDFDocumentProxy(e,this))}),e.on("DocException",e=>{t._capability.reject(wrapReason(e))}),e.on("PasswordRequest",e=>{this.#passwordCapability=Promise.withResolvers();try{if(!t.onPassword)throw wrapReason(e);const n=e=>{e instanceof Error?this.#passwordCapability.reject(e):this.#passwordCapability.resolve({password:e})};t.onPassword(n,e.code)}catch(e){this.#passwordCapability.reject(e)}return this.#passwordCapability.promise}),e.on("DataLoaded",e=>{t.onProgress?.({loaded:e.length,total:e.length}),this.downloadInfoCapability.resolve(e)}),e.on("StartRenderPage",e=>{if(this.destroyed)return;const t=this.#pageCache.get(e.pageIndex);t._startRenderPage(e.transparency,e.cacheKey)}),e.on("commonobj",([t,n,s])=>{if(this.destroyed)return null;if(this.commonObjs.has(t))return null;switch(n){case"Font":if("error"in s){const e=s.error;warn(`Error during font loading: ${e}`),this.commonObjs.resolve(t,e);break}const a=this._params.pdfBug&&globalThis.FontInspector?.enabled?(e,t)=>globalThis.FontInspector.fontAdded(e,t):null,o=new FontFaceObject(s,a);this.fontLoader.bind(o).catch(()=>e.sendWithPromise("FontFallback",{id:t})).finally(()=>{!o.fontExtraProperties&&o.data&&(o.data=null),this.commonObjs.resolve(t,o)});break;case"CopyLocalImage":const{imageRef:i}=s;assert(i,"The imageRef must be defined.");for(const e of this.#pageCache.values())for(const[,n]of e.objs){if(n?.ref!==i)continue;return n.dataLen?(this.commonObjs.resolve(t,structuredClone(n)),n.dataLen):null}break;case"FontPath":case"Image":case"Pattern":this.commonObjs.resolve(t,s);break;default:throw new Error(`Got unknown common object type ${n}`)}return null}),e.on("obj",([e,t,n,s])=>{if(this.destroyed)return;const o=this.#pageCache.get(t);if(o.objs.has(e))return;if(o._intentStates.size===0){s?.bitmap?.close();return}switch(n){case"Image":case"Pattern":o.objs.resolve(e,s);break;default:throw new Error(`Got unknown object type ${n}`)}}),e.on("DocProgress",e=>{if(this.destroyed)return;t.onProgress?.({loaded:e.loaded,total:e.total})}),e.on("FetchBinaryData",async e=>{if(this.destroyed)throw new Error("Worker was destroyed.");const t=this[e.type];if(!t)throw new Error(`${e.type} not initialized, see the \`useWorkerFetch\` parameter.`);return t.fetch(e)})}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){this.annotationStorage.size<=0&&warn("saveDocument called while `annotationStorage` is empty, please use the getData-method instead.");const{map:e,transfer:t}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:e,filename:this._fullReader?.filename??null},t).finally(()=>{this.annotationStorage.resetModified()})}getPage(e){if(!Number.isInteger(e)||e<=0||e>this._numPages)return Promise.reject(new Error("Invalid page request."));const t=e-1,n=this.#pagePromises.get(t);if(n)return n;const s=this.messageHandler.sendWithPromise("GetPage",{pageIndex:t}).then(n=>{if(this.destroyed)throw new Error("Transport destroyed");n.refStr&&this.#pageRefCache.set(n.refStr,e);const s=new PDFPageProxy(t,n,this,this._params.pdfBug);return this.#pageCache.set(t,s),s});return this.#pagePromises.set(t,s),s}getPageIndex(e){return isRefProxy(e)?this.messageHandler.sendWithPromise("GetPageIndex",{num:e.num,gen:e.gen}):Promise.reject(new Error("Invalid pageIndex request."))}getAnnotations(e,t){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:e,intent:t})}getFieldObjects(){return this.#cacheSimpleMethod("GetFieldObjects")}hasJSActions(){return this.#cacheSimpleMethod("HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(e){return typeof e!="string"?Promise.reject(new Error("Invalid destination request.")):this.messageHandler.sendWithPromise("GetDestination",{id:e})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getDocJSActions(){return this.#cacheSimpleMethod("GetDocJSActions")}getPageJSActions(e){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex:e})}getStructTree(e){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex:e})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(e){return this.#cacheSimpleMethod("GetOptionalContentConfig").then(t=>new OptionalContentConfig(t,e))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){const e="GetMetadata",t=this.#methodPromises.get(e);if(t)return t;const n=this.messageHandler.sendWithPromise(e,null).then(e=>({info:e[0],metadata:e[1]?new Metadata(e[1]):null,contentDispositionFilename:this._fullReader?.filename??null,contentLength:this._fullReader?.contentLength??null}));return this.#methodPromises.set(e,n),n}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(e=!1){if(this.destroyed)return;await this.messageHandler.sendWithPromise("Cleanup",null);for(const e of this.#pageCache.values()){const t=e.cleanup();if(!t)throw new Error(`startCleanup: Page ${e.pageNumber} is currently rendering.`)}this.commonObjs.clear(),e||this.fontLoader.clear(),this.#methodPromises.clear(),this.filterFactory.destroy(!0),TextLayer.cleanup()}cachedPageNumber(e){if(!isRefProxy(e))return null;const t=e.gen===0?`${e.num}R`:`${e.num}R${e.gen}`;return this.#pageRefCache.get(t)??null}}class RenderTask{#internalRenderTask=null;onContinue=null;onError=null;constructor(e){this.#internalRenderTask=e}get promise(){return this.#internalRenderTask.capability.promise}cancel(e=0){this.#internalRenderTask.cancel(null,e)}get separateAnnots(){const{separateAnnots:e}=this.#internalRenderTask.operatorList;if(!e)return!1;const{annotationCanvasMap:t}=this.#internalRenderTask;return e.form||e.canvas&&t?.size>0}}class InternalRenderTask{#rAF=null;static#canvasInUse=new WeakSet;constructor({callback:e,params:t,objs:n,commonObjs:s,annotationCanvasMap:o,operatorList:i,pageIndex:a,canvasFactory:r,filterFactory:c,useRequestAnimationFrame:l=!1,pdfBug:d=!1,pageColors:u=null}){this.callback=e,this.params=t,this.objs=n,this.commonObjs=s,this.annotationCanvasMap=o,this.operatorListIdx=null,this.operatorList=i,this._pageIndex=a,this.canvasFactory=r,this.filterFactory=c,this._pdfBug=d,this.pageColors=u,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this._useRequestAnimationFrame=l===!0&&typeof window!="undefined",this.cancelled=!1,this.capability=Promise.withResolvers(),this.task=new RenderTask(this),this._cancelBound=this.cancel.bind(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=t.canvasContext.canvas}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:e=!1,optionalContentConfig:t}){if(this.cancelled)return;if(this._canvas){if(InternalRenderTask.#canvasInUse.has(this._canvas))throw new Error("Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.");InternalRenderTask.#canvasInUse.add(this._canvas)}this._pdfBug&&globalThis.StepperManager?.enabled&&(this.stepper=globalThis.StepperManager.create(this._pageIndex),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());const{canvasContext:n,viewport:s,transform:o,background:i}=this.params;this.gfx=new CanvasGraphics(n,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:t},this.annotationCanvasMap,this.pageColors),this.gfx.beginDrawing({transform:o,viewport:s,transparency:e,background:i}),this.operatorListIdx=0,this.graphicsReady=!0,this.graphicsReadyCallback?.()}cancel(e=null,t=0){this.running=!1,this.cancelled=!0,this.gfx?.endDrawing(),this.#rAF&&(window.cancelAnimationFrame(this.#rAF),this.#rAF=null),InternalRenderTask.#canvasInUse.delete(this._canvas),e||=new RenderingCancelledException(`Rendering cancelled, page ${this._pageIndex+1}`,t),this.callback(e),this.task.onError?.(e)}operatorListChanged(){if(!this.graphicsReady){this.graphicsReadyCallback||=this._continueBound;return}if(this.stepper?.updateOperatorList(this.operatorList),this.running)return;this._continue()}_continue(){if(this.running=!0,this.cancelled)return;this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext()}_scheduleNext(){this._useRequestAnimationFrame?this.#rAF=window.requestAnimationFrame(()=>{this.#rAF=null,this._nextBound().catch(this._cancelBound)}):Promise.resolve().then(this._nextBound).catch(this._cancelBound)}async _next(){if(this.cancelled)return;this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper),this.operatorListIdx===this.operatorList.argsArray.length&&(this.running=!1,this.operatorList.lastChunk&&(this.gfx.endDrawing(),InternalRenderTask.#canvasInUse.delete(this._canvas),this.callback()))}}const version="5.3.60",build="e78575e59";function makeColorComp(e){return Math.floor(Math.max(0,Math.min(1,e))*255).toString(16).padStart(2,"0")}function scaleAndClamp(e){return Math.max(0,Math.min(255,255*e))}class ColorConverters{static CMYK_G([e,t,n,s]){return["G",1-Math.min(1,.3*e+.59*n+.11*t+s)]}static G_CMYK([e]){return["CMYK",0,0,0,1-e]}static G_RGB([e]){return["RGB",e,e,e]}static G_rgb([e]){return e=scaleAndClamp(e),[e,e,e]}static G_HTML([e]){const t=makeColorComp(e);return`#${t}${t}${t}`}static RGB_G([e,t,n]){return["G",.3*e+.59*t+.11*n]}static RGB_rgb(e){return e.map(scaleAndClamp)}static RGB_HTML(e){return`#${e.map(makeColorComp).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([e,t,n,s]){return["RGB",1-Math.min(1,e+s),1-Math.min(1,n+s),1-Math.min(1,t+s)]}static CMYK_rgb([e,t,n,s]){return[scaleAndClamp(1-Math.min(1,e+s)),scaleAndClamp(1-Math.min(1,n+s)),scaleAndClamp(1-Math.min(1,t+s))]}static CMYK_HTML(e){const t=this.CMYK_RGB(e).slice(1);return this.RGB_HTML(t)}static RGB_CMYK([e,t,n]){const s=1-e,o=1-t,i=1-n,a=Math.min(s,o,i);return["CMYK",s,o,i,a]}}const DateFormats=null&&["m/d","m/d/yy","mm/dd/yy","mm/yy","d-mmm","d-mmm-yy","dd-mmm-yy","yy-mm-dd","mmm-yy","mmmm-yy","mmm d, yyyy","mmmm d, yyyy","m/d/yy h:MM tt","m/d/yy HH:MM"],TimeFormats=null&&["HH:MM","h:MM tt","HH:MM:ss","h:MM:ss tt"];class BaseSVGFactory{create(e,t,n=!1){if(e<=0||t<=0)throw new Error("Invalid SVG dimensions");const s=this._createSVG("svg:svg");return s.setAttribute("version","1.1"),n||(s.setAttribute("width",`${e}px`),s.setAttribute("height",`${t}px`)),s.setAttribute("preserveAspectRatio","none"),s.setAttribute("viewBox",`0 0 ${e} ${t}`),s}createElement(e){if(typeof e!="string")throw new Error("Invalid SVG element type");return this._createSVG(e)}_createSVG(){unreachable("Abstract method `_createSVG` called.")}}class DOMSVGFactory extends BaseSVGFactory{_createSVG(e){return document.createElementNS(SVG_NS,e)}}class XfaLayer{static setupStorage(e,t,n,s,o){const i=s.getValue(t,{value:null});switch(n.name){case"textarea":if(i.value!==null&&(e.textContent=i.value),o==="print")break;e.addEventListener("input",e=>{s.setValue(t,{value:e.target.value})});break;case"input":if(n.attributes.type==="radio"||n.attributes.type==="checkbox"){if(i.value===n.attributes.xfaOn?e.setAttribute("checked",!0):i.value===n.attributes.xfaOff&&e.removeAttribute("checked"),o==="print")break;e.addEventListener("change",e=>{s.setValue(t,{value:e.target.checked?e.target.getAttribute("xfaOn"):e.target.getAttribute("xfaOff")})})}else{if(i.value!==null&&e.setAttribute("value",i.value),o==="print")break;e.addEventListener("input",e=>{s.setValue(t,{value:e.target.value})})}break;case"select":if(i.value!==null){e.setAttribute("value",i.value);for(const e of n.children)e.attributes.value===i.value?e.attributes.selected=!0:e.attributes.hasOwnProperty("selected")&&delete e.attributes.selected}e.addEventListener("input",e=>{const n=e.target.options,o=n.selectedIndex===-1?"":n[n.selectedIndex].value;s.setValue(t,{value:o})});break}}static setAttributes({html:e,element:t,storage:n=null,intent:s,linkService:o}){const{attributes:i}=t,a=e instanceof HTMLAnchorElement;i.type==="radio"&&(i.name=`${i.name}-${s}`);for(const[n,t]of Object.entries(i)){if(t==null)continue;switch(n){case"class":t.length&&e.setAttribute(n,t.join(" "));break;case"dataId":break;case"id":e.setAttribute("data-element-id",t);break;case"style":Object.assign(e.style,t);break;case"textContent":e.textContent=t;break;default:(!a||n!=="href"&&n!=="newWindow")&&e.setAttribute(n,t)}}a&&o.addLinkAttributes(e,i.href,i.newWindow),n&&i.dataId&&this.setupStorage(e,i.dataId,t,n)}static render(e){const l=e.annotationStorage,c=e.linkService,t=e.xfaHtml,a=e.intent||"display",o=document.createElement(t.name);t.attributes&&this.setAttributes({html:o,element:t,intent:a,linkService:c});const r=a!=="richText",i=e.div;if(i.append(o),e.viewport){const t=`matrix(${e.viewport.transform.join(",")})`;i.style.transform=t}r&&i.setAttribute("class","xfaLayer xfaFont");const n=[];if(t.children.length===0){if(t.value){const e=document.createTextNode(t.value);o.append(e),r&&XfaText.shouldBuildText(t.name)&&n.push(e)}return{textDivs:n}}const s=[[t,-1,o]];for(;s.length>0;){const[i,u,d]=s.at(-1);if(u+1===i.children.length){s.pop();continue}const e=i.children[++s.at(-1)[1]];if(e===null)continue;const{name:t}=e;if(t==="#text"){const t=document.createTextNode(e.value);n.push(t),d.append(t);continue}const o=e?.attributes?.xmlns?document.createElementNS(e.attributes.xmlns,t):document.createElement(t);if(d.append(o),e.attributes&&this.setAttributes({html:o,element:e,storage:l,intent:a,linkService:c}),e.children?.length>0)s.push([e,-1,o]);else if(e.value){const s=document.createTextNode(e.value);r&&XfaText.shouldBuildText(t)&&n.push(s),o.append(s)}}for(const e of i.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea"))e.setAttribute("readOnly",!0);return{textDivs:n}}static update(e){const t=`matrix(${e.viewport.transform.join(",")})`;e.div.style.transform=t,e.div.hidden=!1}}const annotation_layer_DEFAULT_FONT_SIZE=9,GetElementsByNameSet=new WeakSet;class AnnotationElementFactory{static create(e){const t=e.data.annotationType;switch(t){case AnnotationType.LINK:return new LinkAnnotationElement(e);case AnnotationType.TEXT:return new TextAnnotationElement(e);case AnnotationType.WIDGET:const t=e.data.fieldType;switch(t){case"Tx":return new TextWidgetAnnotationElement(e);case"Btn":return e.data.radioButton?new RadioButtonWidgetAnnotationElement(e):e.data.checkBox?new CheckboxWidgetAnnotationElement(e):new PushButtonWidgetAnnotationElement(e);case"Ch":return new ChoiceWidgetAnnotationElement(e);case"Sig":return new SignatureWidgetAnnotationElement(e)}return new WidgetAnnotationElement(e);case AnnotationType.POPUP:return new PopupAnnotationElement(e);case AnnotationType.FREETEXT:return new FreeTextAnnotationElement(e);case AnnotationType.LINE:return new LineAnnotationElement(e);case AnnotationType.SQUARE:return new SquareAnnotationElement(e);case AnnotationType.CIRCLE:return new CircleAnnotationElement(e);case AnnotationType.POLYLINE:return new PolylineAnnotationElement(e);case AnnotationType.CARET:return new CaretAnnotationElement(e);case AnnotationType.INK:return new InkAnnotationElement(e);case AnnotationType.POLYGON:return new PolygonAnnotationElement(e);case AnnotationType.HIGHLIGHT:return new HighlightAnnotationElement(e);case AnnotationType.UNDERLINE:return new UnderlineAnnotationElement(e);case AnnotationType.SQUIGGLY:return new SquigglyAnnotationElement(e);case AnnotationType.STRIKEOUT:return new StrikeOutAnnotationElement(e);case AnnotationType.STAMP:return new StampAnnotationElement(e);case AnnotationType.FILEATTACHMENT:return new FileAttachmentAnnotationElement(e);default:return new AnnotationElement(e)}}}class AnnotationElement{#updates=null;#hasBorder=!1;#popupElement=null;constructor(e,{isRenderable:t=!1,ignoreBorder:n=!1,createQuadrilaterals:s=!1}={}){this.isRenderable=t,this.data=e.data,this.layer=e.layer,this.linkService=e.linkService,this.downloadManager=e.downloadManager,this.imageResourcesPath=e.imageResourcesPath,this.renderForms=e.renderForms,this.svgFactory=e.svgFactory,this.annotationStorage=e.annotationStorage,this.enableScripting=e.enableScripting,this.hasJSActions=e.hasJSActions,this._fieldObjects=e.fieldObjects,this.parent=e.parent,t&&(this.container=this._createContainer(n)),s&&this._createQuadrilaterals()}static _hasPopupData({contentsObj:e,richText:t}){return!!(e?.str||t?.str)}get _isEditable(){return this.data.isEditable}get hasPopupData(){return AnnotationElement._hasPopupData(this.data)}updateEdited(e){if(!this.container)return;this.#updates||={rect:this.data.rect.slice(0)};const{rect:t}=e;t&&this.#setRectEdited(t),this.#popupElement?.popup.updateEdited(e)}resetEdited(){if(!this.#updates)return;this.#setRectEdited(this.#updates.rect),this.#popupElement?.popup.resetEdited(),this.#updates=null}#setRectEdited(e){const{container:{style:t},data:{rect:i,rotation:s},parent:{viewport:{rawDims:{pageWidth:o,pageHeight:n,pageX:a,pageY:r}}}}=this;i?.splice(0,4,...e),t.left=`${100*(e[0]-a)/o}%`,t.top=`${100*(n-e[3]+r)/n}%`,s===0?(t.width=`${100*(e[2]-e[0])/o}%`,t.height=`${100*(e[3]-e[1])/n}%`):this.setRotation(s)}_createContainer(e){const{data:t,parent:{page:o,viewport:u}}=this,s=document.createElement("section");s.setAttribute("data-annotation-id",t.id),this instanceof WidgetAnnotationElement||(s.tabIndex=0);const{style:n}=s;if(n.zIndex=this.parent.zIndex++,t.alternativeText&&(s.title=t.alternativeText),t.noRotate&&s.classList.add("norotate"),!t.rect||this instanceof PopupAnnotationElement){const{rotation:e}=t;return!t.hasOwnCanvas&&e!==0&&this.setRotation(e,s),s}const{width:a,height:i}=this;if(!e&&t.borderStyle.width>0){n.borderWidth=`${t.borderStyle.width}px`;const s=t.borderStyle.horizontalCornerRadius,o=t.borderStyle.verticalCornerRadius;if(s>0||o>0){const e=`calc(${s}px * var(--total-scale-factor)) / calc(${o}px * var(--total-scale-factor))`;n.borderRadius=e}else if(this instanceof RadioButtonWidgetAnnotationElement){const e=`calc(${a}px * var(--total-scale-factor)) / calc(${i}px * var(--total-scale-factor))`;n.borderRadius=e}switch(t.borderStyle.style){case AnnotationBorderStyleType.SOLID:n.borderStyle="solid";break;case AnnotationBorderStyleType.DASHED:n.borderStyle="dashed";break;case AnnotationBorderStyleType.BEVELED:warn("Unimplemented border style: beveled");break;case AnnotationBorderStyleType.INSET:warn("Unimplemented border style: inset");break;case AnnotationBorderStyleType.UNDERLINE:n.borderBottomStyle="solid";break;default:break}const e=t.borderColor||null;e?(this.#hasBorder=!0,n.borderColor=Util.makeHexColor(e[0]|0,e[1]|0,e[2]|0)):n.borderWidth=0}const r=Util.normalizeRect([t.rect[0],o.view[3]-t.rect[1]+o.view[1],t.rect[2],o.view[3]-t.rect[3]+o.view[1]]),{pageWidth:c,pageHeight:l,pageX:h,pageY:m}=u.rawDims;n.left=`${100*(r[0]-h)/c}%`,n.top=`${100*(r[1]-m)/l}%`;const{rotation:d}=t;return t.hasOwnCanvas||d===0?(n.width=`${100*a/c}%`,n.height=`${100*i/l}%`):this.setRotation(d,s),s}setRotation(e,t=this.container){if(!this.data.rect)return;const{pageWidth:o,pageHeight:i}=this.parent.viewport.rawDims;let{width:n,height:s}=this;e%180!==0&&([n,s]=[s,n]),t.style.width=`${100*n/o}%`,t.style.height=`${100*s/i}%`,t.setAttribute("data-main-rotation",(360-e)%360)}get _commonActions(){const e=(e,t,n)=>{const s=n.detail[e],o=s[0],i=s.slice(1);n.target.style[t]=ColorConverters[`${o}_HTML`](i),this.annotationStorage.setValue(this.data.id,{[t]:ColorConverters[`${o}_rgb`](i)})};return shadow(this,"_commonActions",{display:e=>{const{display:t}=e.detail,n=t%2===1;this.container.style.visibility=n?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noView:n,noPrint:t===1||t===2})},print:e=>{this.annotationStorage.setValue(this.data.id,{noPrint:!e.detail.print})},hidden:e=>{const{hidden:t}=e.detail;this.container.style.visibility=t?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noPrint:t,noView:t})},focus:e=>{setTimeout(()=>e.target.focus({preventScroll:!1}),0)},userName:e=>{e.target.title=e.detail.userName},readonly:e=>{e.target.disabled=e.detail.readonly},required:e=>{this._setRequired(e.target,e.detail.required)},bgColor:t=>{e("bgColor","backgroundColor",t)},fillColor:t=>{e("fillColor","backgroundColor",t)},fgColor:t=>{e("fgColor","color",t)},textColor:t=>{e("textColor","color",t)},borderColor:t=>{e("borderColor","borderColor",t)},strokeColor:t=>{e("strokeColor","borderColor",t)},rotation:e=>{const t=e.detail.rotation;this.setRotation(t),this.annotationStorage.setValue(this.data.id,{rotation:t})}})}_dispatchEventFromSandbox(e,t){const n=this._commonActions;for(const s of Object.keys(t.detail)){const o=e[s]||n[s];o?.(t)}}_setDefaultPropertiesFromJS(e){if(!this.enableScripting)return;const t=this.annotationStorage.getRawValue(this.data.id);if(!t)return;const n=this._commonActions;for(const[s,i]of Object.entries(t)){const o=n[s];if(o){const n={detail:{[s]:i},target:e};o(n),delete t[s]}}}_createQuadrilaterals(){if(!this.container)return;const{quadPoints:e}=this.data;if(!e)return;const[r,u,c,i]=this.data.rect.map(e=>Math.fround(e));if(e.length===8){const[t,n,s,o]=e.subarray(2,6);if(c===t&&i===n&&r===s&&u===o)return}const{style:a}=this.container;let s;if(this.#hasBorder){const{borderColor:e,borderWidth:t}=a;a.borderWidth=0,s=["url('data:image/svg+xml;utf8,",`<svg xmlns="http://www.w3.org/2000/svg"`,` preserveAspectRatio="none" viewBox="0 0 1 1">`,`<g fill="transparent" stroke="${e}" stroke-width="${t}">`],this.container.classList.add("hasBorder")}const l=c-r,d=i-u,{svgFactory:n}=this,t=n.createElement("svg");t.classList.add("quadrilateralsContainer"),t.setAttribute("width",0),t.setAttribute("height",0);const h=n.createElement("defs");t.append(h);const o=n.createElement("clipPath"),m=`clippath_${this.data.id}`;o.setAttribute("id",m),o.setAttribute("clipPathUnits","objectBoundingBox"),h.append(o);for(let t=2,g=e.length;t<g;t+=8){const v=e[t],c=e[t+1],u=e[t+2],b=e[t+3],a=n.createElement("rect"),h=(u-r)/l,m=(i-c)/d,f=(v-u)/l,p=(c-b)/d;a.setAttribute("x",h),a.setAttribute("y",m),a.setAttribute("width",f),a.setAttribute("height",p),o.append(a),s?.push(`<rect vector-effect="non-scaling-stroke" x="${h}" y="${m}" width="${f}" height="${p}"/>`)}this.#hasBorder&&(s.push(`</g></svg>')`),a.backgroundImage=s.join("")),this.container.append(t),this.container.style.clipPath=`url(#${m})`}_createPopup(){const{data:e}=this,t=this.#popupElement=new PopupAnnotationElement({data:{color:e.color,titleObj:e.titleObj,modificationDate:e.modificationDate,contentsObj:e.contentsObj,richText:e.richText,parentRect:e.rect,borderStyle:0,id:`popup_${e.id}`,rotation:e.rotation},parent:this.parent,elements:[this]});this.parent.div.append(t.render())}render(){unreachable("Abstract method `AnnotationElement.render` called")}_getElementsByName(e,t=null){const n=[];if(this._fieldObjects){const s=this._fieldObjects[e];if(s)for(const{page:a,id:e,exportValues:i}of s){if(a===-1)continue;if(e===t)continue;const r=typeof i=="string"?i:null,o=document.querySelector(`[data-element-id="${e}"]`);if(o&&!GetElementsByNameSet.has(o)){warn(`_getElementsByName - element not allowed: ${e}`);continue}n.push({id:e,exportValue:r,domElement:o})}return n}for(const s of document.getElementsByName(e)){const{exportValue:i}=s,o=s.getAttribute("data-element-id");if(o===t)continue;if(!GetElementsByNameSet.has(s))continue;n.push({id:o,exportValue:i,domElement:s})}return n}show(){this.container&&(this.container.hidden=!1),this.popup?.maybeShow()}hide(){this.container&&(this.container.hidden=!0),this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){const e=this.getElementsToTriggerPopup();if(Array.isArray(e))for(const t of e)t.classList.add("highlightArea");else e.classList.add("highlightArea")}_editOnDoubleClick(){if(!this._isEditable)return;const{annotationEditorType:e,data:{id:t}}=this;this.container.addEventListener("dblclick",()=>{this.linkService.eventBus?.dispatch("switchannotationeditormode",{source:this,mode:e,editId:t})})}get width(){return this.data.rect[2]-this.data.rect[0]}get height(){return this.data.rect[3]-this.data.rect[1]}}class LinkAnnotationElement extends AnnotationElement{constructor(e,t=null){super(e,{isRenderable:!0,ignoreBorder:!!t?.ignoreBorder,createQuadrilaterals:!0}),this.isTooltipOnly=e.data.isTooltipOnly}render(){const{data:e,linkService:s}=this,t=document.createElement("a");t.setAttribute("data-element-id",e.id);let n=!1;return e.url?(s.addLinkAttributes(t,e.url,e.newWindow),n=!0):e.action?(this._bindNamedAction(t,e.action),n=!0):e.attachment?(this.#bindAttachment(t,e.attachment,e.attachmentDest),n=!0):e.setOCGState?(this.#bindSetOCGState(t,e.setOCGState),n=!0):e.dest?(this._bindLink(t,e.dest),n=!0):(e.actions&&(e.actions.Action||e.actions["Mouse Up"]||e.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions&&(this._bindJSAction(t,e),n=!0),e.resetForm?(this._bindResetFormAction(t,e.resetForm),n=!0):this.isTooltipOnly&&!n&&(this._bindLink(t,""),n=!0)),this.container.classList.add("linkAnnotation"),n&&this.container.append(t),this.container}#setInternalLink(){this.container.setAttribute("data-internal-link","")}_bindLink(e,t){e.href=this.linkService.getDestinationHash(t),e.onclick=()=>(t&&this.linkService.goToDestination(t),!1),(t||t==="")&&this.#setInternalLink()}_bindNamedAction(e,t){e.href=this.linkService.getAnchorUrl(""),e.onclick=()=>(this.linkService.executeNamedAction(t),!1),this.#setInternalLink()}#bindAttachment(e,t,n=null){e.href=this.linkService.getAnchorUrl(""),t.description&&(e.title=t.description),e.onclick=()=>(this.downloadManager?.openOrDownloadData(t.content,t.filename,n),!1),this.#setInternalLink()}#bindSetOCGState(e,t){e.href=this.linkService.getAnchorUrl(""),e.onclick=()=>(this.linkService.executeSetOCGState(t),!1),this.#setInternalLink()}_bindJSAction(e,t){e.href=this.linkService.getAnchorUrl("");const n=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const s of Object.keys(t.actions)){const o=n.get(s);if(!o)continue;e[o]=()=>(this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t.id,name:s}}),!1)}e.onclick||(e.onclick=()=>!1),this.#setInternalLink()}_bindResetFormAction(e,t){const n=e.onclick;if(n||(e.href=this.linkService.getAnchorUrl("")),this.#setInternalLink(),!this._fieldObjects){warn(`_bindResetFormAction - "resetForm" action not supported, `+"ensure that the `fieldObjects` parameter is provided."),n||(e.onclick=()=>!1);return}e.onclick=()=>{n?.();const{fields:o,refs:i,include:r}=t,e=[];if(o.length!==0||i.length!==0){const t=new Set(i);for(const e of o){const n=this._fieldObjects[e]||[];for(const{id:e}of n)t.add(e)}for(const n of Object.values(this._fieldObjects))for(const s of n)t.has(s.id)===r&&e.push(s)}else for(const t of Object.values(this._fieldObjects))e.push(...t);const s=this.annotationStorage,a=[];for(const t of e){const{id:n}=t;switch(a.push(n),t.type){case"text":{const e=t.defaultValue||"";s.setValue(n,{value:e});break}case"checkbox":case"radiobutton":{const e=t.defaultValue===t.exportValues;s.setValue(n,{value:e});break}case"combobox":case"listbox":{const e=t.defaultValue||"";s.setValue(n,{value:e});break}default:continue}const o=document.querySelector(`[data-element-id="${n}"]`);if(!o)continue;if(!GetElementsByNameSet.has(o)){warn(`_bindResetFormAction - element not allowed: ${n}`);continue}o.dispatchEvent(new Event("resetform"))}return this.enableScripting&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:a,name:"ResetForm"}}),!1}}}class TextAnnotationElement extends AnnotationElement{constructor(e){super(e,{isRenderable:!0})}render(){this.container.classList.add("textAnnotation");const e=document.createElement("img");return e.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",e.setAttribute("data-l10n-id","pdfjs-text-annotation-type"),e.setAttribute("data-l10n-args",JSON.stringify({type:this.data.name})),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.append(e),this.container}}class WidgetAnnotationElement extends AnnotationElement{render(){return this.container}showElementAndHideCanvas(e){this.data.hasOwnCanvas&&(e.previousSibling?.nodeName==="CANVAS"&&(e.previousSibling.hidden=!0),e.hidden=!1)}_getKeyModifier(e){return util_FeatureTest.platform.isMac?e.metaKey:e.ctrlKey}_setEventListener(e,t,n,s,o){n.includes("mouse")?e.addEventListener(n,e=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:s,value:o(e),shift:e.shiftKey,modifier:this._getKeyModifier(e)}})}):e.addEventListener(n,e=>{if(n==="blur"){if(!t.focused||!e.relatedTarget)return;t.focused=!1}else if(n==="focus"){if(t.focused)return;t.focused=!0}if(!o)return;this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:s,value:o(e)}})})}_setEventListeners(e,t,n,s){for(const[i,o]of n)(o==="Action"||this.data.actions?.[o])&&((o==="Focus"||o==="Blur")&&(t||={focused:!1}),this._setEventListener(e,t,i,o,s),o==="Focus"&&!this.data.actions?.Blur?this._setEventListener(e,t,"blur","Blur",null):o==="Blur"&&!this.data.actions?.Focus&&this._setEventListener(e,t,"focus","Focus",null))}_setBackgroundColor(e){const t=this.data.backgroundColor||null;e.style.backgroundColor=t===null?"transparent":Util.makeHexColor(t[0],t[1],t[2])}_setTextStyle(e){const r=["left","center","right"],{fontColor:t}=this.data.defaultAppearanceData,n=this.data.defaultAppearanceData.fontSize||annotation_layer_DEFAULT_FONT_SIZE,s=e.style;let o;const i=2,a=e=>Math.round(10*e)/10;if(this.data.multiLine){const e=Math.abs(this.data.rect[3]-this.data.rect[1]-i),t=Math.round(e/(LINE_FACTOR*n))||1,s=e/t;o=Math.min(n,a(s/LINE_FACTOR))}else{const e=Math.abs(this.data.rect[3]-this.data.rect[1]-i);o=Math.min(n,a(e/LINE_FACTOR))}s.fontSize=`calc(${o}px * var(--total-scale-factor))`,s.color=Util.makeHexColor(t[0],t[1],t[2]),this.data.textAlignment!==null&&(s.textAlign=r[this.data.textAlignment])}_setRequired(e,t){t?e.setAttribute("required",!0):e.removeAttribute("required"),e.setAttribute("aria-required",t)}}class TextWidgetAnnotationElement extends WidgetAnnotationElement{constructor(e){const t=e.renderForms||e.data.hasOwnCanvas||!e.data.hasAppearance&&!!e.data.fieldValue;super(e,{isRenderable:t})}setPropertyOnSiblings(e,t,n,s){const o=this.annotationStorage;for(const i of this._getElementsByName(e.name,e.id))i.domElement&&(i.domElement[t]=n),o.setValue(i.id,{[s]:n})}render(){const n=this.annotationStorage,t=this.data.id;this.container.classList.add("textWidgetAnnotation");let e=null;if(this.renderForms){{const c=n.getValue(t,{value:this.data.fieldValue});let o=c.value||"";const i=n.getValue(t,{charLimit:this.data.maxLen}).charLimit;i&&o.length>i&&(o=o.slice(0,i));let a=c.formattedValue||this.data.textContent?.join(`
`)||null;a&&this.data.comb&&(a=a.replaceAll(/\s+/g,""));const s={userValue:o,formattedValue:a,lastCommittedValue:null,commitKey:1,focused:!1};this.data.multiLine?(e=document.createElement("textarea"),e.textContent=a??o,this.data.doNotScroll&&(e.style.overflowY="hidden")):(e=document.createElement("input"),e.type=this.data.password?"password":"text",e.setAttribute("value",a??o),this.data.doNotScroll&&(e.style.overflowX="hidden")),this.data.hasOwnCanvas&&(e.hidden=!0),GetElementsByNameSet.add(e),e.setAttribute("data-element-id",t),e.disabled=this.data.readOnly,e.name=this.data.fieldName,e.tabIndex=0;const l=this.data.dateFormat||this.data.timeFormat;l&&(e.title=l),this._setRequired(e,this.data.required),i&&(e.maxLength=i),e.addEventListener("input",o=>{n.setValue(t,{value:o.target.value}),this.setPropertyOnSiblings(e,"value",o.target.value,"value"),s.formattedValue=null}),e.addEventListener("resetform",t=>{const n=this.data.defaultFieldValue??"";e.value=s.userValue=n,s.formattedValue=null});let r=e=>{const{formattedValue:t}=s;t!=null&&(e.target.value=t),e.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){e.addEventListener("focus",e=>{if(s.focused)return;const{target:t}=e;s.userValue&&(t.value=s.userValue),s.lastCommittedValue=t.value,s.commitKey=1,this.data.actions?.Focus||(s.focused=!0)}),e.addEventListener("updatefromsandbox",e=>{this.showElementAndHideCanvas(e.target);const o={value(e){s.userValue=e.detail.value??"",n.setValue(t,{value:s.userValue.toString()}),e.target.value=s.userValue},formattedValue(e){const{formattedValue:o}=e.detail;s.formattedValue=o,o!=null&&e.target!==document.activeElement&&(e.target.value=o),n.setValue(t,{formattedValue:o})},selRange(e){e.target.setSelectionRange(...e.detail.selRange)},charLimit:e=>{const{charLimit:a}=e.detail,{target:i}=e;if(a===0){i.removeAttribute("maxLength");return}i.setAttribute("maxLength",a);let o=s.userValue;if(!o||o.length<=a)return;o=o.slice(0,a),i.value=s.userValue=o,n.setValue(t,{value:o}),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:o,willCommit:!0,commitKey:1,selStart:i.selectionStart,selEnd:i.selectionEnd}})}};this._dispatchEventFromSandbox(o,e)}),e.addEventListener("keydown",e=>{s.commitKey=1;let n=-1;if(e.key==="Escape"?n=0:e.key==="Enter"&&!this.data.multiLine?n=2:e.key==="Tab"&&(s.commitKey=3),n===-1)return;const{value:o}=e.target;if(s.lastCommittedValue===o)return;s.lastCommittedValue=o,s.userValue=o,this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:o,willCommit:!0,commitKey:n,selStart:e.target.selectionStart,selEnd:e.target.selectionEnd}})});const o=r;r=null,e.addEventListener("blur",e=>{if(!s.focused||!e.relatedTarget)return;this.data.actions?.Blur||(s.focused=!1);const{value:n}=e.target;s.userValue=n,s.lastCommittedValue!==n&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:n,willCommit:!0,commitKey:s.commitKey,selStart:e.target.selectionStart,selEnd:e.target.selectionEnd}}),o(e)}),this.data.actions?.Keystroke&&e.addEventListener("beforeinput",e=>{s.lastCommittedValue=null;const{data:c,target:l}=e,{value:o,selectionStart:n,selectionEnd:i}=l;let a=n,r=i;switch(e.inputType){case"deleteWordBackward":{const e=o.substring(0,n).match(/\w*[^\w]*$/);e&&(a-=e[0].length);break}case"deleteWordForward":{const e=o.substring(n).match(/^[^\w]*\w*/);e&&(r+=e[0].length);break}case"deleteContentBackward":n===i&&(a-=1);break;case"deleteContentForward":n===i&&(r+=1);break}e.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:o,change:c||"",willCommit:!1,selStart:a,selEnd:r}})}),this._setEventListeners(e,s,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],e=>e.target.value)}if(r&&e.addEventListener("blur",r),this.data.comb){const t=this.data.rect[2]-this.data.rect[0],n=t/i;e.classList.add("comb"),e.style.letterSpacing=`calc(${n}px * var(--total-scale-factor) - 1ch)`}}}else e=document.createElement("div"),e.textContent=this.data.fieldValue,e.style.verticalAlign="middle",e.style.display="table-cell",this.data.hasOwnCanvas&&(e.hidden=!0);return this._setTextStyle(e),this._setBackgroundColor(e),this._setDefaultPropertiesFromJS(e),this.container.append(e),this.container}}class SignatureWidgetAnnotationElement extends WidgetAnnotationElement{constructor(e){super(e,{isRenderable:!!e.data.hasOwnCanvas})}}class CheckboxWidgetAnnotationElement extends WidgetAnnotationElement{constructor(e){super(e,{isRenderable:e.renderForms})}render(){const s=this.annotationStorage,t=this.data,n=t.id;let o=s.getValue(n,{value:t.exportValue===t.fieldValue}).value;typeof o=="string"&&(o=o!=="Off",s.setValue(n,{value:o})),this.container.classList.add("buttonWidgetAnnotation","checkBox");const e=document.createElement("input");return GetElementsByNameSet.add(e),e.setAttribute("data-element-id",n),e.disabled=t.readOnly,this._setRequired(e,this.data.required),e.type="checkbox",e.name=t.fieldName,o&&e.setAttribute("checked",!0),e.setAttribute("exportValue",t.exportValue),e.tabIndex=0,e.addEventListener("change",e=>{const{name:i,checked:o}=e.target;for(const e of this._getElementsByName(i,n)){const a=o&&e.exportValue===t.exportValue;e.domElement&&(e.domElement.checked=a),s.setValue(e.id,{value:a})}s.setValue(n,{value:o})}),e.addEventListener("resetform",e=>{const n=t.defaultFieldValue||"Off";e.target.checked=n===t.exportValue}),this.enableScripting&&this.hasJSActions&&(e.addEventListener("updatefromsandbox",e=>{const t={value(e){e.target.checked=e.detail.value!=="Off",s.setValue(n,{value:e.target.checked})}};this._dispatchEventFromSandbox(t,e)}),this._setEventListeners(e,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],e=>e.target.checked)),this._setBackgroundColor(e),this._setDefaultPropertiesFromJS(e),this.container.append(e),this.container}}class RadioButtonWidgetAnnotationElement extends WidgetAnnotationElement{constructor(e){super(e,{isRenderable:e.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");const s=this.annotationStorage,t=this.data,n=t.id;let o=s.getValue(n,{value:t.fieldValue===t.buttonValue}).value;if(typeof o=="string"&&(o=o!==t.buttonValue,s.setValue(n,{value:o})),o)for(const e of this._getElementsByName(t.fieldName,n))s.setValue(e.id,{value:!1});const e=document.createElement("input");if(GetElementsByNameSet.add(e),e.setAttribute("data-element-id",n),e.disabled=t.readOnly,this._setRequired(e,this.data.required),e.type="radio",e.name=t.fieldName,o&&e.setAttribute("checked",!0),e.tabIndex=0,e.addEventListener("change",e=>{const{name:t,checked:o}=e.target;for(const e of this._getElementsByName(t,n))s.setValue(e.id,{value:!1});s.setValue(n,{value:o})}),e.addEventListener("resetform",e=>{const n=t.defaultFieldValue;e.target.checked=n!=null&&n===t.buttonValue}),this.enableScripting&&this.hasJSActions){const o=t.buttonValue;e.addEventListener("updatefromsandbox",e=>{const t={value:e=>{const t=o===e.detail.value;for(const o of this._getElementsByName(e.target.name)){const i=t&&o.id===n;o.domElement&&(o.domElement.checked=i),s.setValue(o.id,{value:i})}}};this._dispatchEventFromSandbox(t,e)}),this._setEventListeners(e,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],e=>e.target.checked)}return this._setBackgroundColor(e),this._setDefaultPropertiesFromJS(e),this.container.append(e),this.container}}class PushButtonWidgetAnnotationElement extends LinkAnnotationElement{constructor(e){super(e,{ignoreBorder:e.data.hasAppearance})}render(){const e=super.render();e.classList.add("buttonWidgetAnnotation","pushButton");const t=e.lastChild;return this.enableScripting&&this.hasJSActions&&t&&(this._setDefaultPropertiesFromJS(t),t.addEventListener("updatefromsandbox",e=>{this._dispatchEventFromSandbox({},e)})),e}}class ChoiceWidgetAnnotationElement extends WidgetAnnotationElement{constructor(e){super(e,{isRenderable:e.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");const s=this.annotationStorage,n=this.data.id,c=s.getValue(n,{value:this.data.fieldValue}),e=document.createElement("select");GetElementsByNameSet.add(e),e.setAttribute("data-element-id",n),e.disabled=this.data.readOnly,this._setRequired(e,this.data.required),e.name=this.data.fieldName,e.tabIndex=0;let r=this.data.combo&&this.data.options.length>0;this.data.combo||(e.size=this.data.options.length,this.data.multiSelect&&(e.multiple=!0)),e.addEventListener("resetform",t=>{const n=this.data.defaultFieldValue;for(const t of e.options)t.selected=t.value===n});for(const n of this.data.options){const t=document.createElement("option");t.textContent=n.displayValue,t.value=n.exportValue,c.value.includes(n.exportValue)&&(t.setAttribute("selected",!0),r=!1),e.append(t)}let i=null;if(r){const t=document.createElement("option");t.value=" ",t.setAttribute("hidden",!0),t.setAttribute("selected",!0),e.prepend(t),i=()=>{t.remove(),e.removeEventListener("input",i),i=null},e.addEventListener("input",i)}const t=t=>{const s=t?"value":"textContent",{options:n,multiple:o}=e;return o?Array.prototype.filter.call(n,e=>e.selected).map(e=>e[s]):n.selectedIndex===-1?null:n[n.selectedIndex][s]};let o=t(!1);const a=e=>{const t=e.target.options;return Array.prototype.map.call(t,e=>({displayValue:e.textContent,exportValue:e.value}))};return this.enableScripting&&this.hasJSActions?(e.addEventListener("updatefromsandbox",r=>{const c={value(a){i?.();const r=a.detail.value,c=new Set(Array.isArray(r)?r:[r]);for(const t of e.options)t.selected=c.has(t.value);s.setValue(n,{value:t(!0)}),o=t(!1)},multipleSelection(){e.multiple=!0},remove(i){const r=e.options,c=i.detail.remove;if(r[c].selected=!1,e.remove(c),r.length>0){const e=Array.prototype.findIndex.call(r,e=>e.selected);e===-1&&(r[0].selected=!0)}s.setValue(n,{value:t(!0),items:a(i)}),o=t(!1)},clear(){for(;e.length!==0;)e.remove(0);s.setValue(n,{value:null,items:[]}),o=t(!1)},insert(i){const{index:l,displayValue:d,exportValue:u}=i.detail.insert,c=e.children[l],r=document.createElement("option");r.textContent=d,r.value=u,c?c.before(r):e.append(r),s.setValue(n,{value:t(!0),items:a(i)}),o=t(!1)},items(i){const{items:r}=i.detail;for(;e.length!==0;)e.remove(0);for(const n of r){const{displayValue:s,exportValue:o}=n,t=document.createElement("option");t.textContent=s,t.value=o,e.append(t)}e.options.length>0&&(e.options[0].selected=!0),s.setValue(n,{value:t(!0),items:a(i)}),o=t(!1)},indices(e){const i=new Set(e.detail.indices);for(const t of e.target.options)t.selected=i.has(t.index);s.setValue(n,{value:t(!0)}),o=t(!1)},editable(e){e.target.disabled=!e.detail.editable}};this._dispatchEventFromSandbox(c,r)}),e.addEventListener("input",e=>{const i=t(!0),a=t(!1);s.setValue(n,{value:i}),e.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:n,name:"Keystroke",value:o,change:a,changeEx:i,willCommit:!1,commitKey:1,keyDown:!1}})}),this._setEventListeners(e,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],e=>e.target.value)):e.addEventListener("input",function(){s.setValue(n,{value:t(!0)})}),this.data.combo&&this._setTextStyle(e),this._setBackgroundColor(e),this._setDefaultPropertiesFromJS(e),this.container.append(e),this.container}}class PopupAnnotationElement extends AnnotationElement{constructor(e){const{data:t,elements:n}=e;super(e,{isRenderable:AnnotationElement._hasPopupData(t)}),this.elements=n,this.popup=null}render(){const{container:e}=this;e.classList.add("popupAnnotation"),e.role="comment";const n=this.popup=new PopupElement({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open}),t=[];for(const e of this.elements)e.popup=n,e.container.ariaHasPopup="dialog",t.push(e.data.id),e.addHighlightArea();return this.container.setAttribute("aria-controls",t.map(e=>`${AnnotationPrefix}${e}`).join(",")),this.container}}class PopupElement{#boundKeyDown=this.#keyDown.bind(this);#boundHide=this.#hide.bind(this);#boundShow=this.#show.bind(this);#boundToggle=this.#toggle.bind(this);#color=null;#container=null;#contentsObj=null;#dateObj=null;#elements=null;#parent=null;#parentRect=null;#pinned=!1;#popup=null;#position=null;#rect=null;#richText=null;#titleObj=null;#updates=null;#wasVisible=!1;constructor({container:e,color:t,elements:n,titleObj:s,modificationDate:o,contentsObj:i,richText:a,parent:r,rect:c,parentRect:l,open:d}){this.#container=e,this.#titleObj=s,this.#contentsObj=i,this.#richText=a,this.#parent=r,this.#color=t,this.#rect=c,this.#parentRect=l,this.#elements=n,this.#dateObj=PDFDateString.toDateObject(o),this.trigger=n.flatMap(e=>e.getElementsToTriggerPopup());for(const e of this.trigger)e.addEventListener("click",this.#boundToggle),e.addEventListener("mouseenter",this.#boundShow),e.addEventListener("mouseleave",this.#boundHide),e.classList.add("popupTriggerArea");for(const e of n)e.container?.addEventListener("keydown",this.#boundKeyDown);this.#container.hidden=!0,d&&this.#toggle()}render(){if(this.#popup)return;const e=this.#popup=document.createElement("div");if(e.className="popup",this.#color){const t=e.style.outlineColor=Util.makeHexColor(...this.#color);e.style.backgroundColor=`color-mix(in srgb, ${t} 30%, white)`}const t=document.createElement("span");t.className="header";const n=document.createElement("h1");if(t.append(n),{dir:n.dir,str:n.textContent}=this.#titleObj,e.append(t),this.#dateObj){const e=document.createElement("time");e.classList.add("popupDate"),e.setAttribute("data-l10n-id","pdfjs-annotation-date-time-string"),e.setAttribute("data-l10n-args",JSON.stringify({dateObj:this.#dateObj.valueOf()})),e.dateTime=this.#dateObj.toISOString(),t.append(e)}const s=this.#html;if(s)XfaLayer.render({xfaHtml:s,intent:"richText",div:e}),e.lastChild.classList.add("richText","popupContent");else{const t=this._formatContents(this.#contentsObj);e.append(t)}this.#container.append(e)}get#html(){const e=this.#richText,t=this.#contentsObj;return e?.str&&(!t?.str||t.str===e.str)?this.#richText.html||null:null}get#fontSize(){return this.#html?.attributes?.style?.fontSize||0}get#fontColor(){return this.#html?.attributes?.style?.color||null}#makePopupContent(e){const t=[],n={str:e,html:{name:"div",attributes:{dir:"auto"},children:[{name:"p",children:t}]}},s={style:{color:this.#fontColor,fontSize:this.#fontSize?`calc(${this.#fontSize}px * var(--total-scale-factor))`:""}};for(const n of e.split(`
`))t.push({name:"span",value:n,attributes:s});return n}_formatContents({str:e,dir:t}){const n=document.createElement("p");n.classList.add("popupContent"),n.dir=t;const s=e.split(/(?:\r\n?|\n)/);for(let e=0,t=s.length;e<t;++e){const o=s[e];n.append(document.createTextNode(o)),e<t-1&&n.append(document.createElement("br"))}return n}#keyDown(e){if(e.altKey||e.shiftKey||e.ctrlKey||e.metaKey)return;(e.key==="Enter"||e.key==="Escape"&&this.#pinned)&&this.#toggle()}updateEdited({rect:e,popupContent:t}){this.#updates||={contentsObj:this.#contentsObj,richText:this.#richText},e&&(this.#position=null),t&&(this.#richText=this.#makePopupContent(t),this.#contentsObj=null),this.#popup?.remove(),this.#popup=null}resetEdited(){if(!this.#updates)return;({contentsObj:this.#contentsObj,richText:this.#richText}=this.#updates,this.#updates=null,this.#popup?.remove(),this.#popup=null,this.#position=null)}#setPosition(){if(this.#position!==null)return;const{page:{view:t},viewport:{rawDims:{pageWidth:h,pageHeight:r,pageX:i,pageY:a}}}=this.#parent;let n=!!this.#parentRect,e=n?this.#parentRect:this.#rect;for(const t of this.#elements)if(!e||Util.intersect(t.data.rect,e)!==null){e=t.data.rect,n=!0;break}const o=Util.normalizeRect([e[0],t[3]-e[1]+t[1],e[2],t[3]-e[3]+t[1]]),c=5,l=n?e[2]-e[0]+c:0,d=o[0]+l,u=o[1];this.#position=[100*(d-i)/h,100*(u-a)/r];const{style:s}=this.#container;s.left=`${this.#position[0]}%`,s.top=`${this.#position[1]}%`}#toggle(){this.#pinned=!this.#pinned,this.#pinned?(this.#show(),this.#container.addEventListener("click",this.#boundToggle),this.#container.addEventListener("keydown",this.#boundKeyDown)):(this.#hide(),this.#container.removeEventListener("click",this.#boundToggle),this.#container.removeEventListener("keydown",this.#boundKeyDown))}#show(){this.#popup||this.render(),this.isVisible?this.#pinned&&this.#container.classList.add("focused"):(this.#setPosition(),this.#container.hidden=!1,this.#container.style.zIndex=parseInt(this.#container.style.zIndex)+1e3)}#hide(){if(this.#container.classList.remove("focused"),this.#pinned||!this.isVisible)return;this.#container.hidden=!0,this.#container.style.zIndex=parseInt(this.#container.style.zIndex)-1e3}forceHide(){if(this.#wasVisible=this.isVisible,!this.#wasVisible)return;this.#container.hidden=!0}maybeShow(){if(!this.#wasVisible)return;this.#popup||this.#show(),this.#wasVisible=!1,this.#container.hidden=!1}get isVisible(){return this.#container.hidden===!1}}class FreeTextAnnotationElement extends AnnotationElement{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.textContent=e.data.textContent,this.textPosition=e.data.textPosition,this.annotationEditorType=AnnotationEditorType.FREETEXT}render(){if(this.container.classList.add("freeTextAnnotation"),this.textContent){const e=document.createElement("div");e.classList.add("annotationTextContent"),e.setAttribute("role","comment");for(const n of this.textContent){const t=document.createElement("span");t.textContent=n,e.append(t)}this.container.append(e)}return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}class LineAnnotationElement extends AnnotationElement{#line=null;constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("lineAnnotation");const{data:e,width:s,height:o}=this,n=this.svgFactory.create(s,o,!0),t=this.#line=this.svgFactory.createElement("svg:line");return t.setAttribute("x1",e.rect[2]-e.lineCoordinates[0]),t.setAttribute("y1",e.rect[3]-e.lineCoordinates[1]),t.setAttribute("x2",e.rect[2]-e.lineCoordinates[2]),t.setAttribute("y2",e.rect[3]-e.lineCoordinates[3]),t.setAttribute("stroke-width",e.borderStyle.width||1),t.setAttribute("stroke","transparent"),t.setAttribute("fill","transparent"),n.append(t),this.container.append(n),!e.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#line}addHighlightArea(){this.container.classList.add("highlightArea")}}class SquareAnnotationElement extends AnnotationElement{#square=null;constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("squareAnnotation");const{data:n,width:s,height:o}=this,i=this.svgFactory.create(s,o,!0),t=n.borderStyle.width,e=this.#square=this.svgFactory.createElement("svg:rect");return e.setAttribute("x",t/2),e.setAttribute("y",t/2),e.setAttribute("width",s-t),e.setAttribute("height",o-t),e.setAttribute("stroke-width",t||1),e.setAttribute("stroke","transparent"),e.setAttribute("fill","transparent"),i.append(e),this.container.append(i),!n.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#square}addHighlightArea(){this.container.classList.add("highlightArea")}}class CircleAnnotationElement extends AnnotationElement{#circle=null;constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("circleAnnotation");const{data:o,width:t,height:n}=this,i=this.svgFactory.create(t,n,!0),s=o.borderStyle.width,e=this.#circle=this.svgFactory.createElement("svg:ellipse");return e.setAttribute("cx",t/2),e.setAttribute("cy",n/2),e.setAttribute("rx",t/2-s/2),e.setAttribute("ry",n/2-s/2),e.setAttribute("stroke-width",s||1),e.setAttribute("stroke","transparent"),e.setAttribute("fill","transparent"),i.append(e),this.container.append(i),!o.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#circle}addHighlightArea(){this.container.classList.add("highlightArea")}}class PolylineAnnotationElement extends AnnotationElement{#polyline=null;constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="polylineAnnotation",this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);const{data:{rect:s,vertices:t,borderStyle:i,popupRef:a},width:r,height:c}=this;if(!t)return this.container;const o=this.svgFactory.create(r,c,!0);let n=[];for(let e=0,o=t.length;e<o;e+=2){const i=t[e]-s[0],a=s[3]-t[e+1];n.push(`${i},${a}`)}n=n.join(" ");const e=this.#polyline=this.svgFactory.createElement(this.svgElementName);return e.setAttribute("points",n),e.setAttribute("stroke-width",i.width||1),e.setAttribute("stroke","transparent"),e.setAttribute("fill","transparent"),o.append(e),this.container.append(o),!a&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#polyline}addHighlightArea(){this.container.classList.add("highlightArea")}}class PolygonAnnotationElement extends PolylineAnnotationElement{constructor(e){super(e),this.containerClassName="polygonAnnotation",this.svgElementName="svg:polygon"}}class CaretAnnotationElement extends AnnotationElement{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add("caretAnnotation"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}}class InkAnnotationElement extends AnnotationElement{#polylinesGroupElement=null;#polylines=[];constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="inkAnnotation",this.svgElementName="svg:polyline",this.annotationEditorType=this.data.it==="InkHighlight"?AnnotationEditorType.HIGHLIGHT:AnnotationEditorType.INK}#getTransform(e,t){switch(e){case 90:return{transform:`rotate(90) translate(${-t[0]},${t[1]}) scale(1,-1)`,width:t[3]-t[1],height:t[2]-t[0]};case 180:return{transform:`rotate(180) translate(${-t[2]},${t[1]}) scale(1,-1)`,width:t[2]-t[0],height:t[3]-t[1]};case 270:return{transform:`rotate(270) translate(${-t[2]},${t[3]}) scale(1,-1)`,width:t[3]-t[1],height:t[2]-t[0]};default:return{transform:`translate(${-t[0]},${t[3]}) scale(1,-1)`,width:t[2]-t[0],height:t[3]-t[1]}}}render(){this.container.classList.add(this.containerClassName);const{data:{rect:s,rotation:o,inkLists:t,borderStyle:i,popupRef:a}}=this,{transform:r,width:c,height:l}=this.#getTransform(o,s),n=this.svgFactory.create(c,l,!0),e=this.#polylinesGroupElement=this.svgFactory.createElement("svg:g");n.append(e),e.setAttribute("stroke-width",i.width||1),e.setAttribute("stroke-linecap","round"),e.setAttribute("stroke-linejoin","round"),e.setAttribute("stroke-miterlimit",10),e.setAttribute("stroke","transparent"),e.setAttribute("fill","transparent"),e.setAttribute("transform",r);for(let n=0,o=t.length;n<o;n++){const s=this.svgFactory.createElement(this.svgElementName);this.#polylines.push(s),s.setAttribute("points",t[n].join(",")),e.append(s)}return!a&&this.hasPopupData&&this._createPopup(),this.container.append(n),this._editOnDoubleClick(),this.container}updateEdited(e){super.updateEdited(e);const{thickness:n,points:s,rect:o}=e,t=this.#polylinesGroupElement;if(n>=0&&t.setAttribute("stroke-width",n||1),s)for(let e=0,t=this.#polylines.length;e<t;e++)this.#polylines[e].setAttribute("points",s[e].join(","));if(o){const{transform:e,width:n,height:s}=this.#getTransform(this.data.rotation,o),i=t.parentElement;i.setAttribute("viewBox",`0 0 ${n} ${s}`),t.setAttribute("transform",e)}}getElementsToTriggerPopup(){return this.#polylines}addHighlightArea(){this.container.classList.add("highlightArea")}}class HighlightAnnotationElement extends AnnotationElement{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0}),this.annotationEditorType=AnnotationEditorType.HIGHLIGHT}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("highlightAnnotation"),this._editOnDoubleClick(),this.container}}class UnderlineAnnotationElement extends AnnotationElement{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("underlineAnnotation"),this.container}}class SquigglyAnnotationElement extends AnnotationElement{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("squigglyAnnotation"),this.container}}class StrikeOutAnnotationElement extends AnnotationElement{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("strikeoutAnnotation"),this.container}}class StampAnnotationElement extends AnnotationElement{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.annotationEditorType=AnnotationEditorType.STAMP}render(){return this.container.classList.add("stampAnnotation"),this.container.setAttribute("role","img"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}class FileAttachmentAnnotationElement extends AnnotationElement{#trigger=null;constructor(e){super(e,{isRenderable:!0});const{file:t}=this.data;this.filename=t.filename,this.content=t.content,this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,...t})}render(){this.container.classList.add("fileAttachmentAnnotation");const{container:n,data:t}=this;let e;t.hasAppearance||t.fillAlpha===0?e=document.createElement("div"):(e=document.createElement("img"),e.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(t.name)?"paperclip":"pushpin"}.svg`,t.fillAlpha&&t.fillAlpha<1&&(e.style=`filter: opacity(${Math.round(t.fillAlpha*100)}%);`)),e.addEventListener("dblclick",this.#download.bind(this)),this.#trigger=e;const{isMac:s}=util_FeatureTest.platform;return n.addEventListener("keydown",e=>{e.key==="Enter"&&(s?e.metaKey:e.ctrlKey)&&this.#download()}),!t.popupRef&&this.hasPopupData?this._createPopup():e.classList.add("popupTriggerArea"),n.append(e),n}getElementsToTriggerPopup(){return this.#trigger}addHighlightArea(){this.container.classList.add("highlightArea")}#download(){this.downloadManager?.openOrDownloadData(this.content,this.filename)}}class AnnotationLayer{#accessibilityManager=null;#annotationCanvasMap=null;#editableAnnotations=new Map;#structTreeLayer=null;constructor({div:e,accessibilityManager:t,annotationCanvasMap:n,annotationEditorUIManager:s,page:o,viewport:i,structTreeLayer:a}){this.div=e,this.#accessibilityManager=t,this.#annotationCanvasMap=n,this.#structTreeLayer=a||null,this.page=o,this.viewport=i,this.zIndex=0,this._annotationEditorUIManager=s}hasEditableAnnotations(){return this.#editableAnnotations.size>0}async#appendElement(e,t,n){const s=e.firstChild||e,i=s.id=`${AnnotationPrefix}${t}`,o=await this.#structTreeLayer?.getAriaAttributes(i);if(o)for(const[e,t]of o)s.setAttribute(e,t);n?n.at(-1).container.after(e):(this.div.append(e),this.#accessibilityManager?.moveElementInDOM(this.div,e,s,!1))}async render(e){const{annotations:o}=e,s=this.div;setLayerDimensions(s,this.viewport);const n=new Map,t={data:null,layer:s,linkService:e.linkService,downloadManager:e.downloadManager,imageResourcesPath:e.imageResourcesPath||"",renderForms:e.renderForms!==!1,svgFactory:new DOMSVGFactory,annotationStorage:e.annotationStorage||new AnnotationStorage,enableScripting:e.enableScripting===!0,hasJSActions:e.hasJSActions,fieldObjects:e.fieldObjects,parent:this,elements:null};for(const e of o){if(e.noHTML)continue;const i=e.annotationType===AnnotationType.POPUP;if(i){const s=n.get(e.id);if(!s)continue;t.elements=s}else if(e.rect[2]===e.rect[0]||e.rect[3]===e.rect[1])continue;t.data=e;const s=AnnotationElementFactory.create(t);if(!s.isRenderable)continue;if(!i&&e.popupRef){const t=n.get(e.popupRef);t?t.push(s):n.set(e.popupRef,[s])}const a=s.render();e.hidden&&(a.style.visibility="hidden"),await this.#appendElement(a,e.id,t.elements),s._isEditable&&(this.#editableAnnotations.set(s.data.id,s),this._annotationEditorUIManager?.renderAnnotationElement(s))}this.#setAnnotationCanvasMap()}async addLinkAnnotations(e,t){const n={data:null,layer:this.div,linkService:t,svgFactory:new DOMSVGFactory,parent:this};for(const t of e){t.borderStyle||=AnnotationLayer._defaultBorderStyle,n.data=t;const s=AnnotationElementFactory.create(n);if(!s.isRenderable)continue;const o=s.render();await this.#appendElement(o,t.id,null)}}update({viewport:e}){const t=this.div;this.viewport=e,setLayerDimensions(t,{rotation:e.rotation}),this.#setAnnotationCanvasMap(),t.hidden=!1}#setAnnotationCanvasMap(){if(!this.#annotationCanvasMap)return;const e=this.div;for(const[i,t]of this.#annotationCanvasMap){const s=e.querySelector(`[data-annotation-id="${i}"]`);if(!s)continue;t.className="annotationContent";const{firstChild:n}=s;n?n.nodeName==="CANVAS"?n.replaceWith(t):n.classList.contains("annotationContent")?n.after(t):n.before(t):s.append(t);const o=this.#editableAnnotations.get(i);if(!o)continue;o._hasNoCanvas?(this._annotationEditorUIManager?.setMissingCanvas(i,s.id,t),o._hasNoCanvas=!1):o.canvas=t}this.#annotationCanvasMap.clear()}getEditableAnnotations(){return Array.from(this.#editableAnnotations.values())}getEditableAnnotation(e){return this.#editableAnnotations.get(e)}static get _defaultBorderStyle(){return shadow(this,"_defaultBorderStyle",Object.freeze({width:1,rawWidth:1,style:AnnotationBorderStyleType.SOLID,dashArray:[3],horizontalCornerRadius:0,verticalCornerRadius:0}))}}const EOL_PATTERN=/\r\n?|\n/g;class FreeTextEditor extends AnnotationEditor{#color;#content="";#editorDivId=`${this.id}-editor`;#editModeAC=null;#fontSize;static _freeTextDefaultContent="";static _internalPadding=0;static _defaultColor=null;static _defaultFontSize=10;static get _keyboardManager(){const e=FreeTextEditor.prototype,t=e=>e.isEmpty(),n=AnnotationEditorUIManager.TRANSLATE_SMALL,s=AnnotationEditorUIManager.TRANSLATE_BIG;return shadow(this,"_keyboardManager",new KeyboardManager([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],e.commitOrRemove,{bubbles:!0}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],e.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],e._translateEmpty,{args:[-n,0],checker:t}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],e._translateEmpty,{args:[-s,0],checker:t}],[["ArrowRight","mac+ArrowRight"],e._translateEmpty,{args:[n,0],checker:t}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],e._translateEmpty,{args:[s,0],checker:t}],[["ArrowUp","mac+ArrowUp"],e._translateEmpty,{args:[0,-n],checker:t}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],e._translateEmpty,{args:[0,-s],checker:t}],[["ArrowDown","mac+ArrowDown"],e._translateEmpty,{args:[0,n],checker:t}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],e._translateEmpty,{args:[0,s],checker:t}]]))}static _type="freetext";static _editorType=AnnotationEditorType.FREETEXT;constructor(e){super({...e,name:"freeTextEditor"}),this.#color=e.color||FreeTextEditor._defaultColor||AnnotationEditor._defaultLineColor,this.#fontSize=e.fontSize||FreeTextEditor._defaultFontSize}static initialize(e,t){AnnotationEditor.initialize(e,t);const n=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(n.getPropertyValue("--freetext-padding"))}static updateDefaultParams(e,t){switch(e){case AnnotationEditorParamsType.FREETEXT_SIZE:FreeTextEditor._defaultFontSize=t;break;case AnnotationEditorParamsType.FREETEXT_COLOR:FreeTextEditor._defaultColor=t;break}}updateParams(e,t){switch(e){case AnnotationEditorParamsType.FREETEXT_SIZE:this.#updateFontSize(t);break;case AnnotationEditorParamsType.FREETEXT_COLOR:this.#updateColor(t);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.FREETEXT_SIZE,FreeTextEditor._defaultFontSize],[AnnotationEditorParamsType.FREETEXT_COLOR,FreeTextEditor._defaultColor||AnnotationEditor._defaultLineColor]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.FREETEXT_SIZE,this.#fontSize],[AnnotationEditorParamsType.FREETEXT_COLOR,this.#color]]}#updateFontSize(e){const t=e=>{this.editorDiv.style.fontSize=`calc(${e}px * var(--total-scale-factor))`,this.translate(0,-(e-this.#fontSize)*this.parentScale),this.#fontSize=e,this.#setEditorDimensions()},n=this.#fontSize;this.addCommands({cmd:t.bind(this,e),undo:t.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:AnnotationEditorParamsType.FREETEXT_SIZE,overwriteIfSameType:!0,keepUndo:!0})}#updateColor(e){const t=e=>{this.#color=this.editorDiv.style.color=e},n=this.#color;this.addCommands({cmd:t.bind(this,e),undo:t.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:AnnotationEditorParamsType.FREETEXT_COLOR,overwriteIfSameType:!0,keepUndo:!0})}_translateEmpty(e,t){this._uiManager.translateSelectedEditors(e,t,!0)}getInitialTranslation(){const e=this.parentScale;return[-FreeTextEditor._internalPadding*e,-(FreeTextEditor._internalPadding+this.#fontSize)*e]}rebuild(){if(!this.parent)return;if(super.rebuild(),this.div===null)return;this.isAttachedToDOM||this.parent.add(this)}enableEditMode(){if(!super.enableEditMode())return!1;this.overlayDiv.classList.remove("enabled"),this.editorDiv.contentEditable=!0,this._isDraggable=!1,this.div.removeAttribute("aria-activedescendant"),this.#editModeAC=new AbortController;const e=this._uiManager.combinedSignal(this.#editModeAC);return this.editorDiv.addEventListener("keydown",this.editorDivKeydown.bind(this),{signal:e}),this.editorDiv.addEventListener("focus",this.editorDivFocus.bind(this),{signal:e}),this.editorDiv.addEventListener("blur",this.editorDivBlur.bind(this),{signal:e}),this.editorDiv.addEventListener("input",this.editorDivInput.bind(this),{signal:e}),this.editorDiv.addEventListener("paste",this.editorDivPaste.bind(this),{signal:e}),!0}disableEditMode(){return!!super.disableEditMode()&&(this.overlayDiv.classList.add("enabled"),this.editorDiv.contentEditable=!1,this.div.setAttribute("aria-activedescendant",this.#editorDivId),this._isDraggable=!0,this.#editModeAC?.abort(),this.#editModeAC=null,this.div.focus({preventScroll:!0}),this.isEditing=!1,this.parent.div.classList.add("freetextEditing"),!0)}focusin(e){if(!this._focusEventsAllowed)return;super.focusin(e),e.target!==this.editorDiv&&this.editorDiv.focus()}onceAdded(e){if(this.width)return;this.enableEditMode(),e&&this.editorDiv.focus(),this._initialOptions?.isCentered&&this.center(),this._initialOptions=null}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===""}remove(){this.isEditing=!1,this.parent&&(this.parent.setEditingState(!0),this.parent.div.classList.add("freetextEditing")),super.remove()}#extractText(){const e=[];this.editorDiv.normalize();let t=null;for(const n of this.editorDiv.childNodes){if(t?.nodeType===Node.TEXT_NODE&&n.nodeName==="BR")continue;e.push(FreeTextEditor.#getNodeContent(n)),t=n}return e.join(`
`)}#setEditorDimensions(){const[t,n]=this.parentDimensions;let e;if(this.isAttachedToDOM)e=this.div.getBoundingClientRect();else{const{currentLayer:n,div:t}=this,s=t.style.display,o=t.classList.contains("hidden");t.classList.remove("hidden"),t.style.display="hidden",n.div.append(this.div),e=t.getBoundingClientRect(),t.remove(),t.style.display=s,t.classList.toggle("hidden",o)}this.rotation%180===this.parentRotation%180?(this.width=e.width/t,this.height=e.height/n):(this.width=e.height/t,this.height=e.width/n),this.fixAndSetPosition()}commit(){if(!this.isInEditMode())return;super.commit(),this.disableEditMode();const e=this.#content,t=this.#content=this.#extractText().trimEnd();if(e===t)return;const n=e=>{if(this.#content=e,!e){this.remove();return}this.#setContent(),this._uiManager.rebuild(this),this.#setEditorDimensions()};this.addCommands({cmd:()=>{n(t)},undo:()=>{n(e)},mustExec:!1}),this.#setEditorDimensions()}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode(),this.editorDiv.focus()}keydown(e){e.target===this.div&&e.key==="Enter"&&(this.enterInEditMode(),e.preventDefault())}editorDivKeydown(e){FreeTextEditor._keyboardManager.exec(this,e)}editorDivFocus(){this.isEditing=!0}editorDivBlur(){this.isEditing=!1}editorDivInput(){this.parent.div.classList.toggle("freetextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment"),this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox"),this.editorDiv.setAttribute("aria-multiline",!0)}get canChangeContent(){return!0}render(){if(this.div)return this.div;let e,t;(this._isCopy||this.annotationElementId)&&(e=this.x,t=this.y),super.render(),this.editorDiv=document.createElement("div"),this.editorDiv.className="internal",this.editorDiv.setAttribute("id",this.#editorDivId),this.editorDiv.setAttribute("data-l10n-id","pdfjs-free-text2"),this.editorDiv.setAttribute("data-l10n-attrs","default-content"),this.enableEditing(),this.editorDiv.contentEditable=!0;const{style:n}=this.editorDiv;if(n.fontSize=`calc(${this.#fontSize}px * var(--total-scale-factor))`,n.color=this.#color,this.div.append(this.editorDiv),this.overlayDiv=document.createElement("div"),this.overlayDiv.classList.add("overlay","enabled"),this.div.append(this.overlayDiv),this._isCopy||this.annotationElementId){const[n,s]=this.parentDimensions;if(this.annotationElementId){const{position:a}=this._initialData;let[o,i]=this.getInitialTranslation();[o,i]=this.pageTranslationToScreen(o,i);const[r,c]=this.pageDimensions,[u,h]=this.pageTranslation;let l,d;switch(this.rotation){case 0:l=e+(a[0]-u)/r,d=t+this.height-(a[1]-h)/c;break;case 90:l=e+(a[0]-u)/r,d=t-(a[1]-h)/c,[o,i]=[i,-o];break;case 180:l=e-this.width+(a[0]-u)/r,d=t-(a[1]-h)/c,[o,i]=[-o,-i];break;case 270:l=e+(a[0]-u-this.height*c)/r,d=t+(a[1]-h-this.width*r)/c,[o,i]=[-i,o];break}this.setAt(l*n,d*s,o,i)}else this._moveAfterPaste(e,t);this.#setContent(),this._isDraggable=!0,this.editorDiv.contentEditable=!1}else this._isDraggable=!1,this.editorDiv.contentEditable=!0;return this.div}static#getNodeContent(e){return(e.nodeType===Node.TEXT_NODE?e.nodeValue:e.innerText).replaceAll(EOL_PATTERN,"")}editorDivPaste(e){const l=e.clipboardData||window.clipboardData,{types:d}=l;if(d.length===1&&d[0]==="text/plain")return;e.preventDefault();const o=FreeTextEditor.#deserializeContent(l.getData("text")||"").replaceAll(EOL_PATTERN,`
`);if(!o)return;const t=window.getSelection();if(!t.rangeCount)return;this.editorDiv.normalize(),t.deleteFromDocument();const u=t.getRangeAt(0);if(!o.includes(`
`)){u.insertNode(document.createTextNode(o)),this.editorDiv.normalize(),t.collapseToStart();return}const{startContainer:n,startOffset:r}=u,s=[],i=[];if(n.nodeType===Node.TEXT_NODE){const e=n.parentElement;if(i.push(n.nodeValue.slice(r).replaceAll(EOL_PATTERN,"")),e!==this.editorDiv){let t=s;for(const n of this.editorDiv.childNodes){if(n===e){t=i;continue}t.push(FreeTextEditor.#getNodeContent(n))}}s.push(n.nodeValue.slice(0,r).replaceAll(EOL_PATTERN,""))}else if(n===this.editorDiv){let e=s,t=0;for(const n of this.editorDiv.childNodes)t++===r&&(e=i),e.push(FreeTextEditor.#getNodeContent(n))}this.#content=`${s.join(`
`)}${o}${i.join(`
`)}`,this.#setContent();const c=new Range;let a=Math.sumPrecise(s.map(e=>e.length));for(const{firstChild:e}of this.editorDiv.childNodes)if(e.nodeType===Node.TEXT_NODE){const t=e.nodeValue.length;if(a<=t){c.setStart(e,a),c.setEnd(e,a);break}a-=t}t.removeAllRanges(),t.addRange(c)}#setContent(){if(this.editorDiv.replaceChildren(),!this.#content)return;for(const e of this.#content.split(`
`)){const t=document.createElement("div");t.append(e?document.createTextNode(e):document.createElement("br")),this.editorDiv.append(t)}}#serializeContent(){return this.#content.replaceAll("\xa0"," ")}static#deserializeContent(e){return e.replaceAll(" ","\xa0")}get contentDiv(){return this.editorDiv}static async deserialize(e,t,n){let o=null;if(e instanceof FreeTextAnnotationElement){const{data:{defaultAppearanceData:{fontSize:n,fontColor:s},rect:i,rotation:a,id:r,popupRef:c},textContent:t,textPosition:l,parent:{page:{pageNumber:d}}}=e;if(!t||t.length===0)return null;o=e={annotationType:AnnotationEditorType.FREETEXT,color:Array.from(s),fontSize:n,value:t.join(`
`),position:l,pageIndex:d-1,rect:i.slice(0),rotation:a,id:r,deleted:!1,popupRef:c}}const s=await super.deserialize(e,t,n);return s.#fontSize=e.fontSize,s.#color=Util.makeHexColor(...e.color),s.#content=FreeTextEditor.#deserializeContent(e.value),s.annotationElementId=e.id||null,s._initialData=o,s}serialize(e=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const n=FreeTextEditor._internalPadding*this.parentScale,s=this.getRect(n,n),o=AnnotationEditor._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:this.#color),t={annotationType:AnnotationEditorType.FREETEXT,color:o,fontSize:this.#fontSize,value:this.#serializeContent(),pageIndex:this.pageIndex,rect:s,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return e?(t.isCopy=!0,t):this.annotationElementId&&!this.#hasElementChanged(t)?null:(t.id=this.annotationElementId,t)}#hasElementChanged(e){const{value:t,fontSize:n,color:s,pageIndex:o}=this._initialData;return this._hasBeenMoved||e.value!==t||e.fontSize!==n||e.color.some((e,t)=>e!==s[t])||e.pageIndex!==o}renderAnnotationElement(e){const t=super.renderAnnotationElement(e);if(this.deleted)return t;const{style:n}=t;n.fontSize=`calc(${this.#fontSize}px * var(--total-scale-factor))`,n.color=this.#color,t.replaceChildren();for(const e of this.#content.split(`
`)){const n=document.createElement("div");n.append(e?document.createTextNode(e):document.createElement("br")),t.append(n)}const s=FreeTextEditor._internalPadding*this.parentScale;return e.updateEdited({rect:this.getRect(s,s),popupContent:this.#content}),t}resetAnnotationElement(e){super.resetAnnotationElement(e),e.resetEdited()}}class Outline{static PRECISION=1e-4;toSVGPath(){unreachable("Abstract method `toSVGPath` must be implemented.")}get box(){unreachable("Abstract getter `box` must be implemented.")}serialize(){unreachable("Abstract method `serialize` must be implemented.")}static _rescale(e,t,n,s,o,i){i||=new Float32Array(e.length);for(let a=0,r=e.length;a<r;a+=2)i[a]=t+e[a]*s,i[a+1]=n+e[a+1]*o;return i}static _rescaleAndSwap(e,t,n,s,o,i){i||=new Float32Array(e.length);for(let a=0,r=e.length;a<r;a+=2)i[a]=t+e[a+1]*s,i[a+1]=n+e[a]*o;return i}static _translate(e,t,n,s){s||=new Float32Array(e.length);for(let o=0,i=e.length;o<i;o+=2)s[o]=t+e[o],s[o+1]=n+e[o+1];return s}static svgRound(e){return Math.round(e*1e4)}static _normalizePoint(e,t,n,s,o){switch(o){case 90:return[1-t/n,e/s];case 180:return[1-e/n,1-t/s];case 270:return[t/n,1-e/s];default:return[e/n,t/s]}}static _normalizePagePoint(e,t,n){switch(n){case 90:return[1-t,e];case 180:return[1-e,1-t];case 270:return[t,1-e];default:return[e,t]}}static createBezierPoints(e,t,n,s,o,i){return[(e+5*n)/6,(t+5*s)/6,(5*n+o)/6,(5*s+i)/6,(n+o)/2,(s+i)/2]}}class FreeDrawOutliner{#box;#bottom=[];#innerMargin;#isLTR;#top=[];#last=new Float32Array(18);#lastX;#lastY;#min;#min_dist;#scaleFactor;#thickness;#points=[];static#MIN_DIST=8;static#MIN_DIFF=2;static#MIN=FreeDrawOutliner.#MIN_DIST+FreeDrawOutliner.#MIN_DIFF;constructor({x:e,y:t},n,s,o,i,a=0){this.#box=n,this.#thickness=o*s,this.#isLTR=i,this.#last.set([NaN,NaN,NaN,NaN,e,t],6),this.#innerMargin=a,this.#min_dist=FreeDrawOutliner.#MIN_DIST*s,this.#min=FreeDrawOutliner.#MIN*s,this.#scaleFactor=s,this.#points.push(e,t)}isEmpty(){return isNaN(this.#last[8])}#getLastCoords(){const e=this.#last.subarray(4,6),t=this.#last.subarray(16,18),[n,s,o,i]=this.#box;return[(this.#lastX+(e[0]-t[0])/2-n)/o,(this.#lastY+(e[1]-t[1])/2-s)/i,(this.#lastX+(t[0]-e[0])/2-n)/o,(this.#lastY+(t[1]-e[1])/2-s)/i]}add({x:e,y:t}){this.#lastX=e,this.#lastY=t;const[a,r,c,l]=this.#box;let[n,s,o,i]=this.#last.subarray(8,12);const b=e-o,j=t-i,f=Math.hypot(b,j);if(f<this.#min)return!1;const p=f-this.#min_dist,y=p/f,g=y*b,v=y*j;let d=n,u=s;n=o,s=i,o+=g,i+=v,this.#points?.push(e,t);const _=-v/p,w=g/p,m=_*this.#thickness,h=w*this.#thickness;if(this.#last.set(this.#last.subarray(2,8),0),this.#last.set([o+m,i+h],4),this.#last.set(this.#last.subarray(14,18),12),this.#last.set([o-m,i-h],16),isNaN(this.#last[6]))return this.#top.length===0&&(this.#last.set([n+m,s+h],2),this.#top.push(NaN,NaN,NaN,NaN,(n+m-a)/c,(s+h-r)/l),this.#last.set([n-m,s-h],14),this.#bottom.push(NaN,NaN,NaN,NaN,(n-m-a)/c,(s-h-r)/l)),this.#last.set([d,u,n,s,o,i],6),!this.isEmpty();this.#last.set([d,u,n,s,o,i],6);const O=Math.abs(Math.atan2(u-s,d-n)-Math.atan2(v,g));return O<Math.PI/2?([n,s,o,i]=this.#last.subarray(2,6),this.#top.push(NaN,NaN,NaN,NaN,((n+o)/2-a)/c,((s+i)/2-r)/l),[n,s,d,u]=this.#last.subarray(14,18),this.#bottom.push(NaN,NaN,NaN,NaN,((d+n)/2-a)/c,((u+s)/2-r)/l),!0):([d,u,n,s,o,i]=this.#last.subarray(0,6),this.#top.push(((d+5*n)/6-a)/c,((u+5*s)/6-r)/l,((5*n+o)/6-a)/c,((5*s+i)/6-r)/l,((n+o)/2-a)/c,((s+i)/2-r)/l),[o,i,n,s,d,u]=this.#last.subarray(12,18),this.#bottom.push(((d+5*n)/6-a)/c,((u+5*s)/6-r)/l,((5*n+o)/6-a)/c,((5*s+i)/6-r)/l,((n+o)/2-a)/c,((s+i)/2-r)/l),!0)}toSVGPath(){if(this.isEmpty())return"";const e=this.#top,t=this.#bottom;if(isNaN(this.#last[6])&&!this.isEmpty())return this.#toSVGPathTwoPoints();const n=[];n.push(`M${e[4]} ${e[5]}`);for(let t=6;t<e.length;t+=6)isNaN(e[t])?n.push(`L${e[t+4]} ${e[t+5]}`):n.push(`C${e[t]} ${e[t+1]} ${e[t+2]} ${e[t+3]} ${e[t+4]} ${e[t+5]}`);this.#toSVGPathEnd(n);for(let e=t.length-6;e>=6;e-=6)isNaN(t[e])?n.push(`L${t[e+4]} ${t[e+5]}`):n.push(`C${t[e]} ${t[e+1]} ${t[e+2]} ${t[e+3]} ${t[e+4]} ${t[e+5]}`);return this.#toSVGPathStart(n),n.join(" ")}#toSVGPathTwoPoints(){const[e,t,n,s]=this.#box,[o,i,a,r]=this.#getLastCoords();return`M${(this.#last[2]-e)/n} ${(this.#last[3]-t)/s} L${(this.#last[4]-e)/n} ${(this.#last[5]-t)/s} L${o} ${i} L${a} ${r} L${(this.#last[16]-e)/n} ${(this.#last[17]-t)/s} L${(this.#last[14]-e)/n} ${(this.#last[15]-t)/s} Z`}#toSVGPathStart(e){const t=this.#bottom;e.push(`L${t[4]} ${t[5]} Z`)}#toSVGPathEnd(e){const[t,n,s,o]=this.#box,i=this.#last.subarray(4,6),a=this.#last.subarray(16,18),[r,c,l,d]=this.#getLastCoords();e.push(`L${(i[0]-t)/s} ${(i[1]-n)/o} L${r} ${c} L${l} ${d} L${(a[0]-t)/s} ${(a[1]-n)/o}`)}newFreeDrawOutline(e,t,n,s,o,i){return new FreeDrawOutline(e,t,n,s,o,i)}getOutlines(){const s=this.#top,o=this.#bottom,l=this.#last,[i,a,r,c]=this.#box,n=new Float32Array((this.#points?.length??0)+2);for(let e=0,t=n.length-2;e<t;e+=2)n[e]=(this.#points[e]-i)/r,n[e+1]=(this.#points[e+1]-a)/c;if(n[n.length-2]=(this.#lastX-i)/r,n[n.length-1]=(this.#lastY-a)/c,isNaN(l[6])&&!this.isEmpty())return this.#getOutlineTwoPoints(n);const e=new Float32Array(this.#top.length+24+this.#bottom.length);let t=s.length;for(let n=0;n<t;n+=2){if(isNaN(s[n])){e[n]=e[n+1]=NaN;continue}e[n]=s[n],e[n+1]=s[n+1]}t=this.#getOutlineEnd(e,t);for(let n=o.length-6;n>=6;n-=6)for(let s=0;s<6;s+=2){if(isNaN(o[n+s])){e[t]=e[t+1]=NaN,t+=2;continue}e[t]=o[n+s],e[t+1]=o[n+s+1],t+=2}return this.#getOutlineStart(e,t),this.newFreeDrawOutline(e,n,this.#box,this.#scaleFactor,this.#innerMargin,this.#isLTR)}#getOutlineTwoPoints(e){const t=this.#last,[n,s,o,i]=this.#box,[r,c,l,d]=this.#getLastCoords(),a=new Float32Array(36);return a.set([NaN,NaN,NaN,NaN,(t[2]-n)/o,(t[3]-s)/i,NaN,NaN,NaN,NaN,(t[4]-n)/o,(t[5]-s)/i,NaN,NaN,NaN,NaN,r,c,NaN,NaN,NaN,NaN,l,d,NaN,NaN,NaN,NaN,(t[16]-n)/o,(t[17]-s)/i,NaN,NaN,NaN,NaN,(t[14]-n)/o,(t[15]-s)/i],0),this.newFreeDrawOutline(a,e,this.#box,this.#scaleFactor,this.#innerMargin,this.#isLTR)}#getOutlineStart(e,t){const n=this.#bottom;return e.set([NaN,NaN,NaN,NaN,n[4],n[5]],t),t+=6}#getOutlineEnd(e,t){const n=this.#last.subarray(4,6),s=this.#last.subarray(16,18),[o,i,a,r]=this.#box,[c,l,d,u]=this.#getLastCoords();return e.set([NaN,NaN,NaN,NaN,(n[0]-o)/a,(n[1]-i)/r,NaN,NaN,NaN,NaN,c,l,NaN,NaN,NaN,NaN,d,u,NaN,NaN,NaN,NaN,(s[0]-o)/a,(s[1]-i)/r],t),t+=24}}class FreeDrawOutline extends Outline{#box;#bbox=new Float32Array(4);#innerMargin;#isLTR;#points;#scaleFactor;#outline;constructor(e,t,n,s,o,i){super(),this.#outline=e,this.#points=t,this.#box=n,this.#scaleFactor=s,this.#innerMargin=o,this.#isLTR=i,this.lastPoint=[NaN,NaN],this.#computeMinMax(i);const[a,r,c,l]=this.#bbox;for(let t=0,n=e.length;t<n;t+=2)e[t]=(e[t]-a)/c,e[t+1]=(e[t+1]-r)/l;for(let e=0,n=t.length;e<n;e+=2)t[e]=(t[e]-a)/c,t[e+1]=(t[e+1]-r)/l}toSVGPath(){const e=[`M${this.#outline[4]} ${this.#outline[5]}`];for(let t=6,n=this.#outline.length;t<n;t+=6){if(isNaN(this.#outline[t])){e.push(`L${this.#outline[t+4]} ${this.#outline[t+5]}`);continue}e.push(`C${this.#outline[t]} ${this.#outline[t+1]} ${this.#outline[t+2]} ${this.#outline[t+3]} ${this.#outline[t+4]} ${this.#outline[t+5]}`)}return e.push("Z"),e.join(" ")}serialize([e,t,n,s],o){const i=n-e,a=s-t;let r,c;switch(o){case 0:r=Outline._rescale(this.#outline,e,s,i,-a),c=Outline._rescale(this.#points,e,s,i,-a);break;case 90:r=Outline._rescaleAndSwap(this.#outline,e,t,i,a),c=Outline._rescaleAndSwap(this.#points,e,t,i,a);break;case 180:r=Outline._rescale(this.#outline,n,t,-i,a),c=Outline._rescale(this.#points,n,t,-i,a);break;case 270:r=Outline._rescaleAndSwap(this.#outline,n,s,-i,-a),c=Outline._rescaleAndSwap(this.#points,n,s,-i,-a);break}return{outline:Array.from(r),points:[Array.from(c)]}}#computeMinMax(e){const n=this.#outline;let i=n[4],a=n[5];const t=[i,a,i,a];let s=i,o=a;const c=e?Math.max:Math.min;for(let e=6,d=n.length;e<d;e+=6){const l=n[e+4],r=n[e+5];if(isNaN(n[e]))Util.pointBoundingBox(l,r,t),o<r?(s=l,o=r):o===r&&(s=c(s,l));else{const r=[1/0,1/0,-(1/0),-(1/0)];Util.bezierBoundingBox(i,a,...n.slice(e,e+6),r),Util.rectBoundingBox(...r,t),o<r[3]?(s=r[2],o=r[3]):o===r[3]&&(s=c(s,r[2]))}i=l,a=r}const r=this.#bbox;r[0]=t[0]-this.#innerMargin,r[1]=t[1]-this.#innerMargin,r[2]=t[2]-t[0]+2*this.#innerMargin,r[3]=t[3]-t[1]+2*this.#innerMargin,this.lastPoint=[s,o]}get box(){return this.#bbox}newOutliner(e,t,n,s,o,i=0){return new FreeDrawOutliner(e,t,n,s,o,i)}getNewOutline(e,t){const[f,l,d,u]=this.#bbox,[h,m,s,o]=this.#box,i=d*s,n=u*o,a=f*s+h,r=l*o+m,c=this.newOutliner({x:this.#points[0]*i+a,y:this.#points[1]*n+r},this.#box,this.#scaleFactor,e,this.#isLTR,t??this.#innerMargin);for(let e=2;e<this.#points.length;e+=2)c.add({x:this.#points[e]*i+a,y:this.#points[e+1]*n+r});return c.getOutlines()}}class HighlightOutliner{#box;#lastPoint;#verticalEdges=[];#intervals=[];constructor(e,t=0,n=0,s=!0){const i=[1/0,1/0,-(1/0),-(1/0)],u=4,o=10**-u;for(const{x:a,y:r,width:d,height:u}of e){const c=Math.floor((a-t)/o)*o,l=Math.ceil((a+d+t)/o)*o,n=Math.floor((r-t)/o)*o,s=Math.ceil((r+u+t)/o)*o,h=[c,n,s,!0],m=[l,n,s,!1];this.#verticalEdges.push(h,m),Util.rectBoundingBox(c,n,l,s,i)}const c=i[2]-i[0]+2*n,a=i[3]-i[1]+2*n,l=i[0]-n,r=i[1]-n,d=this.#verticalEdges.at(s?-1:-2),h=[d[0],d[2]];for(const e of this.#verticalEdges){const[t,n,s]=e;e[0]=(t-l)/c,e[1]=(n-r)/a,e[2]=(s-r)/a}this.#box=new Float32Array([l,r,c,a]),this.#lastPoint=h}getOutlines(){this.#verticalEdges.sort((e,t)=>e[0]-t[0]||e[1]-t[1]||e[2]-t[2]);const e=[];for(const t of this.#verticalEdges)t[3]?(e.push(...this.#breakEdge(t)),this.#insert(t)):(this.#remove(t),e.push(...this.#breakEdge(t)));return this.#getOutlines(e)}#getOutlines(e){const n=[],t=new Set;for(const t of e){const[s,o,i]=t;n.push([s,o,t],[s,i,t])}n.sort((e,t)=>e[1]-t[1]||e[0]-t[0]);for(let e=0,i=n.length;e<i;e+=2){const s=n[e][2],o=n[e+1][2];s.push(o),o.push(s),t.add(s),t.add(o)}const o=[];let s;for(;t.size>0;){const d=t.values().next().value;let[e,n,a,c,l]=d;t.delete(d);let r=e,i=n;for(s=[e,a],o.push(s);!0;){let o;if(t.has(c))o=c;else if(t.has(l))o=l;else break;t.delete(o),[e,n,a,c,l]=o,r!==e&&(s.push(r,i,e,i===n?n:a),r=e),i=i===n?a:n}s.push(r,i)}return new HighlightOutline(o,this.#box,this.#lastPoint)}#binarySearch(e){const s=this.#intervals;let n=0,t=s.length-1;for(;n<=t;){const o=n+t>>1,i=s[o][0];if(i===e)return o;i<e?n=o+1:t=o-1}return t+1}#insert([,e,t]){const n=this.#binarySearch(e);this.#intervals.splice(n,0,[e,t])}#remove([,e,t]){const n=this.#binarySearch(e);for(let s=n;s<this.#intervals.length;s++){const[o,i]=this.#intervals[s];if(o!==e)break;if(o===e&&i===t){this.#intervals.splice(s,1);return}}for(let s=n-1;s>=0;s--){const[o,i]=this.#intervals[s];if(o!==e)break;if(o===e&&i===t){this.#intervals.splice(s,1);return}}}#breakEdge(e){const[n,o,s]=e,t=[[n,o,s]],i=this.#binarySearch(s);for(let s=0;s<i;s++){const[o,e]=this.#intervals[s];for(let s=0,a=t.length;s<a;s++){const[,r,i]=t[s];if(e<=r||i<=o)continue;if(r>=o){if(i>e)t[s][1]=e;else{if(a===1)return[];t.splice(s,1),s--,a--}continue}t[s][2]=o,i>e&&t.push([n,e,i])}}return t}}class HighlightOutline extends Outline{#box;#outlines;constructor(e,t,n){super(),this.#outlines=e,this.#box=t,this.lastPoint=n}toSVGPath(){const e=[];for(const t of this.#outlines){let[n,s]=t;e.push(`M${n} ${s}`);for(let o=2;o<t.length;o+=2){const i=t[o],a=t[o+1];i===n?(e.push(`V${a}`),s=a):a===s&&(e.push(`H${i}`),n=i)}e.push("Z")}return e.join(" ")}serialize([e,t,n,s]){const i=[],a=n-e,r=s-t;for(const t of this.#outlines){const n=new Array(t.length);for(let o=0;o<t.length;o+=2)n[o]=e+t[o]*a,n[o+1]=s-t[o+1]*r;i.push(n)}return i}get box(){return this.#box}get classNamesForOutlining(){return["highlightOutline"]}}class FreeHighlightOutliner extends FreeDrawOutliner{newFreeDrawOutline(e,t,n,s,o,i){return new FreeHighlightOutline(e,t,n,s,o,i)}}class FreeHighlightOutline extends FreeDrawOutline{newOutliner(e,t,n,s,o,i=0){return new FreeHighlightOutliner(e,t,n,s,o,i)}}class ColorPicker{#button=null;#buttonSwatch=null;#defaultColor;#dropdown=null;#dropdownWasFromKeyboard=!1;#isMainColorPicker=!1;#editor=null;#eventBus;#openDropdownAC=null;#uiManager=null;#type;static#l10nColor=null;static get _keyboardManager(){return shadow(this,"_keyboardManager",new KeyboardManager([[["Escape","mac+Escape"],ColorPicker.prototype._hideDropdownFromKeyboard],[[" ","mac+ "],ColorPicker.prototype._colorSelectFromKeyboard],[["ArrowDown","ArrowRight","mac+ArrowDown","mac+ArrowRight"],ColorPicker.prototype._moveToNext],[["ArrowUp","ArrowLeft","mac+ArrowUp","mac+ArrowLeft"],ColorPicker.prototype._moveToPrevious],[["Home","mac+Home"],ColorPicker.prototype._moveToBeginning],[["End","mac+End"],ColorPicker.prototype._moveToEnd]]))}constructor({editor:e=null,uiManager:t=null}){e?(this.#isMainColorPicker=!1,this.#type=AnnotationEditorParamsType.HIGHLIGHT_COLOR,this.#editor=e):(this.#isMainColorPicker=!0,this.#type=AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR),this.#uiManager=e?._uiManager||t,this.#eventBus=this.#uiManager._eventBus,this.#defaultColor=e?.color||this.#uiManager?.highlightColors.values().next().value||"#FFFF98",ColorPicker.#l10nColor||=Object.freeze({blue:"pdfjs-editor-colorpicker-blue",green:"pdfjs-editor-colorpicker-green",pink:"pdfjs-editor-colorpicker-pink",red:"pdfjs-editor-colorpicker-red",yellow:"pdfjs-editor-colorpicker-yellow"})}renderButton(){const e=this.#button=document.createElement("button");e.className="colorPicker",e.tabIndex="0",e.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-button"),e.setAttribute("aria-haspopup",!0);const n=this.#uiManager._signal;e.addEventListener("click",this.#openDropdown.bind(this),{signal:n}),e.addEventListener("keydown",this.#keyDown.bind(this),{signal:n});const t=this.#buttonSwatch=document.createElement("span");return t.className="swatch",t.setAttribute("aria-hidden",!0),t.style.backgroundColor=this.#defaultColor,e.append(t),e}renderMainDropdown(){const e=this.#dropdown=this.#getDropdownRoot();return e.setAttribute("aria-orientation","horizontal"),e.setAttribute("aria-labelledby","highlightColorPickerLabel"),e}#getDropdownRoot(){const e=document.createElement("div"),t=this.#uiManager._signal;e.addEventListener("contextmenu",noContextMenu,{signal:t}),e.className="dropdown",e.role="listbox",e.setAttribute("aria-multiselectable",!1),e.setAttribute("aria-orientation","vertical"),e.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-dropdown");for(const[i,s]of this.#uiManager.highlightColors){const n=document.createElement("button");n.tabIndex="0",n.role="option",n.setAttribute("data-color",s),n.title=i,n.setAttribute("data-l10n-id",ColorPicker.#l10nColor[i]);const o=document.createElement("span");n.append(o),o.className="swatch",o.style.backgroundColor=s,n.setAttribute("aria-selected",s===this.#defaultColor),n.addEventListener("click",this.#colorSelect.bind(this,s),{signal:t}),e.append(n)}return e.addEventListener("keydown",this.#keyDown.bind(this),{signal:t}),e}#colorSelect(e,t){t.stopPropagation(),this.#eventBus.dispatch("switchannotationeditorparams",{source:this,type:this.#type,value:e})}_colorSelectFromKeyboard(e){if(e.target===this.#button){this.#openDropdown(e);return}const t=e.target.getAttribute("data-color");if(!t)return;this.#colorSelect(t,e)}_moveToNext(e){if(!this.#isDropdownVisible){this.#openDropdown(e);return}if(e.target===this.#button){this.#dropdown.firstChild?.focus();return}e.target.nextSibling?.focus()}_moveToPrevious(e){if(e.target===this.#dropdown?.firstChild||e.target===this.#button){this.#isDropdownVisible&&this._hideDropdownFromKeyboard();return}this.#isDropdownVisible||this.#openDropdown(e),e.target.previousSibling?.focus()}_moveToBeginning(e){if(!this.#isDropdownVisible){this.#openDropdown(e);return}this.#dropdown.firstChild?.focus()}_moveToEnd(e){if(!this.#isDropdownVisible){this.#openDropdown(e);return}this.#dropdown.lastChild?.focus()}#keyDown(e){ColorPicker._keyboardManager.exec(this,e)}#openDropdown(e){if(this.#isDropdownVisible){this.hideDropdown();return}if(this.#dropdownWasFromKeyboard=e.detail===0,this.#openDropdownAC||(this.#openDropdownAC=new AbortController,window.addEventListener("pointerdown",this.#pointerDown.bind(this),{signal:this.#uiManager.combinedSignal(this.#openDropdownAC)})),this.#dropdown){this.#dropdown.classList.remove("hidden");return}const t=this.#dropdown=this.#getDropdownRoot();this.#button.append(t)}#pointerDown(e){if(this.#dropdown?.contains(e.target))return;this.hideDropdown()}hideDropdown(){this.#dropdown?.classList.add("hidden"),this.#openDropdownAC?.abort(),this.#openDropdownAC=null}get#isDropdownVisible(){return this.#dropdown&&!this.#dropdown.classList.contains("hidden")}_hideDropdownFromKeyboard(){if(this.#isMainColorPicker)return;if(!this.#isDropdownVisible){this.#editor?.unselect();return}this.hideDropdown(),this.#button.focus({preventScroll:!0,focusVisible:this.#dropdownWasFromKeyboard})}updateColor(e){if(this.#buttonSwatch&&(this.#buttonSwatch.style.backgroundColor=e),!this.#dropdown)return;const t=this.#uiManager.highlightColors.values();for(const n of this.#dropdown.children)n.setAttribute("aria-selected",t.next().value===e)}destroy(){this.#button?.remove(),this.#button=null,this.#buttonSwatch=null,this.#dropdown?.remove(),this.#dropdown=null}}class HighlightEditor extends AnnotationEditor{#anchorNode=null;#anchorOffset=0;#boxes;#clipPathId=null;#colorPicker=null;#focusOutlines=null;#focusNode=null;#focusOffset=0;#highlightDiv=null;#highlightOutlines=null;#id=null;#isFreeHighlight=!1;#lastPoint=null;#opacity;#outlineId=null;#text="";#thickness;#methodOfCreation="";static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=12;static _type="highlight";static _editorType=AnnotationEditorType.HIGHLIGHT;static _freeHighlightId=-1;static _freeHighlight=null;static _freeHighlightClipId="";static get _keyboardManager(){const e=HighlightEditor.prototype;return shadow(this,"_keyboardManager",new KeyboardManager([[["ArrowLeft","mac+ArrowLeft"],e._moveCaret,{args:[0]}],[["ArrowRight","mac+ArrowRight"],e._moveCaret,{args:[1]}],[["ArrowUp","mac+ArrowUp"],e._moveCaret,{args:[2]}],[["ArrowDown","mac+ArrowDown"],e._moveCaret,{args:[3]}]]))}constructor(e){super({...e,name:"highlightEditor"}),this.color=e.color||HighlightEditor._defaultColor,this.#thickness=e.thickness||HighlightEditor._defaultThickness,this.#opacity=e.opacity||HighlightEditor._defaultOpacity,this.#boxes=e.boxes||null,this.#methodOfCreation=e.methodOfCreation||"",this.#text=e.text||"",this._isDraggable=!1,this.defaultL10nId="pdfjs-editor-highlight-editor",e.highlightId>-1?(this.#isFreeHighlight=!0,this.#createFreeOutlines(e),this.#addToDrawLayer()):this.#boxes&&(this.#anchorNode=e.anchorNode,this.#anchorOffset=e.anchorOffset,this.#focusNode=e.focusNode,this.#focusOffset=e.focusOffset,this.#createOutlines(),this.#addToDrawLayer(),this.rotate(this.rotation))}get telemetryInitialData(){return{action:"added",type:this.#isFreeHighlight?"free_highlight":"highlight",color:this._uiManager.highlightColorNames.get(this.color),thickness:this.#thickness,methodOfCreation:this.#methodOfCreation}}get telemetryFinalData(){return{type:"highlight",color:this._uiManager.highlightColorNames.get(this.color)}}static computeTelemetryFinalData(e){return{numberOfColors:e.get("color").size}}#createOutlines(){const t=new HighlightOutliner(this.#boxes,.001);this.#highlightOutlines=t.getOutlines(),[this.x,this.y,this.width,this.height]=this.#highlightOutlines.box;const n=new HighlightOutliner(this.#boxes,.0025,.001,this._uiManager.direction==="ltr");this.#focusOutlines=n.getOutlines();const{lastPoint:e}=this.#focusOutlines;this.#lastPoint=[(e[0]-this.x)/this.width,(e[1]-this.y)/this.height]}#createFreeOutlines({highlightOutlines:e,highlightId:t,clipPathId:n}){this.#highlightOutlines=e;const c=1.5;if(this.#focusOutlines=e.getNewOutline(this.#thickness/2+c,.0025),t>=0)this.#id=t,this.#clipPathId=n,this.parent.drawLayer.finalizeDraw(t,{bbox:e.box,path:{d:e.toSVGPath()}}),this.#outlineId=this.parent.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:!0},bbox:this.#focusOutlines.box,path:{d:this.#focusOutlines.toSVGPath()}},!0);else if(this.parent){const t=this.parent.viewport.rotation;this.parent.drawLayer.updateProperties(this.#id,{bbox:HighlightEditor.#rotateBbox(this.#highlightOutlines.box,(t-this.rotation+360)%360),path:{d:e.toSVGPath()}}),this.parent.drawLayer.updateProperties(this.#outlineId,{bbox:HighlightEditor.#rotateBbox(this.#focusOutlines.box,t),path:{d:this.#focusOutlines.toSVGPath()}})}const[s,o,i,a]=e.box;switch(this.rotation){case 0:this.x=s,this.y=o,this.width=i,this.height=a;break;case 90:{const[e,t]=this.parentDimensions;this.x=o,this.y=1-s,this.width=i*t/e,this.height=a*e/t;break}case 180:this.x=1-s,this.y=1-o,this.width=i,this.height=a;break;case 270:{const[e,t]=this.parentDimensions;this.x=1-o,this.y=s,this.width=i*t/e,this.height=a*e/t;break}}const{lastPoint:r}=this.#focusOutlines;this.#lastPoint=[(r[0]-s)/i,(r[1]-o)/a]}static initialize(e,t){AnnotationEditor.initialize(e,t),HighlightEditor._defaultColor||=t.highlightColors?.values().next().value||"#fff066"}static updateDefaultParams(e,t){switch(e){case AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR:HighlightEditor._defaultColor=t;break;case AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:HighlightEditor._defaultThickness=t;break}}translateInPage(){}get toolbarPosition(){return this.#lastPoint}updateParams(e,t){switch(e){case AnnotationEditorParamsType.HIGHLIGHT_COLOR:this.#updateColor(t);break;case AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:this.#updateThickness(t);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR,HighlightEditor._defaultColor],[AnnotationEditorParamsType.HIGHLIGHT_THICKNESS,HighlightEditor._defaultThickness]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.HIGHLIGHT_COLOR,this.color||HighlightEditor._defaultColor],[AnnotationEditorParamsType.HIGHLIGHT_THICKNESS,this.#thickness||HighlightEditor._defaultThickness],[AnnotationEditorParamsType.HIGHLIGHT_FREE,this.#isFreeHighlight]]}#updateColor(e){const t=(e,t)=>{this.color=e,this.#opacity=t,this.parent?.drawLayer.updateProperties(this.#id,{root:{fill:e,"fill-opacity":t}}),this.#colorPicker?.updateColor(e)},n=this.color,s=this.#opacity;this.addCommands({cmd:t.bind(this,e,HighlightEditor._defaultOpacity),undo:t.bind(this,n,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:AnnotationEditorParamsType.HIGHLIGHT_COLOR,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"color_changed",color:this._uiManager.highlightColorNames.get(e)},!0)}#updateThickness(e){const n=this.#thickness,t=e=>{this.#thickness=e,this.#changeThickness(e)};this.addCommands({cmd:t.bind(this,e),undo:t.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:AnnotationEditorParamsType.INK_THICKNESS,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"thickness_changed",thickness:e},!0)}async addEditToolbar(){const e=await super.addEditToolbar();return e?(this._uiManager.highlightColors&&(this.#colorPicker=new ColorPicker({editor:this}),e.addColorPicker(this.#colorPicker)),e):null}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}fixAndSetPosition(){return super.fixAndSetPosition(this.#getRotation())}getBaseTranslation(){return[0,0]}getRect(e,t){return super.getRect(e,t,this.#getRotation())}onceAdded(e){this.annotationElementId||this.parent.addUndoableEditor(this),e&&this.div.focus()}remove(){this.#cleanDrawLayer(),this._reportTelemetry({action:"deleted"}),super.remove()}rebuild(){if(!this.parent)return;if(super.rebuild(),this.div===null)return;this.#addToDrawLayer(),this.isAttachedToDOM||this.parent.add(this)}setParent(e){let t=!1;this.parent&&!e?this.#cleanDrawLayer():e&&(this.#addToDrawLayer(e),t=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(e),this.show(this._isVisible),t&&this.select()}#changeThickness(e){if(!this.#isFreeHighlight)return;this.#createFreeOutlines({highlightOutlines:this.#highlightOutlines.getNewOutline(e/2)}),this.fixAndSetPosition();const[t,n]=this.parentDimensions;this.setDims(this.width*t,this.height*n)}#cleanDrawLayer(){if(this.#id===null||!this.parent)return;this.parent.drawLayer.remove(this.#id),this.#id=null,this.parent.drawLayer.remove(this.#outlineId),this.#outlineId=null}#addToDrawLayer(e=this.parent){if(this.#id!==null)return;({id:this.#id,clipPathId:this.#clipPathId}=e.drawLayer.draw({bbox:this.#highlightOutlines.box,root:{viewBox:"0 0 1 1",fill:this.color,"fill-opacity":this.#opacity},rootClass:{highlight:!0,free:this.#isFreeHighlight},path:{d:this.#highlightOutlines.toSVGPath()}},!1,!0),this.#outlineId=e.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:this.#isFreeHighlight},bbox:this.#focusOutlines.box,path:{d:this.#focusOutlines.toSVGPath()}},this.#isFreeHighlight),this.#highlightDiv&&(this.#highlightDiv.style.clipPath=this.#clipPathId))}static#rotateBbox([e,t,n,s],o){switch(o){case 90:return[1-t-s,e,s,n];case 180:return[1-e-n,1-t-s,n,s];case 270:return[t,1-e-n,s,n]}return[e,t,n,s]}rotate(e){const{drawLayer:n}=this.parent;let t;this.#isFreeHighlight?(e=(e-this.rotation+360)%360,t=HighlightEditor.#rotateBbox(this.#highlightOutlines.box,e)):t=HighlightEditor.#rotateBbox([this.x,this.y,this.width,this.height],e),n.updateProperties(this.#id,{bbox:t,root:{"data-main-rotation":e}}),n.updateProperties(this.#outlineId,{bbox:HighlightEditor.#rotateBbox(this.#focusOutlines.box,e),root:{"data-main-rotation":e}})}render(){if(this.div)return this.div;const e=super.render();this.#text&&(e.setAttribute("aria-label",this.#text),e.setAttribute("role","mark")),this.#isFreeHighlight?e.classList.add("free"):this.div.addEventListener("keydown",this.#keydown.bind(this),{signal:this._uiManager._signal});const t=this.#highlightDiv=document.createElement("div");e.append(t),t.setAttribute("aria-hidden","true"),t.className="internal",t.style.clipPath=this.#clipPathId;const[n,s]=this.parentDimensions;return this.setDims(this.width*n,this.height*s),bindEvents(this,this.#highlightDiv,["pointerover","pointerleave"]),this.enableEditing(),e}pointerover(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!0}})}pointerleave(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!1}})}#keydown(e){HighlightEditor._keyboardManager.exec(this,e)}_moveCaret(e){switch(this.parent.unselect(this),e){case 0:case 2:this.#setCaret(!0);break;case 1:case 3:this.#setCaret(!1);break}}#setCaret(e){if(!this.#anchorNode)return;const t=window.getSelection();e?t.setPosition(this.#anchorNode,this.#anchorOffset):t.setPosition(this.#focusNode,this.#focusOffset)}select(){if(super.select(),!this.#outlineId)return;this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!1,selected:!0}})}unselect(){if(super.unselect(),!this.#outlineId)return;this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{selected:!1}}),this.#isFreeHighlight||this.#setCaret(!1)}get _mustFixPosition(){return!this.#isFreeHighlight}show(e=this._isVisible){super.show(e),this.parent&&(this.parent.drawLayer.updateProperties(this.#id,{rootClass:{hidden:!e}}),this.parent.drawLayer.updateProperties(this.#outlineId,{rootClass:{hidden:!e}}))}#getRotation(){return this.#isFreeHighlight?this.rotation:0}#serializeBoxes(){if(this.#isFreeHighlight)return null;const[n,s]=this.pageDimensions,[i,a]=this.pageTranslation,o=this.#boxes,e=new Float32Array(o.length*8);let t=0;for(const{x:l,y:d,width:u,height:h}of o){const r=l*n+i,c=(1-d)*s+a;e[t]=e[t+4]=r,e[t+1]=e[t+3]=c,e[t+2]=e[t+6]=r+u*n,e[t+5]=e[t+7]=c-h*s,t+=8}return e}#serializeOutlines(e){return this.#highlightOutlines.serialize(e,this.#getRotation())}static startHighlighting(e,t,{target:n,x:s,y:o}){const{x:c,y:l,width:d,height:u}=n.getBoundingClientRect(),a=new AbortController,i=e.combinedSignal(a),r=t=>{a.abort(),this.#endHighlight(e,t)};window.addEventListener("blur",r,{signal:i}),window.addEventListener("pointerup",r,{signal:i}),window.addEventListener("pointerdown",stopEvent,{capture:!0,passive:!1,signal:i}),window.addEventListener("contextmenu",noContextMenu,{signal:i}),n.addEventListener("pointermove",this.#highlightMove.bind(this,e),{signal:i}),this._freeHighlight=new FreeHighlightOutliner({x:s,y:o},[c,l,d,u],e.scale,this._defaultThickness/2,t,.001),{id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=e.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:this._defaultColor,"fill-opacity":this._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:this._freeHighlight.toSVGPath()}},!0,!0)}static#highlightMove(e,t){this._freeHighlight.add(t)&&e.drawLayer.updateProperties(this._freeHighlightId,{path:{d:this._freeHighlight.toSVGPath()}})}static#endHighlight(e,t){this._freeHighlight.isEmpty()?e.drawLayer.remove(this._freeHighlightId):e.createAndAddNewEditor(t,!1,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:"main_toolbar"}),this._freeHighlightId=-1,this._freeHighlight=null,this._freeHighlightClipId=""}static async deserialize(e,t,n){let a=null;if(e instanceof HighlightAnnotationElement){const{data:{quadPoints:t,rect:n,rotation:s,id:o,color:i,opacity:r,popupRef:c},parent:{page:{pageNumber:l}}}=e;a=e={annotationType:AnnotationEditorType.HIGHLIGHT,color:Array.from(i),opacity:r,quadPoints:t,boxes:null,pageIndex:l-1,rect:n.slice(0),rotation:s,id:o,deleted:!1,popupRef:c}}else if(e instanceof InkAnnotationElement){const{data:{inkLists:t,rect:n,rotation:s,id:o,color:i,borderStyle:{rawWidth:r},popupRef:c},parent:{page:{pageNumber:l}}}=e;a=e={annotationType:AnnotationEditorType.HIGHLIGHT,color:Array.from(i),thickness:r,inkLists:t,boxes:null,pageIndex:l-1,rect:n.slice(0),rotation:s,id:o,deleted:!1,popupRef:c}}const{color:u,quadPoints:o,inkLists:r,opacity:h}=e,s=await super.deserialize(e,t,n);s.color=Util.makeHexColor(...u),s.#opacity=h||1,r&&(s.#thickness=e.thickness),s.annotationElementId=e.id||null,s._initialData=a;const[c,i]=s.pageDimensions,[l,d]=s.pageTranslation;if(o){const e=s.#boxes=[];for(let t=0;t<o.length;t+=8)e.push({x:(o[t]-l)/c,y:1-(o[t+1]-d)/i,width:(o[t+2]-o[t])/c,height:(o[t+1]-o[t+5])/i});s.#createOutlines(),s.#addToDrawLayer(),s.rotate(s.rotation)}else if(r){s.#isFreeHighlight=!0;const e=r[0],n={x:e[0]-l,y:i-(e[1]-d)},o=new FreeHighlightOutliner(n,[0,0,c,i],1,s.#thickness/2,!0,.001);for(let t=0,s=e.length;t<s;t+=2)n.x=e[t]-l,n.y=i-(e[t+1]-d),o.add(n);const{id:a,clipPathId:u}=t.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:s.color,"fill-opacity":s._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:o.toSVGPath()}},!0,!0);s.#createFreeOutlines({highlightOutlines:o.getOutlines(),highlightId:a,clipPathId:u}),s.#addToDrawLayer(),s.rotate(s.parentRotation)}return s}serialize(e=!1){if(this.isEmpty()||e)return null;if(this.deleted)return this.serializeDeleted();const n=this.getRect(0,0),s=AnnotationEditor._colorManager.convert(this.color),t={annotationType:AnnotationEditorType.HIGHLIGHT,color:s,opacity:this.#opacity,thickness:this.#thickness,quadPoints:this.#serializeBoxes(),outlines:this.#serializeOutlines(n),pageIndex:this.pageIndex,rect:n,rotation:this.#getRotation(),structTreeParentId:this._structTreeParentId};return this.annotationElementId&&!this.#hasElementChanged(t)?null:(t.id=this.annotationElementId,t)}#hasElementChanged(e){const{color:t}=this._initialData;return e.color.some((e,n)=>e!==t[n])}renderAnnotationElement(e){return e.updateEdited({rect:this.getRect(0,0)}),null}static canCreateNewEmptyEditor(){return!1}}class DrawingOptions{#svgProperties=Object.create(null);updateProperty(e,t){this[e]=t,this.updateSVGProperty(e,t)}updateProperties(e){if(!e)return;for(const[t,n]of Object.entries(e))t.startsWith("_")||this.updateProperty(t,n)}updateSVGProperty(e,t){this.#svgProperties[e]=t}toSVGProperties(){const e=this.#svgProperties;return this.#svgProperties=Object.create(null),{root:e}}reset(){this.#svgProperties=Object.create(null)}updateAll(e=this){this.updateProperties(e)}clone(){unreachable("Not implemented")}}class DrawingEditor extends AnnotationEditor{#drawOutlines=null;#mustBeCommitted;_drawId=null;static _currentDrawId=-1;static _currentParent=null;static#currentDraw=null;static#currentDrawingAC=null;static#currentDrawingOptions=null;static#currentPointerId=NaN;static#currentPointerType=null;static#currentPointerIds=null;static#currentMoveTimestamp=NaN;static _INNER_MARGIN=3;constructor(e){super(e),this.#mustBeCommitted=e.mustBeCommitted||!1,this._addOutlines(e)}_addOutlines(e){e.drawOutlines&&(this.#createDrawOutlines(e),this.#addToDrawLayer())}#createDrawOutlines({drawOutlines:e,drawId:t,drawingOptions:n}){this.#drawOutlines=e,this._drawingOptions||=n,t>=0?(this._drawId=t,this.parent.drawLayer.finalizeDraw(t,e.defaultProperties)):this._drawId=this.#createDrawing(e,this.parent),this.#updateBbox(e.box)}#createDrawing(e,t){const{id:n}=t.drawLayer.draw(DrawingEditor._mergeSVGProperties(this._drawingOptions.toSVGProperties(),e.defaultSVGProperties),!1,!1);return n}static _mergeSVGProperties(e,t){const n=new Set(Object.keys(e));for(const[s,o]of Object.entries(t))n.has(s)?Object.assign(e[s],o):e[s]=o;return e}static getDefaultDrawingOptions(){unreachable("Not implemented")}static get typesMap(){unreachable("Not implemented")}static get isDrawer(){return!0}static get supportMultipleDrawings(){return!1}static updateDefaultParams(e,t){const n=this.typesMap.get(e);n&&this._defaultDrawingOptions.updateProperty(n,t),this._currentParent&&(DrawingEditor.#currentDraw.updateProperty(n,t),this._currentParent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}updateParams(e,t){const n=this.constructor.typesMap.get(e);n&&this._updateProperty(e,n,t)}static get defaultPropertiesToUpdate(){const e=[],t=this._defaultDrawingOptions;for(const[n,s]of this.typesMap)e.push([n,t[s]]);return e}get propertiesToUpdate(){const e=[],{_drawingOptions:t}=this;for(const[n,s]of this.constructor.typesMap)e.push([n,t[s]]);return e}_updateProperty(e,t,n){const s=this._drawingOptions,i=s[t],o=e=>{s.updateProperty(t,e);const n=this.#drawOutlines.updateProperty(t,e);n&&this.#updateBbox(n),this.parent?.drawLayer.updateProperties(this._drawId,s.toSVGProperties())};this.addCommands({cmd:o.bind(this,n),undo:o.bind(this,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:e,overwriteIfSameType:!0,keepUndo:!0})}_onResizing(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#drawOutlines.getPathResizingSVGProperties(this.#convertToDrawSpace()),{bbox:this.#rotateBox()}))}_onResized(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#drawOutlines.getPathResizedSVGProperties(this.#convertToDrawSpace()),{bbox:this.#rotateBox()}))}_onTranslating(){this.parent?.drawLayer.updateProperties(this._drawId,{bbox:this.#rotateBox()})}_onTranslated(){this.parent?.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties(this.#drawOutlines.getPathTranslatedSVGProperties(this.#convertToDrawSpace(),this.parentDimensions),{bbox:this.#rotateBox()}))}_onStartDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!0}})}_onStopDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!1}})}commit(){super.commit(),this.disableEditMode(),this.disableEditing()}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}getBaseTranslation(){return[0,0]}get isResizable(){return!0}onceAdded(e){this.annotationElementId||this.parent.addUndoableEditor(this),this._isDraggable=!0,this.#mustBeCommitted&&(this.#mustBeCommitted=!1,this.commit(),this.parent.setSelected(this),e&&this.isOnScreen&&this.div.focus())}remove(){this.#cleanDrawLayer(),super.remove()}rebuild(){if(!this.parent)return;if(super.rebuild(),this.div===null)return;this.#addToDrawLayer(),this.#updateBbox(this.#drawOutlines.box),this.isAttachedToDOM||this.parent.add(this)}setParent(e){let t=!1;this.parent&&!e?(this._uiManager.removeShouldRescale(this),this.#cleanDrawLayer()):e&&(this._uiManager.addShouldRescale(this),this.#addToDrawLayer(e),t=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(e),t&&this.select()}#cleanDrawLayer(){if(this._drawId===null||!this.parent)return;this.parent.drawLayer.remove(this._drawId),this._drawId=null,this._drawingOptions.reset()}#addToDrawLayer(e=this.parent){if(this._drawId!==null&&this.parent===e)return;if(this._drawId!==null){this.parent.drawLayer.updateParent(this._drawId,e.drawLayer);return}this._drawingOptions.updateAll(),this._drawId=this.#createDrawing(this.#drawOutlines,e)}#convertToParentSpace([e,t,n,s]){const{parentDimensions:[o,i],rotation:a}=this;switch(a){case 90:return[t,1-e,n*(i/o),s*(o/i)];case 180:return[1-e,1-t,n,s];case 270:return[1-t,e,n*(i/o),s*(o/i)];default:return[e,t,n,s]}}#convertToDrawSpace(){const{x:e,y:t,width:n,height:s,parentDimensions:[o,i],rotation:a}=this;switch(a){case 90:return[1-t,e,n*(o/i),s*(i/o)];case 180:return[1-e,1-t,n,s];case 270:return[t,1-e,n*(o/i),s*(i/o)];default:return[e,t,n,s]}}#updateBbox(e){if([this.x,this.y,this.width,this.height]=this.#convertToParentSpace(e),this.div){this.fixAndSetPosition();const[e,t]=this.parentDimensions;this.setDims(this.width*e,this.height*t)}this._onResized()}#rotateBox(){const{x:o,y:i,width:e,height:t,rotation:a,parentRotation:r,parentDimensions:[n,s]}=this;switch((a*4+r)/90){case 1:return[1-i-t,o,t,e];case 2:return[1-o-e,1-i-t,e,t];case 3:return[i,1-o-e,t,e];case 4:return[o,i-e*(n/s),t*(s/n),e*(n/s)];case 5:return[1-i,o,e*(n/s),t*(s/n)];case 6:return[1-o-t*(s/n),1-i,t*(s/n),e*(n/s)];case 7:return[i-e*(n/s),1-o-t*(s/n),e*(n/s),t*(s/n)];case 8:return[o-e,i-t,e,t];case 9:return[1-i,o-e,t,e];case 10:return[1-o,1-i,e,t];case 11:return[i-t,1-o,t,e];case 12:return[o-t*(s/n),i,t*(s/n),e*(n/s)];case 13:return[1-i-e*(n/s),o-t*(s/n),e*(n/s),t*(s/n)];case 14:return[1-o,1-i-e*(n/s),t*(s/n),e*(n/s)];case 15:return[i,1-o,e*(n/s),t*(s/n)];default:return[o,i,e,t]}}rotate(){if(!this.parent)return;this.parent.drawLayer.updateProperties(this._drawId,DrawingEditor._mergeSVGProperties({bbox:this.#rotateBox()},this.#drawOutlines.updateRotation((this.parentRotation-this.rotation+360)%360)))}onScaleChanging(){if(!this.parent)return;this.#updateBbox(this.#drawOutlines.updateParentDimensions(this.parentDimensions,this.parent.scale))}static onScaleChangingWhenDrawing(){}render(){if(this.div)return this.div;let n,s;this._isCopy&&(n=this.x,s=this.y);const e=super.render();e.classList.add("draw");const t=document.createElement("div");e.append(t),t.setAttribute("aria-hidden","true"),t.className="internal";const[o,i]=this.parentDimensions;return this.setDims(this.width*o,this.height*i),this._uiManager.addShouldRescale(this),this.disableEditing(),this._isCopy&&this._moveAfterPaste(n,s),e}static createDrawerInstance(){unreachable("Not implemented")}static startDrawing(e,t,n,s){const{target:i,offsetX:a,offsetY:r,pointerId:h,pointerType:c}=s;if(DrawingEditor.#currentPointerType&&DrawingEditor.#currentPointerType!==c)return;const{viewport:{rotation:l}}=e,{width:d,height:u}=i.getBoundingClientRect(),m=DrawingEditor.#currentDrawingAC=new AbortController,o=e.combinedSignal(m);if(DrawingEditor.#currentPointerId||=h,DrawingEditor.#currentPointerType??=c,window.addEventListener("pointerup",e=>{DrawingEditor.#currentPointerId===e.pointerId?this._endDraw(e):DrawingEditor.#currentPointerIds?.delete(e.pointerId)},{signal:o}),window.addEventListener("pointercancel",e=>{DrawingEditor.#currentPointerId===e.pointerId?this._currentParent.endDrawingSession():DrawingEditor.#currentPointerIds?.delete(e.pointerId)},{signal:o}),window.addEventListener("pointerdown",e=>{if(DrawingEditor.#currentPointerType!==e.pointerType)return;(DrawingEditor.#currentPointerIds||=new Set).add(e.pointerId),DrawingEditor.#currentDraw.isCancellable()&&(DrawingEditor.#currentDraw.removeLastElement(),DrawingEditor.#currentDraw.isEmpty()?this._currentParent.endDrawingSession(!0):this._endDraw(null))},{capture:!0,passive:!1,signal:o}),window.addEventListener("contextmenu",noContextMenu,{signal:o}),i.addEventListener("pointermove",this._drawMove.bind(this),{signal:o}),i.addEventListener("touchmove",e=>{e.timeStamp===DrawingEditor.#currentMoveTimestamp&&stopEvent(e)},{signal:o}),e.toggleDrawing(),t._editorUndoBar?.hide(),DrawingEditor.#currentDraw){e.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#currentDraw.startNew(a,r,d,u,l));return}t.updateUIForDefaultProperties(this),DrawingEditor.#currentDraw=this.createDrawerInstance(a,r,d,u,l),DrawingEditor.#currentDrawingOptions=this.getDefaultDrawingOptions(),this._currentParent=e,{id:this._currentDrawId}=e.drawLayer.draw(this._mergeSVGProperties(DrawingEditor.#currentDrawingOptions.toSVGProperties(),DrawingEditor.#currentDraw.defaultSVGProperties),!0,!1)}static _drawMove(e){if(DrawingEditor.#currentMoveTimestamp=-1,!DrawingEditor.#currentDraw)return;const{offsetX:t,offsetY:n,pointerId:s}=e;if(DrawingEditor.#currentPointerId!==s)return;if(DrawingEditor.#currentPointerIds?.size>=1){this._endDraw(e);return}this._currentParent.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#currentDraw.add(t,n)),DrawingEditor.#currentMoveTimestamp=e.timeStamp,stopEvent(e)}static _cleanup(e){e&&(this._currentDrawId=-1,this._currentParent=null,DrawingEditor.#currentDraw=null,DrawingEditor.#currentDrawingOptions=null,DrawingEditor.#currentPointerType=null,DrawingEditor.#currentMoveTimestamp=NaN),DrawingEditor.#currentDrawingAC&&(DrawingEditor.#currentDrawingAC.abort(),DrawingEditor.#currentDrawingAC=null,DrawingEditor.#currentPointerId=NaN,DrawingEditor.#currentPointerIds=null)}static _endDraw(e){const t=this._currentParent;if(!t)return;if(t.toggleDrawing(!0),this._cleanup(!1),e?.target===t.div&&t.drawLayer.updateProperties(this._currentDrawId,DrawingEditor.#currentDraw.end(e.offsetX,e.offsetY)),this.supportMultipleDrawings){const e=DrawingEditor.#currentDraw,n=this._currentDrawId,s=e.getLastElement();t.addCommands({cmd:()=>{t.drawLayer.updateProperties(n,e.setLastElement(s))},undo:()=>{t.drawLayer.updateProperties(n,e.removeLastElement())},mustExec:!1,type:AnnotationEditorParamsType.DRAW_STEP});return}this.endDrawing(!1)}static endDrawing(e){const t=this._currentParent;if(!t)return null;if(t.toggleDrawing(!0),t.cleanUndoStack(AnnotationEditorParamsType.DRAW_STEP),!DrawingEditor.#currentDraw.isEmpty()){const{pageDimensions:[s,o],scale:n}=t,i=t.createAndAddNewEditor({offsetX:0,offsetY:0},!1,{drawId:this._currentDrawId,drawOutlines:DrawingEditor.#currentDraw.getOutlines(s*n,o*n,n,this._INNER_MARGIN),drawingOptions:DrawingEditor.#currentDrawingOptions,mustBeCommitted:!e});return this._cleanup(!0),i}return t.drawLayer.remove(this._currentDrawId),this._cleanup(!0),null}createDrawingOptions(){}static deserializeDraw(){unreachable("Not implemented")}static async deserialize(e,t,n){const{rawDims:{pageWidth:o,pageHeight:i,pageX:a,pageY:r}}=t.viewport,c=this.deserializeDraw(a,r,o,i,this._INNER_MARGIN,e),s=await super.deserialize(e,t,n);return s.createDrawingOptions(e),s.#createDrawOutlines({drawOutlines:c}),s.#addToDrawLayer(),s.onScaleChanging(),s.rotate(),s}serializeDraw(e){const[t,n]=this.pageTranslation,[s,o]=this.pageDimensions;return this.#drawOutlines.serialize([t,n,s,o],e)}renderAnnotationElement(e){return e.updateEdited({rect:this.getRect(0,0)}),null}static canCreateNewEmptyEditor(){return!1}}class InkDrawOutliner{#last=new Float64Array(6);#line;#lines;#rotation;#thickness;#points;#lastSVGPath="";#lastIndex=0;#outlines=new InkDrawOutline;#parentWidth;#parentHeight;constructor(e,t,n,s,o,i){this.#parentWidth=n,this.#parentHeight=s,this.#rotation=o,this.#thickness=i,[e,t]=this.#normalizePoint(e,t);const a=this.#line=[NaN,NaN,NaN,NaN,e,t];this.#points=[e,t],this.#lines=[{line:a,points:this.#points}],this.#last.set(a,0)}updateProperty(e,t){e==="stroke-width"&&(this.#thickness=t)}#normalizePoint(e,t){return Outline._normalizePoint(e,t,this.#parentWidth,this.#parentHeight,this.#rotation)}isEmpty(){return!this.#lines||this.#lines.length===0}isCancellable(){return this.#points.length<=10}add(e,t){[e,t]=this.#normalizePoint(e,t);const[o,i,n,s]=this.#last.subarray(2,6),a=e-n,r=t-s,c=Math.hypot(this.#parentWidth*a,this.#parentHeight*r);return c<=2?null:(this.#points.push(e,t),isNaN(o)?(this.#last.set([n,s,e,t],2),this.#line.push(NaN,NaN,NaN,NaN,e,t),{path:{d:this.toSVGPath()}}):(isNaN(this.#last[0])&&this.#line.splice(6,6),this.#last.set([o,i,n,s,e,t],0),this.#line.push(...Outline.createBezierPoints(o,i,n,s,e,t)),{path:{d:this.toSVGPath()}}))}end(e,t){const n=this.add(e,t);return n?n:this.#points.length===2?{path:{d:this.toSVGPath()}}:null}startNew(e,t,n,s,o){this.#parentWidth=n,this.#parentHeight=s,this.#rotation=o,[e,t]=this.#normalizePoint(e,t);const a=this.#line=[NaN,NaN,NaN,NaN,e,t];this.#points=[e,t];const i=this.#lines.at(-1);return i&&(i.line=new Float32Array(i.line),i.points=new Float32Array(i.points)),this.#lines.push({line:a,points:this.#points}),this.#last.set(a,0),this.#lastIndex=0,this.toSVGPath(),null}getLastElement(){return this.#lines.at(-1)}setLastElement(e){return this.#lines?(this.#lines.push(e),this.#line=e.line,this.#points=e.points,this.#lastIndex=0,{path:{d:this.toSVGPath()}}):this.#outlines.setLastElement(e)}removeLastElement(){if(!this.#lines)return this.#outlines.removeLastElement();this.#lines.pop(),this.#lastSVGPath="";for(let e=0,t=this.#lines.length;e<t;e++){const{line:n,points:s}=this.#lines[e];this.#line=n,this.#points=s,this.#lastIndex=0,this.toSVGPath()}return{path:{d:this.#lastSVGPath}}}toSVGPath(){const e=Outline.svgRound(this.#line[4]),t=Outline.svgRound(this.#line[5]);if(this.#points.length===2)return this.#lastSVGPath=`${this.#lastSVGPath} M ${e} ${t} Z`,this.#lastSVGPath;if(this.#points.length<=6){const n=this.#lastSVGPath.lastIndexOf("M");this.#lastSVGPath=`${this.#lastSVGPath.slice(0,n)} M ${e} ${t}`,this.#lastIndex=6}if(this.#points.length===4){const e=Outline.svgRound(this.#line[10]),t=Outline.svgRound(this.#line[11]);return this.#lastSVGPath=`${this.#lastSVGPath} L ${e} ${t}`,this.#lastIndex=12,this.#lastSVGPath}const n=[];this.#lastIndex===0&&(n.push(`M ${e} ${t}`),this.#lastIndex=6);for(let e=this.#lastIndex,t=this.#line.length;e<t;e+=6){const[s,o,i,a,r,c]=this.#line.slice(e,e+6).map(Outline.svgRound);n.push(`C${s} ${o} ${i} ${a} ${r} ${c}`)}return this.#lastSVGPath+=n.join(" "),this.#lastIndex=this.#line.length,this.#lastSVGPath}getOutlines(e,t,n,s){const o=this.#lines.at(-1);return o.line=new Float32Array(o.line),o.points=new Float32Array(o.points),this.#outlines.build(this.#lines,e,t,n,this.#rotation,this.#thickness,s),this.#last=null,this.#line=null,this.#lines=null,this.#lastSVGPath=null,this.#outlines}get defaultSVGProperties(){return{root:{viewBox:"0 0 10000 10000"},rootClass:{draw:!0},bbox:[0,0,1,1]}}}class InkDrawOutline extends Outline{#bbox;#currentRotation=0;#innerMargin;#lines;#parentWidth;#parentHeight;#parentScale;#rotation;#thickness;build(e,t,n,s,o,i,a){this.#parentWidth=t,this.#parentHeight=n,this.#parentScale=s,this.#rotation=o,this.#thickness=i,this.#innerMargin=a??0,this.#lines=e,this.#computeBbox()}get thickness(){return this.#thickness}setLastElement(e){return this.#lines.push(e),{path:{d:this.toSVGPath()}}}removeLastElement(){return this.#lines.pop(),{path:{d:this.toSVGPath()}}}toSVGPath(){const e=[];for(const{line:t}of this.#lines){if(e.push(`M${Outline.svgRound(t[4])} ${Outline.svgRound(t[5])}`),t.length===6){e.push("Z");continue}if(t.length===12&&isNaN(t[6])){e.push(`L${Outline.svgRound(t[10])} ${Outline.svgRound(t[11])}`);continue}for(let n=6,s=t.length;n<s;n+=6){const[o,i,a,r,c,l]=t.subarray(n,n+6).map(Outline.svgRound);e.push(`C${o} ${i} ${a} ${r} ${c} ${l}`)}}return e.join("")}serialize([e,t,n,s],o){const j=[],b=[],[i,a,g,v]=this.#getBBoxWithNoMargin();let r,c,l,d,h,m,f,p,u;switch(this.#rotation){case 0:u=Outline._rescale,r=e,c=t+s,l=n,d=-s,h=e+i*n,m=t+(1-a-v)*s,f=e+(i+g)*n,p=t+(1-a)*s;break;case 90:u=Outline._rescaleAndSwap,r=e,c=t,l=n,d=s,h=e+a*n,m=t+i*s,f=e+(a+v)*n,p=t+(i+g)*s;break;case 180:u=Outline._rescale,r=e+n,c=t,l=-n,d=s,h=e+(1-i-g)*n,m=t+a*s,f=e+(1-i)*n,p=t+(a+v)*s;break;case 270:u=Outline._rescaleAndSwap,r=e+n,c=t+s,l=-n,d=-s,h=e+(1-a-v)*n,m=t+(1-i-g)*s,f=e+(1-a)*n,p=t+(1-i)*s;break}for(const{line:e,points:t}of this.#lines)j.push(u(e,r,c,l,d,o?new Array(e.length):null)),b.push(u(t,r,c,l,d,o?new Array(t.length):null));return{lines:j,points:b,rect:[h,m,f,p]}}static deserialize(e,t,n,s,o,{paths:{lines:i,points:a},rotation:r,thickness:c}){const f=[];let l,d,u,h,m;switch(r){case 0:m=Outline._rescale,l=-e/n,d=t/s+1,u=1/n,h=-1/s;break;case 90:m=Outline._rescaleAndSwap,l=-t/s,d=-e/n,u=1/s,h=1/n;break;case 180:m=Outline._rescale,l=e/n+1,d=-t/s,u=-1/n,h=1/s;break;case 270:m=Outline._rescaleAndSwap,l=t/s+1,d=e/n+1,u=-1/s,h=-1/n;break}if(!i){i=[];for(const e of a){const t=e.length;if(t===2){i.push(new Float32Array([NaN,NaN,NaN,NaN,e[0],e[1]]));continue}if(t===4){i.push(new Float32Array([NaN,NaN,NaN,NaN,e[0],e[1],NaN,NaN,NaN,NaN,e[2],e[3]]));continue}const n=new Float32Array(3*(t-2));i.push(n);let[s,o,r,c]=e.subarray(0,4);n.set([NaN,NaN,NaN,NaN,s,o],0);for(let i=4;i<t;i+=2){const a=e[i],l=e[i+1];n.set(Outline.createBezierPoints(s,o,r,c,a,l),(i-2)*3),[s,o,r,c]=[r,c,a,l]}}}for(let e=0,t=i.length;e<t;e++)f.push({line:m(i[e].map(e=>e??NaN),l,d,u,h),points:m(a[e].map(e=>e??NaN),l,d,u,h)});const p=new this.prototype.constructor;return p.build(f,n,s,1,r,c,o),p}#getMarginComponents(e=this.#thickness){const t=this.#innerMargin+e/2*this.#parentScale;return this.#rotation%180===0?[t/this.#parentWidth,t/this.#parentHeight]:[t/this.#parentHeight,t/this.#parentWidth]}#getBBoxWithNoMargin(){const[n,s,o,i]=this.#bbox,[e,t]=this.#getMarginComponents(0);return[n+e,s+t,o-2*e,i-2*t]}#computeBbox(){const e=this.#bbox=new Float32Array([1/0,1/0,-(1/0),-(1/0)]);for(const{line:t}of this.#lines){if(t.length<=12){for(let n=4,s=t.length;n<s;n+=6)Util.pointBoundingBox(t[n],t[n+1],e);continue}let n=t[4],s=t[5];for(let o=6,r=t.length;o<r;o+=6){const[c,l,d,u,i,a]=t.subarray(o,o+6);Util.bezierBoundingBox(n,s,c,l,d,u,i,a,e),n=i,s=a}}const[t,n]=this.#getMarginComponents();e[0]=MathClamp(e[0]-t,0,1),e[1]=MathClamp(e[1]-n,0,1),e[2]=MathClamp(e[2]+t,0,1),e[3]=MathClamp(e[3]+n,0,1),e[2]-=e[0],e[3]-=e[1]}get box(){return this.#bbox}updateProperty(e,t){return e==="stroke-width"?this.#updateThickness(t):null}#updateThickness(e){const[o,i]=this.#getMarginComponents();this.#thickness=e;const[a,r]=this.#getMarginComponents(),[n,s]=[a-o,r-i],t=this.#bbox;return t[0]-=n,t[1]-=s,t[2]+=2*n,t[3]+=2*s,t}updateParentDimensions([e,t],n){const[a,r]=this.#getMarginComponents();this.#parentWidth=e,this.#parentHeight=t,this.#parentScale=n;const[c,l]=this.#getMarginComponents(),o=c-a,i=l-r,s=this.#bbox;return s[0]-=o,s[1]-=i,s[2]+=2*o,s[3]+=2*i,s}updateRotation(e){return this.#currentRotation=e,{path:{transform:this.rotationTransform}}}get viewBox(){return this.#bbox.map(Outline.svgRound).join(" ")}get defaultProperties(){const[e,t]=this.#bbox;return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(e)} ${Outline.svgRound(t)}`}}}get rotationTransform(){const[,,e,t]=this.#bbox;let a=0,n=0,s=0,r=0,o=0,i=0;switch(this.#currentRotation){case 90:n=t/e,s=-e/t,o=e;break;case 180:a=-1,r=-1,o=e,i=t;break;case 270:n=-t/e,s=e/t,i=t;break;default:return""}return`matrix(${a} ${n} ${s} ${r} ${Outline.svgRound(o)} ${Outline.svgRound(i)})`}getPathResizingSVGProperties([e,t,n,s]){const[o,i]=this.#getMarginComponents(),[c,l,a,r]=this.#bbox;if(Math.abs(a-o)<=Outline.PRECISION||Math.abs(r-i)<=Outline.PRECISION){const o=e+n/2-(c+a/2),i=t+s/2-(l+r/2);return{path:{"transform-origin":`${Outline.svgRound(e)} ${Outline.svgRound(t)}`,transform:`${this.rotationTransform} translate(${o} ${i})`}}}const d=(n-2*o)/(a-2*o),u=(s-2*i)/(r-2*i),h=a/n,m=r/s;return{path:{"transform-origin":`${Outline.svgRound(c)} ${Outline.svgRound(l)}`,transform:`${this.rotationTransform} scale(${h} ${m}) `+`translate(${Outline.svgRound(o)} ${Outline.svgRound(i)}) scale(${d} ${u}) `+`translate(${Outline.svgRound(-o)} ${Outline.svgRound(-i)})`}}}getPathResizedSVGProperties([e,t,n,s]){const[o,i]=this.#getMarginComponents(),a=this.#bbox,[m,f,l,d]=a;if(a[0]=e,a[1]=t,a[2]=n,a[3]=s,Math.abs(l-o)<=Outline.PRECISION||Math.abs(d-i)<=Outline.PRECISION){const o=e+n/2-(m+l/2),i=t+s/2-(f+d/2);for(const{line:e,points:t}of this.#lines)Outline._translate(e,o,i,e),Outline._translate(t,o,i,t);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(e)} ${Outline.svgRound(t)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}const r=(n-2*o)/(l-2*o),c=(s-2*i)/(d-2*i),u=-r*(m+o)+e+o,h=-c*(f+i)+t+i;if(r!==1||c!==1||u!==0||h!==0)for(const{line:e,points:t}of this.#lines)Outline._rescale(e,u,h,r,c,e),Outline._rescale(t,u,h,r,c,t);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Outline.svgRound(e)} ${Outline.svgRound(t)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}getPathTranslatedSVGProperties([e,t],n){const[a,r]=n,s=this.#bbox,o=e-s[0],i=t-s[1];if(this.#parentWidth===a&&this.#parentHeight===r)for(const{line:e,points:t}of this.#lines)Outline._translate(e,o,i,e),Outline._translate(t,o,i,t);else{const e=this.#parentWidth/a,t=this.#parentHeight/r;this.#parentWidth=a,this.#parentHeight=r;for(const{line:n,points:s}of this.#lines)Outline._rescale(n,o,i,e,t,n),Outline._rescale(s,o,i,e,t,s);s[2]*=e,s[3]*=t}return s[0]=e,s[1]=t,{root:{viewBox:this.viewBox},path:{d:this.toSVGPath(),"transform-origin":`${Outline.svgRound(e)} ${Outline.svgRound(t)}`}}}get defaultSVGProperties(){const e=this.#bbox;return{root:{viewBox:this.viewBox},rootClass:{draw:!0},path:{d:this.toSVGPath(),"transform-origin":`${Outline.svgRound(e[0])} ${Outline.svgRound(e[1])}`,transform:this.rotationTransform||null},bbox:e}}}class InkDrawingOptions extends DrawingOptions{constructor(e){super(),this._viewParameters=e,super.updateProperties({fill:"none",stroke:AnnotationEditor._defaultLineColor,"stroke-opacity":1,"stroke-width":1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-miterlimit":10})}updateSVGProperty(e,t){e==="stroke-width"&&(t??=this["stroke-width"],t*=this._viewParameters.realScale),super.updateSVGProperty(e,t)}clone(){const e=new InkDrawingOptions(this._viewParameters);return e.updateAll(this),e}}class InkEditor extends DrawingEditor{static _type="ink";static _editorType=AnnotationEditorType.INK;static _defaultDrawingOptions=null;constructor(e){super({...e,name:"inkEditor"}),this._willKeepAspectRatio=!0,this.defaultL10nId="pdfjs-editor-ink-editor"}static initialize(e,t){AnnotationEditor.initialize(e,t),this._defaultDrawingOptions=new InkDrawingOptions(t.viewParameters)}static getDefaultDrawingOptions(e){const t=this._defaultDrawingOptions.clone();return t.updateProperties(e),t}static get supportMultipleDrawings(){return!0}static get typesMap(){return shadow(this,"typesMap",new Map([[AnnotationEditorParamsType.INK_THICKNESS,"stroke-width"],[AnnotationEditorParamsType.INK_COLOR,"stroke"],[AnnotationEditorParamsType.INK_OPACITY,"stroke-opacity"]]))}static createDrawerInstance(e,t,n,s,o){return new InkDrawOutliner(e,t,n,s,o,this._defaultDrawingOptions["stroke-width"])}static deserializeDraw(e,t,n,s,o,i){return InkDrawOutline.deserialize(e,t,n,s,o,i)}static async deserialize(e,t,n){let o=null;if(e instanceof InkAnnotationElement){const{data:{inkLists:t,rect:n,rotation:s,id:i,color:a,opacity:r,borderStyle:{rawWidth:c},popupRef:l},parent:{page:{pageNumber:d}}}=e;o=e={annotationType:AnnotationEditorType.INK,color:Array.from(a),thickness:c,opacity:r,paths:{points:t},boxes:null,pageIndex:d-1,rect:n.slice(0),rotation:s,id:i,deleted:!1,popupRef:l}}const s=await super.deserialize(e,t,n);return s.annotationElementId=e.id||null,s._initialData=o,s}onScaleChanging(){if(!this.parent)return;super.onScaleChanging();const{_drawId:t,_drawingOptions:e,parent:n}=this;e.updateSVGProperty("stroke-width"),n.drawLayer.updateProperties(t,e.toSVGProperties())}static onScaleChangingWhenDrawing(){const e=this._currentParent;if(!e)return;super.onScaleChangingWhenDrawing(),this._defaultDrawingOptions.updateSVGProperty("stroke-width"),e.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties())}createDrawingOptions({color:e,thickness:t,opacity:n}){this._drawingOptions=InkEditor.getDefaultDrawingOptions({stroke:Util.makeHexColor(...e),"stroke-width":t,"stroke-opacity":n})}serialize(e=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const{lines:n,points:s,rect:o}=this.serializeDraw(e),{_drawingOptions:{stroke:i,"stroke-opacity":a,"stroke-width":r}}=this,t={annotationType:AnnotationEditorType.INK,color:AnnotationEditor._colorManager.convert(i),opacity:a,thickness:r,paths:{lines:n,points:s},pageIndex:this.pageIndex,rect:o,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return e?(t.isCopy=!0,t):this.annotationElementId&&!this.#hasElementChanged(t)?null:(t.id=this.annotationElementId,t)}#hasElementChanged(e){const{color:t,thickness:n,opacity:s,pageIndex:o}=this._initialData;return this._hasBeenMoved||this._hasBeenResized||e.color.some((e,n)=>e!==t[n])||e.thickness!==n||e.opacity!==s||e.pageIndex!==o}renderAnnotationElement(e){const{points:t,rect:n}=this.serializeDraw(!1);return e.updateEdited({rect:n,thickness:this._drawingOptions["stroke-width"],points:t}),null}}class ContourDrawOutline extends InkDrawOutline{toSVGPath(){let e=super.toSVGPath();return e.endsWith("Z")||(e+="Z"),e}}const BASE_HEADER_LENGTH=8,POINTS_PROPERTIES_NUMBER=3;class SignatureExtractor{static#PARAMETERS={maxDim:512,sigmaSFactor:.02,sigmaR:25,kernelSize:16};static#neighborIndexToId(e,t,n,s){return n-=e,s-=t,n===0?s>0?0:4:n===1?s+6:2-s}static#neighborIdToIndex=new Int32Array([0,1,-1,1,-1,0,-1,-1,0,-1,1,-1,1,0,1,1]);static#clockwiseNonZero(e,t,n,s,o,i,a){const r=this.#neighborIndexToId(n,s,o,i);for(let o=0;o<8;o++){const i=(-o+r-a+16)%8,c=this.#neighborIdToIndex[2*i],l=this.#neighborIdToIndex[2*i+1];if(e[(n+c)*t+(s+l)]!==0)return i}return-1}static#counterClockwiseNonZero(e,t,n,s,o,i,a){const r=this.#neighborIndexToId(n,s,o,i);for(let o=0;o<8;o++){const i=(o+r+a+16)%8,c=this.#neighborIdToIndex[2*i],l=this.#neighborIdToIndex[2*i+1];if(e[(n+c)*t+(s+l)]!==0)return i}return-1}static#findContours(e,t,n,s){const c=e.length,o=new Int32Array(c);for(let t=0;t<c;t++)o[t]=e[t]<=s?1:0;for(let e=1;e<n-1;e++)o[e*t]=o[e*t+t-1]=0;for(let e=0;e<t;e++)o[e]=o[t*n-1-e]=0;let a=1,i;const r=[];for(let e=1;e<n-1;e++){i=1;for(let n=1;n<t-1;n++){const s=e*t+n,c=o[s];if(c===0)continue;let p=e,l=n;if(c===1&&o[s-1]===0)a+=1,l-=1;else if(c>=1&&o[s+1]===0)a+=1,l+=1,c>1&&(i=c);else{c!==1&&(i=Math.abs(c));continue}const _=[n,e],f=l===n+1,m={isHole:f,points:_,id:a,parent:0};r.push(m);let h;for(const e of r)if(e.id===i){h=e;break}h?h.isHole?m.parent=f?h.parent:i:m.parent=f?i:h.parent:m.parent=f?i:0;const g=this.#clockwiseNonZero(o,t,e,n,p,l,0);if(g===-1){o[s]=-a,o[s]!==1&&(i=Math.abs(o[s]));continue}let v=this.#neighborIdToIndex[2*g],b=this.#neighborIdToIndex[2*g+1];const j=e+v,y=n+b;p=j,l=y;let u=e,d=n;for(;!0;){const m=this.#counterClockwiseNonZero(o,t,u,d,p,l,1);v=this.#neighborIdToIndex[2*m],b=this.#neighborIdToIndex[2*m+1];const c=u+v,h=d+b;_.push(h,c);const r=u*t+d;if(o[r+1]===0?o[r]=-a:o[r]===1&&(o[r]=a),c===e&&h===n&&u===j&&d===y){o[s]!==1&&(i=Math.abs(o[s]));break}p=u,l=d,u=c,d=h}}}return r}static#douglasPeuckerHelper(e,t,n,s){if(n-t<=4){for(let o=t;o<n-2;o+=2)s.push(e[o],e[o+1]);return}const d=e[t],c=e[t+1],u=e[n-4]-d,a=e[n-3]-c,o=Math.hypot(u,a),m=u/o,f=a/o,j=m*c-f*d,y=a/u,b=1/o,v=Math.atan(y),h=Math.cos(v),i=Math.sin(v),p=b*(Math.abs(h)+Math.abs(i)),g=b*(1-p+p**2),_=Math.max(Math.atan(Math.abs(i+h)*g),Math.atan(Math.abs(i-h)*g));let l=0,r=t;for(let s=t+2;s<n-2;s+=2){const o=Math.abs(j-m*e[s+1]+f*e[s]);o>l&&(r=s,l=o)}l>(o*_)**2?(this.#douglasPeuckerHelper(e,t,r+2,s),this.#douglasPeuckerHelper(e,r,n,s)):s.push(d,c)}static#douglasPeucker(e){const t=[],n=e.length;return this.#douglasPeuckerHelper(e,0,n,t),t.push(e[n-2],e[n-1]),t.length<=4?null:t}static#bilateralFilter(e,t,n,s,o,i){const r=new Float32Array(i**2),u=-2*s**2,a=i>>1;for(let e=0;e<i;e++){const t=(e-a)**2;for(let n=0;n<i;n++)r[e*i+n]=Math.exp((t+(n-a)**2)/u)}const c=new Float32Array(256),h=-2*o**2;for(let e=0;e<256;e++)c[e]=Math.exp(e**2/h);const m=e.length,l=new Uint8Array(m),d=new Uint32Array(256);for(let s=0;s<n;s++)for(let o=0;o<t;o++){const u=s*t+o,f=e[u];let h=0,m=0;for(let l=0;l<i;l++){const d=s+l-a;if(d<0||d>=n)continue;for(let n=0;n<i;n++){const s=o+n-a;if(s<0||s>=t)continue;const u=e[d*t+s],p=r[l*i+n]*c[Math.abs(u-f)];h+=u*p,m+=p}}const p=l[u]=Math.round(h/m);d[p]++}return[l,d]}static#getHistogram(e){const t=new Uint32Array(256);for(const n of e)t[n]++;return t}static#toUint8(e){const o=e.length,t=new Uint8ClampedArray(o>>2);let n=-(1/0),s=1/0;for(let o=0,a=t.length;o<a;o++){const r=e[(o<<2)+3];if(r===0){n=t[o]=255;continue}const i=t[o]=e[o<<2];i>n&&(n=i),i<s&&(s=i)}const i=255/(n-s);for(let e=0;e<o;e++)t[e]=(t[e]-s)*i;return t}static#guessThreshold(e){let t,o=-(1/0),i=-(1/0);const n=e.findIndex(e=>e!==0);let s=n,a=n;for(t=n;t<256;t++){const r=e[t];r>o&&(t-s>i&&(i=t-s,a=t-1),o=r,s=t)}for(t=a-1;t>=0;t--)if(e[t]>e[t+1])break;return t}static#getGrayPixels(e){const r=e,{width:o,height:i}=e,{maxDim:s}=this.#PARAMETERS;let t=o,n=i;if(o>s||i>s){let c=o,l=i,a=Math.log2(Math.max(o,i)/s);const d=Math.floor(a);a=a===d?d-1:d;for(let s=0;s<a;s++){t=Math.ceil(c/2),n=Math.ceil(l/2);const o=new OffscreenCanvas(t,n),i=o.getContext("2d");i.drawImage(e,0,0,c,l,0,0,t,n),c=t,l=n,e!==r&&e.close(),e=o.transferToImageBitmap()}const u=Math.min(s/t,s/n);t=Math.round(t*u),n=Math.round(n*u)}const c=new OffscreenCanvas(t,n),a=c.getContext("2d",{willReadFrequently:!0});a.filter="grayscale(1)",a.drawImage(e,0,0,e.width,e.height,0,0,t,n);const l=a.getImageData(0,0,t,n).data,d=this.#toUint8(l);return[d,t,n]}static extractContoursFromText(e,{fontFamily:t,fontStyle:n,fontWeight:s},o,i,a,r){let m=new OffscreenCanvas(1,1),c=m.getContext("2d",{alpha:!1});const h=200,w=c.font=`${n} ${s} ${h}px ${t}`,{actualBoundingBoxLeft:p,actualBoundingBoxRight:_,actualBoundingBoxAscent:y,actualBoundingBoxDescent:j,fontBoundingBoxAscent:g,fontBoundingBoxDescent:v,width:b}=c.measureText(e),u=1.5,d=Math.ceil(Math.max(Math.abs(p)+Math.abs(_)||0,b)*u),l=Math.ceil(Math.max(Math.abs(y)+Math.abs(j)||h,Math.abs(g)+Math.abs(v)||h)*u);m=new OffscreenCanvas(d,l),c=m.getContext("2d",{alpha:!0,willReadFrequently:!0}),c.font=w,c.filter="grayscale(1)",c.fillStyle="white",c.fillRect(0,0,d,l),c.fillStyle="black",c.fillText(e,d*(u-1)/2,l*(3-u)/2);const f=this.#toUint8(c.getImageData(0,0,d,l).data),O=this.#getHistogram(f),x=this.#guessThreshold(O),C=this.#findContours(f,d,l,x);return this.processDrawnLines({lines:{curves:C,width:d,height:l},pageWidth:o,pageHeight:i,rotation:a,innerMargin:r,mustSmooth:!0,areContours:!0})}static process(e,t,n,s,o){const[r,i,a]=this.#getGrayPixels(e),[c,l]=this.#bilateralFilter(r,i,a,Math.hypot(i,a)*this.#PARAMETERS.sigmaSFactor,this.#PARAMETERS.sigmaR,this.#PARAMETERS.kernelSize),d=this.#guessThreshold(l),u=this.#findContours(c,i,a,d);return this.processDrawnLines({lines:{curves:u,width:i,height:a},pageWidth:t,pageHeight:n,rotation:s,innerMargin:o,mustSmooth:!0,areContours:!0})}static processDrawnLines({lines:e,pageWidth:t,pageHeight:n,rotation:s,innerMargin:o,mustSmooth:i,areContours:a}){s%180!==0&&([t,n]=[n,t]);const{curves:g,width:d,height:u}=e,h=e.thickness??0,l=[],m=Math.min(t/d,n/u),r=m/t,c=m/n,f=[];for(const{points:h}of g){const e=i?this.#douglasPeucker(h):h;if(!e)continue;f.push(e);const n=e.length,t=new Float32Array(n),u=new Float32Array(3*(n===2?2:n-2));if(l.push({line:u,points:t}),n===2){t[0]=e[0]*r,t[1]=e[1]*c,u.set([NaN,NaN,NaN,NaN,t[0],t[1]],0);continue}let[s,o,a,d]=e;s*=r,o*=c,a*=r,d*=c,t.set([s,o,a,d],0),u.set([NaN,NaN,NaN,NaN,s,o],0);for(let i=4;i<n;i+=2){const l=t[i]=e[i]*r,h=t[i+1]=e[i+1]*c;u.set(Outline.createBezierPoints(s,o,a,d,l,h),(i-2)*3),[s,o,a,d]=[a,d,l,h]}}if(l.length===0)return null;const p=a?new ContourDrawOutline:new InkDrawOutline;return p.build(l,t,n,1,s,a?0:h,o),{outline:p,newCurves:f,areContours:a,thickness:h,width:d,height:u}}static async compressSignature({outlines:e,areContours:t,thickness:n,width:s,height:o}){let c=1/0,l=-(1/0),m=0;for(const t of e){m+=t.length;for(let e=2,s=t.length;e<s;e++){const n=t[e]-t[e-2];c=Math.min(c,n),l=Math.max(l,n)}}let r;c>=-128&&l<=127?r=Int8Array:c>=-32768&&l<=32767?r=Int16Array:r=Int32Array;const u=e.length,h=BASE_HEADER_LENGTH+POINTS_PROPERTIES_NUMBER*u,i=new Uint32Array(h);let a=0;i[a++]=h*Uint32Array.BYTES_PER_ELEMENT+(m-2*u)*r.BYTES_PER_ELEMENT,i[a++]=0,i[a++]=s,i[a++]=o,i[a++]=t?0:1,i[a++]=Math.max(0,Math.floor(n??0)),i[a++]=u,i[a++]=r.BYTES_PER_ELEMENT;for(const t of e)i[a++]=t.length-2,i[a++]=t[0],i[a++]=t[1];const f=new CompressionStream("deflate-raw"),d=f.writable.getWriter();await d.ready,d.write(i);const p=r.prototype.constructor;for(const t of e){const n=new p(t.length-2);for(let e=2,s=t.length;e<s;e++)n[e-2]=t[e]-t[e-2];d.write(n)}d.close();const g=await new Response(f.readable).arrayBuffer(),v=new Uint8Array(g);return toBase64Util(v)}static async decompressSignature(e){try{const f=fromBase64Util(e),{readable:v,writable:g}=new DecompressionStream("deflate-raw"),o=g.getWriter();await o.ready,o.write(f).then(async()=>{await o.ready,await o.close()}).catch(()=>{});let n=null,i=0;for await(const e of v)n||=new Uint8Array(new Uint32Array(e.buffer,0,4)[0]),n.set(e,i),i+=e.length;const t=new Uint32Array(n.buffer,0,n.length>>2),c=t[1];if(c!==0)throw new Error(`Invalid version: ${c}`);const d=t[2],u=t[3],h=t[4]===0,m=t[5],r=t[6],p=t[7],l=[],a=(BASE_HEADER_LENGTH+POINTS_PROPERTIES_NUMBER*r)*Uint32Array.BYTES_PER_ELEMENT;let s;switch(p){case Int8Array.BYTES_PER_ELEMENT:s=new Int8Array(n.buffer,a);break;case Int16Array.BYTES_PER_ELEMENT:s=new Int16Array(n.buffer,a);break;case Int32Array.BYTES_PER_ELEMENT:s=new Int32Array(n.buffer,a);break}i=0;for(let e=0;e<r;e++){const o=t[POINTS_PROPERTIES_NUMBER*e+BASE_HEADER_LENGTH],n=new Float32Array(o+2);l.push(n);for(let s=0;s<POINTS_PROPERTIES_NUMBER-1;s++)n[s]=t[POINTS_PROPERTIES_NUMBER*e+BASE_HEADER_LENGTH+s+1];for(let e=0;e<o;e++)n[e+2]=n[e]+s[i++]}return{areContours:h,thickness:m,outlines:l,width:d,height:u}}catch(e){return warn(`decompressSignature: ${e}`),null}}}class SignatureOptions extends DrawingOptions{constructor(){super(),super.updateProperties({fill:AnnotationEditor._defaultLineColor,"stroke-width":0})}clone(){const e=new SignatureOptions;return e.updateAll(this),e}}class DrawnSignatureOptions extends InkDrawingOptions{constructor(e){super(e),super.updateProperties({stroke:AnnotationEditor._defaultLineColor,"stroke-width":1})}clone(){const e=new DrawnSignatureOptions(this._viewParameters);return e.updateAll(this),e}}class SignatureEditor extends DrawingEditor{#isExtracted=!1;#description=null;#signatureData=null;#signatureUUID=null;static _type="signature";static _editorType=AnnotationEditorType.SIGNATURE;static _defaultDrawingOptions=null;constructor(e){super({...e,mustBeCommitted:!0,name:"signatureEditor"}),this._willKeepAspectRatio=!0,this.#signatureData=e.signatureData||null,this.#description=null,this.defaultL10nId="pdfjs-editor-signature-editor1"}static initialize(e,t){AnnotationEditor.initialize(e,t),this._defaultDrawingOptions=new SignatureOptions,this._defaultDrawnSignatureOptions=new DrawnSignatureOptions(t.viewParameters)}static getDefaultDrawingOptions(e){const t=this._defaultDrawingOptions.clone();return t.updateProperties(e),t}static get supportMultipleDrawings(){return!1}static get typesMap(){return shadow(this,"typesMap",new Map)}static get isDrawer(){return!1}get telemetryFinalData(){return{type:"signature",hasDescription:!!this.#description}}static computeTelemetryFinalData(e){const t=e.get("hasDescription");return{hasAltText:t.get(!0)??0,hasNoAltText:t.get(!1)??0}}get isResizable(){return!0}onScaleChanging(){if(this._drawId===null)return;super.onScaleChanging()}render(){if(this.div)return this.div;let e,t;const{_isCopy:n}=this;if(n&&(this._isCopy=!1,e=this.x,t=this.y),super.render(),this._drawId===null)if(this.#signatureData){const{lines:e,mustSmooth:t,areContours:n,description:s,uuid:o,heightInPage:i}=this.#signatureData,{rawDims:{pageWidth:a,pageHeight:r},rotation:c}=this.parent.viewport,l=SignatureExtractor.processDrawnLines({lines:e,pageWidth:a,pageHeight:r,rotation:c,innerMargin:SignatureEditor._INNER_MARGIN,mustSmooth:t,areContours:n});this.addSignature(l,i,s,o)}else this.div.setAttribute("data-l10n-args",JSON.stringify({description:""})),this.div.hidden=!0,this._uiManager.getSignature(this);return n&&(this._isCopy=!0,this._moveAfterPaste(e,t)),this.div}setUuid(e){this.#signatureUUID=e,this.addEditToolbar()}getUuid(){return this.#signatureUUID}get description(){return this.#description}set description(e){this.#description=e,super.addEditToolbar().then(t=>{t?.updateEditSignatureButton(e)})}getSignaturePreview(){const{newCurves:o,areContours:e,thickness:i,width:t,height:n}=this.#signatureData,s=Math.max(t,n),a=SignatureExtractor.processDrawnLines({lines:{curves:o.map(e=>({points:e})),thickness:i,width:t,height:n},pageWidth:s,pageHeight:s,rotation:0,innerMargin:0,mustSmooth:!1,areContours:e});return{areContours:e,outline:a.outline}}async addEditToolbar(){const e=await super.addEditToolbar();return e?(this._uiManager.signatureManager&&this.#description!==null&&(await e.addEditSignatureButton(this._uiManager.signatureManager,this.#signatureUUID,this.#description),e.show()),e):null}addSignature(e,t,n,s){const{x:r,y:c}=this,{outline:a}=this.#signatureData=e;this.#isExtracted=a instanceof ContourDrawOutline,this.#description=n,this.div.setAttribute("data-l10n-args",JSON.stringify({description:n}));let i;this.#isExtracted?i=SignatureEditor.getDefaultDrawingOptions():(i=SignatureEditor._defaultDrawnSignatureOptions.clone(),i.updateProperties({"stroke-width":a.thickness})),this._addOutlines({drawOutlines:a,drawingOptions:i});const[l,d]=this.parentDimensions,[,u]=this.pageDimensions;let o=t/u;o=o>=1?.5:o,this.width*=o/this.height,this.width>=1&&(o*=.9/this.width,this.width=.9),this.height=o,this.setDims(l*this.width,d*this.height),this.x=r,this.y=c,this.center(),this._onResized(),this.onScaleChanging(),this.rotate(),this._uiManager.addToAnnotationStorage(this),this.setUuid(s),this._reportTelemetry({action:"pdfjs.signature.inserted",data:{hasBeenSaved:!!s,hasDescription:!!n}}),this.div.hidden=!1}getFromImage(e){const{rawDims:{pageWidth:t,pageHeight:n},rotation:s}=this.parent.viewport;return SignatureExtractor.process(e,t,n,s,SignatureEditor._INNER_MARGIN)}getFromText(e,t){const{rawDims:{pageWidth:n,pageHeight:s},rotation:o}=this.parent.viewport;return SignatureExtractor.extractContoursFromText(e,t,n,s,o,SignatureEditor._INNER_MARGIN)}getDrawnSignature(e){const{rawDims:{pageWidth:t,pageHeight:n},rotation:s}=this.parent.viewport;return SignatureExtractor.processDrawnLines({lines:e,pageWidth:t,pageHeight:n,rotation:s,innerMargin:SignatureEditor._INNER_MARGIN,mustSmooth:!1,areContours:!1})}createDrawingOptions({areContours:e,thickness:t}){e?this._drawingOptions=SignatureEditor.getDefaultDrawingOptions():(this._drawingOptions=SignatureEditor._defaultDrawnSignatureOptions.clone(),this._drawingOptions.updateProperties({"stroke-width":t}))}serialize(e=!1){if(this.isEmpty())return null;const{lines:n,points:s,rect:o}=this.serializeDraw(e),{_drawingOptions:{"stroke-width":i}}=this,t={annotationType:AnnotationEditorType.SIGNATURE,isSignature:!0,areContours:this.#isExtracted,color:[0,0,0],thickness:this.#isExtracted?0:i,pageIndex:this.pageIndex,rect:o,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return e?(t.paths={lines:n,points:s},t.uuid=this.#signatureUUID,t.isCopy=!0):t.lines=n,this.#description&&(t.accessibilityData={type:"Figure",alt:this.#description}),t}static deserializeDraw(e,t,n,s,o,i){return i.areContours?ContourDrawOutline.deserialize(e,t,n,s,o,i):InkDrawOutline.deserialize(e,t,n,s,o,i)}static async deserialize(e,t,n){const s=await super.deserialize(e,t,n);return s.#isExtracted=e.areContours,s.#description=e.accessibilityData?.alt||"",s.#signatureUUID=e.uuid,s}}class StampEditor extends AnnotationEditor{#bitmap=null;#bitmapId=null;#bitmapPromise=null;#bitmapUrl=null;#bitmapFile=null;#bitmapFileName="";#canvas=null;#missingCanvas=!1;#resizeTimeoutId=null;#isSvg=!1;#hasBeenAddedInUndoStack=!1;static _type="stamp";static _editorType=AnnotationEditorType.STAMP;constructor(e){super({...e,name:"stampEditor"}),this.#bitmapUrl=e.bitmapUrl,this.#bitmapFile=e.bitmapFile,this.defaultL10nId="pdfjs-editor-stamp-editor"}static initialize(e,t){AnnotationEditor.initialize(e,t)}static isHandlingMimeForPasting(e){return SupportedImageMimeTypes.includes(e)}static paste(e,t){t.pasteEditor({mode:AnnotationEditorType.STAMP},{bitmapFile:e.getAsFile()})}altTextFinish(){this._uiManager.useNewAltTextFlow&&(this.div.hidden=!1),super.altTextFinish()}get telemetryFinalData(){return{type:"stamp",hasAltText:!!this.altTextData?.altText}}static computeTelemetryFinalData(e){const t=e.get("hasAltText");return{hasAltText:t.get(!0)??0,hasNoAltText:t.get(!1)??0}}#getBitmapFetched(e,t=!1){if(!e){this.remove();return}this.#bitmap=e.bitmap,t||(this.#bitmapId=e.id,this.#isSvg=e.isSvg),e.file&&(this.#bitmapFileName=e.file.name),this.#createCanvas()}#getBitmapDone(){if(this.#bitmapPromise=null,this._uiManager.enableWaiting(!1),!this.#canvas)return;if(this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#bitmap){this._editToolbar.hide(),this._uiManager.editAltText(this,!0);return}if(!this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#bitmap){this._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!1,alt_text_type:"empty"}});try{this.mlGuessAltText()}catch{}}this.div.focus()}async mlGuessAltText(e=null,t=!0){if(this.hasAltTextData())return null;const{mlManager:s}=this._uiManager;if(!s)throw new Error("No ML.");if(!await s.isEnabledFor("altText"))throw new Error("ML isn't enabled for alt text.");const{data:i,width:a,height:r}=e||this.copyCanvas(null,null,!0).imageData,n=await s.guess({name:"altText",request:{data:i,width:a,height:r,channels:i.length/(a*r)}});if(!n)throw new Error("No response from the AI service.");if(n.error)throw new Error("Error from the AI service.");if(n.cancel)return null;if(!n.output)throw new Error("No valid response from the AI service.");const o=n.output;return await this.setGuessedAltText(o),t&&!this.hasAltTextData()&&(this.altTextData={alt:o,decorative:!1}),o}#getBitmap(){if(this.#bitmapId){this._uiManager.enableWaiting(!0),this._uiManager.imageManager.getFromId(this.#bitmapId).then(e=>this.#getBitmapFetched(e,!0)).finally(()=>this.#getBitmapDone());return}if(this.#bitmapUrl){const e=this.#bitmapUrl;this.#bitmapUrl=null,this._uiManager.enableWaiting(!0),this.#bitmapPromise=this._uiManager.imageManager.getFromUrl(e).then(e=>this.#getBitmapFetched(e)).finally(()=>this.#getBitmapDone());return}if(this.#bitmapFile){const e=this.#bitmapFile;this.#bitmapFile=null,this._uiManager.enableWaiting(!0),this.#bitmapPromise=this._uiManager.imageManager.getFromFile(e).then(e=>this.#getBitmapFetched(e)).finally(()=>this.#getBitmapDone());return}const e=document.createElement("input");e.type="file",e.accept=SupportedImageMimeTypes.join(",");const t=this._uiManager._signal;this.#bitmapPromise=new Promise(n=>{e.addEventListener("change",async()=>{if(!e.files||e.files.length===0)this.remove();else{this._uiManager.enableWaiting(!0);const t=await this._uiManager.imageManager.getFromFile(e.files[0]);this._reportTelemetry({action:"pdfjs.image.image_selected",data:{alt_text_modal:this._uiManager.useNewAltTextFlow}}),this.#getBitmapFetched(t)}n()},{signal:t}),e.addEventListener("cancel",()=>{this.remove(),n()},{signal:t})}).finally(()=>this.#getBitmapDone()),e.click()}remove(){this.#bitmapId&&(this.#bitmap=null,this._uiManager.imageManager.deleteId(this.#bitmapId),this.#canvas?.remove(),this.#canvas=null,this.#resizeTimeoutId&&(clearTimeout(this.#resizeTimeoutId),this.#resizeTimeoutId=null)),super.remove()}rebuild(){if(!this.parent){this.#bitmapId&&this.#getBitmap();return}if(super.rebuild(),this.div===null)return;this.#bitmapId&&this.#canvas===null&&this.#getBitmap(),this.isAttachedToDOM||this.parent.add(this)}onceAdded(e){this._isDraggable=!0,e&&this.div.focus()}isEmpty(){return!(this.#bitmapPromise||this.#bitmap||this.#bitmapUrl||this.#bitmapFile||this.#bitmapId||this.#missingCanvas)}get isResizable(){return!0}render(){if(this.div)return this.div;let e,t;return this._isCopy&&(e=this.x,t=this.y),super.render(),this.div.hidden=!0,this.addAltTextButton(),this.#missingCanvas||(this.#bitmap?this.#createCanvas():this.#getBitmap()),this._isCopy&&this._moveAfterPaste(e,t),this._uiManager.addShouldRescale(this),this.div}setCanvas(e,t){const{id:n,bitmap:s}=this._uiManager.imageManager.getFromCanvas(e,t);t.remove(),n&&this._uiManager.imageManager.isValidId(n)&&(this.#bitmapId=n,s&&(this.#bitmap=s),this.#missingCanvas=!1,this.#createCanvas())}_onResized(){this.onScaleChanging()}onScaleChanging(){if(!this.parent)return;this.#resizeTimeoutId!==null&&clearTimeout(this.#resizeTimeoutId);const e=200;this.#resizeTimeoutId=setTimeout(()=>{this.#resizeTimeoutId=null,this.#drawBitmap()},e)}#createCanvas(){const{div:a}=this;let{width:e,height:t}=this.#bitmap;const[n,s]=this.pageDimensions,o=.75;if(this.width)e=this.width*n,t=this.height*s;else if(e>o*n||t>o*s){const i=Math.min(o*n/e,o*s/t);e*=i,t*=i}const[r,c]=this.parentDimensions;this.setDims(e*r/n,t*c/s),this._uiManager.enableWaiting(!1);const i=this.#canvas=document.createElement("canvas");i.setAttribute("role","img"),this.addContainer(i),this.width=e/n,this.height=t/s,this._initialOptions?.isCentered?this.center():this.fixAndSetPosition(),this._initialOptions=null,(!this._uiManager.useNewAltTextWhenAddingImage||!this._uiManager.useNewAltTextFlow||this.annotationElementId)&&(a.hidden=!1),this.#drawBitmap(),this.#hasBeenAddedInUndoStack||(this.parent.addUndoableEditor(this),this.#hasBeenAddedInUndoStack=!0),this._reportTelemetry({action:"inserted_image"}),this.#bitmapFileName&&this.div.setAttribute("aria-description",this.#bitmapFileName)}copyCanvas(e,t,n=!1){e||(e=224);const{width:o,height:i}=this.#bitmap,a=new OutputScale;let s=this.#bitmap,c=o,l=i,r=null;if(t){if(o>t||i>t){const e=Math.min(t/o,t/i);c=Math.floor(o*e),l=Math.floor(i*e)}r=document.createElement("canvas");const h=r.width=Math.ceil(c*a.sx),m=r.height=Math.ceil(l*a.sy);this.#isSvg||(s=this.#scaleBitmap(h,m));const e=r.getContext("2d");e.filter=this._uiManager.hcmFilter;let p="white",f="#cfcfd8";this._uiManager.hcmFilter!=="none"?f="black":window.matchMedia?.("(prefers-color-scheme: dark)").matches&&(p="#8f8f9d",f="#42414d");const g=15,n=g*a.sx,d=g*a.sy,v=new OffscreenCanvas(n*2,d*2),u=v.getContext("2d");u.fillStyle=p,u.fillRect(0,0,n*2,d*2),u.fillStyle=f,u.fillRect(0,0,n,d),u.fillRect(n,d,n,d),e.fillStyle=e.createPattern(v,"repeat"),e.fillRect(0,0,h,m),e.drawImage(s,0,0,s.width,s.height,0,0,h,m)}let d=null;if(n){let t,n;if(a.symmetric&&s.width<e&&s.height<e)t=s.width,n=s.height;else if(s=this.#bitmap,o>e||i>e){const a=Math.min(e/o,e/i);t=Math.floor(o*a),n=Math.floor(i*a),this.#isSvg||(s=this.#scaleBitmap(t,n))}const c=new OffscreenCanvas(t,n),r=c.getContext("2d",{willReadFrequently:!0});r.drawImage(s,0,0,s.width,s.height,0,0,t,n),d={width:t,height:n,data:r.getImageData(0,0,t,n).data}}return{canvas:r,width:c,height:l,imageData:d}}#scaleBitmap(e,t){const{width:i,height:a}=this.#bitmap;let n=i,s=a,o=this.#bitmap;for(;n>2*e||s>2*t;){const a=n,r=s;n>2*e&&(n=n>=16384?Math.floor(n/2)-1:Math.ceil(n/2)),s>2*t&&(s=s>=16384?Math.floor(s/2)-1:Math.ceil(s/2));const i=new OffscreenCanvas(n,s),c=i.getContext("2d");c.drawImage(o,0,0,a,r,0,0,n,s),o=i.transferToImageBitmap()}return o}#drawBitmap(){const[a,r]=this.parentDimensions,{width:c,height:l}=this,o=new OutputScale,t=Math.ceil(c*a*o.sx),n=Math.ceil(l*r*o.sy),e=this.#canvas;if(!e||e.width===t&&e.height===n)return;e.width=t,e.height=n;const s=this.#isSvg?this.#bitmap:this.#scaleBitmap(t,n),i=e.getContext("2d");i.filter=this._uiManager.hcmFilter,i.drawImage(s,0,0,s.width,s.height,0,0,t,n)}#serializeBitmap(e){if(e){if(this.#isSvg){const e=this._uiManager.imageManager.getSvgUrl(this.#bitmapId);if(e)return e}const e=document.createElement("canvas");({width:e.width,height:e.height}=this.#bitmap);const t=e.getContext("2d");return t.drawImage(this.#bitmap,0,0),e.toDataURL()}if(this.#isSvg){const[s,o]=this.pageDimensions,e=Math.round(this.width*s*PixelsPerInch.PDF_TO_CSS_UNITS),t=Math.round(this.height*o*PixelsPerInch.PDF_TO_CSS_UNITS),n=new OffscreenCanvas(e,t),i=n.getContext("2d");return i.drawImage(this.#bitmap,0,0,this.#bitmap.width,this.#bitmap.height,0,0,e,t),n.transferToImageBitmap()}return structuredClone(this.#bitmap)}static async deserialize(e,t,n){let i=null,r=!1;if(e instanceof StampAnnotationElement){const{data:{rect:l,rotation:d,id:o,structParent:u,popupRef:h},container:m,parent:{page:{pageNumber:f}},canvas:s}=e;let a,c;s?(delete e.canvas,{id:a,bitmap:c}=n.imageManager.getFromCanvas(m.id,s),s.remove()):(r=!0,e._hasNoCanvas=!0);const p=(await t._structTree.getAriaAttributes(`${AnnotationPrefix}${o}`))?.get("aria-label")||"";i=e={annotationType:AnnotationEditorType.STAMP,bitmapId:a,bitmap:c,pageIndex:f-1,rect:l.slice(0),rotation:d,id:o,deleted:!1,accessibilityData:{decorative:!1,altText:p},isSvg:!1,structParent:u,popupRef:h}}const s=await super.deserialize(e,t,n),{rect:o,bitmap:c,bitmapUrl:d,bitmapId:a,isSvg:u,accessibilityData:l}=e;r?(n.addMissingCanvas(e.id,s),s.#missingCanvas=!0):a&&n.imageManager.isValidId(a)?(s.#bitmapId=a,c&&(s.#bitmap=c)):s.#bitmapUrl=d,s.#isSvg=u;const[h,m]=s.pageDimensions;return s.width=(o[2]-o[0])/h,s.height=(o[3]-o[1])/m,s.annotationElementId=e.id||null,l&&(s.altTextData=l),s._initialData=i,s.#hasBeenAddedInUndoStack=!!i,s}serialize(e=!1,t=null){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const n={annotationType:AnnotationEditorType.STAMP,bitmapId:this.#bitmapId,pageIndex:this.pageIndex,rect:this.getRect(0,0),rotation:this.rotation,isSvg:this.#isSvg,structTreeParentId:this._structTreeParentId};if(e)return n.bitmapUrl=this.#serializeBitmap(!0),n.accessibilityData=this.serializeAltText(!0),n.isCopy=!0,n;const{decorative:i,altText:o}=this.serializeAltText(!1);if(!i&&o&&(n.accessibilityData={type:"Figure",alt:o}),this.annotationElementId){const e=this.#hasElementChanged(n);if(e.isSame)return null;e.isSameAltText?delete n.accessibilityData:n.accessibilityData.structParent=this._initialData.structParent??-1}if(n.id=this.annotationElementId,t===null)return n;t.stamps||=new Map;const s=this.#isSvg?(n.rect[2]-n.rect[0])*(n.rect[3]-n.rect[1]):null;if(t.stamps.has(this.#bitmapId)){if(this.#isSvg){const e=t.stamps.get(this.#bitmapId);s>e.area&&(e.area=s,e.serialized.bitmap.close(),e.serialized.bitmap=this.#serializeBitmap(!1))}}else t.stamps.set(this.#bitmapId,{area:s,serialized:n}),n.bitmap=this.#serializeBitmap(!1);return n}#hasElementChanged(e){const{pageIndex:n,accessibilityData:{altText:s}}=this._initialData,o=e.pageIndex===n,t=(e.accessibilityData?.alt||"")===s;return{isSame:!this._hasBeenMoved&&!this._hasBeenResized&&o&&t,isSameAltText:t}}renderAnnotationElement(e){return e.updateEdited({rect:this.getRect(0,0)}),null}}class AnnotationEditorLayer{#accessibilityManager;#allowClick=!1;#annotationLayer=null;#clickAC=null;#editorFocusTimeoutId=null;#editors=new Map;#hadPointerDown=!1;#isDisabling=!1;#isEnabling=!1;#drawingAC=null;#focusedElement=null;#textLayer=null;#textSelectionAC=null;#uiManager;static _initialized=!1;static#editorTypes=new Map([FreeTextEditor,InkEditor,StampEditor,HighlightEditor,SignatureEditor].map(e=>[e._editorType,e]));constructor({uiManager:e,pageIndex:t,div:n,structTreeLayer:s,accessibilityManager:o,annotationLayer:i,drawLayer:a,textLayer:r,viewport:c,l10n:l}){const d=[...AnnotationEditorLayer.#editorTypes.values()];if(!AnnotationEditorLayer._initialized){AnnotationEditorLayer._initialized=!0;for(const t of d)t.initialize(l,e)}e.registerEditorTypes(d),this.#uiManager=e,this.pageIndex=t,this.div=n,this.#accessibilityManager=o,this.#annotationLayer=i,this.viewport=c,this.#textLayer=r,this.drawLayer=a,this._structTree=s,this.#uiManager.addLayer(this)}get isEmpty(){return this.#editors.size===0}get isInvisible(){return this.isEmpty&&this.#uiManager.getMode()===AnnotationEditorType.NONE}updateToolbar(e){this.#uiManager.updateToolbar(e)}updateMode(e=this.#uiManager.getMode()){switch(this.#cleanup(),e){case AnnotationEditorType.NONE:this.disableTextSelection(),this.togglePointerEvents(!1),this.toggleAnnotationLayerPointerEvents(!0),this.disableClick();return;case AnnotationEditorType.INK:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick();break;case AnnotationEditorType.HIGHLIGHT:this.enableTextSelection(),this.togglePointerEvents(!1),this.disableClick();break;default:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick()}this.toggleAnnotationLayerPointerEvents(!1);const{classList:t}=this.div;for(const n of AnnotationEditorLayer.#editorTypes.values())t.toggle(`${n._type}Editing`,e===n._editorType);this.div.hidden=!1}hasTextLayer(e){return e===this.#textLayer?.div}setEditingState(e){this.#uiManager.setEditingState(e)}addCommands(e){this.#uiManager.addCommands(e)}cleanUndoStack(e){this.#uiManager.cleanUndoStack(e)}toggleDrawing(e=!1){this.div.classList.toggle("drawing",!e)}togglePointerEvents(e=!1){this.div.classList.toggle("disabled",!e)}toggleAnnotationLayerPointerEvents(e=!1){this.#annotationLayer?.div.classList.toggle("disabled",!e)}async enable(){this.#isEnabling=!0,this.div.tabIndex=0,this.togglePointerEvents(!0);const e=new Set;for(const t of this.#editors.values())t.enableEditing(),t.show(!0),t.annotationElementId&&(this.#uiManager.removeChangedExistingAnnotation(t),e.add(t.annotationElementId));if(!this.#annotationLayer){this.#isEnabling=!1;return}const t=this.#annotationLayer.getEditableAnnotations();for(const n of t){if(n.hide(),this.#uiManager.isDeletedAnnotationElement(n.data.id))continue;if(e.has(n.data.id))continue;const s=await this.deserialize(n);if(!s)continue;this.addOrRebuild(s),s.enableEditing()}this.#isEnabling=!1}disable(){this.#isDisabling=!0,this.div.tabIndex=-1,this.togglePointerEvents(!1);const e=new Map,t=new Map;for(const n of this.#editors.values()){if(n.disableEditing(),!n.annotationElementId)continue;if(n.serialize()!==null){e.set(n.annotationElementId,n);continue}t.set(n.annotationElementId,n),this.getEditableAnnotation(n.annotationElementId)?.show(),n.remove()}if(this.#annotationLayer){const n=this.#annotationLayer.getEditableAnnotations();for(const o of n){const{id:i}=o.data;if(this.#uiManager.isDeletedAnnotationElement(i))continue;let s=t.get(i);if(s){s.resetAnnotationElement(o),s.show(!1),o.show();continue}s=e.get(i),s&&(this.#uiManager.addChangedExistingAnnotation(s),s.renderAnnotationElement(o)&&s.show(!1)),o.show()}}this.#cleanup(),this.isEmpty&&(this.div.hidden=!0);const{classList:n}=this.div;for(const e of AnnotationEditorLayer.#editorTypes.values())n.remove(`${e._type}Editing`);this.disableTextSelection(),this.toggleAnnotationLayerPointerEvents(!0),this.#isDisabling=!1}getEditableAnnotation(e){return this.#annotationLayer?.getEditableAnnotation(e)||null}setActiveEditor(e){const t=this.#uiManager.getActive();if(t===e)return;this.#uiManager.setActiveEditor(e)}enableTextSelection(){if(this.div.tabIndex=-1,this.#textLayer?.div&&!this.#textSelectionAC){this.#textSelectionAC=new AbortController;const e=this.#uiManager.combinedSignal(this.#textSelectionAC);this.#textLayer.div.addEventListener("pointerdown",this.#textLayerPointerDown.bind(this),{signal:e}),this.#textLayer.div.classList.add("highlighting")}}disableTextSelection(){this.div.tabIndex=0,this.#textLayer?.div&&this.#textSelectionAC&&(this.#textSelectionAC.abort(),this.#textSelectionAC=null,this.#textLayer.div.classList.remove("highlighting"))}#textLayerPointerDown(e){this.#uiManager.unselectAll();const{target:t}=e;if(t===this.#textLayer.div||(t.getAttribute("role")==="img"||t.classList.contains("endOfContent"))&&this.#textLayer.div.contains(t)){const{isMac:t}=util_FeatureTest.platform;if(e.button!==0||e.ctrlKey&&t)return;this.#uiManager.showAllEditors("highlight",!0,!0),this.#textLayer.div.classList.add("free"),this.toggleDrawing(),HighlightEditor.startHighlighting(this,this.#uiManager.direction==="ltr",{target:this.#textLayer.div,x:e.x,y:e.y}),this.#textLayer.div.addEventListener("pointerup",()=>{this.#textLayer.div.classList.remove("free"),this.toggleDrawing(!0)},{once:!0,signal:this.#uiManager._signal}),e.preventDefault()}}enableClick(){if(this.#clickAC)return;this.#clickAC=new AbortController;const e=this.#uiManager.combinedSignal(this.#clickAC);this.div.addEventListener("pointerdown",this.pointerdown.bind(this),{signal:e});const t=this.pointerup.bind(this);this.div.addEventListener("pointerup",t,{signal:e}),this.div.addEventListener("pointercancel",t,{signal:e})}disableClick(){this.#clickAC?.abort(),this.#clickAC=null}attach(e){this.#editors.set(e.id,e);const{annotationElementId:t}=e;t&&this.#uiManager.isDeletedAnnotationElement(t)&&this.#uiManager.removeDeletedAnnotationElement(e)}detach(e){this.#editors.delete(e.id),this.#accessibilityManager?.removePointerInTextLayer(e.contentDiv),!this.#isDisabling&&e.annotationElementId&&this.#uiManager.addDeletedAnnotationElement(e)}remove(e){this.detach(e),this.#uiManager.removeEditor(e),e.div.remove(),e.isAttachedToDOM=!1}changeParent(e){if(e.parent===this)return;e.parent&&e.annotationElementId&&(this.#uiManager.addDeletedAnnotationElement(e.annotationElementId),AnnotationEditor.deleteAnnotationElement(e),e.annotationElementId=null),this.attach(e),e.parent?.detach(e),e.setParent(this),e.div&&e.isAttachedToDOM&&(e.div.remove(),this.div.append(e.div))}add(e){if(e.parent===this&&e.isAttachedToDOM)return;if(this.changeParent(e),this.#uiManager.addEditor(e),this.attach(e),!e.isAttachedToDOM){const t=e.render();this.div.append(t),e.isAttachedToDOM=!0}e.fixAndSetPosition(),e.onceAdded(!this.#isEnabling),this.#uiManager.addToAnnotationStorage(e),e._reportTelemetry(e.telemetryInitialData)}moveEditorInDOM(e){if(!e.isAttachedToDOM)return;const{activeElement:t}=document;e.div.contains(t)&&!this.#editorFocusTimeoutId&&(e._focusEventsAllowed=!1,this.#editorFocusTimeoutId=setTimeout(()=>{this.#editorFocusTimeoutId=null,e.div.contains(document.activeElement)?e._focusEventsAllowed=!0:(e.div.addEventListener("focusin",()=>{e._focusEventsAllowed=!0},{once:!0,signal:this.#uiManager._signal}),t.focus())},0)),e._structTreeParentId=this.#accessibilityManager?.moveElementInDOM(this.div,e.div,e.contentDiv,!0)}addOrRebuild(e){e.needsToBeRebuilt()?(e.parent||=this,e.rebuild(),e.show()):this.add(e)}addUndoableEditor(e){const t=()=>e._uiManager.rebuild(e),n=()=>{e.remove()};this.addCommands({cmd:t,undo:n,mustExec:!1})}getNextId(){return this.#uiManager.getId()}get#currentEditorType(){return AnnotationEditorLayer.#editorTypes.get(this.#uiManager.getMode())}combinedSignal(e){return this.#uiManager.combinedSignal(e)}#createNewEditor(e){const t=this.#currentEditorType;return t?new t.prototype.constructor(e):null}canCreateNewEmptyEditor(){return this.#currentEditorType?.canCreateNewEmptyEditor()}async pasteEditor(e,t){this.updateToolbar(e),await this.#uiManager.updateMode(e.mode);const{offsetX:s,offsetY:o}=this.#getCenterPoint(),i=this.getNextId(),n=this.#createNewEditor({parent:this,id:i,x:s,y:o,uiManager:this.#uiManager,isCentered:!0,...t});n&&this.add(n)}async deserialize(e){return await AnnotationEditorLayer.#editorTypes.get(e.annotationType??e.annotationEditorType)?.deserialize(e,this,this.#uiManager)||null}createAndAddNewEditor(e,t,n={}){const o=this.getNextId(),s=this.#createNewEditor({parent:this,id:o,x:e.offsetX,y:e.offsetY,uiManager:this.#uiManager,isCentered:t,...n});return s&&this.add(s),s}#getCenterPoint(){const{x:e,y:t,width:o,height:i}=this.div.getBoundingClientRect(),a=Math.max(0,e),r=Math.max(0,t),c=Math.min(window.innerWidth,e+o),l=Math.min(window.innerHeight,t+i),n=(a+c)/2-e,s=(r+l)/2-t,[d,u]=this.viewport.rotation%180===0?[n,s]:[s,n];return{offsetX:d,offsetY:u}}addNewEditor(e={}){this.createAndAddNewEditor(this.#getCenterPoint(),!0,e)}setSelected(e){this.#uiManager.setSelected(e)}toggleSelected(e){this.#uiManager.toggleSelected(e)}unselect(e){this.#uiManager.unselect(e)}pointerup(e){const{isMac:n}=util_FeatureTest.platform;if(e.button!==0||e.ctrlKey&&n)return;if(e.target!==this.div)return;if(!this.#hadPointerDown)return;if(this.#hadPointerDown=!1,this.#currentEditorType?.isDrawer&&this.#currentEditorType.supportMultipleDrawings)return;if(!this.#allowClick){this.#allowClick=!0;return}const t=this.#uiManager.getMode();if(t===AnnotationEditorType.STAMP||t===AnnotationEditorType.SIGNATURE){this.#uiManager.unselectAll();return}this.createAndAddNewEditor(e,!1)}pointerdown(e){if(this.#uiManager.getMode()===AnnotationEditorType.HIGHLIGHT&&this.enableTextSelection(),this.#hadPointerDown){this.#hadPointerDown=!1;return}const{isMac:n}=util_FeatureTest.platform;if(e.button!==0||e.ctrlKey&&n)return;if(e.target!==this.div)return;if(this.#hadPointerDown=!0,this.#currentEditorType?.isDrawer){this.startDrawingSession(e);return}const t=this.#uiManager.getActive();this.#allowClick=!t||t.isEmpty()}startDrawingSession(e){if(this.div.focus({preventScroll:!0}),this.#drawingAC){this.#currentEditorType.startDrawing(this,this.#uiManager,!1,e);return}this.#uiManager.setCurrentDrawingSession(this),this.#drawingAC=new AbortController;const t=this.#uiManager.combinedSignal(this.#drawingAC);this.div.addEventListener("blur",({relatedTarget:e})=>{e&&!this.div.contains(e)&&(this.#focusedElement=null,this.commitOrRemove())},{signal:t}),this.#currentEditorType.startDrawing(this,this.#uiManager,!1,e)}pause(e){if(e){const{activeElement:e}=document;this.div.contains(e)&&(this.#focusedElement=e);return}this.#focusedElement&&setTimeout(()=>{this.#focusedElement?.focus(),this.#focusedElement=null},0)}endDrawingSession(e=!1){return this.#drawingAC?(this.#uiManager.setCurrentDrawingSession(null),this.#drawingAC.abort(),this.#drawingAC=null,this.#focusedElement=null,this.#currentEditorType.endDrawing(e)):null}findNewParent(e,t,n){const s=this.#uiManager.findParent(t,n);return s!==null&&s!==this&&(s.changeParent(e),!0)}commitOrRemove(){return!!this.#drawingAC&&(this.endDrawingSession(),!0)}onScaleChanging(){if(!this.#drawingAC)return;this.#currentEditorType.onScaleChangingWhenDrawing(this)}destroy(){this.commitOrRemove(),this.#uiManager.getActive()?.parent===this&&(this.#uiManager.commitOrRemove(),this.#uiManager.setActiveEditor(null)),this.#editorFocusTimeoutId&&(clearTimeout(this.#editorFocusTimeoutId),this.#editorFocusTimeoutId=null);for(const e of this.#editors.values())this.#accessibilityManager?.removePointerInTextLayer(e.contentDiv),e.setParent(null),e.isAttachedToDOM=!1,e.div.remove();this.div=null,this.#editors.clear(),this.#uiManager.removeLayer(this)}#cleanup(){for(const e of this.#editors.values())e.isEmpty()&&e.remove()}render({viewport:e}){this.viewport=e,setLayerDimensions(this.div,e);for(const e of this.#uiManager.getEditors(this.pageIndex))this.add(e),e.rebuild();this.updateMode()}update({viewport:e}){this.#uiManager.commitOrRemove(),this.#cleanup();const n=this.viewport.rotation,t=e.rotation;if(this.viewport=e,setLayerDimensions(this.div,{rotation:t}),n!==t)for(const e of this.#editors.values())e.rotate(t)}get pageDimensions(){const{pageWidth:e,pageHeight:t}=this.viewport.rawDims;return[e,t]}get scale(){return this.#uiManager.viewParameters.realScale}}class DrawLayer{#parent=null;#mapping=new Map;#toUpdate=new Map;static#id=0;constructor({pageIndex:e}){this.pageIndex=e}setParent(e){if(!this.#parent){this.#parent=e;return}if(this.#parent!==e){if(this.#mapping.size>0)for(const t of this.#mapping.values())t.remove(),e.append(t);this.#parent=e}}static get _svgFactory(){return shadow(this,"_svgFactory",new DOMSVGFactory)}static#setBox(e,[t,n,s,o]){const{style:i}=e;i.top=`${100*n}%`,i.left=`${100*t}%`,i.width=`${100*s}%`,i.height=`${100*o}%`}#createSVG(){const e=DrawLayer._svgFactory.create(1,1,!0);return this.#parent.append(e),e.setAttribute("aria-hidden",!0),e}#createClipPath(e,t){const n=DrawLayer._svgFactory.createElement("clipPath");e.append(n);const o=`clip_${t}`;n.setAttribute("id",o),n.setAttribute("clipPathUnits","objectBoundingBox");const s=DrawLayer._svgFactory.createElement("use");return n.append(s),s.setAttribute("href",`#${t}`),s.classList.add("clip"),o}#updateProperties(e,t){for(const[n,s]of Object.entries(t))s===null?e.removeAttribute(n):e.setAttribute(n,s)}draw(e,t=!1,n=!1){const s=DrawLayer.#id++,o=this.#createSVG(),a=DrawLayer._svgFactory.createElement("defs");o.append(a);const i=DrawLayer._svgFactory.createElement("path");a.append(i);const r=`path_p${this.pageIndex}_${s}`;i.setAttribute("id",r),i.setAttribute("vector-effect","non-scaling-stroke"),t&&this.#toUpdate.set(s,i);const l=n?this.#createClipPath(a,r):null,c=DrawLayer._svgFactory.createElement("use");return o.append(c),c.setAttribute("href",`#${r}`),this.updateProperties(o,e),this.#mapping.set(s,o),{id:s,clipPathId:`url(#${l})`}}drawOutline(e,t){const o=DrawLayer.#id++,n=this.#createSVG(),a=DrawLayer._svgFactory.createElement("defs");n.append(a);const r=DrawLayer._svgFactory.createElement("path");a.append(r);const c=`path_p${this.pageIndex}_${o}`;r.setAttribute("id",c),r.setAttribute("vector-effect","non-scaling-stroke");let i;if(t){const t=DrawLayer._svgFactory.createElement("mask");a.append(t),i=`mask_p${this.pageIndex}_${o}`,t.setAttribute("id",i),t.setAttribute("maskUnits","objectBoundingBox");const n=DrawLayer._svgFactory.createElement("rect");t.append(n),n.setAttribute("width","1"),n.setAttribute("height","1"),n.setAttribute("fill","white");const e=DrawLayer._svgFactory.createElement("use");t.append(e),e.setAttribute("href",`#${c}`),e.setAttribute("stroke","none"),e.setAttribute("fill","black"),e.setAttribute("fill-rule","nonzero"),e.classList.add("mask")}const s=DrawLayer._svgFactory.createElement("use");n.append(s),s.setAttribute("href",`#${c}`),i&&s.setAttribute("mask",`url(#${i})`);const l=s.cloneNode();return n.append(l),s.classList.add("mainOutline"),l.classList.add("secondaryOutline"),this.updateProperties(n,e),this.#mapping.set(o,n),o}finalizeDraw(e,t){this.#toUpdate.delete(e),this.updateProperties(e,t)}updateProperties(e,t){if(!t)return;const{root:s,bbox:o,rootClass:i,path:a}=t,n=typeof e=="number"?this.#mapping.get(e):e;if(!n)return;if(s&&this.#updateProperties(n,s),o&&DrawLayer.#setBox(n,o),i){const{classList:e}=n;for(const[t,n]of Object.entries(i))e.toggle(t,n)}if(a){const e=n.firstChild,t=e.firstChild;this.#updateProperties(t,a)}}updateParent(e,t){if(t===this)return;const n=this.#mapping.get(e);if(!n)return;t.#parent.append(n),this.#mapping.delete(e),t.#mapping.set(e,n)}remove(e){if(this.#toUpdate.delete(e),this.#parent===null)return;this.#mapping.get(e).remove(),this.#mapping.delete(e)}destroy(){this.#parent=null;for(const e of this.#mapping.values())e.remove();this.#mapping.clear(),this.#toUpdate.clear()}}globalThis._pdfjsTestingUtils={HighlightOutliner},globalThis.pdfjsLib={AbortException,AnnotationEditorLayer,AnnotationEditorParamsType,AnnotationEditorType,AnnotationEditorUIManager,AnnotationLayer,AnnotationMode,AnnotationType,build,ColorPicker,createValidAbsoluteUrl,DOMSVGFactory,DrawLayer,FeatureTest:util_FeatureTest,fetchData,getDocument,getFilenameFromUrl,getPdfFilenameFromUrl,getUuid,getXfaPageViewport,GlobalWorkerOptions,ImageKind:util_ImageKind,InvalidPDFException,isDataScheme,isPdfFile,isValidExplicitDest,MathClamp,noContextMenu,normalizeUnicode,OPS,OutputScale,PasswordResponses,PDFDataRangeTransport,PDFDateString,PDFWorker,PermissionFlag,PixelsPerInch,RenderingCancelledException,ResponseException,setLayerDimensions,shadow,SignatureExtractor,stopEvent,SupportedImageMimeTypes,TextLayer,TouchManager,updateUrlHash,Util,VerbosityLevel,version,XfaLayer};export{AbortException,AnnotationEditorLayer,AnnotationEditorParamsType,AnnotationEditorType,AnnotationEditorUIManager,AnnotationLayer,AnnotationMode,AnnotationType,ColorPicker,DOMSVGFactory,DrawLayer,util_FeatureTest as FeatureTest,GlobalWorkerOptions,util_ImageKind as ImageKind,InvalidPDFException,MathClamp,OPS,OutputScale,PDFDataRangeTransport,PDFDateString,PDFWorker,PasswordResponses,PermissionFlag,PixelsPerInch,RenderingCancelledException,ResponseException,SignatureExtractor,SupportedImageMimeTypes,TextLayer,TouchManager,Util,VerbosityLevel,XfaLayer,build,createValidAbsoluteUrl,fetchData,getDocument,getFilenameFromUrl,getPdfFilenameFromUrl,getUuid,getXfaPageViewport,isDataScheme,isPdfFile,isValidExplicitDest,noContextMenu,normalizeUnicode,setLayerDimensions,shadow,stopEvent,updateUrlHash,version}